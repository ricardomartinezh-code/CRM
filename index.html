<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="theme-color" content="#0b1220" />
  <title>ReLead EDU</title>
<link rel="icon" type="image/png" href="./icon-unidep180.png">
<link rel="apple-touch-icon" href="./icon-unidep180.png?v=1">
<link rel="shortcut icon" type="image/png" href="./icon-unidep180.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />
  <meta name="color-scheme" content="light dark" />
  <style>
    :root {
      --color-primary: #003a5f; /* azul del logo */
      --color-secondary: #8a9ca3;
      --bg: #0b1220;
      --bg-soft: #0f172a;
      --card: #0f192f;
      --card-2: #121c34;
      --elev: rgba(255,255,255,0.06);
      --text: #e6ebf3;
      --muted: #9fb0cc;
      --accent: var(--color-primary);
      --accent-2: var(--color-secondary);
      --ok: #22c55e; --warn: #f59e0b; --bad: #ef4444; --info:#60a5fa;
      --panel-base-rgb: 37,99,235;
      --panel-base-color: rgb(var(--panel-base-rgb));
      --panel-base-strong: color-mix(in srgb, rgb(var(--panel-base-rgb)) 82%, #050b1b 18%);
      --panel-base-soft: color-mix(in srgb, rgb(var(--panel-base-rgb)) 54%, #0b1220 46%);
      --panel-base-bright: color-mix(in srgb, rgb(var(--panel-base-rgb)) 68%, #f8fafc 32%);
      --panel-stage-text: #f8fafc;
      --etapa-nuevo: #2563eb;
      --etapa-contactado: #0ea5e9;
      --etapa-no-contactado: #d97706;
      --etapa-inscrito: #16a34a;
      --etapa-descartado: #dc2626;
      --radius: 14px;
      --shadow: 0 10px 30px rgba(2,10,28,0.45);
      --ring: 0 0 0 3px rgba(0,58,95,.35);
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      --font-size-base: 15px;
      --space:16px;
      --space-sm:8px;
      --space-xs:4px;
      --avatar-size:120px;
    }
    html[data-theme="light"]{
      --bg: #f6f8fb;
      --bg-soft:#eef2f7;
      --card:#ffffff;
      --card-2:#f8fafc;
      --elev: rgba(2,10,28,0.06);
      --text:#0f172a;
      --muted:#5b6b86;
      --shadow: 0 10px 24px rgba(15,23,42,0.08);
      --ring: 0 0 0 3px rgba(0,58,95,.25);
      --accent: var(--color-primary);
      --accent-2: var(--color-secondary);
      --panel-base-strong: color-mix(in srgb, rgb(var(--panel-base-rgb)) 70%, #1e293b 30%);
      --panel-base-soft: color-mix(in srgb, rgb(var(--panel-base-rgb)) 30%, #ffffff 70%);
      --panel-base-bright: color-mix(in srgb, rgb(var(--panel-base-rgb)) 42%, #ffffff 58%);
      --panel-stage-text: #0f172a;
    }
    html[data-theme="light"] .nav-footer{ border-top:1px solid rgba(15,23,42,0.08); }
    html[data-theme="light"] .nav-footer__meta{ border-color:rgba(15,23,42,0.08); color:#475569; }
    html[data-theme="light"] .nav-footer__rights{ color:#475569; }
    html[data-theme="light"] .view-controls .filters label{
      background: rgba(var(--panel-base-rgb),0.12);
      border-color: rgba(var(--panel-base-rgb),0.28);
      color: #0f172a;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.6), 0 10px 24px rgba(var(--panel-base-rgb),0.16);
    }
    html[data-theme="light"] .view-controls .filters label select{
      background: rgba(255,255,255,0.92);
      border-color: rgba(var(--panel-base-rgb),0.3);
      color:#0f172a;
      box-shadow: inset 0 1px 2px rgba(var(--panel-base-rgb),0.18);
    }
    html[data-theme="light"] .view-controls .filters label select.is-multiple{
      background:#ffffff;
    }
    html[data-theme="light"] .kpi-group{
      background: color-mix(in srgb, var(--card) 90%, var(--panel-base-soft) 10%);
      border-color: color-mix(in srgb, var(--panel-base-color) 22%, transparent);
      box-shadow: 0 18px 42px color-mix(in srgb, var(--panel-base-color) 14%, rgba(15,23,42,0.08));
    }
    html[data-theme="light"] .kpi-metric{
      background: color-mix(in srgb, var(--card) 94%, var(--panel-base-bright) 6%);
      border-color: color-mix(in srgb, var(--panel-base-color) 18%, transparent);
      box-shadow: inset 0 1px 2px color-mix(in srgb, var(--panel-base-bright) 30%, rgba(255,255,255,0.6)), 0 14px 30px color-mix(in srgb, var(--panel-base-color) 12%, rgba(15,23,42,0.08));
    }
    html[data-theme="light"] .kpi-metric .metric-name{ color:color-mix(in srgb, var(--panel-base-color) 32%, #5b6b86 68%); }
    html[data-theme="light"] .kpi-metric .metric-icon{ background: color-mix(in srgb, var(--panel-base-bright) 42%, rgba(255,255,255,0.4)); color: color-mix(in srgb, var(--panel-base-color) 18%, var(--panel-stage-text) 82%); box-shadow: inset 0 1px 2px rgba(255,255,255,0.6); }
    * { box-sizing: border-box }
    body {
      margin: 0;
      background: radial-gradient(1200px 600px at 80% -10%, rgba(138,156,163,0.14), transparent 60%), radial-gradient(900px 500px at -10% 10%, rgba(0,58,95,0.18), transparent 60%), var(--bg);
      color: var(--text);
      font-family: var(--font);
      font-size: var(--font-size-base);
      line-height: 1.5;
      letter-spacing:.2px;
    }
    body.sidebar-open{ overflow:hidden; }
    @keyframes spin{ to{ transform: rotate(360deg); } }
    @keyframes fadeUp{ from{ opacity:0; transform:translate3d(0,18px,0); } to{ opacity:1; transform:translate3d(0,0,0); } }
    @keyframes floatCard{
      0%{ transform:translate3d(0,8px,0); }
      50%{ transform:translate3d(0,0,0); }
      100%{ transform:translate3d(0,8px,0); }
    }
    .loading-overlay{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(11,18,32,0.6);
      backdrop-filter: blur(12px);
      z-index:120;
      opacity:0;
      pointer-events:none;
      transition: opacity .24s ease;
    }
    .loading-overlay.active{
      opacity:1;
      pointer-events:auto;
    }
    .loading-card{
      background: var(--card);
      border:1px solid rgba(255,255,255,0.12);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: calc(var(--space) * 1.25);
      min-width:220px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:var(--space-sm);
      animation: floatCard 3.2s ease-in-out infinite;
    }
    html[data-theme="light"] .loading-card{ border-color: rgba(15,23,42,0.12); }
    .loading-spinner{
      width:32px;
      height:32px;
      border-radius:50%;
      border:3px solid rgba(255,255,255,0.25);
      border-top-color: var(--accent);
      animation: spin .8s linear infinite;
    }
    html[data-theme="light"] .loading-spinner{
      border-color: rgba(15,23,42,0.16);
      border-top-color: var(--accent);
    }
    .loading-message{
      margin:0;
      text-align:center;
      font-weight:600;
      letter-spacing:.3px;
      color:var(--text);
    }
    .login-screen{
      position:fixed;
      inset:0;
      z-index:100;
      display:flex;
      flex-direction:column;
      gap:calc(var(--space) * 1.5);
      align-items:stretch;
      justify-content:center;
      padding:calc(var(--space) * 2) clamp(var(--space), 5vw, calc(var(--space) * 4));
      overflow-y:auto;
      background: radial-gradient(1200px 600px at 80% -10%, rgba(138,156,163,0.22), transparent 60%), radial-gradient(900px 500px at -10% 10%, rgba(0,58,95,0.25), transparent 60%), rgba(11,18,32,0.92);
      backdrop-filter: blur(8px);
    }
    .landing-layout{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
      gap:calc(var(--space) * 2);
      align-items:center;
    }
    .landing-hero{
      display:flex;
      flex-direction:column;
      gap:var(--space);
      color:var(--panel-stage-text);
    }
    .hero-kicker{
      display:inline-flex;
      align-items:center;
      gap:6px;
      width:max-content;
      padding:6px 12px;
      font-size:12px;
      font-weight:700;
      letter-spacing:.4px;
      text-transform:uppercase;
      border-radius:999px;
      background:rgba(var(--panel-base-rgb),0.18);
      color:var(--panel-stage-text);
      box-shadow:inset 0 1px 0 rgba(255,255,255,0.18);
    }
    .landing-hero h1{
      margin:0;
      font-size:clamp(32px, 5vw, 48px);
      line-height:1.1;
      font-weight:800;
    }
    .hero-subtitle{
      margin:0;
      font-size:clamp(16px, 2.2vw, 20px);
      color:color-mix(in srgb, var(--panel-stage-text) 82%, rgba(255,255,255,0.32) 18%);
      max-width:46ch;
    }
    html[data-theme="light"] .hero-subtitle{
      color:color-mix(in srgb, #0f172a 78%, rgba(15,23,42,0.32) 22%);
    }
    .hero-cta{
      display:flex;
      flex-wrap:wrap;
      gap:var(--space-sm);
      align-items:center;
    }
    .hero-cta .btn{
      min-width:180px;
      justify-content:center;
      font-weight:700;
    }
    .btn.outline{
      background:transparent;
      border:1px solid rgba(255,255,255,0.5);
      color:var(--panel-stage-text);
    }
    .btn.outline:hover,
    .btn.outline:focus-visible{
      background:rgba(var(--panel-base-rgb),0.12);
      color:var(--panel-stage-text);
    }
    html[data-theme="light"] .btn.outline{
      border-color:rgba(15,23,42,0.16);
      color:var(--text);
    }
    html[data-theme="light"] .btn.outline:hover,
    html[data-theme="light"] .btn.outline:focus-visible{
      background:rgba(var(--panel-base-rgb),0.12);
    }
    .hero-metrics{
      position:relative;
      overflow:hidden;
      margin-top:var(--space);
    }
    .hero-metrics__viewport{
      overflow:hidden;
      mask-image:linear-gradient(90deg, transparent 0%, rgba(0,0,0,0.85) 12%, rgba(0,0,0,0.85) 88%, transparent 100%);
    }
    .hero-metrics__track{
      display:flex;
      gap:var(--space);
      width:max-content;
      animation:heroCarousel 32s linear infinite;
    }
    .hero-metric{
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:6px;
      min-width:200px;
      padding:18px 20px;
      border-radius:calc(var(--radius) - 4px);
      border:1px solid rgba(255,255,255,0.14);
      background:linear-gradient(135deg, rgba(var(--panel-base-rgb),0.28), rgba(11,18,32,0.6));
      box-shadow:0 18px 40px rgba(2,10,28,0.45);
      color:var(--panel-stage-text);
    }
    html[data-theme="light"] .hero-metric{
      border-color:rgba(15,23,42,0.08);
      background:linear-gradient(135deg, rgba(var(--panel-base-rgb),0.14), #fff);
      color:#0f172a;
      box-shadow:0 18px 42px rgba(var(--panel-base-rgb),0.24);
    }
    .hero-metric__value{
      font-size:26px;
      font-weight:800;
      letter-spacing:-0.5px;
    }
    .hero-metric__label{
      font-size:13px;
      letter-spacing:.2px;
      text-transform:uppercase;
      color:color-mix(in srgb, currentColor 72%, rgba(255,255,255,0.45) 28%);
    }
    .hero-metric__trend{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:13px;
      font-weight:600;
      color:var(--ok);
    }
    html[data-theme="light"] .hero-metric__label{
      color:color-mix(in srgb, currentColor 70%, rgba(15,23,42,0.3) 30%);
    }
    .hero-metric__trend .bi{ font-size:16px; }
    @keyframes heroCarousel{
      0%{ transform:translateX(0); }
      100%{ transform:translateX(-50%); }
    }
    @media (prefers-reduced-motion: reduce){
      .hero-metrics__track{ animation:none; }
    }
    .success-stories{
      display:flex;
      flex-direction:column;
      gap:calc(var(--space) * 1.5);
      padding:calc(var(--space) * 1.5) clamp(var(--space), 6vw, calc(var(--space) * 4));
      border-radius:calc(var(--radius) * 1.25);
      background:rgba(15,23,42,0.32);
      border:1px solid rgba(255,255,255,0.12);
      box-shadow:0 28px 60px rgba(2,10,28,0.35);
      color:var(--panel-stage-text);
    }
    html[data-theme="light"] .success-stories{
      background:linear-gradient(135deg, rgba(var(--panel-base-rgb),0.12), #ffffff);
      border-color:rgba(15,23,42,0.08);
      box-shadow:0 32px 72px rgba(var(--panel-base-rgb),0.18);
      color:#0f172a;
    }
    .success-header h2{
      margin:0 0 6px;
      font-size:clamp(26px, 3vw, 32px);
      font-weight:800;
    }
    .success-header p{
      margin:0;
      max-width:60ch;
      color:color-mix(in srgb, currentColor 78%, rgba(255,255,255,0.32) 22%);
    }
    html[data-theme="light"] .success-header p{
      color:color-mix(in srgb, currentColor 68%, rgba(15,23,42,0.32) 32%);
    }
    .success-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
      gap:var(--space);
    }
    .success-card{
      display:flex;
      flex-direction:column;
      gap:var(--space-sm);
      padding:var(--space);
      border-radius:var(--radius);
      background:var(--card);
      border:1px solid rgba(255,255,255,0.12);
      box-shadow:var(--shadow);
    }
    html[data-theme="light"] .success-card{
      border-color:rgba(15,23,42,0.08);
    }
    .success-card__meta{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .success-card__quote{
      margin:0;
      font-size:15px;
      line-height:1.55;
      color:color-mix(in srgb, currentColor 80%, rgba(255,255,255,0.26) 20%);
    }
    html[data-theme="light"] .success-card__quote{
      color:color-mix(in srgb, currentColor 80%, rgba(15,23,42,0.18) 20%);
    }
    .success-card__author{
      font-weight:700;
      color:var(--panel-base-bright);
    }
    html[data-theme="light"] .success-card__author{
      color:color-mix(in srgb, rgb(var(--panel-base-rgb)) 60%, #0f172a 40%);
    }
    .success-card__role{
      margin:0;
      font-size:13px;
      color:var(--muted);
    }
    @media (max-width: 900px){
      .landing-layout{ grid-template-columns:1fr; }
      .hero-cta .btn{ flex:1 1 140px; }
    }
    @media (max-width: 600px){
      .success-stories{
        padding:calc(var(--space) * 1.25);
      }
    }
    .login-card{
      width:min(100%, 360px);
      background: var(--card);
      border:1px solid rgba(255,255,255,0.12);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: calc(var(--space) * 1.5);
      display:flex;
      flex-direction:column;
      gap:var(--space);
      align-items:stretch;
      text-align:left;
    }
    html[data-theme="light"] .login-card{
      background:#fff;
      border-color:rgba(15,23,42,0.1);
      box-shadow: 0 20px 60px rgba(15,23,42,0.18);
    }
    .login-logo{ display:flex; justify-content:center; }
    .login-logo img{ max-width:132px; width:100%; height:auto; filter: drop-shadow(0 12px 24px rgba(15,23,42,0.24)); }
    .login-title{
      margin:0 0 var(--space-xs);
      text-align:center;
      font-size:1.45rem;
      letter-spacing:.5px;
      font-weight:800;
      color:var(--text);
    }
    .login-intro{
      margin:0 0 var(--space);
      color:var(--muted);
      font-size:14px;
      line-height:1.55;
      text-align:center;
    }
    .login-form{ display:flex; flex-direction:column; gap:var(--space-sm); }
    .login-form label{ display:flex; flex-direction:column; gap:6px; font-size:13px; font-weight:600; color:var(--muted); }
    .login-actions{ margin-top:var(--space-sm); display:flex; flex-direction:column; gap:var(--space-sm); }
    .login-actions .btn.primary{
      font-size:1.05rem;
      font-weight:700;
      padding:14px 18px;
      letter-spacing:.5px;
      box-shadow:0 18px 38px rgba(0,58,95,0.32);
      transition:transform .18s ease, box-shadow .2s ease;
    }
    .login-actions .btn.primary:hover{
      transform:translateY(-1px);
      box-shadow:0 22px 45px rgba(0,58,95,0.36);
    }
    .login-actions .btn.primary:focus-visible{
      outline:none;
      box-shadow:var(--ring), 0 22px 45px rgba(0,58,95,0.38);
    }
    .login-message{ margin:0; font-size:13px; text-align:center; min-height:1.2em; }
    .login-error{ color:var(--bad); }
    .login-success{ color:var(--ok); }
    .login-info{ color:var(--info); }
    .login-hint{ margin:0; font-size:12px; text-align:center; color:var(--muted); }
    .login-hint .link-button{
      background:none;
      border:none;
      color:var(--accent);
      font:inherit;
      font-weight:600;
      padding:0;
      cursor:pointer;
      text-decoration:underline;
    }
    .login-hint .link-button:hover,
    .login-hint .link-button:focus-visible{
      color:var(--text);
      outline:none;
      text-decoration:none;
    }
    .login-meta{ margin-top:calc(var(--space) * 1.25); padding-top:var(--space-sm); border-top:1px solid rgba(255,255,255,0.12); display:flex; flex-direction:column; gap:4px; font-size:12px; text-align:center; color:var(--muted); letter-spacing:.35px; }
    .login-meta__version{ font-weight:700; color:var(--accent); }
    .login-meta__rights{ font-weight:600; font-size:11px; letter-spacing:.35px; }
    .login-meta__rights sup,
    .nav-footer__rights sup,
    .site-footer__rights sup{
      font-size:.65em;
      line-height:1;
      margin-left:1px;
    }
    html[data-theme="light"] .login-meta{ border-color:rgba(15,23,42,0.12); color:#475569; }
    html[data-theme="light"] .login-meta__rights{ color:#475569; }
    /* Layout */
    .app {
      --sidebar-width: 280px;
      display:grid;
      grid-template-columns: var(--sidebar-width) minmax(0, 1fr);
      min-height: 100dvh;
      position:relative;
    }
    .sidebar { position: sticky; top:0; align-self:start; height:100dvh; padding:calc(var(--space) + 12px) var(--space) var(--space); background: var(--card); border-right:1px solid rgba(255,255,255,.12); box-shadow: 6px 0 24px rgba(2,10,28,0.32); display:flex; flex-direction:column; }
    html[data-theme="light"] .sidebar{ background:#ffffff; border-color:rgba(15,23,42,0.08); box-shadow: 8px 0 30px rgba(15,23,42,0.08); }
    .brand { display:flex; align-items:center; gap:var(--space-sm); margin:6px 6px var(--space); padding:8px 12px; border-radius:16px; background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08); box-shadow: inset 0 1px 0 rgba(255,255,255,0.06); }
    .brand-logo{ width:44px; height:44px; border-radius:14px; background:rgba(4,12,30,0.65); padding:6px; object-fit:cover; box-shadow: var(--shadow); display:block; }
    .brand-logo--avatar{ background:none; border:none; padding:0; }
    html[data-theme="light"] .brand{ background:rgba(15,23,42,0.06); border-color:rgba(15,23,42,0.08); box-shadow:none; }
    html[data-theme="light"] .brand-logo{ background:#fff; border:1px solid rgba(15,23,42,0.08); box-shadow:0 12px 26px rgba(15,23,42,0.16); }
    html[data-theme="light"] .brand-logo--avatar{ border:none; box-shadow:0 12px 26px rgba(15,23,42,0.16); }
    .brand-name{ font-size:1.1rem; font-weight:800; letter-spacing:.42px; color:var(--text); text-transform:none; }
    .app.collapsed .brand{ justify-content:center; padding:0; background:transparent; border:none; box-shadow:none; margin:6px auto var(--space); }
    .nav { display:flex; flex-direction:column; gap:var(--space-sm); margin-top:var(--space-sm); flex:1; }
    .nav-header{ display:flex; align-items:center; gap:var(--space-sm); margin-bottom:var(--space-sm); }
    .menu-toggle{ display:flex; align-items:center; justify-content:center; padding:4px; border-radius:999px; border:none; background:none; color:inherit; cursor:pointer; transition:transform .2s ease; }
    .menu-toggle:focus-visible{ outline:2px solid var(--accent); outline-offset:2px; }
    .menu-toggle__icon{ width:46px; height:46px; border-radius:50%; box-shadow: var(--shadow); background: var(--card); border:1px solid rgba(255,255,255,.12); display:flex; align-items:center; justify-content:center; overflow:hidden; transition: border-color .2s ease, box-shadow .2s ease, transform .2s ease; }
    .menu-toggle:hover .menu-toggle__icon{ border-color: var(--accent); transform:translateY(-1px); }
    html[data-theme="light"] .menu-toggle__icon{ background:#fff; border-color:rgba(15,23,42,0.08); box-shadow: 0 10px 24px rgba(15,23,42,0.08); }
    .menu-toggle__bars{ display:flex; flex-direction:column; gap:6px; width:18px; }
    .menu-toggle__bars span{ display:block; width:100%; height:2px; border-radius:999px; background: var(--accent); }
    .menu-toggle[aria-expanded="true"] .menu-toggle__bars,
    .app:not(.collapsed) .menu-toggle__bars,
    .app.show-sidebar .menu-toggle__bars{ display:none; }
    .menu-trigger[aria-expanded="true"] .bi-list{ display:none; }
    .menu-toggle__icon img{ width:100%; height:100%; object-fit:cover; display:none; }
    .menu-toggle.has-avatar .menu-toggle__bars{ display:none; }
    .menu-toggle.has-avatar .menu-toggle__icon img{ display:block; }
    .nav-header .menu-toggle{ display:none; }
    .nav-user{ display:inline-flex; align-items:center; justify-content:flex-start; gap:8px; padding:8px 12px; border-radius:12px; font-weight:700; font-size:15px; letter-spacing:.4px; color:var(--text); background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.12); box-shadow: inset 0 1px 0 rgba(255,255,255,0.06); }
    html[data-theme="light"] .nav-user{ background:rgba(15,23,42,0.06); border-color:rgba(15,23,42,0.12); }
    .sidebar-close{ position:absolute; top:12px; right:12px; border:none; background:none; color:var(--muted); font-size:18px; line-height:1; padding:4px; cursor:pointer; transition:color .2s ease; z-index:5; }
    .sidebar-close:hover{ color:var(--text); }
    .sidebar-close:focus-visible{ outline:2px solid var(--accent); outline-offset:2px; border-radius:6px; }
    .nav-divider{ height:1px; background:rgba(255,255,255,0.12); margin:0; }
    html[data-theme="light"] .nav-divider{ background:rgba(15,23,42,0.1); }
    .nav-group { display:flex; flex-direction:column; gap:var(--space-sm); }
    .nav-footer { margin-top:auto; padding-top:var(--space); border-top:1px solid rgba(255,255,255,.08); display:flex; flex-direction:column; gap:var(--space-sm); }
    .nav-footer__meta{ margin-top:var(--space-sm); padding-top:var(--space-xs); border-top:1px solid rgba(255,255,255,0.08); display:flex; flex-direction:column; gap:4px; font-size:12px; color:var(--muted); letter-spacing:.3px; }
    .nav-footer__version{ font-weight:700; color:var(--accent); }
    .nav-footer__rights{ font-weight:600; font-size:11px; letter-spacing:.35px; }
    .nav a,
    .nav button:not(.menu-toggle) { display:flex; align-items:center; gap:var(--space-sm); padding:10px var(--space-sm); border-radius:12px; color:var(--text); text-decoration:none; opacity:.9; border:1px solid transparent; }
    .nav button.nav-link.is-busy{ opacity:.75; }
    .nav button.nav-link:disabled{ cursor:wait; }
    .nav-link__spinner{
      width:16px;
      height:16px;
      border-radius:50%;
      border:2px solid currentColor;
      border-top-color: transparent;
      animation: spin .8s linear infinite;
      margin-left:auto;
    }
    .nav button:not(.menu-toggle) { background:none; cursor:pointer; font:inherit; text-align:left; width:100%; }
    .nav a:hover,
    .nav button:not(.menu-toggle):hover { background: var(--card-2); border-color: rgba(255,255,255,.08) }
    .nav a.active,
    .nav button:not(.menu-toggle).active { background: linear-gradient(180deg, rgba(0,58,95,.16), rgba(0,58,95,.06)); border-color: rgba(0,58,95,.35) }
    .app.collapsed .nav-header{ align-items:center; justify-content:center; padding-right:0; }
    .app.collapsed .nav-user{ display:none !important; }
    .app.collapsed .sidebar-close{ display:none; }
    .app.collapsed .nav-divider{ margin:var(--space-sm) auto; width:40px; }
    .brand--interactive{ cursor:pointer; }
    .brand--interactive:focus-visible{ outline:2px solid var(--accent); outline-offset:4px; border-radius:16px; }
    .spacer { height:10px }
    .badge { padding:2px 8px; border-radius:999px; font-size:12px; background:rgba(0,58,95,.15); color:var(--accent); }

    .main { display:flex; flex-direction:column; min-width:0 }
    .site-footer{ margin-top:auto; padding:calc(var(--space) * 1.5) var(--space) calc(var(--space) * 2.25); border-top:1px solid rgba(255,255,255,0.08); color:var(--muted); font-size:12px; letter-spacing:.3px; }
    .site-footer__inner{ max-width:1200px; margin:0 auto; width:100%; display:flex; flex-wrap:wrap; align-items:center; justify-content:space-between; gap:var(--space-sm); }
    .site-footer__version{ font-weight:700; color:var(--accent); }
    .site-footer__rights{ font-weight:600; font-size:11px; letter-spacing:.35px; }
    html[data-theme="light"] .site-footer{ border-color:rgba(15,23,42,0.08); color:#475569; }
    html[data-theme="light"] .site-footer__rights{ color:#475569; }
    .view-section{
      opacity:0;
      transform:translate3d(0,18px,0);
      transition: opacity .32s ease, transform .32s ease;
      will-change: opacity, transform;
    }
    .view-section.is-visible{
      opacity:1;
      transform:translate3d(0,0,0);
      animation: fadeUp .32s ease;
    }
    .view-section.is-exiting{
      opacity:0;
      transform:translate3d(0,12px,0);
    }
    header.topbar { position: sticky; top:0; z-index:10; backdrop-filter: blur(10px); background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,0)); border-bottom:1px solid rgba(255,255,255,.06); }
    .topbar-inner { display:flex; align-items:center; gap:var(--space-sm); padding:var(--space) }
    .menu-btn {
      display:none;
      border:none;
      background: var(--card);
      color: var(--text);
      padding:8px;
      border-radius:12px;
      box-shadow: var(--shadow);
      cursor:pointer;
      line-height:0;
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .menu-btn:hover { box-shadow: var(--ring), var(--shadow); }
    .menu-btn:active { transform: translateY(1px); }
    .menu-btn:focus-visible { outline:none; box-shadow: var(--ring), var(--shadow); }
    .mobile-topbar{ display:none; align-items:center; gap:var(--space-sm); padding:var(--space-sm) var(--space); position:sticky; top:0; z-index:70; backdrop-filter: blur(10px); background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0)); border-bottom:1px solid rgba(255,255,255,.06); }
    html[data-theme="light"] .mobile-topbar{ background: linear-gradient(180deg, rgba(248,252,255,0.88), rgba(248,252,255,0.6)); border-bottom:1px solid rgba(15,23,42,0.08); }
    .mobile-topbar__label{ font-weight:700; letter-spacing:.35px; text-transform:none; color:var(--muted); font-size:13px; }
    .search { position:relative; flex:1 1 220px; min-width:0 }
    .search input { width:100%; padding:10px 36px; border-radius:999px; border:1px solid rgba(255,255,255,.12); background: var(--card); color: var(--text); box-shadow: var(--shadow); outline:none }
    .search input:focus { box-shadow: var(--ring), var(--shadow) }
    .search .icon { position:absolute; left:12px; top:50%; transform:translateY(-50%); opacity:.6 }

    .actions { display:flex; align-items:center; gap:10px; flex:0 0 auto }
    .btn { display:inline-flex; align-items:center; gap:var(--space-sm); border:1px solid var(--accent-2); background: var(--card); color:var(--text); padding:10px 12px; border-radius:12px; cursor:pointer; box-shadow:0 2px 4px rgba(0,0,0,.2); transition:transform .1s ease, box-shadow .1s ease }
    .btn.micro{ padding:6px 10px; font-size:12px; border-radius:10px; box-shadow:0 1px 2px rgba(0,0,0,0.18); }
    .btn.micro i{ font-size:13px; }
    .btn:hover { border-color: var(--accent) }
    .btn:active { transform:translateY(1px); box-shadow:0 1px 2px rgba(0,0,0,.2) }
    .btn.primary { background: linear-gradient(135deg, var(--accent), var(--color-primary)); border-color: transparent; color:#fff; box-shadow: var(--shadow) }
    .btn.outline { background:#fff; color:#0b1220; border-color: var(--accent); box-shadow:0 2px 6px rgba(15,23,42,0.12); }
    html[data-theme="light"] .btn.outline { background:#fff; }
    .btn.outline:hover { border-color: var(--accent); box-shadow: var(--ring), 0 3px 10px rgba(15,23,42,0.2); color:#0b1220; }
    .btn.outline:focus-visible { outline:none; box-shadow: var(--ring), 0 3px 10px rgba(15,23,42,0.2); color:#0b1220; }
    .btn.outline:disabled { opacity:.6; color: rgba(15,23,42,0.65); border-color: rgba(0,58,95,0.35); box-shadow:none; }
    .btn.danger { background: linear-gradient(135deg, #dc2626, #b91c1c); border-color: transparent; color:#fff; box-shadow: var(--shadow); }
    .btn.danger:hover { filter: brightness(1.05); }
    .btn.danger:active { transform:translateY(1px); box-shadow:0 1px 2px rgba(0,0,0,.2); }
    select { padding:8px 10px; border:1px solid var(--accent-2); border-radius:var(--radius); background:var(--card); color:var(--text); box-shadow:inset 0 2px 4px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.12); transition:border-color .2s ease, box-shadow .2s ease, background .2s ease }
    select:focus { outline:none; border-color: var(--accent); box-shadow: var(--ring) }
    input[type="text"],
    input[type="email"],
    input[type="password"],
    input[type="tel"],
    textarea{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.12);
      background: var(--card-2);
      color: var(--text);
      box-shadow: inset 0 1px 1px rgba(2,12,29,0.24);
      font: 500 14px/1.4 var(--font);
      transition: border-color .2s ease, box-shadow .2s ease, background .2s ease;
    }
    input[type="text"]:focus,
    input[type="email"]:focus,
    input[type="password"]:focus,
    input[type="tel"]:focus,
    textarea:focus{
      outline:none;
      border-color: var(--accent);
      box-shadow: var(--ring);
      background: var(--card);
    }
    textarea{ min-height:96px; resize:vertical; }
    html[data-theme="light"] input[type="text"],
    html[data-theme="light"] input[type="email"],
    html[data-theme="light"] input[type="password"],
    html[data-theme="light"] input[type="tel"],
    html[data-theme="light"] textarea{
      border-color: rgba(15,23,42,0.12);
      background:#fff;
      box-shadow: inset 0 1px 1px rgba(15,23,42,0.12);
      color:#0f172a;
    }
    html[data-theme="light"] input[type="text"]:focus,
    html[data-theme="light"] input[type="email"]:focus,
    html[data-theme="light"] input[type="password"]:focus,
    html[data-theme="light"] input[type="tel"]:focus,
    html[data-theme="light"] textarea:focus{
      background:#fff;
    }
    .panel-filters{ flex-wrap:wrap; align-items:stretch; gap:var(--space-sm); }
    .panel-filters select{ min-width:160px; padding:10px 12px; }
    .panel-section{ display:flex; flex-direction:column; gap:var(--space-sm); padding:var(--space) 0; border-top:1px solid rgba(255,255,255,.08); }
    .panel-section:first-of-type{ border-top:none; padding-top:0; }
    .panel-section h3{ margin:0; font-size:15px; font-weight:700; letter-spacing:.3px; text-transform:uppercase; color:var(--muted); display:flex; align-items:center; gap:var(--space-sm); }
    .panel-section p{ margin:2px 0 0; color:var(--muted); font-size:14px; }
    html[data-theme="light"] .panel-section{ border-color: rgba(15,23,42,0.08); }
    .panel-status{
      margin:6px 0 0;
      padding:12px;
      border-radius:12px;
      background:rgba(255,255,255,0.05);
      color:var(--muted);
      font-size:13px;
      line-height:1.45;
      transition:background .32s ease, color .32s ease;
    }
    html[data-theme="light"] .panel-status{
      background:rgba(15,23,42,0.08);
      color:#334155;
    }
    .panel-actions{ flex-wrap:wrap; justify-content:flex-start; }
    .panel-preview{ margin-top:var(--space-sm); }
    .panel-filters .date-filter{ display:flex; flex-direction:column; justify-content:center; gap:6px; padding:8px 12px; border-radius:var(--radius); background:var(--card-2); border:1px solid rgba(255,255,255,.12); min-width:170px; box-shadow: inset 0 1px 0 rgba(255,255,255,0.05), 0 4px 10px rgba(2,12,29,0.22); color: var(--muted); font-size:12px; letter-spacing:.4px; text-transform:uppercase; font-weight:600; }
    html[data-theme="light"] .panel-filters .date-filter{ border-color: rgba(15,23,42,0.12); box-shadow: inset 0 1px 0 rgba(255,255,255,0.7), 0 6px 16px rgba(15,23,42,0.12); }
    .panel-filters .date-filter input[type="date"]{ border:none; background:transparent; color: var(--text); font: 600 14px/1.2 var(--font); padding:0; margin:0; min-width:0; }
    .panel-filters .date-filter input[type="date"]:focus{ outline:none; }
    .panel-filters .date-filter:focus-within{ border-color: var(--accent); color: var(--accent); box-shadow: var(--ring), 0 4px 12px rgba(0,58,95,0.25); }
    .panel-filters .date-filter input[type="date"]::-webkit-calendar-picker-indicator{ filter: invert(0.8); opacity:0.8; cursor:pointer; transition: opacity .2s ease; }
    html[data-theme="light"] .panel-filters .date-filter input[type="date"]::-webkit-calendar-picker-indicator{ filter:none; opacity:0.7; }
    .panel-filters .date-filter input[type="date"]::-webkit-calendar-picker-indicator:hover{ opacity:1; }
    .file-input{ width:100%; min-width:220px; padding:12px 14px; border-radius:var(--radius); border:1px dashed rgba(148,163,184,0.35); background:var(--card-2); color:var(--muted); font:600 14px/1 var(--font); cursor:pointer; transition:border-color .2s ease, color .2s ease, box-shadow .2s ease, background .2s ease; }
    html[data-theme="light"] .file-input{ border-color:rgba(148,163,184,0.5); background:#fff; }
    .file-input:hover{ border-color:var(--accent); color:var(--accent); box-shadow:var(--ring), 0 4px 12px rgba(0,58,95,0.25); background:linear-gradient(180deg, rgba(0,58,95,0.08), rgba(0,58,95,0.02)); }
    .file-input:focus{ outline:none; border-color:var(--accent); color:var(--accent); box-shadow:var(--ring), 0 4px 12px rgba(0,58,95,0.25); }
    .file-input::file-selector-button,
    .file-input::-webkit-file-upload-button{ margin-right:12px; padding:10px 16px; border-radius:10px; border:1px solid rgba(255,255,255,0.35); background:linear-gradient(135deg, var(--accent), rgba(0,58,95,0.9)); color:#fff; font:600 14px/1 var(--font); cursor:pointer; transition:filter .2s ease; }
    html[data-theme="light"] .file-input::file-selector-button,
    html[data-theme="light"] .file-input::-webkit-file-upload-button{ border-color:rgba(15,23,42,0.12); }
    .file-input::file-selector-button:hover,
    .file-input::-webkit-file-upload-button:hover{ filter:brightness(1.05); }
    .cmd-panel { margin-top:16px; background: linear-gradient(160deg, rgba(8,13,25,0.92), rgba(3,7,18,0.96)); border-radius:14px; border:1px solid rgba(96,165,250,0.18); box-shadow: inset 0 0 0 1px rgba(255,255,255,0.04), 0 16px 40px rgba(3,10,25,0.55); padding:14px 18px; max-height:320px; overflow:auto; font-family:"JetBrains Mono", "Fira Code", "SFMono-Regular", Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .cmd-panel ul { list-style:none; margin:0; padding:0; }
    .cmd-panel li { display:flex; align-items:flex-start; gap:10px; margin:0; padding:3px 0; color:#94a3b8; white-space:pre-wrap; word-break:break-word; }
    .cmd-panel li::before { content:'>'; color:rgba(148,163,184,0.7); }
    .cmd-panel ul ul { margin-left:18px; padding-left:12px; border-left:1px solid rgba(148,163,184,0.25); }
    .cmd-panel ul ul li::before { content:'↳'; color:rgba(148,163,184,0.5); }
    .dup-grid { display:grid; gap:var(--space); margin-top:var(--space-sm); grid-template-columns:repeat(auto-fit, minmax(260px,1fr)); }
    .dup-card { background: var(--card-2); border:1px solid rgba(255,255,255,0.08); border-radius: var(--radius); padding:16px; display:flex; flex-direction:column; gap:12px; box-shadow: inset 0 1px 0 rgba(255,255,255,0.04); }
    .dup-card header { display:flex; flex-direction:column; gap:6px; }
    .dup-card h3 { margin:0; font-size:16px; }
    .dup-card .dup-counts { display:flex; flex-wrap:wrap; gap:8px; font-size:12px; }
    .dup-card .dup-counts span { padding:2px 8px; border-radius:999px; background: rgba(245,158,11,0.15); border:1px solid rgba(245,158,11,0.35); color:#f59e0b; font-weight:600; letter-spacing:.3px; }
    html[data-theme="light"] .dup-card .dup-counts span { background: rgba(245,158,11,0.18); border-color: rgba(245,158,11,0.45); }
    .dup-card .dup-sample { font-size:13px; color: var(--muted); display:flex; flex-direction:column; gap:8px; }
    .dup-card .dup-sample strong { color: var(--text); display:block; margin-bottom:2px; }
    .dup-card ul { margin:0; padding-left:18px; }
    .dup-card button { margin-top:auto; }
    #dupStatus { margin-top:6px; }

    /* Theme toggle */

    /* Filters */
    .view-controls {
      display:flex;
      align-items:center;
      flex-wrap:wrap;
      gap:var(--space-sm);
      width:100%;
    }
    .preferences-callout{
      display:flex;
      flex-direction:column;
      gap:var(--space-xs);
      padding:var(--space);
      border-radius:14px;
      border:1px dashed rgba(255,255,255,0.2);
      background: rgba(15,23,42,0.28);
      color:var(--muted);
      flex:1 1 280px;
      min-width:260px;
    }
    html[data-theme="light"] .preferences-callout{
      border-color: rgba(15,23,42,0.18);
      background: rgba(226,232,240,0.55);
      color:#1e293b;
    }
    .preferences-callout__heading{
      font-size:12px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:.5px;
      color:var(--accent);
    }
    .preferences-callout p{
      margin:0 0 var(--space-sm);
      font-size:13px;
      line-height:1.5;
      color:inherit;
    }
    .preferences-callout__action{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:0;
      border:none;
      background:none;
      color:var(--accent);
      font-weight:700;
      font-size:13px;
      cursor:pointer;
      text-decoration:underline;
      text-underline-offset:4px;
    }
    .preferences-callout__action:focus-visible{
      outline:none;
      text-decoration:none;
      box-shadow:0 0 0 3px rgba(0,58,95,0.35);
      border-radius:8px;
      padding:4px 8px;
      margin:-4px -8px;
    }
    .view-controls .filters {
      display:flex;
      align-items:center;
      flex-wrap:wrap;
      gap:var(--space-sm);
      flex:1 1 auto;
    }
    .view-controls .filters label {
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size:13px;
      font-weight:600;
      color: rgba(248,252,255,0.92);
      flex:1 1 160px;
      min-width:160px;
      padding:12px;
      background: rgba(var(--panel-base-rgb),0.18);
      border:1px solid rgba(var(--panel-base-rgb),0.35);
      border-radius:14px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.08), 0 12px 28px rgba(2,10,28,0.28);
      transition: border-color .2s ease, box-shadow .2s ease;
    }
    .view-controls .filters label:hover,
    .view-controls .filters label:focus-within {
      border-color: rgba(148,193,255,0.6);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.12), 0 16px 32px rgba(2,10,28,0.35);
    }
    .view-controls .filters label select {
      min-width:160px;
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid rgba(148,193,255,0.4);
      background: rgba(8,19,45,0.55);
      color:#f8fbff;
      box-shadow: inset 0 1px 2px rgba(15,23,42,0.65);
    }
    .view-controls .filters label select.is-multiple{
      min-height:140px;
      padding-right:8px;
      overflow:auto;
    }
    .view-controls .filters label select.is-multiple option{
      white-space:normal;
      line-height:1.35;
      padding:4px 6px;
    }
    .view-controls .filters label select:focus {
      outline:none;
      border-color: rgba(148,193,255,0.75);
      box-shadow: inset 0 1px 2px rgba(15,23,42,0.75), 0 0 0 3px rgba(var(--panel-base-rgb),0.35);
    }
    .view-controls .filters .page-size {
      margin-left:auto;
    }
    .chip { display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid rgba(255,255,255,.12); background: var(--card); border-radius:999px; cursor:pointer; user-select:none }
    .chip input { appearance:none; width:12px; height:12px; border-radius:3px; border:1px solid rgba(255,255,255,.25); display:inline-block; position:relative }
    .chip input:checked { background: var(--accent); border-color: var(--accent) }
    .daily-shortcuts{
      width:100%;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .daily-shortcuts__header{
      font-size:11px;
      font-weight:700;
      letter-spacing:.5px;
      text-transform:uppercase;
      color:rgba(248,252,255,0.78);
    }
    .daily-shortcuts__group{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    .daily-shortcuts__label{
      font-size:12px;
      font-weight:600;
      color:var(--muted);
    }
    .daily-shortcuts__btn{
      display:flex;
      align-items:center;
      gap:6px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(var(--panel-base-rgb),0.35);
      background:rgba(var(--panel-base-rgb),0.18);
      color:var(--text);
      font-weight:600;
      font-size:13px;
      cursor:pointer;
      transition: border-color .2s ease, background .2s ease, transform .2s ease;
    }
    .daily-shortcuts__btn span{ font-size:12px; font-weight:500; color:var(--muted); }
    .daily-shortcuts__btn:hover,
    .daily-shortcuts__btn:focus{
      outline:none;
      transform:translateY(-1px);
      border-color:rgba(148,193,255,0.65);
      background:rgba(var(--panel-base-rgb),0.28);
    }
    .daily-shortcuts__btn.is-active{
      border-color:rgba(34,197,94,0.55);
      background:rgba(34,197,94,0.2);
      color:var(--text);
    }
    .daily-shortcuts__btn.is-active span{ color:rgba(34,197,94,0.85); }
    .daily-shortcuts__empty{
      font-size:12px;
      color:var(--muted);
      font-style:italic;
    }
    html[data-theme="light"] .daily-shortcuts__header{ color:#334155; }
    html[data-theme="light"] .daily-shortcuts__btn{
      background:rgba(var(--panel-base-rgb),0.12);
      border-color:rgba(var(--panel-base-rgb),0.28);
      color:#0f172a;
    }
    html[data-theme="light"] .daily-shortcuts__btn span{ color:#475569; }
    html[data-theme="light"] .daily-shortcuts__btn.is-active{
      background:rgba(34,197,94,0.16);
      border-color:rgba(34,197,94,0.5);
      color:#065f46;
    }
    .contact-scripts{
      margin-top:12px;
      padding:var(--space-sm);
      border-radius:var(--radius);
      border:1px solid rgba(var(--panel-base-rgb),0.28);
      background:rgba(var(--panel-base-rgb),0.12);
      display:flex;
      flex-direction:column;
      gap:var(--space-sm);
    }
    .contact-scripts__header{
      font-size:14px;
      font-weight:700;
      color:var(--text);
      display:flex;
      align-items:center;
      gap:6px;
    }
    .contact-scripts__grid{
      display:grid;
      gap:var(--space-sm);
      grid-template-columns:repeat(auto-fit, minmax(220px,1fr));
    }
    .contact-script{
      background:var(--card);
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.08);
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.04);
    }
    .contact-script header{
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:700;
      color:var(--text);
    }
    .contact-script textarea{
      width:100%;
      min-height:96px;
      resize:vertical;
      border-radius:10px;
      border:1px solid rgba(var(--panel-base-rgb),0.3);
      background:var(--card-2);
      color:var(--text);
      padding:10px;
      font-family:var(--font);
      font-size:13px;
      line-height:1.5;
    }
    .contact-script textarea:focus{
      outline:none;
      border-color:rgba(var(--panel-base-rgb),0.55);
      box-shadow:var(--ring);
    }
    .contact-script__actions{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .contact-scripts__status{
      font-size:12px;
      color:var(--muted);
    }
    .contact-scripts__status.hidden{ display:none; }
    html[data-theme="light"] .contact-scripts{
      border-color:rgba(var(--panel-base-rgb),0.22);
      background:rgba(var(--panel-base-rgb),0.08);
    }
    html[data-theme="light"] .contact-script{
      border-color:rgba(148,163,184,0.28);
      box-shadow:none;
    }
    html[data-theme="light"] .contact-script textarea{
      background:#f8fafc;
      border-color:rgba(148,163,184,0.35);
      color:#0f172a;
    }
    .pill { padding:8px 12px; border:1px solid color-mix(in srgb, var(--panel-tone-bright) 36%, #1e293b 64%); border-radius:12px }
    .pill.priority-pill{
      font-size:12px;
      font-weight:700;
      letter-spacing:.3px;
    }
    .pill.priority-alta{
      background:rgba(34,197,94,0.2);
      border-color:rgba(34,197,94,0.45);
      color:var(--ok);
    }
    .pill.priority-media{
      background:rgba(234,179,8,0.18);
      border-color:rgba(234,179,8,0.45);
      color:var(--warn);
    }
    .pill.priority-baja{
      background:rgba(96,165,250,0.18);
      border-color:rgba(96,165,250,0.45);
      color:var(--info);
    }
    html[data-theme="light"] .contact-script header{ color:#0f172a; }
    html[data-theme="light"] .pill.priority-alta{ color:#15803d; }
    html[data-theme="light"] .pill.priority-media{ color:#b45309; }
    html[data-theme="light"] .pill.priority-baja{ color:#1d4ed8; }

    /* KPIs */
    .kpi-groups{ display:flex; flex-direction:column; gap:calc(var(--space) * 0.75); padding:0 var(--space) var(--space-sm); }
    .kpi-group{ background: color-mix(in srgb, var(--card) 82%, var(--panel-base-soft) 18%); border:1px solid color-mix(in srgb, var(--panel-base-color) 34%, transparent); border-radius: var(--radius); padding:var(--space); box-shadow: 0 18px 42px color-mix(in srgb, var(--panel-base-color) 18%, rgba(2,10,28,0.22)); }
    .kpi-group header{ display:flex; flex-direction:column; gap:4px; margin-bottom:var(--space-sm); }
    .kpi-group h4{ margin:0; font-size:1rem; letter-spacing:.4px; }
    .kpi-group p{ margin:0; color:var(--muted); font-size:13px; }
    .kpi-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:var(--space-sm); align-items:stretch; }
    .kpi-metric{ background: color-mix(in srgb, var(--card) 86%, var(--panel-base-soft) 14%); border:1px solid color-mix(in srgb, var(--panel-base-color) 38%, transparent); border-radius: var(--radius); padding:var(--space-sm); display:flex; flex-direction:column; gap:6px; min-height:120px; box-shadow: inset 0 1px 2px color-mix(in srgb, var(--panel-base-bright) 26%, transparent), 0 8px 16px color-mix(in srgb, var(--panel-base-color) 20%, rgba(2,10,28,0.28)); }
    .kpi-metric .metric-header{ display:flex; align-items:center; gap:var(--space-sm); }
    .kpi-metric .metric-icon{ width:40px; height:40px; border-radius:50%; display:grid; place-items:center; background: color-mix(in srgb, var(--panel-base-bright) 28%, transparent); color: var(--panel-stage-text); font-size:18px; box-shadow: inset 0 1px 2px color-mix(in srgb, var(--panel-base-bright) 18%, transparent); }
    .kpi-metric .metric-name{ font:600 11px var(--font); letter-spacing:.6px; text-transform:uppercase; color:color-mix(in srgb, var(--panel-base-bright) 54%, var(--muted) 46%); }
    .kpi-metric .metric-value{ font-size:26px; font-weight:800; letter-spacing:.2px; color:var(--text); }
    .kpi-metric .metric-extra{ font-size:12px; color:var(--muted); font-weight:600; }
    .kpi-metric .metric-desc{ margin-top:auto; font-size:12px; color:var(--muted); line-height:1.4; }
    .kpi-metric .metric-note{ margin-top:auto; font-size:12px; color:var(--muted); font-style:italic; line-height:1.4; }
    .kpi-metric ul{ margin:0; padding-left:18px; font-size:12px; color:var(--muted); line-height:1.4; }
    .kpi-metric ul li{ margin:2px 0; }
    .critical-summary{ display:flex; flex-direction:column; gap:var(--space-sm); }
    .critical-summary > p{ margin:0; color:var(--muted); font-size:13px; max-width:640px; }
    .critical-kpis{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    .critical-kpis .kpi-metric{ padding:var(--space); gap:var(--space-sm); background: color-mix(in srgb, var(--card) 78%, var(--panel-base-soft) 22%); border-color: color-mix(in srgb, var(--panel-base-color) 46%, transparent); box-shadow: inset 0 1px 2px color-mix(in srgb, var(--panel-base-bright) 26%, transparent), 0 16px 36px color-mix(in srgb, var(--panel-base-color) 24%, rgba(2,10,28,0.28)); }
    .critical-kpis .kpi-metric .metric-value{ font-size:32px; }
    html[data-theme="light"] .critical-kpis .kpi-metric{ background: color-mix(in srgb, var(--card) 88%, var(--panel-base-bright) 12%); border-color: color-mix(in srgb, var(--panel-base-color) 30%, transparent); box-shadow: inset 0 1px 2px color-mix(in srgb, var(--panel-base-bright) 32%, rgba(255,255,255,0.6)), 0 18px 38px color-mix(in srgb, var(--panel-base-color) 18%, rgba(15,23,42,0.08)); }
    .kpi-empty{ padding:var(--space); text-align:center; color:var(--muted); font-size:13px; }
    .card { background: var(--card); border:1px solid rgba(255,255,255,.08); border-radius: var(--radius); padding:14px; box-shadow: var(--shadow) }
    .spark { height:36px; margin-top:10px }

    /* View switcher */
    .seg { background: var(--card); border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:4px; display:flex; gap:4px }
    .seg button { border:1px solid var(--accent-2); background:var(--card); color: var(--text); padding:8px 12px; border-radius:8px; cursor:pointer; box-shadow:0 2px 4px rgba(0,0,0,.1); transition:transform .1s ease, box-shadow .1s ease }
    .seg button[aria-pressed="true"]{ background: linear-gradient(180deg, rgba(0,58,95,.15), rgba(0,58,95,.05)); border:1px solid var(--accent); box-shadow:var(--shadow) }
    .seg button:active{ transform:translateY(1px); box-shadow:0 1px 2px rgba(0,0,0,.1) }

    /* Pagination */
    .pagination{ display:flex; justify-content:center; gap:6px; padding:var(--space); }
    .pagination.is-hidden{ display:none; }
    .pagination button{ border:1px solid var(--accent-2); background:var(--card); color:var(--text); padding:6px 10px; border-radius:8px; cursor:pointer; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
    .pagination button.active{ background:var(--accent); color:#fff; }
    .pagination button:disabled{ opacity:.5; cursor:default; }

    /* Content views */
    .content { display:flex; flex-direction:column; gap:var(--space-sm); }
    .board {
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap:8px;
      padding:6px;
      background: var(--card);
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px;
      max-height: clamp(300px, 62vh, 420px);
      overflow-y:auto;
      overflow-x:hidden;
      width:min(100%, calc(100vw - var(--sidebar-width, 0px) - (var(--space) * 2)));
      max-width:100%;
      min-height:0;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.04);
    }
    html[data-board-density="compact"] .board{ grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }
    html[data-board-density="expanded"] .board{ grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
    .column { background: var(--card); border:1px solid rgba(255,255,255,.08); border-radius: 16px; min-height: 140px; display:flex; flex-direction:column }
    .column header { display:flex; align-items:center; justify-content:space-between; padding:6px 8px; border-bottom:1px dashed rgba(255,255,255,.08) }
    .column header .count { background: rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12); padding:2px 6px; border-radius:999px; font-size:12px }
    .column-toggle{ border:none; background:none; color:inherit; display:none; align-items:center; justify-content:center; padding:4px; border-radius:8px; cursor:pointer; }
    .column-toggle:focus-visible{ outline:none; box-shadow: var(--ring); }
    .column-toggle-icon{ transition: transform .2s ease; }
    .list { padding:6px; display:flex; flex-direction:column; gap:6px }
    .column-load-more{ margin:8px; padding:6px 10px; border-radius:10px; border:1px solid rgba(255,255,255,0.18); background:rgba(var(--panel-base-rgb),0.12); color:var(--text); font-weight:600; cursor:pointer; transition: background .2s ease; align-self:center; }
    .column-load-more:hover{ background:rgba(var(--panel-base-rgb),0.2); }
    html[data-theme="light"] .column-load-more{ border-color:rgba(15,23,42,0.16); background:rgba(37,99,235,0.12); }
    html[data-board-density="compact"] .list{ gap:4px; }
    html[data-board-density="expanded"] .list{ gap:10px; }
    .card-lead { background: var(--card-2); border:1px solid rgba(255,255,255,.1); border-radius:14px; padding:8px; cursor:pointer; transition: transform .12s ease, box-shadow .12s ease; box-shadow: 0 1px 4px rgba(0,0,0,.06) }
    html[data-board-density="compact"] .card-lead{ padding:6px; }
    html[data-board-density="expanded"] .card-lead{ padding:12px; }
    .card-lead:hover { transform: translateY(-2px) scale(1.01); border-color: rgba(0,58,95,.35); box-shadow: 0 4px 14px rgba(0,0,0,.12) }
    .card-lead[data-priority="alta"]{ box-shadow: 0 6px 18px rgba(34,197,94,0.25); border-color: rgba(34,197,94,0.55); }
    .card-lead[data-priority="media"]{ border-color: rgba(234,179,8,0.45); }
    .card-lead[data-priority="baja"]{ border-color: rgba(96,165,250,0.45); }
    .tag { padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid rgba(255,255,255,.15); color: var(--muted) }
    .tag.ok{ color: #065f46; background: rgba(16,185,129,.15); border-color: rgba(16,185,129,.25) }
    .tag.bad{ color: #7f1d1d; background: rgba(239,68,68,.15); border-color: rgba(239,68,68,.25) }

    /* Etapa colors */
    .column[data-step="Nuevo"] header{ background: var(--etapa-nuevo); color:#fff; }
    .column[data-step="Contactado"] header{ background: var(--etapa-contactado); color:#fff; }
    .column[data-step="No Contactado"] header{ background: var(--etapa-no-contactado); color:#fff; }
    .column[data-step="Inscrito"] header{ background: var(--etapa-inscrito); color:#fff; }
    .column[data-step="Descartado"] header{ background: var(--etapa-descartado); color:#fff; }
    .column[data-step] header .muted{ color: rgba(255,255,255,.75); }

    .panel[data-etapa]{
      background: linear-gradient(150deg, var(--panel-tone-strong), var(--panel-tone-soft));
      border-color: var(--panel-tone-strong);
      color: var(--panel-tone-text);
      box-shadow: 0 32px 72px rgba(5,12,28,0.52);
    }
    .panel[data-etapa="nuevo"]{
      --panel-tone-strong:#1d4f9c;
      --panel-tone-soft:#112f63;
      --panel-tone-bright:#3b7bea;
      --panel-tone-text:#f9fbff;
    }
    .panel[data-etapa="contactado"]{
      --panel-tone-strong:#156271;
      --panel-tone-soft:#0b3b45;
      --panel-tone-bright:#2e9fad;
      --panel-tone-text:#f4feff;
    }
    .panel[data-etapa="no-contactado"]{
      --panel-tone-strong:#b66a1e;
      --panel-tone-soft:#7a4711;
      --panel-tone-bright:#e88a2c;
      --panel-tone-text:#fff9f3;
    }
    .panel[data-etapa="inscrito"]{
      --panel-tone-strong:#1e7a52;
      --panel-tone-soft:#0f4a31;
      --panel-tone-bright:#32c381;
      --panel-tone-text:#f6fff9;
    }
    .panel[data-etapa="descartado"]{
      --panel-tone-strong:#a3323a;
      --panel-tone-soft:#681c23;
      --panel-tone-bright:#d3474f;
      --panel-tone-text:#fff5f5;
    }
    html[data-theme="light"] .panel[data-etapa]{
      box-shadow: 0 28px 58px rgba(15,23,42,0.16);
    }
    html[data-theme="light"] .panel[data-etapa="nuevo"]{
      --panel-tone-strong:#90b4ff;
      --panel-tone-soft:#e3ecff;
      --panel-tone-bright:#4f7dff;
      --panel-tone-text:#102041;
    }
    html[data-theme="light"] .panel[data-etapa="contactado"]{
      --panel-tone-strong:#71d0d4;
      --panel-tone-soft:#dcf7f8;
      --panel-tone-bright:#3aa9b0;
      --panel-tone-text:#0f2f33;
    }
    html[data-theme="light"] .panel[data-etapa="no-contactado"]{
      --panel-tone-strong:#f4c076;
      --panel-tone-soft:#fcebd1;
      --panel-tone-bright:#e39b37;
      --panel-tone-text:#3b1f05;
    }
    html[data-theme="light"] .panel[data-etapa="inscrito"]{
      --panel-tone-strong:#84dcb3;
      --panel-tone-soft:#e2f8ee;
      --panel-tone-bright:#3fb67c;
      --panel-tone-text:#0b3a22;
    }
    html[data-theme="light"] .panel[data-etapa="descartado"]{
      --panel-tone-strong:#f3a1a5;
      --panel-tone-soft:#fde5e7;
      --panel-tone-bright:#d24e55;
      --panel-tone-text:#4c1114;
    }

    .card-lead[data-step="Nuevo"]{ border-left:4px solid var(--etapa-nuevo); }
    .card-lead[data-step="Contactado"]{ border-left:4px solid var(--etapa-contactado); }
    .card-lead[data-step="No Contactado"]{ border-left:4px solid var(--etapa-no-contactado); }
    .card-lead[data-step="Inscrito"]{ border-left:4px solid var(--etapa-inscrito); }
    .card-lead[data-step="Descartado"]{ border-left:4px solid var(--etapa-descartado); }

    .table-wrap { background: var(--card); border:1px solid rgba(255,255,255,.08); border-radius: 16px; overflow:auto }
    table { width:100%; border-collapse: collapse; font-size:14px }
    thead th { position: sticky; top:0; background: linear-gradient(180deg, var(--card), var(--card-2)); text-align:left; padding:12px; border-bottom:1px solid rgba(255,255,255,.12); cursor:pointer }
    thead .filter-row th{ padding:8px 12px; border-bottom:1px solid rgba(255,255,255,.12); }
    .col-filter{ width:100%; padding:6px; border-radius:8px; border:1px solid rgba(255,255,255,.12); background:var(--card-2); color:var(--text); }
    tbody td { padding:12px; border-bottom: 1px dashed rgba(255,255,255,.08) }
    tbody tr:hover { background: rgba(0,58,95,.06) }
    .preview-box{ color: var(--text); font-size:14px; }
    .preview-box .table-wrap{ margin-top:8px; }
    .preview-summary{ color: var(--muted); font-size:13px; margin-bottom:6px; }
    /* Details panel */
    .panel {
      position: relative;
      --panel-tone-strong: var(--panel-base-strong);
      --panel-tone-soft: var(--panel-base-soft);
      --panel-tone-bright: var(--panel-base-bright);
      --panel-tone-text: var(--panel-stage-text);
      background: linear-gradient(145deg, var(--panel-tone-strong), color-mix(in srgb, var(--panel-tone-strong) 35%, #050b1b 65%));
      border:1px solid color-mix(in srgb, var(--panel-tone-strong) 45%, #050b1b 55%);
      border-radius:20px;
      padding:28px;
      min-height: 360px;
      width:min(620px, calc(100vw - 96px));
      max-height: min(88vh, 760px);
      overflow:auto;
      box-shadow: 0 28px 60px rgba(5,12,28,0.48);
      opacity:0;
      transform: translateY(18px) scale(0.95);
      transition: transform .28s ease, opacity .28s ease;
      font-family: 'Manrope', var(--font);
      letter-spacing:.18px;
      line-height:1.6;
    }
    .panel.show { opacity:1; transform: translateY(0) scale(1); }
    .panel-header { margin-bottom:20px; }
    .panel-title { margin:0; display:flex; align-items:flex-start; gap:14px; font-size:26px; line-height:1.05; }
    .panel-title span:first-child{ font-weight:800; font-size:1.04em; letter-spacing:.4px; flex:1 1 auto; min-width:0; }
    .panel[data-etapa] .panel-title span:first-child{ color:var(--panel-tone-text); text-shadow:none; }
    html[data-theme="light"] .panel{
      background: linear-gradient(145deg, color-mix(in srgb, var(--panel-tone-strong) 25%, #ffffff 75%), #ffffff);
      border-color: color-mix(in srgb, var(--panel-tone-strong) 30%, #dbe4f6 70%);
      box-shadow: 0 24px 52px rgba(15,23,42,0.12);
    }
    .stage-pill {
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:7px 16px;
      border-radius:999px;
      font-size:13px;
      font-weight:700;
      background: linear-gradient(135deg, var(--panel-tone-strong), var(--panel-tone-soft));
      border:1px solid var(--panel-tone-strong);
      color:var(--panel-tone-text);
      letter-spacing:.4px;
    }
    .stage-pill i{ font-size:16px; }
    .stage-pill.is-empty{ background: color-mix(in srgb, var(--panel-tone-bright) 25%, #1e293b 75%); border-color: color-mix(in srgb, var(--panel-tone-bright) 20%, #1f2937 80%); color: var(--muted); }
    .panel-quick{
      margin-top:24px;
      padding:24px;
      border-radius:18px;
      background: color-mix(in srgb, var(--panel-tone-soft) 65%, rgba(5,12,28,0.45) 35%);
      border:1px solid color-mix(in srgb, var(--panel-tone-strong) 55%, #050b1b 45%);
      display:flex;
      flex-direction:column;
      gap:18px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.08);
    }
    html[data-theme="light"] .panel-quick{
      background: color-mix(in srgb, #ffffff 80%, var(--panel-tone-soft) 20%);
      border-color: color-mix(in srgb, var(--panel-tone-strong) 25%, #e2e8f0 75%);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.75);
    }
    .panel-quick__header h4{
      margin:0;
      font-size:16px;
      font-weight:800;
      letter-spacing:.35px;
      color:var(--panel-tone-text);
    }
    .panel-quick__header p{
      margin:4px 0 0;
      color:color-mix(in srgb, var(--panel-tone-text) 70%, rgba(226,232,240,0.9) 30%);
      font-size:13px;
      line-height:1.4;
    }
    html[data-theme="light"] .panel-quick__header p{
      color:color-mix(in srgb, var(--panel-tone-strong) 40%, #1e293b 60%);
    }
    .panel-quick__grid{
      display:flex;
      flex-wrap:wrap;
      gap:16px;
    }
    .panel-quick__field{
      flex:1 1 200px;
      display:flex;
      flex-direction:column;
      gap:10px;
      font-size:12px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:.4px;
      color:var(--panel-tone-text);
    }
    .panel-quick__field select{
      border-radius:12px;
      border:1px solid color-mix(in srgb, var(--panel-tone-bright) 45%, var(--panel-tone-strong) 55%);
      padding:12px 14px;
      width:100%;
      min-width:0;
      background: var(--panel-tone-soft);
      color:var(--panel-tone-text);
      font:600 15px/1.25 'Manrope', var(--font);
      letter-spacing:.2px;
      text-transform:none;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.08);
    }
    .panel-quick__field select:focus{ outline:none; box-shadow:0 0 0 3px var(--panel-tone-bright); }
    .panel-quick__comment textarea{
      border-radius:12px;
      border:1px solid color-mix(in srgb, var(--panel-tone-bright) 45%, var(--panel-tone-strong) 55%);
      padding:12px 14px;
      background: var(--panel-tone-soft);
      color:var(--panel-tone-text);
      font:600 14px/1.4 'Manrope', var(--font);
      min-height:96px;
      resize:vertical;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.08);
    }
    .panel-quick__comment textarea:focus{ outline:none; box-shadow:0 0 0 3px var(--panel-tone-bright); }
    .panel-quick__feedback{
      border-radius:12px;
      border:1px solid color-mix(in srgb, var(--panel-tone-strong) 45%, rgba(2,6,23,0.55) 55%);
      background: color-mix(in srgb, var(--panel-tone-soft) 70%, rgba(15,23,42,0.6) 30%);
      padding:14px 16px;
      display:flex;
      flex-direction:column;
      gap:6px;
      color:var(--panel-tone-text);
    }
    .panel-quick__feedback strong{ font-size:14px; letter-spacing:.3px; }
    .panel-quick__feedback p{ margin:0; font-size:13px; line-height:1.45; }
    .panel-quick__feedback[data-tone="error"]{
      border-color:rgba(239,68,68,0.55);
      background: color-mix(in srgb, rgba(239,68,68,0.55) 58%, var(--panel-tone-soft) 42%);
      color:#fecaca;
    }
    html[data-theme="light"] .panel-quick__feedback{
      background: color-mix(in srgb, #ffffff 80%, var(--panel-tone-soft) 20%);
      border-color: color-mix(in srgb, rgba(148,163,184,0.45) 55%, var(--panel-tone-strong) 45%);
      color:#1e293b;
    }
    html[data-theme="light"] .panel-quick__feedback[data-tone="error"]{
      background: rgba(254,226,226,0.92);
      border-color: rgba(239,68,68,0.45);
      color:#b91c1c;
    }
    .panel-quick__actions{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .panel-quick__shortcuts{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }
    .panel-quick__shortcuts .btn{
      flex:1 1 140px;
      justify-content:center;
    }
    html[data-theme="light"] .stage-pill.is-empty{ background: color-mix(in srgb, #ffffff 60%, var(--panel-tone-bright) 40%); border-color: color-mix(in srgb, #e2e8f0 70%, var(--panel-tone-strong) 30%); }
    .kv { display:grid; grid-template-columns: 140px 1fr; gap:12px 18px; font-size:15px }
    .panel .kv-label {
      color:var(--panel-tone-text);
      font-size:12.5px;
      font-weight:700;
      letter-spacing:.45px;
      text-transform:uppercase;
      opacity:0.92;
    }
    .panel .actions { gap:10px; margin-top:14px }
    .pill { padding:8px 12px; border:1px solid color-mix(in srgb, var(--panel-tone-bright) 36%, #1e293b 64%); border-radius:12px }
    .id-pill{ font-weight:700; letter-spacing:.32px; background:var(--panel-tone-soft); border-color:var(--panel-tone-strong); color:var(--panel-tone-text); }

    .panel .contact-btn{
      background:var(--panel-tone-bright);
      color:var(--panel-tone-text);
      border:1px solid color-mix(in srgb, var(--panel-tone-strong) 60%, var(--panel-tone-bright) 40%);
      box-shadow: 0 16px 36px rgba(5,12,28,0.35);
      font-weight:600;
      letter-spacing:.24px;
    }
    .panel .contact-btn:hover{ box-shadow: 0 18px 40px rgba(5,12,28,0.4); }
    .panel .contact-btn:focus-visible{ box-shadow: 0 0 0 3px var(--panel-tone-bright), 0 18px 40px rgba(5,12,28,0.4); }
    .panel .contact-btn i{ font-size:18px; }
    .panel .contact-call i{ color:#ef4444; }
    .panel .contact-wa i{ color:#22c55e; }
    .panel .contact-mail i{ color:#2563eb; }
    html[data-theme="light"] .panel .contact-btn{
      border-color: color-mix(in srgb, var(--panel-tone-strong) 35%, #ffffff 65%);
      box-shadow: 0 12px 26px rgba(15,23,42,0.16);
      color: var(--panel-tone-text);
    }

    .panel-overlay { position: fixed; inset: 0; display:flex; justify-content:center; align-items:center; padding:40px; background: var(--bg-soft); opacity:0; pointer-events:none; transition: opacity .24s ease; z-index: 60; }
    .panel-overlay.open { opacity:1; pointer-events:auto; }
    .panel-close { position:absolute; top:12px; right:12px; border:none; background: none; color: var(--muted); cursor:pointer; font-size:18px; padding:4px; border-radius:8px; }
    .panel-close:hover, .panel-close:focus-visible { color: var(--text); outline:none; box-shadow: var(--ring); }
    .panel-close i { pointer-events:none; }
    .view-label { display:flex; align-items:center; gap:8px; background: var(--card); border:1px solid rgba(255,255,255,.12); padding:8px 12px; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,.08); font-weight:600; }

    @media (min-width: 1280px){
      .panel{
        padding:34px 36px;
        width:min(680px, calc(100vw - 140px));
      }
      .kv{ grid-template-columns: 160px 1fr; }
    }

    /* Drawer (mobile) */
    .drawer { position: fixed; inset: 0; background: var(--bg-soft); display:none; align-items: flex-end; z-index: 50 }
    .drawer.open { display:flex }
    .drawer .sheet { background: var(--card); width: 100%; max-height: 85vh; border-radius: 16px 16px 0 0; padding: 12px; overflow:auto }
    .drawer-summary{ margin:6px 0 0; color:var(--muted); font-size:13px; }
    .drawer-quick{ margin-top:18px; padding:18px; border-radius:16px; background:var(--card-2); border:1px solid rgba(255,255,255,0.12); display:flex; flex-direction:column; gap:14px; }
    html[data-theme="light"] .drawer-quick{ background:#f1f5f9; border-color:rgba(15,23,42,0.12); }
    .drawer-quick__hint{ margin:0; font-size:13px; color:var(--muted); }
    .drawer-quick__shortcuts{ display:flex; flex-wrap:wrap; gap:10px; }
    .drawer-quick__shortcuts .btn{ flex:1 1 140px; justify-content:center; }
    .drawer-quick__field{ display:flex; flex-direction:column; gap:8px; font-size:12px; font-weight:700; text-transform:uppercase; letter-spacing:.35px; color:var(--muted); }
    .drawer-quick__field select,
    .drawer-quick__field textarea{ border-radius:10px; border:1px solid rgba(148,163,184,0.35); padding:10px 12px; background:var(--card); color:var(--text); font:600 14px/1.35 'Manrope', var(--font); box-shadow: inset 0 1px 0 rgba(255,255,255,0.08); }
    .drawer-quick__field textarea{ min-height:96px; resize:vertical; }
    .drawer-quick__field select:focus,
    .drawer-quick__field textarea:focus{ outline:none; box-shadow:0 0 0 3px rgba(var(--panel-base-rgb),0.25); }
    .drawer-quick__feedback{
      border-radius:12px;
      border:1px solid rgba(239,68,68,0.45);
      background: rgba(239,68,68,0.18);
      padding:12px 14px;
      display:flex;
      flex-direction:column;
      gap:4px;
      color:#fecaca;
    }
    .drawer-quick__feedback strong{ font-size:13px; letter-spacing:.2px; }
    .drawer-quick__feedback p{ margin:0; font-size:12px; line-height:1.45; }
    html[data-theme="light"] .drawer-quick__feedback{
      background: rgba(254,226,226,0.92);
      color:#b91c1c;
    }
    .drawer-quick__actions{ display:flex; justify-content:flex-end; }

    /* Responsive */
    @media (max-width: 1200px){ .panel-overlay{ display:none } }
    @media (max-width: 900px){
      .app{
        --sidebar-width: 0px;
        display:block;
        min-height:100dvh;
      }
      .app.collapsed{
        --sidebar-width: 0px;
        display:block;
      }
      .main{ min-height:100dvh; }
      .sidebar{
        position:fixed;
        top:0;
        left:0;
        height:100dvh;
        width:min(260px, 82vw);
        max-width:320px;
        transform:translateX(-110%);
        transition: transform .24s ease, opacity .24s ease;
        z-index:80;
        box-shadow: var(--shadow);
        overflow-y:auto;
        opacity:0;
        pointer-events:none;
        visibility:hidden;
      }
      .app.show-sidebar .sidebar{
        transform:translateX(0);
        opacity:1;
        pointer-events:auto;
        visibility:visible;
      }
      .mobile-topbar{ display:flex; }
      .menu-toggle{ display:none; }
      .menu-btn{ display:inline-flex; }
      .topbar-inner{ padding:var(--space) var(--space-sm); }
      .brand-name{ display:block; }
      .nav a span{ display:inline; }
      .preferences-callout{ flex:1 1 100%; min-width:100%; }
      .panel-quick{ padding:18px; }
      .panel-quick__shortcuts .btn{ flex:1 1 100%; }
    }
    @media (min-width: 901px){ .sidebar-overlay{ display:none; } }
    @media (max-width: 880px){
      .critical-kpis{ grid-template-columns:1fr; }
    }
    @media (max-width: 700px){
      .kpi-grid{ grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); }
      .board{ grid-template-columns: repeat(3,minmax(180px,1fr)) }
      .view-controls{
        flex-direction:column;
        align-items:flex-start;
        gap:var(--space-sm);
      }
      .view-label{ width:100%; justify-content:flex-start; }
      .view-controls .filters{
        width:100%;
        display:flex;
        gap:var(--space-sm);
        flex-wrap:nowrap;
        align-items:flex-end;
      }
      .view-controls .filters label{
        width:100%;
        flex:1 1 0;
        min-width:0;
      }
      .view-controls .filters label select{
        width:100%;
        min-width:0;
      }
      .view-controls .filters .page-size{
        margin-left:0;
        flex:1 1 0;
      }
      .column.mobile-collapsible{ min-height:0; }
      .column.mobile-collapsible header{ padding:10px 12px; }
      .column.mobile-collapsible .column-toggle{ display:inline-flex; }
      .column.mobile-collapsible.collapsed .list{ display:none; }
      .column.mobile-collapsible.collapsed .column-toggle-icon{ transform:rotate(-90deg); }
      .column.mobile-collapsible.expanded .column-toggle-icon{ transform:rotate(0deg); }
      .site-footer__inner{ justify-content:center; text-align:center; gap:var(--space-xs); }
    }
    @media (max-width: 600px){
      .kpi-grid{ grid-template-columns:1fr; }
      .board{ grid-template-columns: repeat(2,minmax(180px,1fr)) }
      .view-controls .filters{ gap:8px; }
      .view-controls .filters label{ flex:1 1 0; }
      .view-controls .filters label select{ padding:6px 10px; font-size:13px; }
    }
    @media (max-width: 480px){
      .topbar-inner{
        flex-wrap:nowrap;
        gap:var(--space-sm);
      }
      .search input{ padding:8px 32px; font-size:14px; }
      .actions{ width:auto; }
      .actions .btn{ padding:8px 12px; }
      #themeBtn{ top:12px; right:12px }
      .view-controls .filters{ gap:6px; }
      .view-controls .filters label{ flex:1 1 0; font-size:12px; }
      .view-controls .filters label select{ padding:6px 8px; font-size:12px; }
    }
    @media (max-width: 400px){ .board{ grid-template-columns: repeat(1,minmax(180px,1fr)) } }

    /* Help view */
    .help-role{ display:flex; flex-direction:column; gap:var(--space-sm); padding:var(--space); border-radius:var(--radius); background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08); }
    html[data-theme="light"] .help-role{ background:rgba(15,23,42,0.04); border-color:rgba(15,23,42,0.08); }
    .help-role-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:var(--space-sm); }
    .help-role-grid h4{ margin:0; font-size:14px; font-weight:700; color:var(--text); }
    .help-role-grid ul{ margin:0; padding-left:18px; display:grid; gap:6px; list-style:disc; }
    .help-highlights{ margin:0; padding-left:18px; display:grid; gap:8px; line-height:1.55; color:var(--text); list-style:disc; }
    .help-role-table{ display:flex; flex-direction:column; gap:var(--space-sm); }
    .help-table{ width:100%; border-collapse:collapse; font-size:13px; }
    .help-table th, .help-table td{ border:1px solid rgba(255,255,255,0.12); padding:8px; text-align:left; }
    html[data-theme="light"] .help-table th,
    html[data-theme="light"] .help-table td{ border-color:rgba(15,23,42,0.16); }
    .help-table th{ font-weight:700; background:rgba(var(--panel-base-rgb),0.12); color:var(--text); }
    html[data-theme="light"] .help-table th{ background:rgba(15,23,42,0.08); }
    html[data-contrast="high"] .card,
    html[data-contrast="high"] .board,
    html[data-contrast="high"] .panel,
    html[data-contrast="high"] .help-role,
    html[data-contrast="high"] .profile-summary,
    html[data-contrast="high"] .security-status{ box-shadow:none; border-color:rgba(255,255,255,0.38); }
    html[data-theme="light"][data-contrast="high"] .card,
    html[data-theme="light"][data-contrast="high"] .board,
    html[data-theme="light"][data-contrast="high"] .panel,
    html[data-theme="light"][data-contrast="high"] .help-role,
    html[data-theme="light"][data-contrast="high"] .profile-summary,
    html[data-theme="light"][data-contrast="high"] .security-status{ border-color:rgba(15,23,42,0.32); }
    html[data-contrast="high"] .muted{ color:#f4f6ff; }
    html[data-theme="light"][data-contrast="high"] .muted{ color:#1f2937; }

    /* Utility */
    .muted{ color: var(--muted) }
    .row{ display:flex; align-items:center }
    .row.between{ justify-content:space-between }
    .row.gap4{ gap:4px } .row.gap6{ gap:6px } .row.gap8{ gap:8px } .row.gap10{ gap:10px } .row.gap12{ gap:12px }
    .w100{ width:100% }
    .hidden{ display:none !important }
    .small{ font-size:12px; line-height:1.5 }
    .settings-card{ display:flex; flex-direction:column; gap:var(--space); }
    .settings-profile{ display:flex; flex-wrap:wrap; gap:var(--space); align-items:flex-start; }
    .profile-avatar{ display:flex; flex-direction:column; gap:var(--space-sm); align-items:flex-start; }
    .avatar-frame{ width:var(--avatar-size); height:var(--avatar-size); border-radius:50%; border:2px dashed rgba(255,255,255,0.2); background:var(--card-2); color:var(--accent); display:flex; align-items:center; justify-content:center; font-size:32px; font-weight:700; text-transform:uppercase; position:relative; overflow:hidden; box-shadow: inset 0 2px 6px rgba(2,12,29,0.35); }
    .avatar-frame img{ width:100%; height:100%; object-fit:cover; display:none; }
    .avatar-frame.has-image{ border-style:solid; border-color:rgba(255,255,255,0.3); }
    .avatar-frame.has-image img{ display:block; }
    .avatar-frame.has-image span{ display:none; }
    .avatar-actions{ display:flex; flex-direction:column; gap:var(--space-sm); width:100%; }
    .avatar-actions .btn{ justify-content:center; }
    .profile-details{ flex:1 1 280px; display:flex; flex-direction:column; gap:var(--space-sm); }
    .form-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:var(--space-sm); }
    .form-grid label{ display:flex; flex-direction:column; gap:6px; font-size:13px; font-weight:600; letter-spacing:.2px; color:var(--muted); }
    .profile-summary{ display:grid; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); gap:var(--space-sm); padding:var(--space); border-radius:var(--radius); background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08); }
    html[data-theme="light"] .profile-summary{ background:rgba(15,23,42,0.04); border-color:rgba(15,23,42,0.08); }
    .profile-summary div{ display:flex; flex-direction:column; gap:4px; }
    .profile-sync-alert{ padding:10px 12px; border-radius:12px; border:1px solid rgba(148,163,184,0.35); background:rgba(148,163,184,0.12); display:flex; flex-direction:column; gap:6px; font-size:13px; color:var(--muted); }
    .profile-sync-alert strong{ font-weight:700; color:var(--text); }
    .profile-sync-alert[data-state="stale"]{ border-color:rgba(239,68,68,0.45); background:rgba(239,68,68,0.12); color:var(--bad); }
    .profile-sync-alert[data-state="stale"] strong{ color:var(--bad); }
    .profile-sync-alert[data-state="unknown"]{ border-color:rgba(245,158,11,0.45); background:rgba(245,158,11,0.12); color:var(--warn); }
    .profile-sync-alert button{ align-self:flex-start; }
    .summary-label{ font-size:12px; text-transform:uppercase; letter-spacing:.4px; color:var(--muted); }
    .summary-value{ font-size:14px; font-weight:600; color:var(--text); word-break:break-word; }
    .security-form{ gap:var(--space-sm); align-items:flex-end; }
    .security-actions{ flex-wrap:wrap; }
    .security-status{ grid-column:1 / -1; display:flex; flex-direction:column; gap:4px; padding:var(--space-sm); border-radius:var(--radius); background:rgba(var(--panel-base-rgb),0.12); border:1px solid rgba(var(--panel-base-rgb),0.35); transition:background .2s ease, border-color .2s ease; }
    .security-status[data-tone="success"]{ background:rgba(34,197,94,0.12); border-color:rgba(34,197,94,0.35); }
    .security-status[data-tone="warning"]{ background:rgba(245,158,11,0.12); border-color:rgba(245,158,11,0.35); }
    .security-status[data-tone="error"]{ background:rgba(239,68,68,0.12); border-color:rgba(239,68,68,0.35); }
    .security-status[data-tone="success"] .summary-value{ color:var(--ok); }
    .security-status[data-tone="warning"] .summary-value{ color:var(--warn); }
    .security-status[data-tone="error"] .summary-value{ color:var(--bad); }
    .security-status__header{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .security-timeline{ margin:4px 0 0; display:flex; flex-direction:column; gap:6px; font-size:12px; color:var(--muted); }
    .security-timeline__item{ display:flex; align-items:flex-start; gap:8px; }
    .security-timeline__badge{ width:10px; height:10px; border-radius:50%; margin-top:5px; background:rgba(var(--panel-base-rgb),0.4); flex:0 0 auto; }
    .security-timeline__item[data-state="done"] .security-timeline__badge{ background:var(--ok); }
    .security-timeline__item[data-state="active"] .security-timeline__badge{ background:var(--warn); box-shadow:0 0 0 3px rgba(245,158,11,0.25); }
    .security-timeline__item[data-state="future"] .security-timeline__badge{ background:rgba(148,163,184,0.4); }
    .security-timeline__content{ display:flex; flex-direction:column; gap:2px; }
    .security-timeline__label{ font-weight:600; color:var(--text); }
    .security-timeline__meta{ font-size:11px; color:var(--muted); }
    .security-status__actions{ display:flex; flex-wrap:wrap; gap:6px; margin-top:4px; }
    .settings-preferences{ display:grid; gap:var(--space); }
    .pref-presets{ padding:12px 14px; border-radius:12px; border:1px dashed rgba(var(--panel-base-rgb),0.35); background:rgba(var(--panel-base-rgb),0.08); display:flex; flex-direction:column; gap:8px; }
    .pref-presets[hidden]{ display:none; }
    .pref-presets__title{ margin:0; font-size:13px; font-weight:700; letter-spacing:.35px; text-transform:uppercase; color:var(--muted); }
    .pref-presets__list{ display:flex; flex-wrap:wrap; gap:10px; }
    .pref-preset-card{ padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,0.12); background:var(--card); display:flex; flex-direction:column; gap:6px; max-width:320px; }
    .pref-preset-card strong{ font-size:14px; color:var(--text); }
    .pref-preset-card p{ margin:0; font-size:12px; color:var(--muted); }
    .settings-group{ display:flex; flex-direction:column; gap:var(--space-sm); font-size:13px; font-weight:600; color:var(--muted); }
    .settings-group legend{ font-size:13px; text-transform:uppercase; letter-spacing:.4px; color:var(--muted); margin-bottom:var(--space-sm); }
    .settings-group select{ width:100%; font-weight:600; color:var(--text); }
    .settings-group.switch{ flex-direction:row; align-items:center; gap:var(--space-sm); font-size:14px; color:var(--text); }
    .settings-group.switch input{ position:relative; width:44px; height:24px; border-radius:999px; border:1px solid rgba(255,255,255,0.2); background:rgba(15,23,42,0.4); appearance:none; cursor:pointer; transition: background .2s ease, border-color .2s ease; }
    .settings-group.switch input::before{ content:""; position:absolute; top:2px; left:2px; width:18px; height:18px; border-radius:50%; background:#fff; box-shadow:0 2px 4px rgba(15,23,42,0.25); transform:translateX(0); transition: transform .2s ease; }
    .settings-group.switch input:checked{ background:var(--accent); border-color:transparent; }
    .settings-group.switch input:checked::before{ transform:translateX(20px); }
    html[data-theme="light"] .settings-group.switch input{ background:rgba(15,23,42,0.12); border-color:rgba(15,23,42,0.16); }
    .settings-group.switch span{ font-weight:600; }
    .segmented{ display:inline-flex; border-radius:12px; padding:4px; gap:4px; background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12); }
    html[data-theme="light"] .segmented{ background:rgba(15,23,42,0.06); border-color:rgba(15,23,42,0.12); }
    .segmented-option{ position:relative; border-radius:10px; overflow:hidden; }
    .segmented-option input{ position:absolute; inset:0; opacity:0; cursor:pointer; }
    .segmented-option span{ display:inline-flex; align-items:center; justify-content:center; padding:8px 16px; border-radius:10px; font-size:13px; font-weight:600; color:var(--text); transition: background .2s ease, color .2s ease, box-shadow .2s ease; min-width:80px; }
    .segmented-option input:checked + span{ background:linear-gradient(135deg, var(--accent), rgba(0,58,95,0.85)); color:#fff; box-shadow:0 10px 18px rgba(0,58,95,0.25); }
    .segmented-option input:focus-visible + span{ outline:2px solid var(--accent); outline-offset:2px; }
    .pref-actions{ flex-wrap:wrap; }
    .settings-summary{ padding:var(--space-sm) var(--space); border-radius:var(--radius); border:1px solid rgba(255,255,255,0.12); background:rgba(255,255,255,0.04); color:var(--muted); min-height:24px; transition: opacity .3s ease, background .3s ease, color .3s ease; }
    html[data-theme="light"] .settings-summary{ background:rgba(15,23,42,0.04); border-color:rgba(15,23,42,0.08); }
    .settings-summary.visible{ color:var(--text); }
    .settings-summary[data-state="success"]{ border-color:rgba(34,197,94,0.45); color:#22c55e; background:rgba(34,197,94,0.12); }
    .settings-summary[data-state="error"]{ border-color:rgba(239,68,68,0.45); color:#ef4444; background:rgba(239,68,68,0.12); }
    .settings-summary[data-state="warning"]{ border-color:rgba(245,158,11,0.45); color:#f59e0b; background:rgba(245,158,11,0.12); }
    .settings-summary.fade{ opacity:0.45; }
    .settings-preferences > *:not(.pref-actions){ max-width:420px; }
    .profile-avatar .muted{ max-width:240px; }
    .permissions-grid{ display:grid; grid-template-columns: minmax(220px, 320px) minmax(0,1fr); gap:var(--space); align-items:flex-start; }
    .permissions-panel{ display:flex; flex-direction:column; gap:var(--space-sm); padding:var(--space); background: var(--card-2); border:1px solid rgba(255,255,255,0.08); border-radius: var(--radius); box-shadow: inset 0 1px 0 rgba(255,255,255,0.04); }
    .permissions-status{ margin:0; }
    .permissions-status[data-tone="info"]{ color:var(--muted); }
    .permissions-status[data-tone="success"]{ color:var(--ok); }
    .permissions-status[data-tone="warning"]{ color:var(--warn); }
    .permissions-status[data-tone="error"]{ color:var(--bad); }
    .permissions-list{ display:flex; flex-direction:column; gap:6px; max-height:360px; overflow:auto; padding-right:4px; }
    .perm-user,
    .team-item{ border:1px solid rgba(255,255,255,0.12); background: var(--card); color: var(--text); border-radius:12px; padding:10px 12px; text-align:left; display:flex; flex-direction:column; gap:4px; cursor:pointer; transition:border-color .2s ease, box-shadow .2s ease, transform .12s ease; }
    .perm-user .perm-user__header,
    .team-item .team-item__header{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .perm-user__name,
    .team-item__name{ font-weight:600; font-size:14px; letter-spacing:.2px; }
    .perm-user__id,
    .team-item__id{ font-size:12px; color:var(--muted); }
    .perm-user__meta,
    .team-item__meta{ font-size:12px; color:var(--muted); display:flex; gap:8px; flex-wrap:wrap; }
    .perm-user__badge,
    .team-item__badge{ display:inline-flex; align-items:center; gap:4px; padding:2px 8px; border-radius:999px; font-weight:600; font-size:11px; background:rgba(var(--panel-base-rgb),0.15); border:1px solid rgba(var(--panel-base-rgb),0.35); color:var(--text); text-transform:uppercase; letter-spacing:.35px; }
    .perm-user__status,
    .team-item__status{ font-size:11px; font-weight:600; text-transform:uppercase; letter-spacing:.35px; }
    .team-item__description{ font-size:12px; color:var(--muted); }
    .perm-user[aria-selected="true"],
    .team-item[aria-selected="true"]{ border-color: var(--accent); box-shadow: var(--ring), var(--shadow); transform: translateY(-1px); }
    .perm-user.is-inactive,
    .team-item.is-inactive{ opacity:0.75; }
    .permissions-form{ display:flex; flex-direction:column; gap:var(--space-sm); padding:var(--space); background: var(--card-2); border:1px solid rgba(255,255,255,0.08); border-radius: var(--radius); box-shadow: inset 0 1px 0 rgba(255,255,255,0.04); }
    .perm-form-title{ margin:0; font-size:16px; }
    .permissions-form .form-grid{ gap:var(--space-sm); }
    .permissions-form label{ font-weight:600; }
    .permissions-form input[type="text"],
    .permissions-form input[type="email"],
    .permissions-form input[type="password"],
    .permissions-form select{ background:var(--card); }
    .permissions-form input[readonly]{ opacity:0.8; cursor:not-allowed; }
    .role-scope-suggestion{ margin-top:6px; padding:10px 12px; border-radius:12px; border:1px dashed rgba(255,255,255,0.18); background:rgba(255,255,255,0.04); display:flex; flex-direction:column; gap:8px; }
    .role-scope-suggestion[hidden]{ display:none; }
    .role-scope-suggestion__text{ margin:0; font-size:13px; color:var(--muted); line-height:1.45; }
    .role-scope-suggestion__chips{ display:flex; flex-wrap:wrap; gap:6px; }
    .role-scope-suggestion__chips .scope-chip{ display:inline-flex; align-items:center; gap:4px; padding:4px 10px; border-radius:999px; background:rgba(var(--panel-base-rgb),0.18); border:1px solid rgba(var(--panel-base-rgb),0.35); font-size:12px; font-weight:600; color:var(--text); letter-spacing:.2px; text-transform:uppercase; }
    .role-scope-suggestion__chips .scope-chip i{ font-size:12px; opacity:0.85; }
    html[data-theme="light"] .role-scope-suggestion{ background:rgba(15,23,42,0.04); border-color:rgba(15,23,42,0.16); }
    html[data-theme="light"] .role-scope-suggestion__chips .scope-chip{ background:rgba(var(--panel-base-rgb),0.12); color:#0f172a; }
    .multi-select[data-dirty="true"] .multi-select__button{ border-color:rgba(239,68,68,0.55); box-shadow:0 0 0 2px rgba(239,68,68,0.18); }
    .multi-select[data-dirty="true"]::after{ content:"Personalizado"; align-self:flex-start; font-size:10px; font-weight:700; letter-spacing:.4px; text-transform:uppercase; color:rgba(239,68,68,0.85); background:rgba(239,68,68,0.12); border:1px solid rgba(239,68,68,0.35); border-radius:999px; padding:2px 8px; margin-top:-4px; }
    .scope-template-toolbar{ display:flex; flex-wrap:wrap; gap:8px; margin-bottom:6px; }
    .scope-template-btn{ display:inline-flex; flex-direction:column; align-items:flex-start; gap:4px; padding:8px 12px; border-radius:12px; border:1px dashed rgba(var(--panel-base-rgb),0.35); background:rgba(var(--panel-base-rgb),0.1); color:var(--text); font-size:12px; font-weight:600; cursor:pointer; transition:border-color .2s ease, background .2s ease, transform .12s ease; }
    .scope-template-btn:hover{ border-color:var(--accent); background:rgba(var(--panel-base-rgb),0.18); transform:translateY(-1px); }
    .scope-template-btn span{ font-weight:500; opacity:0.8; }
    .field-with-hint{ display:flex; flex-direction:column; }
    .field-with-hint .field-hint{ display:block; margin-top:6px; font-size:12px; color:var(--muted); line-height:1.45; }
    .multi-select{ position:relative; display:flex; flex-direction:column; gap:6px; }
    .multi-select__button{ display:flex; align-items:center; justify-content:space-between; width:100%; border-radius:12px; border:1px solid rgba(255,255,255,0.14); background:var(--card); color:var(--text); padding:10px 14px; cursor:pointer; transition:border-color .2s ease, box-shadow .2s ease, background .2s ease; font:inherit; font-size:13px; }
    .multi-select__button:hover{ border-color:rgba(var(--panel-base-rgb),0.5); }
    .multi-select__button:focus-visible{ outline:none; box-shadow:var(--ring); border-color:var(--accent); }
    .multi-select__button i{ font-size:14px; opacity:0.7; }
    .multi-select__menu{ position:absolute; top:calc(100% + 6px); left:0; right:0; background:var(--card); border:1px solid rgba(255,255,255,0.12); border-radius:12px; box-shadow:0 24px 50px rgba(2,10,28,0.45); padding:6px 0; display:none; max-height:220px; overflow-y:auto; z-index:30; }
    .multi-select.is-open .multi-select__menu{ display:block; }
    .multi-select__menu::-webkit-scrollbar{ width:8px; }
    .multi-select__menu::-webkit-scrollbar-thumb{ background:rgba(var(--panel-base-rgb),0.35); border-radius:999px; }
    .multi-select__option{ display:flex; align-items:center; gap:10px; padding:10px 16px; cursor:pointer; font-size:13px; transition:background .18s ease; }
    .multi-select__option:hover{ background:rgba(var(--panel-base-rgb),0.12); }
    .multi-select__option input{ width:16px; height:16px; }
    .multi-select__chips{ display:flex; flex-wrap:wrap; gap:6px; min-height:28px; padding:2px 0 4px; }
    .multi-select__chip{ background:rgba(var(--panel-base-rgb),0.18); border:1px solid rgba(var(--panel-base-rgb),0.35); color:var(--text); padding:4px 12px; border-radius:999px; font-size:12px; font-weight:600; letter-spacing:.2px; }
    .multi-select__placeholder{ font-size:12px; color:var(--muted); }
    .multi-select.has-selection .multi-select__button{ border-color:rgba(var(--panel-base-rgb),0.45); box-shadow:0 18px 40px rgba(var(--panel-base-rgb),0.22); }
    .permissions-reference{ margin-top:var(--space); display:grid; gap:var(--space); grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); }
    .permissions-card{ background:var(--card-2); border:1px solid rgba(255,255,255,0.08); border-radius:var(--radius); box-shadow:inset 0 1px 0 rgba(255,255,255,0.04); padding:var(--space); display:flex; flex-direction:column; gap:var(--space-sm); }
    .permissions-card h4{ margin:0; font-size:16px; display:flex; align-items:center; gap:8px; }
    .permissions-card h4 i{ font-size:18px; }
    .permissions-card p{ margin:0; font-size:13px; color:var(--muted); }
    .permission-matrix{ width:100%; border-collapse:collapse; font-size:13px; }
    .permission-matrix thead th{ text-align:left; font-weight:700; padding:10px; border-bottom:1px solid rgba(255,255,255,0.12); }
    .permission-matrix tbody td{ padding:10px; border-bottom:1px solid rgba(255,255,255,0.08); vertical-align:top; }
    .permission-matrix tbody tr:last-child td{ border-bottom:none; }
    .permission-rules{ margin:0; padding-left:20px; display:flex; flex-direction:column; gap:8px; font-size:13px; color:var(--text); }
    .permission-rules li{ line-height:1.5; }
    .permission-scope-note{ font-size:12px; color:var(--muted); display:flex; flex-direction:column; gap:4px; }
    .permission-scope-values{ display:flex; flex-wrap:wrap; gap:6px; margin:6px 0 10px; }
    .permissions-switch{ display:flex; align-items:center; gap:10px; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.02); cursor:pointer; transition:border-color .2s ease, box-shadow .2s ease; }
    .permissions-switch input{ appearance:none; width:44px; height:24px; border-radius:999px; border:1px solid rgba(255,255,255,0.25); background:rgba(15,23,42,0.55); position:relative; cursor:pointer; transition: background .2s ease, border-color .2s ease; }
    .permissions-switch input::before{ content:""; position:absolute; top:2px; left:2px; width:18px; height:18px; border-radius:50%; background:#fff; box-shadow:0 2px 4px rgba(15,23,42,0.25); transform:translateX(0); transition: transform .2s ease; }
    .permissions-switch input:checked{ background:var(--accent); border-color:transparent; }
    .permissions-switch input:checked::before{ transform:translateX(20px); }
    .permissions-switch span{ font-size:13px; font-weight:600; color:var(--text); }
    .permissions-switch:focus-within{ border-color: var(--accent); box-shadow: var(--ring); }
    .permissions-meta{ min-height:18px; }
    html[data-theme="light"] .permissions-panel,
    html[data-theme="light"] .permissions-form{ border-color:rgba(15,23,42,0.08); box-shadow: inset 0 1px 0 rgba(255,255,255,0.6); }
    html[data-theme="light"] .perm-user,
    html[data-theme="light"] .team-item{ border-color:rgba(15,23,42,0.12); }
    html[data-theme="light"] .permissions-switch{ border-color:rgba(15,23,42,0.12); background:rgba(15,23,42,0.03); }
    html[data-theme="light"] .permissions-switch input{ background:rgba(15,23,42,0.12); border-color:rgba(15,23,42,0.2); }
    html[data-theme="light"] .permissions-form input[readonly]{ background:rgba(15,23,42,0.04); }
    html[data-theme="light"] .multi-select__button{ background:#fff; border-color:rgba(15,23,42,0.14); }
    html[data-theme="light"] .multi-select.has-selection .multi-select__button{ box-shadow:0 18px 40px rgba(var(--panel-base-rgb),0.22); }
    html[data-theme="light"] .multi-select__menu{ border-color:rgba(15,23,42,0.12); box-shadow:0 28px 60px rgba(15,23,42,0.18); }
    html[data-theme="light"] .multi-select__chip{ color:#0f172a; background:rgba(var(--panel-base-rgb),0.14); border-color:rgba(var(--panel-base-rgb),0.32); }
    html[data-theme="light"] .permissions-card{ background:#fff; }
    html[data-theme="light"] .permission-matrix thead th{ border-color:rgba(15,23,42,0.12); }
    html[data-theme="light"] .permission-matrix tbody td{ border-color:rgba(15,23,42,0.08); }
    @media (max-width: 900px){
      .permissions-grid{ grid-template-columns:1fr; }
    }
    html[data-density="compact"]{ --space:12px; --space-sm:6px; }
    html[data-density="compact"] .card{ padding:12px; }
    html[data-density="compact"] .panel-section{ padding:calc(var(--space-sm) + 4px) 0; }
    html[data-density="compact"] .form-grid{ gap:var(--space-xs); }
    html[data-density="compact"] .settings-summary{ padding:var(--space-xs) var(--space); }
    html[data-motion="reduced"] *,
    html[data-motion="reduced"] *::before,
    html[data-motion="reduced"] *::after{
      animation-duration:0.01ms !important;
      animation-iteration-count:1 !important;
      transition-duration:0.01ms !important;
      scroll-behavior:auto !important;
    }
    html[data-eco="true"] body{ background: var(--bg); }
    html[data-eco="true"] .card{ box-shadow:none; background: var(--card-2); border-color: rgba(255,255,255,0.08); }
    html[data-eco="true"][data-theme="light"] .card{ background:#fff; box-shadow:none; border-color:rgba(15,23,42,0.08); }
    html[data-eco="true"] .segmented{ background:rgba(255,255,255,0.04); }
    html[data-eco="true"][data-theme="light"] .segmented{ background:rgba(15,23,42,0.05); }
    html[data-font-scale="large"]{ --font-size-base: 16px; }
    html[data-font-scale="normal"]{ --font-size-base: 15px; }
    @media (max-width: 700px){
      .settings-profile{ flex-direction:column; }
      .avatar-actions{ flex-direction:row; }
      .avatar-actions .btn{ flex:1; }
    }
    @media (max-width: 480px){
      :root{ --avatar-size: 96px; }
      .profile-summary{ grid-template-columns:repeat(1,minmax(0,1fr)); }
    }
    @media (min-width: 901px){
      .app.collapsed{ --sidebar-width: 60px; grid-template-columns: var(--sidebar-width) minmax(0, 1fr); }
      .app.collapsed .sidebar{ padding:18px 8px; }
      .app.collapsed .brand-name,
      .app.collapsed .nav .nav-link span{ display:none; }
      .app.collapsed .nav a{ justify-content:center; }
    }
    .sidebar-overlay{
      position:fixed;
      inset:0;
      background: rgba(11,18,32,0.55);
      opacity:0;
      pointer-events:none;
      transition: opacity .24s ease;
      z-index:40;
    }
    .app.show-sidebar .sidebar-overlay{
      opacity:1;
      pointer-events:auto;
    }
  </style>
</head>
<body>
  <div class="login-screen" id="loginScreen" aria-hidden="false">
    <div class="landing-layout">
      <section class="landing-hero" aria-labelledby="heroTitle">
        <span class="hero-kicker"><i class="bi bi-stars" aria-hidden="true"></i> Plataforma de reactivación</span>
        <h1 id="heroTitle">Impulsa la retención con decisiones basadas en datos</h1>
        <p class="hero-subtitle">ReLead EDU centraliza seguimiento, priorización y comunicación para que cada plantel recupere leads dormidos en menos tiempo.</p>
        <div class="hero-cta">
          <a class="btn primary" href="mailto:hola@relead.edu?subject=Quiero%20una%20demo" data-cta="demo">Solicitar demo guiada</a>
          <a class="btn outline" href="mailto:ventas@relead.edu" data-cta="contacto">Contactar a ventas</a>
        </div>
        <div class="hero-metrics" aria-label="Resultados destacados">
          <div class="hero-metrics__viewport" role="list">
            <div class="hero-metrics__track">
              <article class="hero-metric" role="listitem">
                <span class="hero-metric__label">Leads reactivados</span>
                <span class="hero-metric__value">+62%</span>
                <span class="hero-metric__trend"><i class="bi bi-arrow-up-right"></i> Promedio 90 días</span>
              </article>
              <article class="hero-metric" role="listitem">
                <span class="hero-metric__label">Tiempo de respuesta</span>
                <span class="hero-metric__value">-38%</span>
                <span class="hero-metric__trend"><i class="bi bi-lightning-charge"></i> SLA de atención</span>
              </article>
              <article class="hero-metric" role="listitem">
                <span class="hero-metric__label">Productividad de asesores</span>
                <span class="hero-metric__value">x1.8</span>
                <span class="hero-metric__trend"><i class="bi bi-people"></i> Leads por jornada</span>
              </article>
              <article class="hero-metric" role="listitem">
                <span class="hero-metric__label">Integraciones activas</span>
                <span class="hero-metric__value">12</span>
                <span class="hero-metric__trend"><i class="bi bi-plug"></i> CRM y sistemas escolares</span>
              </article>
              <article class="hero-metric" role="listitem">
                <span class="hero-metric__label">Leads reactivados</span>
                <span class="hero-metric__value">+62%</span>
                <span class="hero-metric__trend"><i class="bi bi-arrow-up-right"></i> Promedio 90 días</span>
              </article>
              <article class="hero-metric" role="listitem">
                <span class="hero-metric__label">Tiempo de respuesta</span>
                <span class="hero-metric__value">-38%</span>
                <span class="hero-metric__trend"><i class="bi bi-lightning-charge"></i> SLA de atención</span>
              </article>
              <article class="hero-metric" role="listitem">
                <span class="hero-metric__label">Productividad de asesores</span>
                <span class="hero-metric__value">x1.8</span>
                <span class="hero-metric__trend"><i class="bi bi-people"></i> Leads por jornada</span>
              </article>
              <article class="hero-metric" role="listitem">
                <span class="hero-metric__label">Integraciones activas</span>
                <span class="hero-metric__value">12</span>
                <span class="hero-metric__trend"><i class="bi bi-plug"></i> CRM y sistemas escolares</span>
              </article>
            </div>
          </div>
        </div>
      </section>
      <div class="login-card" role="dialog" aria-labelledby="loginTitle">
        <div class="login-logo" aria-hidden="true">
          <img src="./icon-unidep180.png" alt="" width="132" height="132" />
        </div>
        <h1 id="loginTitle" class="login-title">ReLead EDU</h1>
        <p class="login-intro">Bienvenido. Si es tu primer acceso, utiliza el correo e ID que te compartió la coordinación para generar tu contraseña y empezar a atender leads de inmediato.</p>
        <div id="loginSignIn" aria-hidden="false">
          <form class="login-form" id="loginForm" autocomplete="off">
            <label>
              <span>Correo institucional</span>
              <input type="email" id="loginEmail" autocomplete="username" required />
            </label>
            <label>
              <span>Contraseña</span>
              <input type="password" id="loginPassword" autocomplete="current-password" required />
            </label>
            <div class="login-actions">
              <button type="submit" class="btn primary w100" id="loginSubmit">Entrar a mi tablero</button>
            </div>
          </form>
          <p class="login-message login-error hidden" id="loginError" role="alert"></p>
          <p class="login-hint" id="loginHint">¿Es tu primer ingreso o olvidaste tu contraseña? <button type="button" class="link-button" id="forgotPasswordBtn">Solicita una contraseña temporal</button>.</p>
        </div>
        <div id="loginReset" class="hidden" aria-hidden="true">
          <form class="login-form" id="resetForm" autocomplete="off">
            <p class="login-hint">Ingresa el correo institucional y tu ID de usuario tal como aparecen en tu hoja de asignación para generar una contraseña temporal de acceso inicial.</p>
            <label>
              <span>Correo institucional</span>
              <input type="email" id="resetEmail" autocomplete="username" required />
            </label>
            <label>
              <span>ID de usuario</span>
              <input type="text" id="resetUserId" autocomplete="off" required />
            </label>
            <div class="login-actions">
              <button type="submit" class="btn primary w100" id="resetSubmit">Crear contraseña temporal</button>
              <button type="button" class="btn w100" id="resetCancel">Volver a iniciar sesión</button>
            </div>
          </form>
          <p class="login-message login-info hidden" id="resetMessage" role="status" aria-live="polite"></p>
          <p class="login-hint" id="resetHint">La contraseña temporal se muestra una sola vez. Anótala y cámbiala desde Configuración &gt; Seguridad después de entrar.</p>
        </div>
        <footer class="login-meta">
          <span class="login-meta__version" data-version-format="Versión {version}"></span>
          <span class="login-meta__rights">ReLead<sup>©</sup> Todos los Derechos Reservados</span>
        </footer>
      </div>
    </div>
    <section class="success-stories" aria-labelledby="successTitle">
      <header class="success-header">
        <h2 id="successTitle">Casos de éxito</h2>
        <p>Instituciones que combinan datos, automatización y seguimiento omnicanal con ReLead EDU para sostener su matrícula.</p>
      </header>
      <div class="success-grid" role="list">
        <article class="success-card" role="listitem">
          <p class="success-card__quote">“Sincronizamos ReLead con el ERP académico y recuperamos el 30% de los prospectos inactivos antes del inicio de ciclo.”</p>
          <div class="success-card__meta">
            <span class="success-card__author">Universidad Horizonte</span>
            <p class="success-card__role">Dirección de Admisiones</p>
          </div>
        </article>
        <article class="success-card" role="listitem">
          <p class="success-card__quote">“Los tableros de productividad nos ayudaron a priorizar llamadas y duplicar el volumen de entrevistas completadas.”</p>
          <div class="success-card__meta">
            <span class="success-card__author">Red Instituto Valle</span>
            <p class="success-card__role">Coordinación Comercial</p>
          </div>
        </article>
        <article class="success-card" role="listitem">
          <p class="success-card__quote">“Automatizamos recordatorios por WhatsApp y correo; ahora cada asesor dispone de un histórico único por lead.”</p>
          <div class="success-card__meta">
            <span class="success-card__author">Colegio Delta</span>
            <p class="success-card__role">Gerencia de Experiencia</p>
          </div>
        </article>
      </div>
    </section>
  </div>
  <div class="loading-overlay hidden" id="globalLoading" role="status" aria-live="polite" aria-hidden="true">
    <div class="loading-card">
      <div class="loading-spinner" aria-hidden="true"></div>
      <p class="loading-message" id="globalLoadingMessage">Procesando…</p>
    </div>
  </div>
  <div class="app hidden" id="app">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar" aria-label="Navegación principal" aria-hidden="false">
      <button class="sidebar-close" type="button" id="sidebarClose" aria-label="Cerrar menú lateral" title="Cerrar menú lateral">×</button>
      <nav class="nav" role="navigation">
        <div class="brand" data-expand-label="Expandir menú lateral">
          <img
            src="./icon-unidep180.png"
            alt=""
            class="brand-logo"
            width="44"
            height="44"
            loading="lazy"
            id="sidebarBrandImg"
            data-fallback-src="./icon-unidep180.png"
            data-favicon-src="./icon-unidep180.png"
            data-logo-alt="ReLead EDU"
          />
          <span class="brand-name" id="sidebarBrandName">ReLead EDU</span>
        </div>
        <div class="nav-header">
          <button class="menu-toggle" type="button" id="menuToggle" aria-label="Alternar menú" aria-expanded="true" aria-controls="sidebar" title="Alternar menú">
            <span class="menu-toggle__icon" aria-hidden="true">
              <img id="sidebarAvatarImg" alt="" />
              <span class="menu-toggle__bars">
                <span></span>
                <span></span>
                <span></span>
              </span>
            </span>
          </button>
          <span class="nav-user hidden" id="userBadge" role="status" aria-live="polite"></span>
        </div>
        <div class="nav-divider" aria-hidden="true"></div>
        <div class="nav-group">
          <a href="#" class="nav-link active" data-nav="kpis" aria-current="page"><i class="bi bi-speedometer2"></i><span>KPI’s</span></a>
          <a href="#" class="nav-link" data-nav="leads"><i class="bi bi-people"></i><span>Leads</span></a>
          <a href="#" class="nav-link" data-nav="importar"><i class="bi bi-box-arrow-down"></i><span>Importar</span></a>
          <a href="#" class="nav-link" data-nav="exportar"><i class="bi bi-box-arrow-up"></i><span>Exportar</span></a>
          <a href="#" class="nav-link" data-nav="sistema"><i class="bi bi-cpu"></i><span>Sistema</span></a>
          <a href="#" class="nav-link" data-nav="permisos"><i class="bi bi-shield-lock"></i><span>Permisos</span></a>
          <a href="#" class="nav-link" data-nav="configuracion"><i class="bi bi-gear"></i><span>Configuración</span></a>
        </div>
        <div class="nav-footer">
          <button type="button" class="nav-link" id="logoutBtn"><i class="bi bi-box-arrow-right" aria-hidden="true"></i><span>Cerrar sesión</span></button>
          <a href="#" class="nav-link" data-nav="ayuda">❓ <span>Ayuda</span></a>
          <div class="nav-footer__meta" aria-live="polite">
            <span class="nav-footer__version" data-version-format="ReLead EDU · {version}"></span>
            <span class="nav-footer__rights">ReLead<sup>©</sup> Todos los Derechos Reservados</span>
          </div>
        </div>
      </nav>
    </aside>

    <div class="sidebar-overlay" id="sidebarOverlay" aria-hidden="true"></div>

    <!-- Main -->
    <main class="main" role="main">
      <header class="mobile-topbar" id="mobileTopbar" aria-hidden="false">
        <button class="menu-btn menu-trigger" type="button" aria-label="Abrir menú principal" aria-expanded="false">
          <i class="bi bi-list"></i>
        </button>
        <span class="mobile-topbar__label" id="mobileViewLabel">Vista actual</span>
      </header>
      <section id="view-kpis" class="view-section is-visible">
        <div class="card" style="margin:18px">
          <div class="panel-section">
            <h3><span aria-hidden="true">📊</span> Indicadores clave</h3>
          </div>
          <div class="panel-section critical-summary" aria-label="Resumen operativo prioritario">
            <h3>Resumen operativo inmediato</h3>
            <p>Vista rápida del pulso operativo para reaccionar ante desviaciones de SLA, duplicados y carga de asignaciones.</p>
            <div class="kpi-grid critical-kpis" role="list">
              <article class="kpi-metric" data-indicator="sla" role="listitem">
                <div class="metric-header">
                  <span class="metric-icon" aria-hidden="true"><i class="bi bi-stopwatch"></i></span>
                  <div>
                    <span class="metric-name">SLA de contacto</span>
                    <span class="metric-extra" data-metric-meta="slaTarget">Meta &lt; 4 h · Últimas 24 h</span>
                  </div>
                </div>
                <span class="metric-value" data-metric-value="slaPromedio" aria-live="polite">2.3 h</span>
                <p class="metric-desc">Promedio del primer contacto desde la asignación. Activa alertas cuando supere el objetivo establecido.</p>
              </article>
              <article class="kpi-metric" data-indicator="duplicados" role="listitem">
                <div class="metric-header">
                  <span class="metric-icon" aria-hidden="true"><i class="bi bi-layers"></i></span>
                  <div>
                    <span class="metric-name">Duplicados detectados</span>
                    <span class="metric-extra" data-metric-meta="dupMeta">Tolerancia diaria &lt; 2%</span>
                  </div>
                </div>
                <span class="metric-value" data-metric-value="duplicadosDia" aria-live="polite">1.4%</span>
                <p class="metric-desc">Porcentaje de registros con coincidencias activas durante las últimas cargas. Permite anticipar conflictos de contacto.</p>
              </article>
              <article class="kpi-metric" data-indicator="asignaciones" role="listitem">
                <div class="metric-header">
                  <span class="metric-icon" aria-hidden="true"><i class="bi bi-people"></i></span>
                  <div>
                    <span class="metric-name">Balance de asignaciones</span>
                    <span class="metric-extra" data-metric-meta="asignacionesMeta">Objetivo &ge; 85% distribuidas</span>
                  </div>
                </div>
                <span class="metric-value" data-metric-value="asignacionesBalance" aria-live="polite">89%</span>
                <p class="metric-desc">Porcentaje de leads entregados frente al total disponible. Indica si existe rezago en la distribución entre asesores.</p>
              </article>
            </div>
          </div>
          <div class="panel-section">
            <h3>KPIs del embudo de reactivación</h3>
            <div class="kpi-groups" aria-label="Indicadores clave" id="kpiContainer"></div>
          </div>
        </div>
      </section>
      <section id="view-leads" class="view-section hidden" data-mobile-title="Leads · Tablero">
      <header class="topbar">
        <div class="topbar-inner">
          <button class="menu-btn menu-trigger" type="button" id="menuBtn" aria-label="Abrir menú principal" aria-expanded="false">
            <i class="bi bi-list"></i>
          </button>
          <div class="search" role="search">
            <svg class="icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            <input id="q" type="search" placeholder="ID, nombre o teléfono… (Ctrl /)" aria-label="ID" />
          </div>
          <div class="actions">
            <div class="btn primary" title="Buscar" id="searchBtn"><i class="bi bi-search"></i> Buscar</div>
          </div>
        </div>
      </header>

      <div class="card" style="margin:18px">
        <div class="panel-section">
          <div class="view-controls" aria-label="Filtros de leads">
            <div class="filters" aria-label="Filtros">
              <label>
                Base
                <select id="sheetSelect"></select>
              </label>
              <label>
                Asesor
                <select id="asesorSelect"></select>
              </label>
              <label>
                Plantel
                <select id="campusSelect"></select>
              </label>
              <label class="page-size">
                Mostrar
                <select id="pageSize">
                  <option value="10">10</option>
                  <option value="30" selected>30</option>
                  <option value="50">50</option>
                  <option value="0">Todos</option>
                </select>
              </label>
            </div>
            <div class="daily-shortcuts" id="dailyShortcuts" aria-label="Listas diarias sugeridas"></div>
          </div>
        </div>
        <div class="panel-section">
          <h3>Leads</h3>
          <section class="content">
            <!-- Kanban -->
            <div id="viewKanban" class="board" role="region" aria-label="Lead Board">
              <!-- Column templates -->
            </div>
          </section>
          <div id="paginator" class="pagination"></div>
        </div>
      </div>
      <div id="panelOverlay" class="panel-overlay" aria-hidden="true">
        <aside class="panel" aria-label="Detalle del lead" tabindex="-1">
          <button class="panel-close" type="button" id="panelClose" aria-label="Cerrar panel de lead"><i class="bi bi-x-lg"></i></button>
          <div class="panel-header">
            <h3 class="panel-title">
              <span id="d-nombre">Selecciona un lead</span>
              <span class="stage-pill is-empty" id="d-etapa">—</span>
            </h3>
          </div>
          <div class="kv">
            <div class="kv-label" id="lab-matricula">Matrícula</div><div id="d-matricula">—</div>
            <div class="kv-label" id="lab-tel">Teléfono</div><div id="d-tel">—</div>
            <div class="kv-label" id="lab-mail">Correo</div><div id="d-mail">—</div>
            <div class="kv-label" id="lab-campus">Plantel</div><div id="d-campus">—</div>
            <div class="kv-label" id="lab-modalidad">Modalidad</div><div id="d-modalidad">—</div>
            <div class="kv-label" id="lab-programa">Programa</div><div id="d-programa">—</div>
            <div class="kv-label" id="lab-estado">Estado</div><div id="d-estado">—</div>
            <div class="kv-label" id="lab-asesor">Asesor</div><div id="d-asesor">—</div>
          </div>
          <section class="panel-quick" aria-labelledby="panelQuickTitle">
            <div class="panel-quick__header">
              <h4 id="panelQuickTitle">Actualiza y contacta</h4>
              <p>Registra etapa, estado y nota antes de usar los accesos rápidos para contactar al lead.</p>
            </div>
            <div class="panel-quick__grid">
              <label class="panel-quick__field">Etapa
                <select id="selEtapa"></select>
              </label>
              <label class="panel-quick__field">Estado
                <select id="selEstado"></select>
              </label>
            </div>
            <label class="panel-quick__field panel-quick__comment">Comentario
              <textarea id="txtComentario" class="w100" rows="3"></textarea>
            </label>
            <div class="panel-quick__feedback hidden" id="panelFeedback" role="alert" aria-live="assertive">
              <strong id="panelFeedbackTitle"></strong>
              <p id="panelFeedbackMessage"></p>
            </div>
            <div class="panel-quick__actions">
              <button class="btn primary" id="updateBtn">Guardar actualización</button>
              <div class="panel-quick__shortcuts" role="group" aria-label="Accesos rápidos de contacto">
                <a class="btn contact-btn contact-call" id="act-call" href="#" target="_blank" rel="noopener"><i class="bi bi-telephone"></i> Llamar</a>
                <a class="btn contact-btn contact-wa" id="act-wa" href="#" target="_blank" rel="noopener"><i class="bi bi-whatsapp"></i> WhatsApp</a>
                <a class="btn contact-btn contact-mail" id="act-mail" href="#" target="_blank" rel="noopener"><i class="bi bi-envelope"></i> Email</a>
              </div>
            </div>
            <p class="contact-scripts__status hidden" id="contactScriptStatus" role="status" aria-live="polite"></p>
          </div>
          <div class="actions" style="margin-top:10px">
            <button class="btn primary" id="updateBtn">Guardar</button>
          </div>
          <div class="actions" style="margin-top:10px">
              <a class="btn contact-btn contact-call" id="act-call" href="#" target="_blank" rel="noopener"><i class="bi bi-telephone"></i> Llamar</a>
              <a class="btn contact-btn contact-wa" id="act-wa" href="#" target="_blank" rel="noopener"><i class="bi bi-whatsapp"></i> WhatsApp</a>
              <a class="btn contact-btn contact-mail" id="act-mail" href="#" target="_blank" rel="noopener"><i class="bi bi-envelope"></i> Email</a>
          </div>
        </aside>
      </div>
      <!-- Drawer for mobile details -->
      <div class="drawer" id="drawer" aria-hidden="true">
        <div class="sheet">
          <button class="btn" id="closeDrawer">Cerrar</button>
          <div id="drawerContent"></div>
        </div>
      </div>
      </section>

      <section id="view-importar" class="view-section hidden">
        <div class="card" style="margin:18px">
          <div class="panel-section">
            <h3>Datos</h3>
            <div class="row gap10 panel-filters">
              <label>
                Base de destino
                <select id="importBaseSelect"></select>
              </label>
              <input type="file" id="importFile" accept=".csv,.xlsx" class="file-input">
            </div>
            <div class="row gap10 panel-actions">
              <button class="btn outline" id="btnVerify">Verificar</button>
              <button class="btn outline" id="btnExecute" disabled>Ejecutar</button>
            </div>
            <div id="importPreview" class="preview-box hidden panel-preview"></div>
            <div id="dupWrap" class="preview-box hidden panel-preview"></div>
          </div>
          <div class="panel-section">
            <h3>Activos</h3>
            <div class="row gap10 panel-filters">
              <input type="file" id="activosFile" accept=".csv,.xlsx" class="file-input">
            </div>
            <div class="row gap10 panel-actions">
              <button class="btn outline" id="btnActivosVerify">Analizar</button>
              <button class="btn outline" id="btnActivosExecute" disabled>Actualizar</button>
            </div>
            <div id="activosPreview" class="preview-box hidden panel-preview"></div>
            <div id="activosDiff" class="preview-box hidden panel-preview"></div>
          </div>
          <div class="panel-section">
            <h3>Cambios masivos</h3>
            <div class="row gap10 panel-filters">
              <input type="file" id="bulkFile" accept=".csv,.xlsx" class="file-input">
            </div>
            <div class="row gap10 panel-actions">
              <button class="btn outline" id="btnBulkVerify">Verificar</button>
              <button class="btn outline" id="btnBulkExecute" disabled>Ejecutar</button>
              <button class="btn outline" id="btnBulkTemplate">Plantilla</button>
            </div>
            <div id="bulkPreview" class="preview-box hidden panel-preview"></div>
            <div id="bulkDupWrap" class="preview-box hidden panel-preview"></div>
          </div>
        </div>
      </section>

      <section id="view-exportar" class="view-section hidden">
        <div class="card" style="margin:18px">
          <div class="panel-section">
            <h3>Datos</h3>
            <div class="row gap10 panel-filters">
              <select id="expDataBase"><option value="">Bases</option></select>
              <select id="expDataAsesor"><option value="">Todos los asesores</option></select>
              <select id="expDataEtapa"><option value="">Etapa</option></select>
              <select id="expDataEstado"><option value="">Todos los estados</option></select>
              <label class="date-filter" for="expDataStart">
                <span>Desde</span>
                <input type="date" id="expDataStart">
              </label>
              <label class="date-filter" for="expDataEnd">
                <span>Hasta</span>
                <input type="date" id="expDataEnd">
              </label>
            </div>
            <div class="row gap10 panel-actions">
              <button class="btn primary" id="btnExportData">Ejecutar</button>
            </div>
          </div>
          <div class="panel-section">
            <h3>Reportes</h3>
            <div class="row gap10 panel-filters">
              <select id="expReportTipo">
                <option value="">Tipo de reporte</option>
                <option value="estado">Estado de la base</option>
                <option value="detalle">Detalle asesor</option>
                <option value="sistema">Sistema</option>
                <option value="losg">Losg</option>
              </select>
              <select id="expReportBase"><option value="">Base</option></select>
              <select id="expReportAsesor"><option value="">Todos los asesores</option></select>
              <label class="date-filter" for="expReportStart">
                <span>Desde</span>
                <input type="date" id="expReportStart">
              </label>
              <label class="date-filter" for="expReportEnd">
                <span>Hasta</span>
                <input type="date" id="expReportEnd">
              </label>
            </div>
            <div class="row gap10 panel-actions">
              <button class="btn primary" id="btnExportReport">Ejecutar</button>
            </div>
          </div>
          <div class="panel-section">
            <h3>Resoluciones</h3>
            <div class="row gap10 panel-filters">
              <select id="expResolCRM">
                <option value="">CRM</option>
                <option value="neotel">Neotel</option>
                <option value="hubspot">HubSpot</option>
              </select>
              <select id="expResolAsesor"><option value="">Todos los asesores</option></select>
              <select id="expResolBase"><option value="">Base</option></select>
              <label class="date-filter" for="expResolStart">
                <span>Desde</span>
                <input type="date" id="expResolStart">
              </label>
              <label class="date-filter" for="expResolEnd">
                <span>Hasta</span>
                <input type="date" id="expResolEnd">
              </label>
            </div>
            <div class="row gap10 panel-actions">
              <button class="btn primary" id="btnExportResolution">Ejecutar</button>
            </div>
          </div>
        </div>
      </section>

      <section id="view-sistema" class="view-section hidden">
        <div class="card" style="margin:18px">
          <div class="panel-section">
            <h3>Diagnóstico</h3>
            <p>Ejecuta un chequeo completo para conocer el estado del sistema, la estructura de las hojas y los posibles riesgos.</p>
            <div class="row gap10 panel-actions">
              <button class="btn primary" id="diagBtn">Iniciar</button>
            </div>
            <div class="cmd-panel" role="log" aria-live="polite" aria-label="Resultados del diagnóstico">
              <ul id="diagLog"></ul>
            </div>
          </div>
          <div class="panel-section">
            <h3>Duplicados</h3>
            <div class="panel-status" id="dupStatus" role="status">Ejecuta el diagnóstico para habilitar esta sección.</div>
            <div id="dupList" class="dup-grid hidden" aria-live="polite"></div>
          </div>
          <div class="panel-section">
            <h3>Solucionar Problemas</h3>
            <p class="muted small">Genera un plan después del diagnóstico para resolver incidencias automáticamente o seguir pasos guiados.</p>
            <div class="panel-status" id="solverStatus" role="status">Ejecuta el diagnóstico para generar recomendaciones.</div>
            <div class="row gap10 panel-actions">
              <button class="btn primary" id="solverAutoBtn" disabled>Solución automática</button>
              <button class="btn" id="solverStepsBtn" disabled>Ver pasos sugeridos</button>
            </div>
            <div class="cmd-panel" role="log" aria-live="polite" aria-label="Plan de solución">
              <ul id="solverLog"></ul>
            </div>
          </div>
        </div>
      </section>

      <section id="view-permisos" class="view-section hidden">
        <div class="card" style="margin:18px">
          <div class="panel-section">
            <h3><span aria-hidden="true">🛡️</span> Permisos</h3>
            <div class="permissions-grid" id="permissionsGrid">
              <div class="permissions-panel" aria-label="Usuarios registrados">
                <div class="row gap10 panel-actions">
                  <button type="button" class="btn outline" id="permReloadBtn"><i class="bi bi-arrow-repeat"></i> Actualizar</button>
                  <button type="button" class="btn primary" id="permNewBtn"><i class="bi bi-plus-lg"></i> Nuevo usuario</button>
                </div>
                <p class="permissions-status small" id="permStatus" role="status" aria-live="polite">Carga los usuarios para comenzar.</p>
                <div class="permissions-list" id="permList" role="listbox" aria-label="Usuarios"></div>
              </div>
              <form class="permissions-form" id="permForm" autocomplete="off" novalidate>
                <h4 class="perm-form-title" id="permFormTitle">Nuevo usuario</h4>
                <div class="form-grid">
                  <label>
                    <span>Correo institucional</span>
                    <input type="email" id="permEmail" autocomplete="email" required />
                  </label>
                  <label>
                    <span>ID de usuario</span>
                    <input type="text" id="permUserId" autocomplete="off" required />
                  </label>
                  <label>
                    <span>Nombre completo</span>
                    <input type="text" id="permName" autocomplete="name" required />
                  </label>
                  <label class="field-with-hint">
                    <span>Rol</span>
                    <select id="permRole">
                      <option value="admin">Administrador</option>
                      <option value="coordinador">Coordinador</option>
                      <option value="asesor">Asesor</option>
                      <option value="viewer">Consulta</option>
                    </select>
                    <span class="field-hint" id="permRoleHint"></span>
                    <div class="role-scope-suggestion" id="permRoleSuggestion" hidden>
                      <p class="role-scope-suggestion__text" id="permRoleDescription"></p>
                      <div class="role-scope-suggestion__chips" id="permRoleScopeChips" aria-live="polite"></div>
                      <button type="button" class="btn micro" id="permApplyRolePreset"><i class="bi bi-magic"></i> Aplicar sugerencia</button>
                    </div>
                  </label>
                  <label class="field-with-hint">
                    <span>Planteles autorizados</span>
                    <div class="multi-select" id="permPlantelesSelect">
                      <button type="button" class="multi-select__button" aria-haspopup="listbox" aria-expanded="false">
                        <span class="multi-select__button-text">Selecciona planteles</span>
                        <i class="bi bi-chevron-down" aria-hidden="true"></i>
                      </button>
                      <div class="multi-select__menu" role="listbox" aria-multiselectable="true" tabindex="-1"></div>
                      <div class="multi-select__chips" aria-live="polite"></div>
                    </div>
                    <input type="hidden" id="permPlanteles" />
                    <span class="field-hint">Seleccionar "Todos" otorga acceso global a todos los planteles.</span>
                  </label>
                  <label class="field-with-hint">
                    <span>Bases autorizadas</span>
                    <div class="multi-select" id="permBasesSelect">
                      <button type="button" class="multi-select__button" aria-haspopup="listbox" aria-expanded="false">
                        <span class="multi-select__button-text">Selecciona bases</span>
                        <i class="bi bi-chevron-down" aria-hidden="true"></i>
                      </button>
                      <div class="multi-select__menu" role="listbox" aria-multiselectable="true" tabindex="-1"></div>
                      <div class="multi-select__chips" aria-live="polite"></div>
                    </div>
                    <input type="hidden" id="permBases" />
                    <span class="field-hint">Seleccionar "Todas" otorga acceso global a todas las bases.</span>
                  </label>
                  <label>
                    <span>Contraseña temporal</span>
                    <input type="password" id="permPassword" autocomplete="new-password" />
                  </label>
                  <label class="permissions-switch">
                    <input type="checkbox" id="permActive" checked />
                    <span>Acceso activo</span>
                  </label>
                </div>
                <p class="small muted" id="permPasswordHint">Se generará una contraseña temporal para compartir con la persona usuaria.</p>
                <div class="permissions-meta small muted" id="permMeta"></div>
                <div class="row gap10 panel-actions">
                  <button type="submit" class="btn primary" id="permSaveBtn"><i class="bi bi-floppy"></i> Guardar</button>
                  <button type="button" class="btn" id="permResetBtn"><i class="bi bi-arrow-counterclockwise"></i> Cancelar</button>
                  <button type="button" class="btn danger" id="permDeleteBtn"><i class="bi bi-person-dash"></i> Desactivar</button>
                </div>
              </form>
            </div>
            <div class="permissions-reference">
              <div class="permissions-card" id="permissionMatrix"></div>
              <div class="permissions-card" id="permissionRules"></div>
            </div>
          </div>
          <div class="panel-section">
            <h3><span aria-hidden="true">👥</span> Equipos</h3>
            <div class="permissions-grid permissions-grid--teams">
              <div class="permissions-panel">
                <div class="row gap10 panel-actions">
                  <button type="button" class="btn outline" id="teamReloadBtn"><i class="bi bi-arrow-repeat"></i> Actualizar</button>
                  <button type="button" class="btn primary" id="teamNewBtn"><i class="bi bi-plus-lg"></i> Nuevo equipo</button>
                </div>
                <p class="permissions-status small" id="teamStatus" role="status" aria-live="polite">Carga los equipos para comenzar.</p>
                <div class="permissions-list" id="teamList" role="listbox" aria-label="Equipos"></div>
              </div>
              <form class="permissions-form" id="teamForm" autocomplete="off" novalidate>
                <h4 class="perm-form-title" id="teamFormTitle">Nuevo equipo</h4>
                <div class="scope-template-toolbar" id="teamTemplateToolbar" aria-label="Plantillas sugeridas"></div>
                <div class="form-grid">
                  <label>
                    <span>ID del equipo</span>
                    <input type="text" id="teamId" autocomplete="off" required />
                  </label>
                  <label>
                    <span>Nombre del equipo</span>
                    <input type="text" id="teamName" autocomplete="off" required />
                  </label>
                  <label>
                    <span>Descripción</span>
                    <textarea id="teamDescription" rows="3"></textarea>
                  </label>
                  <label class="field-with-hint">
                    <span>Planteles asignados</span>
                    <div class="multi-select" id="teamPlantelesSelect">
                      <button type="button" class="multi-select__button" aria-haspopup="listbox" aria-expanded="false">
                        <span class="multi-select__button-text">Selecciona planteles</span>
                        <i class="bi bi-chevron-down" aria-hidden="true"></i>
                      </button>
                      <div class="multi-select__menu" role="listbox" aria-multiselectable="true" tabindex="-1"></div>
                      <div class="multi-select__chips" aria-live="polite"></div>
                    </div>
                    <input type="hidden" id="teamPlanteles" />
                    <span class="field-hint">Determina a qué planteles puede acceder el equipo.</span>
                  </label>
                  <label class="field-with-hint">
                    <span>Bases asignadas</span>
                    <div class="multi-select" id="teamBasesSelect">
                      <button type="button" class="multi-select__button" aria-haspopup="listbox" aria-expanded="false">
                        <span class="multi-select__button-text">Selecciona bases</span>
                        <i class="bi bi-chevron-down" aria-hidden="true"></i>
                      </button>
                      <div class="multi-select__menu" role="listbox" aria-multiselectable="true" tabindex="-1"></div>
                      <div class="multi-select__chips" aria-live="polite"></div>
                    </div>
                    <input type="hidden" id="teamBases" />
                    <span class="field-hint">Controla las bases visibles para el equipo.</span>
                  </label>
                  <label class="field-with-hint">
                    <span>Integrantes</span>
                    <div class="multi-select" id="teamMembersSelect">
                      <button type="button" class="multi-select__button" aria-haspopup="listbox" aria-expanded="false">
                        <span class="multi-select__button-text">Selecciona integrantes</span>
                        <i class="bi bi-chevron-down" aria-hidden="true"></i>
                      </button>
                      <div class="multi-select__menu" role="listbox" aria-multiselectable="true" tabindex="-1"></div>
                      <div class="multi-select__chips" aria-live="polite"></div>
                    </div>
                    <input type="hidden" id="teamMembers" />
                    <span class="field-hint">Asigna usuarios responsables del equipo.</span>
                  </label>
                  <label class="permissions-switch">
                    <input type="checkbox" id="teamActive" checked />
                    <span>Equipo activo</span>
                  </label>
                </div>
                <div class="permissions-meta small muted" id="teamMeta"></div>
                <div class="row gap10 panel-actions">
                  <button type="submit" class="btn primary" id="teamSaveBtn"><i class="bi bi-floppy"></i> Guardar</button>
                  <button type="button" class="btn" id="teamResetBtn"><i class="bi bi-arrow-counterclockwise"></i> Cancelar</button>
                  <button type="button" class="btn" id="teamCloneBtn"><i class="bi bi-copy"></i> Clonar configuración</button>
                  <button type="button" class="btn danger" id="teamDeleteBtn"><i class="bi bi-x-circle"></i> Desactivar</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </section>

      <section id="view-configuracion" class="view-section hidden">
        <div class="card settings-card" style="margin:18px">
          <div class="panel-section">
            <h3><span aria-hidden="true">👤</span> Perfil</h3>
            <div class="settings-profile">
              <div class="profile-avatar">
                <div class="avatar-frame" id="profileAvatarFrame">
                  <img id="profileAvatarImg" alt="Foto de perfil" />
                  <span id="profileAvatarInitials">U</span>
                </div>
                <input type="file" accept="image/*" id="profileAvatarInput" class="hidden" />
                <div class="avatar-actions">
                  <button type="button" class="btn outline" id="profileAvatarUpload"><i class="bi bi-image"></i> Subir foto</button>
                  <button type="button" class="btn" id="profileAvatarRemove"><i class="bi bi-trash"></i> Quitar</button>
                </div>
                <p class="muted small">PNG o JPG de hasta 1.5&nbsp;MB. La imagen se guarda únicamente en este navegador.</p>
              </div>
              <div class="profile-details">
                <p class="muted small">Los datos se muestran en modo lectura y reflejan tu último acceso autorizado.</p>
                <div class="profile-summary" id="profileSummary" aria-live="polite">
                  <div>
                    <span class="summary-label">Usuario</span>
                    <span class="summary-value" id="profileSummaryId">Sin definir</span>
                  </div>
                  <div>
                    <span class="summary-label">Nombre</span>
                    <span class="summary-value" id="profileSummaryName">Sin definir</span>
                  </div>
                  <div>
                    <span class="summary-label">Correo</span>
                    <span class="summary-value" id="profileSummaryEmail">Sin definir</span>
                  </div>
                  <div>
                    <span class="summary-label">Rol</span>
                    <span class="summary-value" id="profileSummaryRole">Sin definir</span>
                  </div>
                  <div>
                    <span class="summary-label">Plantel</span>
                    <span class="summary-value" id="profileSummaryCampus">Sin definir</span>
                  </div>
                </div>
                <div class="profile-sync-alert" id="profileSyncAlert" hidden></div>
              </div>
            </div>
          </div>
          <div class="panel-section">
            <h3><span aria-hidden="true">🔒</span> Seguridad</h3>
            <form id="passwordForm" class="form-grid security-form" autocomplete="off">
              <div class="security-status" id="passwordStatusCard" aria-live="polite">
                <div class="security-status__header">
                  <span class="summary-label">Solicitud de cambio de contraseña</span>
                  <span class="summary-value" id="passwordRequestStatus">Sin solicitudes registradas.</span>
                </div>
                <div class="security-timeline" id="passwordRequestTimeline" aria-live="polite"></div>
                <div class="security-status__actions" id="passwordStatusActions">
                  <button type="button" class="btn micro" id="passwordApproveBtn" hidden><i class="bi bi-check2-circle"></i> Registrar aprobación</button>
                  <button type="button" class="btn micro" id="passwordCompleteBtn" hidden><i class="bi bi-send-check"></i> Confirmar entrega</button>
                </div>
              </div>
              <label>
                <span>Contraseña actual</span>
                <input type="password" id="passwordCurrent" autocomplete="current-password" />
              </label>
              <label>
                <span>Nueva contraseña</span>
                <input type="password" id="passwordNew" autocomplete="new-password" />
              </label>
              <label>
                <span>Confirmar contraseña</span>
                <input type="password" id="passwordConfirm" autocomplete="new-password" />
              </label>
              <div class="row gap10 security-actions">
                <button type="submit" class="btn primary"><i class="bi bi-envelope"></i> Enviar solicitud</button>
                <button type="button" class="btn" id="passwordClear"><i class="bi bi-x"></i> Limpiar</button>
              </div>
              <p class="muted small">Esta acción no actualiza tu acceso automáticamente; se guarda como referencia local.</p>
            </form>
          </div>
          <div class="panel-section">
            <h3><span aria-hidden="true">🎨</span> Preferencias</h3>
            <div class="settings-preferences">
              <fieldset class="settings-group" aria-labelledby="themeOptionsLabel">
                <legend id="themeOptionsLabel">Tema</legend>
                <div class="segmented" role="radiogroup" aria-label="Tema">
                  <label class="segmented-option">
                    <input type="radio" name="pref-theme" value="light" />
                    <span>Claro</span>
                  </label>
                  <label class="segmented-option">
                    <input type="radio" name="pref-theme" value="dark" />
                    <span>Oscuro</span>
                  </label>
                  <label class="segmented-option">
                    <input type="radio" name="pref-theme" value="system" />
                    <span>Sistema</span>
                  </label>
                </div>
              </fieldset>
              <label class="settings-group">
                <span>Idioma</span>
                <select id="prefLanguage">
                  <option value="es">Español</option>
                  <option value="en">English</option>
                </select>
              </label>
              <label class="settings-group">
                <span>Densidad</span>
                <select id="prefDensity">
                  <option value="comfortable">Cómoda</option>
                  <option value="compact">Compacta</option>
                </select>
              </label>
              <label class="settings-group">
                <span>Diseño del tablero</span>
                <select id="prefBoardDensity">
                  <option value="standard">Estándar</option>
                  <option value="compact">Compacto</option>
                  <option value="expanded">Amplio</option>
                </select>
              </label>
              <label class="settings-group">
                <span>Color de acento</span>
                <select id="prefAccent">
                  <option value="blue">Azul institucional</option>
                  <option value="green">Verde</option>
                  <option value="purple">Morado</option>
                  <option value="orange">Ámbar</option>
                  <option value="teal">Turquesa</option>
                  <option value="pink">Magenta</option>
                </select>
              </label>
              <label class="settings-group switch">
                <input type="checkbox" id="prefEco" />
                <span>Modo eco</span>
              </label>
              <label class="settings-group switch">
                <input type="checkbox" id="prefMotion" />
                <span>Reducir animaciones</span>
              </label>
              <label class="settings-group switch">
                <input type="checkbox" id="prefLargeText" />
                <span>Texto amplio</span>
              </label>
              <label class="settings-group switch">
                <input type="checkbox" id="prefHighContrast" />
                <span>Contraste alto</span>
              </label>
              <label class="settings-group switch">
                <input type="checkbox" id="prefShowLeadId" />
                <span>Mostrar ID en tarjetas del tablero</span>
              </label>
              <div class="pref-presets" id="prefPresetRecommendations" hidden>
                <p class="pref-presets__title">Recomendaciones institucionales</p>
                <div class="pref-presets__list" id="prefPresetList"></div>
              </div>
              <div class="row gap10 pref-actions">
                <button type="button" class="btn" id="prefReset"><i class="bi bi-arrow-counterclockwise"></i> Restablecer</button>
              </div>
            </div>
          </div>
          <div class="panel-section">
            <h3><span aria-hidden="true">📝</span> Estado</h3>
            <div class="settings-summary visible" id="settingsStatus" role="status" aria-live="polite">Tus ajustes se guardan en este dispositivo.</div>
          </div>
        </div>
      </section>

      <section id="view-ayuda" class="view-section hidden">
        <div class="card" style="margin:18px">
          <div class="panel-section">
            <h3><span aria-hidden="true">✨</span> Novedades ReLead EDU</h3>
            <ul class="help-highlights">
              <li>Identidad renovada con acceso unificado, nuevo logotipo y título consistente en todo el sitio.</li>
              <li>Transiciones fluidas entre pestañas, paneles y estados de carga para que sepas cuándo un proceso está en marcha.</li>
              <li>Experiencia responsive afinada: la navegación lateral, el tablero de leads y los paneles se adaptan sin pasos extra en mobile.</li>
              <li>Pestaña de ayuda reorganizada con atajos rápidos por módulo y recordatorios de permisos.</li>
            </ul>
          </div>
          <div class="panel-section help-role">
            <h3><span aria-hidden="true">🧭</span> Guía rápida por pestaña</h3>
            <div class="help-role-grid">
              <div>
                <h4>KPI’s</h4>
                <ul>
                  <li>Revisa indicadores priorizados para tu rol. Los totales respetan los filtros activos en Leads.</li>
                  <li>Usa las tarjetas de alerta para detectar pendientes antes de entrar al tablero.</li>
                  <li>Elige la base activa desde <strong>Leads → Base</strong> para que los KPI’s se sincronicen con tus datos.</li>
                </ul>
              </div>
              <div>
                <h4>Leads</h4>
                <ul>
                  <li>Filtra por base, asesor, plantel y tamaño de página sin perder el conteo global por etapa.</li>
                  <li>Abre el panel lateral o el cajón móvil para actualizar etapa, estado y comentario con animaciones de estado.</li>
                </ul>
              </div>
              <div>
                <h4>Importar</h4>
                <ul>
                  <li>Valida encabezados y duplicados con <strong>Verificar</strong> antes de ejecutar cambios definitivos.</li>
                  <li>Carga bases activas o plantillas de cambios masivos con vistas previas interactivas.</li>
                </ul>
              </div>
              <div>
                <h4>Exportar</h4>
                <ul>
                  <li>Descarga datos filtrados por fecha, asesor o etapa desde el bloque de <strong>Datos</strong>.</li>
                  <li>Genera reportes ejecutivos o resoluciones por CRM respetando los límites de filas.</li>
                </ul>
              </div>
              <div>
                <h4>Sistema</h4>
                <ul>
                  <li>Ejecuta diagnósticos completos y consulta resultados en tiempo real.</li>
                  <li>Gestiona duplicados detectados en Google Sheets con mensajes de estado claros.</li>
                </ul>
              </div>
              <div>
                <h4>Permisos</h4>
                <ul>
                  <li>Crea y edita usuarios, equipos y alcances desde un panel con chips interactivos.</li>
                  <li>Observa el resumen del acceso seleccionado sin abandonar la vista.</li>
                </ul>
              </div>
              <div>
                <h4>Configuración</h4>
                <ul>
                  <li>Actualiza tu foto local, revisa tus datos en modo lectura y administra preferencias visuales.</li>
                  <li>Registra solicitudes de cambio de contraseña y consulta su historial local.</li>
                </ul>
              </div>
              <div>
                <h4>Ayuda</h4>
                <ul>
                  <li>Accede a las novedades y a los mensajes frecuentes del diagnóstico en un solo lugar.</li>
                </ul>
              </div>
            </div>
          </div>
          <div class="panel-section help-role">
            <h3><span aria-hidden="true">🧑‍🤝‍🧑</span> Roles y alcance</h3>
            <div class="help-role-grid">
              <div>
                <h4>Administración</h4>
                <ul>
                  <li>Gestiona usuarios, equipos, bases y ejecuciones del diagnóstico.</li>
                  <li>Controla duplicados y habilita exportaciones masivas para cualquier plantel.</li>
                </ul>
              </div>
              <div>
                <h4>Coordinación</h4>
                <ul>
                  <li>Monitorea indicadores, administra equipos asignados y ejecuta importaciones revisadas.</li>
                  <li>Configura preferencias personales y consulta permisos sin modificar accesos globales.</li>
                </ul>
              </div>
              <div>
                <h4>Asesoría</h4>
                <ul>
                  <li>Trabaja con tus leads asignados, registra avances y descarga reportes filtrados.</li>
                  <li>Ajusta visuales (tema, densidad, contraste) y mantén tu control de seguridad personal.</li>
                </ul>
              </div>
              <div>
                <h4>Consulta</h4>
                <ul>
                  <li>Visualiza indicadores, leads y reportes con permisos de solo lectura.</li>
                  <li>Personaliza la interfaz sin alterar datos ni accesos de terceros.</li>
                </ul>
              </div>
            </div>
          </div>
          <div class="panel-section help-role">
            <h3><span aria-hidden="true">🛠️</span> Diagnóstico: mensajes clave</h3>
            <div class="help-role-table">
              <table class="help-table">
                <thead>
                  <tr><th>Mensaje</th><th>Acción sugerida</th></tr>
                </thead>
                <tbody>
                  <tr><td>Error al contactar el servicio</td><td>Confirma tu conexión y que el despliegue de Apps Script siga vigente.</td></tr>
                  <tr><td>No hay hojas disponibles para ejecutar el diagnóstico.</td><td>Verifica que tengas bases asignadas en <strong>Permisos</strong> y que no estén ocultas.</td></tr>
                  <tr><td>No se pudo interpretar la respuesta del diagnóstico.</td><td>Repite la ejecución y valida que el backend no haya cambiado de formato.</td></tr>
                  <tr><td>Prueba de escritura: Fallo</td><td>Asegura permisos de edición y que la hoja no esté protegida.</td></tr>
                  <tr><td>Hoja "…": requiere revisión</td><td>Consulta columnas faltantes, duplicados o datos inválidos y corrige en la base original.</td></tr>
                  <tr><td>Duplicados globales de ID/Teléfono</td><td>Depura coincidencias desde la vista de duplicados para evitar conflictos entre hojas.</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <footer class="site-footer" aria-label="Información de versión y derechos">
        <div class="site-footer__inner">
          <span class="site-footer__version" data-version-format="ReLead EDU · Versión {version}"></span>
          <span class="site-footer__rights">ReLead<sup>©</sup> Todos los Derechos Reservados</span>
        </div>
      </footer>

    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="./config/app-config.js"></script>
  <script src="./js/utils/data-format.js"></script>
  <script>
  // —— Datos desde Google Sheets ——
  const appConfig = window.ReLeadConfig || {};
  const API_URL = appConfig.API_URL || 'https://script.google.com/macros/s/AKfycbz_DsHnZdKlQ0a19SELkTqYTUUgXEnvKpn14nCjsGCt1fxTK0vcFxWzL9iraxSFNK3R/exec';
  const REQUEST_TIMEOUT_MS = Number.isFinite(appConfig.REQUEST_TIMEOUT_MS) ? appConfig.REQUEST_TIMEOUT_MS : 45000;
  const DEFAULT_APP_VERSION = '1.0.0';
  const rawAppVersion = typeof appConfig.VERSION === 'string' ? appConfig.VERSION.trim() : '';
  const APP_VERSION = rawAppVersion || DEFAULT_APP_VERSION;
  const DISPLAY_APP_VERSION = APP_VERSION.startsWith('v') ? APP_VERSION : `v${APP_VERSION}`;
  window.ReLeadAppVersion = DISPLAY_APP_VERSION;

  function applyVersionLabels(){
    const nodes = document.querySelectorAll('[data-version-format]');
    nodes.forEach(node => {
      const template = node.getAttribute('data-version-format') || '{version}';
      node.textContent = template.replace('{version}', DISPLAY_APP_VERSION);
    });
  }

  applyVersionLabels();
  let leads = [];
  let sheets = [];
  let lastDiagnostics = null;
  let globalLeadIndex = null;
  let diagInProgress = false;
  let currentDiagnosticsRunId = 0;
  let currentSolutionPlan = null;
  let solvingInProgress = false;
  let lastSolverAutoRunId = null;
  let permissionUsers = [];
  let permissionsLoaded = false;
  let permissionsLoading = false;
  let selectedPermissionUserId = '';
  let teams = [];
  let teamsLoaded = false;
  let teamsLoading = false;
  let selectedTeamId = '';
  const TONE_COLORS = { ok:'var(--ok)', warn:'var(--warn)', bad:'var(--bad)', info:'var(--muted)' };
  const etapasUI = ["Nuevo","Contactado","No Contactado","Inscrito","Descartado"];
  const estadosByEtapa = {
    'Nuevo':['Sin contactar'],
    'Contactado':['Interesado','Seguimiento activo','En labor de venta','Cita agendada'],
    'No Contactado':['No contesta','Mensaje no respondido','Pendiente de reintento'],
    'Descartado':['Sin interés','Datos incorrectos','Duplicado','SPAM'],
    'Inscrito':['Inscrito confirmado']
  };

  const columns = ['id','nombre','matricula','correo','telefono','campus','modalidad','programa','etapa','estado','asesor','comentario','asignacion'];

  const CONTACT_SCRIPT_TYPES = ['call','whatsapp','email'];
  const CONTACT_CHANNEL_LABELS = { call: 'Llamada', whatsapp: 'WhatsApp', email: 'Correo' };
  const DAILY_SHORTCUT_LIMIT = 3;
  const LEAD_PRIORITY_THRESHOLDS = { high: 6, medium: 3 };
  const CONTACT_TIMESTAMP_FORMAT = (() => {
    try{
      return new Intl.DateTimeFormat('es-MX', { dateStyle: 'short', timeStyle: 'short' });
    }catch(err){
      return null;
    }
  })();

  const KPI_INTEREST_STATES = new Set(['interesado','seguimiento activo','cita agendada','en labor de venta']);
  const KPI_NUMBER_FORMAT = new Intl.NumberFormat('es-MX');
  const KPI_PERCENT_FORMAT = new Intl.NumberFormat('es-MX', { style: 'percent', minimumFractionDigits: 0, maximumFractionDigits: 1 });
  const KPI_GROUPS = {
    Base_Fria: {
      label: 'Base fría',
      description: 'Volumen y depuración de la base fría en seguimiento.',
      metrics: [
        {
          key: 'Total_Leads_Frios',
          label: 'Total leads fríos',
          description: 'Número total de leads en la base fría',
          compute: ctx => ({ value: formatKpiNumber(ctx.total) })
        },
        {
          key: 'Leads_Reimpactados',
          label: 'Leads reimpactados',
          description: 'Cantidad de leads fríos a los que se intentó contactar nuevamente',
          compute: ctx => {
            const ratio = safeDivide(ctx.reimpactados, ctx.total);
            return {
              value: formatKpiNumber(ctx.reimpactados),
              extra: ratio !== null ? `${formatKpiPercent(ratio)} del total` : ''
            };
          }
        },
        {
          key: 'Porcentaje_Reimpactados',
          label: '% reimpactados',
          description: 'Leads reimpactados / Leads fríos totales',
          compute: ctx => {
            const ratio = safeDivide(ctx.reimpactados, ctx.total);
            return {
              value: ratio !== null ? formatKpiPercent(ratio) : '—',
              note: ratio === null ? 'Se requieren leads cargados para calcular el porcentaje.' : ''
            };
          }
        },
        {
          key: 'Leads_Descartados',
          label: 'Leads descartados',
          description: 'Cantidad y % de leads con datos falsos, sin interés o imposibles de recuperar',
          compute: ctx => {
            const ratio = safeDivide(ctx.descartados, ctx.total);
            return {
              value: formatKpiNumber(ctx.descartados),
              extra: ratio !== null ? `${formatKpiPercent(ratio)} del total` : ''
            };
          }
        }
      ]
    },
    Reactivacion: {
      label: 'Reactivación',
      description: 'Impacto de la segunda vuelta y el interés recuperado.',
      metrics: [
        {
          key: 'Leads_Reactivados',
          label: 'Leads reactivados',
          description: 'Leads que respondieron o mostraron interés en la segunda vuelta',
          compute: ctx => {
            const ratio = safeDivide(ctx.reactivados, ctx.reimpactados);
            return {
              value: formatKpiNumber(ctx.reactivados),
              extra: ratio !== null ? `${formatKpiPercent(ratio)} de reimpactados` : '',
              note: ctx.reimpactados ? '' : 'Aún no hay leads reimpactados en la base.'
            };
          }
        },
        {
          key: 'Porcentaje_Reactivados',
          label: '% reactivados',
          description: 'Leads reactivados / Leads reimpactados',
          compute: ctx => {
            const ratio = safeDivide(ctx.reactivados, ctx.reimpactados);
            return {
              value: ratio !== null ? formatKpiPercent(ratio) : '—',
              note: ratio === null ? 'Necesitas leads reimpactados para obtener este porcentaje.' : ''
            };
          }
        },
        {
          key: 'Tasa_Respuesta',
          label: 'Tasa de respuesta',
          description: '% de leads que responden en la segunda vuelta',
          compute: ctx => {
            const ratio = safeDivide(ctx.responded, ctx.reimpactados);
            return {
              value: ratio !== null ? formatKpiPercent(ratio) : '—',
              note: ratio === null ? 'Se requieren leads reimpactados para medir la respuesta.' : ''
            };
          }
        }
      ]
    },
    Conversion: {
      label: 'Conversión',
      description: 'Proporción de leads fríos que avanzan a etapas clave.',
      metrics: [
        {
          key: 'Conversion_Frios_Interesados',
          label: 'Fríos a interesados',
          description: '% de leads fríos que avanzan a interesados',
          compute: ctx => {
            const ratio = safeDivide(ctx.interesados, ctx.total);
            return {
              value: ratio !== null ? formatKpiPercent(ratio) : '—',
              note: ratio === null ? 'Carga leads para estimar la conversión.' : ''
            };
          }
        },
        {
          key: 'Conversion_Frios_Inscritos',
          label: 'Fríos a inscritos',
          description: '% de leads fríos que terminan inscritos',
          compute: ctx => {
            const ratio = safeDivide(ctx.inscritos, ctx.total);
            return {
              value: ratio !== null ? formatKpiPercent(ratio) : '—',
              note: ratio === null ? 'Aún no hay leads para calcular la conversión.' : ''
            };
          }
        },
        {
          key: 'Conversion_Por_Etapa',
          label: 'Avance por etapa',
          description: 'Porcentaje de avance en cada etapa del embudo de reactivación',
          compute: ctx => {
            const etapaRatios = [
              { label: 'Reimpactación', value: safeDivide(ctx.reimpactados, ctx.total) },
              { label: 'Respuesta', value: safeDivide(ctx.responded, ctx.reimpactados) },
              { label: 'Interés', value: safeDivide(ctx.reactivados, ctx.responded) },
              { label: 'Inscripción', value: safeDivide(ctx.inscritos, ctx.reactivados) }
            ];
            return {
              value: ctx.total ? formatKpiPercent(safeDivide(ctx.responded, ctx.total) || 0) : '—',
              extra: ctx.total ? 'Respondieron del total' : '',
              list: etapaRatios.map(step => `${step.label}: ${step.value !== null ? formatKpiPercent(step.value) : '—'}`)
            };
          }
        }
      ]
    },
    Eficiencia_Operativa: {
      label: 'Eficiencia operativa',
      description: 'Esfuerzo necesario para reimpactar la base fría.',
      metrics: [
        {
          key: 'Tiempo_Promedio_Contacto',
          label: 'Tiempo promedio de contacto',
          description: 'Tiempo promedio para volver a contactar a un lead frío',
          compute: () => ({ value: '—', note: 'Pendiente de integrar tiempos de gestión desde CRM.' })
        },
        {
          key: 'Intentos_Promedio_Por_Lead',
          label: 'Intentos por lead',
          description: 'Cantidad de intentos de contacto necesarios para obtener respuesta',
          compute: () => ({ value: '—', note: 'Requiere registrar los intentos de contacto por lead.' })
        },
        {
          key: 'Distribucion_Intentos',
          label: 'Distribución de intentos',
          description: 'Porcentaje de leads que requirieron 1, 2 o más intentos',
          compute: () => ({ value: '—', note: 'Disponible al capturar los intentos de contacto en CRM.' })
        }
      ]
    },
    Rendimiento_Asesores: {
      label: 'Rendimiento de asesores',
      description: 'Seguimiento de la gestión por asesor en segunda vuelta.',
      metrics: [
        {
          key: 'Leads_Reimpactados_Por_Asesor',
          label: 'Leads reimpactados por asesor',
          description: 'Cantidad de leads fríos gestionados por cada asesor',
          compute: ctx => {
            const top = ctx.asesorList
              .filter(item => item.reimpactados > 0)
              .sort((a, b) => b.reimpactados - a.reimpactados)
              .slice(0, 3);
            if(!top.length){
              return { value: '—', note: 'Aún no hay leads reimpactados asignados a asesores.' };
            }
            return {
              value: formatKpiNumber(top[0].reimpactados),
              extra: `Mejor: ${top[0].name}`,
              list: top.map(item => `${item.name}: ${formatKpiNumber(item.reimpactados)} leads`)
            };
          }
        },
        {
          key: 'Conversion_Asesor',
          label: 'Conversión por asesor',
          description: 'Tasa de conversión por asesor en segunda vuelta',
          compute: ctx => {
            const top = ctx.asesorList
              .filter(item => item.reimpactados > 0)
              .map(item => ({
                name: item.name,
                ratio: safeDivide(item.inscritos, item.reimpactados),
                inscritos: item.inscritos
              }))
              .filter(item => item.inscritos > 0 || (item.ratio !== null && item.ratio > 0))
              .sort((a, b) => (b.ratio || 0) - (a.ratio || 0))
              .slice(0, 3);
            if(!top.length){
              return { value: '—', note: 'No hay inscripciones registradas por asesor.' };
            }
            const best = top[0];
            return {
              value: best.ratio !== null ? formatKpiPercent(best.ratio) : '—',
              extra: `Mejor: ${best.name}`,
              list: top.map(item => `${item.name}: ${item.ratio !== null ? formatKpiPercent(item.ratio) : '—'} · ${formatKpiNumber(item.inscritos)} inscritos`)
            };
          }
        },
        {
          key: 'Tiempo_Respuesta_Asesor',
          label: 'Tiempo de respuesta',
          description: 'Tiempo promedio de cada asesor en retomar un lead frío',
          compute: () => ({ value: '—', note: 'Se integrará cuando el CRM comparta tiempos de respuesta por asesor.' })
        }
      ]
    },
    Salud_Base: {
      label: 'Salud de la base',
      description: 'Cobertura de la base fría disponible en CRM.',
      metrics: [
        {
          key: 'Tamaño_Base_Fria',
          label: 'Tamaño base fría',
          description: 'Número total de leads fríos en CRM',
          compute: ctx => ({ value: formatKpiNumber(ctx.total) })
        },
        {
          key: 'Porcentaje_Base_Trabajada',
          label: '% base trabajada',
          description: '% de la base fría ya gestionada en segunda vuelta',
          compute: ctx => {
            const ratio = safeDivide(ctx.reimpactados, ctx.total);
            return {
              value: ratio !== null ? formatKpiPercent(ratio) : '—',
              note: ratio === null ? 'Carga leads para conocer el avance.' : ''
            };
          }
        },
        {
          key: 'Porcentaje_Base_Pendiente',
          label: '% base pendiente',
          description: '% de la base fría aún sin reimpactar',
          compute: ctx => {
            const ratio = safeDivide(ctx.basePendiente, ctx.total);
            return {
              value: ratio !== null ? formatKpiPercent(ratio) : '—',
              note: ratio === null ? 'Sin leads cargados para evaluar el pendiente.' : ''
            };
          }
        }
      ]
    },
    ROI: {
      label: 'ROI de reactivación',
      description: 'Relación entre inscripciones logradas y el esfuerzo de reimpacto.',
      metrics: [
        {
          key: 'ROI_Reactivacion',
          label: 'ROI reactivación',
          description: 'Inscripciones obtenidas de leads fríos / costo y esfuerzo de reimpacto',
          compute: () => ({ value: '—', note: 'Pendiente de integrar costos y horas invertidas en la reactivación.' })
        }
      ]
    }
  };

  const KPI_ROLE_GROUPS = {
    admin: Object.keys(KPI_GROUPS),
    coordinador: Object.keys(KPI_GROUPS),
    asesor: ['Base_Fria','Reactivacion','Conversion','Eficiencia_Operativa','Rendimiento_Asesores','Salud_Base'],
    viewer: ['Base_Fria','Reactivacion','Conversion','Salud_Base']
  };

  const STORAGE_KEYS = {
    profile: 'pulseProfile',
    preferences: 'pulsePreferences',
    password: 'pulsePasswordRequest'
  };
  const DEFAULT_PASSWORD_REQUEST = {
    status: 'idle',
    requestedAt: 0,
    requestedBy: '',
    approvedAt: 0,
    approvedBy: '',
    completedAt: 0,
    completedBy: ''
  };
  const DEFAULT_LOGIN_HINT = '¿Olvidaste tu contraseña?';
  const DEFAULT_RESET_HINT = 'La contraseña temporal se muestra una sola vez. Cámbiala desde Configuración después de entrar.';
  const DEFAULT_PROFILE = {
    userId: '',
    name: '',
    email: '',
    role: '',
    campus: '',
    avatar: '',
    syncedAt: 0,
    sourceUpdatedAt: 0,
    sourceLabel: 'Directorio maestro'
  };
  const DEFAULT_PREFERENCES = {
    theme: 'system',
    language: 'es',
    density: 'comfortable',
    accent: 'blue',
    eco: false,
    reducedMotion: false,
    largeText: false,
    boardDensity: 'standard',
    highContrast: false,
    showLeadId: false,
    appliedPreset: ''
  };
  const ACCENT_PALETTES = {
    blue: { primary: '#003a5f', secondary: '#8a9ca3', panel: '37,99,235' },
    green: { primary: '#047857', secondary: '#22c55e', panel: '5,150,105' },
    purple: { primary: '#6d28d9', secondary: '#a855f7', panel: '124,58,237' },
    orange: { primary: '#b45309', secondary: '#f97316', panel: '180,83,9' },
    teal: { primary: '#0f766e', secondary: '#14b8a6', panel: '15,118,110' },
    pink: { primary: '#be185d', secondary: '#f472b6', panel: '190,24,93' }
  };
  const VIEW_PERMISSIONS = {
    kpis: ['admin','coordinador','asesor','viewer'],
    leads: ['admin','coordinador','asesor','viewer'],
    importar: ['admin','coordinador'],
    exportar: ['admin','coordinador','viewer'],
    sistema: ['admin','coordinador','viewer'],
    permisos: ['admin'],
    configuracion: ['admin','coordinador','asesor','viewer'],
    ayuda: ['admin','coordinador','asesor','viewer']
  };
  const ACTION_PERMISSIONS = {
    updateLead: ['admin','coordinador','asesor'],
    importData: ['admin','coordinador'],
    exportData: ['admin','coordinador','viewer'],
    runDiagnostics: ['admin'],
    manageDuplicates: ['admin'],
    repairSheetStructure: ['admin'],
    syncActivos: ['admin','coordinador'],
    manageTeams: ['admin']
  };
  const ROLE_LABELS = {
    admin: 'Administrador',
    coordinador: 'Coordinador',
    asesor: 'Asesor',
    viewer: 'Consulta'
  };
  const ROLE_ORDER = ['admin','coordinador','asesor','viewer'];
  const PERMISSION_REFERENCE = {
    roles: [
      { action: 'Ver KPIs (kpi.view)', admin: 'Global', coordinador: 'Equipo/Planteles asignados', asesor: 'Propios', viewer: 'Global (sin PII)' },
      { action: 'Ver leads (lead.read)', admin: 'Global', coordinador: 'Equipo/Planteles asignados', asesor: 'Propios', viewer: 'Agregado (sin PII)' },
      { action: 'Tipificar leads (lead.typify)', admin: 'Global', coordinador: 'Equipo', asesor: 'Propios', viewer: 'Ninguno' },
      { action: 'Ver datos de contacto (contact.view)', admin: 'Global', coordinador: 'Equipo', asesor: 'Propios', viewer: 'Ninguno' },
      { action: 'Importar datos (data.import)', admin: 'Global', coordinador: 'Equipo/Planteles asignados', asesor: 'Ninguno', viewer: 'Ninguno' },
      { action: 'Cambios masivos (data.bulk_update)', admin: 'Global', coordinador: 'Ninguno', asesor: 'Ninguno', viewer: 'Ninguno' },
      { action: 'Exportar datos (data.export)', admin: 'Global', coordinador: 'Equipo (acotado)', asesor: 'Ninguno', viewer: 'Ninguno' },
      { action: 'Exportar reportes (report.export)', admin: 'Global', coordinador: 'Equipo (acotado)', asesor: 'Ninguno', viewer: 'Ninguno' },
      { action: 'Generar diagnósticos (system.diagnostics)', admin: 'Global', coordinador: 'Ninguno', asesor: 'Ninguno', viewer: 'Ninguno' },
      { action: 'Eliminar duplicados (lead.merge_duplicates)', admin: 'Global', coordinador: 'Ninguno', asesor: 'Ninguno', viewer: 'Ninguno' },
      { action: 'Gestión de usuarios (user.manage)', admin: 'Global', coordinador: 'Ninguno', asesor: 'Ninguno', viewer: 'Ninguno' },
      { action: 'Asignar roles (role.assign)', admin: 'Global', coordinador: 'Ninguno', asesor: 'Ninguno', viewer: 'Ninguno' },
      { action: 'Asignar planteles/bases (scope.assign)', admin: 'Global', coordinador: 'Equipo', asesor: 'Ninguno', viewer: 'Ninguno' },
      { action: 'Creación y asignación de equipos (team.manage)', admin: 'Global', coordinador: 'Ninguno', asesor: 'Ninguno', viewer: 'Ninguno' }
    ],
    rules: [
      'Viewer no puede acceder a PII ni métodos de contacto.',
      'Asesor solo ve y edita sus propios leads.',
      'Coordinador puede operar únicamente sobre su equipo y planteles/bases asignadas.',
      'Admin tiene control global de todas las acciones y recursos.',
      'Exportaciones deben ser auditadas (registro de usuario, filtros y fecha).',
      'Cambios masivos y eliminación de duplicados requieren confirmación adicional.',
      'La selección de “Todas” en Bases o “Todos” en Planteles equivale a acceso global sin restricciones.'
    ],
    bases: {
      values: ['Todas','Planteles','Regresos','Reciclados','Rescatados'],
      note: 'Seleccionar “Todas” en Bases otorga acceso global a todas las bases.'
    },
    planteles: {
      values: ['Todos','HERMOSILLO','AGUA PRIETA','NOGALES','OBREGÓN','CULIACÁN','MAZATLÁN','CHIHUAHUA','ZACATECAS','TORREON','LA PAL','SALTILLO','TIJUANA','ENSENADA','MEXICALI','AGUASCALIENTES','QUERÉTARO','LOS CABOS','PUERTO PEÑASCO','ALTAMIRA','CD. MANTE','ZIHUATANEJO','LÁZARO CÁRDENAS','TUXPAN','CD. DEL CARMEN','VERACRUZ','ACAPULCO','SAN MIGUEL DE ALLENDE','TULA','HUICHAPAN','CANANEA','TEOCALTICHE','ONLINE','SENADO DE LA REPÚBLICA','PACHUCA'],
      note: 'Seleccionar “Todos” en Planteles otorga acceso global a todos los planteles.'
    }
  };
  const ROLE_SCOPE_HINTS = {
    admin: 'Acceso global a todas las acciones, planteles y bases.',
    coordinador: 'Opera sobre su equipo y los planteles/bases asignadas.',
    asesor: 'Gestiona únicamente los leads y contactos asignados a su usuario.',
    viewer: 'Consulta global sin exponer datos personales identificables.'
  };
  const PERMISSION_SCOPE_CONFIG = {
    planteles: {
      container: '#permPlantelesSelect',
      input: '#permPlanteles',
      options: PERMISSION_REFERENCE.planteles.values,
      globalValue: 'Todos',
      placeholder: 'Selecciona planteles',
      summarySingular: 'plantel',
      summaryPlural: 'planteles'
    },
    bases: {
      container: '#permBasesSelect',
      input: '#permBases',
      options: PERMISSION_REFERENCE.bases.values,
      globalValue: 'Todas',
      placeholder: 'Selecciona bases',
      summarySingular: 'base',
      summaryPlural: 'bases'
    },
    teamPlanteles: {
      container: '#teamPlantelesSelect',
      input: '#teamPlanteles',
      options: PERMISSION_REFERENCE.planteles.values,
      globalValue: 'Todos',
      placeholder: 'Selecciona planteles',
      summarySingular: 'plantel',
      summaryPlural: 'planteles'
    },
    teamBases: {
      container: '#teamBasesSelect',
      input: '#teamBases',
      options: PERMISSION_REFERENCE.bases.values,
      globalValue: 'Todas',
      placeholder: 'Selecciona bases',
      summarySingular: 'base',
      summaryPlural: 'bases'
    },
    teamMembers: {
      container: '#teamMembersSelect',
      input: '#teamMembers',
      options: [],
      placeholder: 'Selecciona integrantes',
      summarySingular: 'integrante',
      summaryPlural: 'integrantes'
    }
  };
  const ROLE_TEMPLATES = buildRoleTemplates();
  const TEAM_TEMPLATES = [
    {
      id: 'comercial-noroeste',
      name: 'Comercial Noroeste',
      description: 'Planteles frontera y bases de seguimiento activo.',
      planteles: ['HERMOSILLO', 'NOGALES', 'OBREGÓN'],
      bases: ['Planteles', 'Rescatados', 'Regresos'],
      members: ['coord.noroeste', 'asesor.nogales']
    },
    {
      id: 'fuerza-online',
      name: 'Fuerza Online',
      description: 'Operación digital con foco en reciclados y rescates.',
      planteles: ['ONLINE'],
      bases: ['Reciclados', 'Rescatados'],
      members: ['coord.online']
    }
  ];
  const INSTITUTIONAL_PRESETS = [
    {
      id: 'institucional-diurno',
      name: 'Institucional Diurno',
      description: 'Tema claro, densidad cómoda, modo eco activo y contraste alto para pisos comerciales.',
      values: { theme: 'light', density: 'comfortable', eco: true, highContrast: true }
    },
    {
      id: 'institucional-nocturno',
      name: 'Institucional Nocturno',
      description: 'Tema oscuro, densidad compacta y contraste normal para guardias vespertinas.',
      values: { theme: 'dark', density: 'compact', eco: false, highContrast: false }
    }
  ];
  let permissionMultiSelectsInitialized = false;
  const permissionMultiSelects = {};
  const permissionScopeDirty = {};

  function buildRoleTemplates(){
    const plantelOptions = Array.isArray(PERMISSION_REFERENCE?.planteles?.values) ? PERMISSION_REFERENCE.planteles.values.slice() : [];
    const baseOptions = Array.isArray(PERMISSION_REFERENCE?.bases?.values) ? PERMISSION_REFERENCE.bases.values.slice() : [];
    const normalize = value => (value || '').toString().trim().toLowerCase();
    const globalPlantel = PERMISSION_SCOPE_CONFIG?.planteles?.globalValue || 'Todos';
    const globalBase = PERMISSION_SCOPE_CONFIG?.bases?.globalValue || 'Todas';
    const localPlanteles = plantelOptions.filter(value => normalize(value) && normalize(value) !== normalize(globalPlantel));
    const localBases = baseOptions.filter(value => normalize(value) && normalize(value) !== normalize(globalBase));
    const ensureValues = (values, fallback = []) => {
      const list = Array.from(new Set((values || []).filter(Boolean)));
      if(list.length) return list;
      return Array.from(new Set((fallback || []).filter(Boolean)));
    };
    const defaultPlanteles = ensureValues(localPlanteles.slice(0, 3), plantelOptions.slice(0, 3));
    const defaultBases = ensureValues(localBases.slice(0, 3), baseOptions.slice(0, 3));
    return {
      admin: {
        description: 'Aplica acceso total para supervisar equipos, reportes y catálogos sin restricciones.',
        planteles: ensureValues([globalPlantel], plantelOptions.slice(0, 1)),
        bases: ensureValues([globalBase], baseOptions.slice(0, 1))
      },
      coordinador: {
        description: 'Agrupa planteles y bases de su región para liderar la operación y monitorear a su equipo.',
        planteles: ensureValues(['HERMOSILLO', 'NOGALES', 'OBREGÓN'].filter(value => plantelOptions.includes(value)), defaultPlanteles),
        bases: ensureValues(['Planteles', 'Regresos', 'Rescatados'].filter(value => baseOptions.includes(value)), defaultBases)
      },
      asesor: {
        description: 'Limita el alcance al plantel principal y a bases activas de seguimiento diario.',
        planteles: ensureValues(localPlanteles.slice(0, 1), defaultPlanteles.slice(0, 1)),
        bases: ensureValues(['Planteles', 'Reciclados'].filter(value => baseOptions.includes(value)), defaultBases.slice(0, 1))
      },
      viewer: {
        description: 'Monitorea resultados institucionales sin exponer datos personales ni modificar información.',
        planteles: ensureValues([globalPlantel], plantelOptions.slice(0, 1)),
        bases: ensureValues([globalBase], baseOptions.slice(0, 1))
      }
    };
  }
  const AUTH_STORAGE_KEY = 'pulseAuthState';
  let authToken = '';
  let currentUser = null;
  let hasBound = false;
  let userProfile = loadStoredProfile();
  let userPreferences = loadStoredPreferences();
  let passwordRequestState = loadStoredPasswordRequest();
  let pendingResetCredentials = null;
  let lastLoginEmail = '';
  let settingsReady = false;
  let settingsStatusTimer = null;
  const systemThemeQuery = window.matchMedia('(prefers-color-scheme: dark)');
  if(typeof systemThemeQuery.addEventListener === 'function'){
    systemThemeQuery.addEventListener('change', handleSystemThemeChange);
  }else if(typeof systemThemeQuery.addListener === 'function'){
    systemThemeQuery.addListener(handleSystemThemeChange);
  }
  applyPreferences();

  const ensureFormatModule = () => {
    if(window.ReLeadDataFormat && typeof window.ReLeadDataFormat.cleanValue === 'function'){
      return window.ReLeadDataFormat;
    }
    const fallbackCleanValue = val => {
      if(val === undefined || val === null) return '';
      if(typeof val === 'string') return val.trim();
      return String(val).trim();
    };
    const fallbackParseNumericValue = value => {
      if(value === null || value === undefined) return NaN;
      if(typeof value === 'number') return Number.isFinite(value) ? value : NaN;
      if(Array.isArray(value)) return value.length;
      if(typeof value === 'object'){
        if('total' in value && value.total !== value){
          const total = fallbackParseNumericValue(value.total);
          if(Number.isFinite(total)) return total;
        }
        if('count' in value && value.count !== value){
          const count = fallbackParseNumericValue(value.count);
          if(Number.isFinite(count)) return count;
        }
        if('value' in value && value.value !== value){
          const nested = fallbackParseNumericValue(value.value);
          if(Number.isFinite(nested)) return nested;
        }
        if('valor' in value && value.valor !== value){
          const nested = fallbackParseNumericValue(value.valor);
          if(Number.isFinite(nested)) return nested;
        }
        if(Array.isArray(value.registros)) return value.registros.length;
      }
      const text = fallbackCleanValue(value);
      if(!text) return NaN;
      const match = text.match(/-?\d+(?:[.,]\d+)?/);
      if(!match) return NaN;
      const normalized = match[0].replace(',','.');
      const num = Number(normalized);
      return Number.isFinite(num) ? num : NaN;
    };
    const fallbackFormatModule = window.ReLeadDataFormat = {
      cleanValue: fallbackCleanValue,
      parseNumericValue: fallbackParseNumericValue,
      formatLosgDateTime: value => {
        if(value === null || value === undefined || value === '') return '';
        if(Array.isArray(value)){
          const first = value.find(item => item !== undefined && item !== null);
          return first !== undefined ? fallbackFormatModule.formatLosgDateTime(first) : '';
        }
        if(value instanceof Date){
          if(Number.isNaN(value.valueOf())) return '';
          return value.toISOString().replace('T',' ').slice(0,16);
        }
        if(typeof value === 'object'){
          const candidate = ['fecha','date','datetime','timestamp','inicio','start','hora','time','first','last']
            .map(key => value[key])
            .find(val => val !== undefined && val !== null && val !== '');
          if(candidate !== undefined){
            return fallbackFormatModule.formatLosgDateTime(candidate);
          }
        }
        const text = fallbackCleanValue(value);
        if(!text) return '';
        const parsed = new Date(text);
        if(Number.isNaN(parsed.valueOf())) return text;
        return parsed.toISOString().replace('T',' ').slice(0,16);
      },
      formatLosgList: value => {
        if(value === null || value === undefined) return '';
        if(Array.isArray(value)){
          return value.map(item => fallbackFormatModule.formatLosgList(item)).filter(Boolean).join(' | ');
        }
        if(value instanceof Date){
          return fallbackFormatModule.formatLosgDateTime(value);
        }
        if(typeof value === 'object'){
          const name = fallbackCleanValue(value.name || value.nombre || value.displayName || value.usuario || value.user || value.title);
          const email = fallbackCleanValue(value.email || value.correo || value.mail);
          const role = fallbackCleanValue(value.role || value.rol || value.perfil);
          const descriptor = fallbackCleanValue(value.descripcion || value.description || value.detalle || value.detail || value.etiqueta || value.label || value.tipo || value.action || value.accion || value.resumen);
          const target = fallbackCleanValue(value.destino || value.target || value.asignado || value.asignadoA || value.para || value.to || value.recipient);
          const parts = [];
          if(descriptor && target){
            parts.push(`${descriptor} → ${target}`);
          }else{
            if(descriptor) parts.push(descriptor);
            if(target) parts.push(target);
          }
          if(name) parts.push(name);
          if(role) parts.push(role);
          if(email) parts.push(email);
          if(!parts.length){
            const values = Object.values(value).map(fallbackCleanValue).filter(Boolean);
            if(values.length){
              return values.join(' / ');
            }
          }
          return parts.join(' · ');
        }
        return fallbackCleanValue(value);
      },
      formatLosgAssignments: value => {
        if(value === null || value === undefined) return '';
        if(Array.isArray(value)){
          return value.map(item => fallbackFormatModule.formatLosgAssignments(item)).filter(Boolean).join(' | ');
        }
        if(typeof value === 'object'){
          const permiso = fallbackCleanValue(value.permiso || value.permission || value.tipo || value.scope || value.descripcion || value.description);
          const destinatario = fallbackCleanValue(value.usuario || value.user || value.destino || value.target || value.asignado || value.asignadoA || value.para || value.to || value.nombre);
          const detalle = fallbackCleanValue(value.detalle || value.detail || value.resumen || value.notes || value.resultado);
          const parts = [];
          if(permiso) parts.push(permiso);
          if(destinatario) parts.push(`→ ${destinatario}`);
          if(detalle) parts.push(`(${detalle})`);
          const text = parts.filter(Boolean).join(' ');
          if(text) return text.trim();
          return fallbackFormatModule.formatLosgList(value);
        }
        return fallbackCleanValue(value);
      },
      formatLosgNumber: value => {
        if(value === null || value === undefined) return '';
        if(value instanceof Date) return fallbackFormatModule.formatLosgDateTime(value);
        if(typeof value === 'number' && Number.isFinite(value)) return String(value);
        const numeric = fallbackParseNumericValue(value);
        if(Number.isFinite(numeric)) return String(numeric);
        if(typeof value === 'object') return fallbackFormatModule.formatLosgList(value);
        const text = fallbackCleanValue(value);
        if(!text) return '';
        const num = Number(text);
        return Number.isFinite(num) ? String(num) : text;
      },
      normalizeLosgEntry: raw => {
        if(!raw || typeof raw !== 'object') return null;
        const lowerMap = new Map();
        Object.keys(raw).forEach(key => {
          lowerMap.set(String(key || '').toLowerCase(), raw[key]);
        });
        const pick = (...keys) => {
          for(const key of keys){
            if(!key) continue;
            const normalized = String(key).toLowerCase();
            if(lowerMap.has(normalized)){
              return lowerMap.get(normalized);
            }
          }
          return undefined;
        };
        const rawTotal = pick('accesos','conexiones','logins','login_count','entradas','ingresos','visitas','sesiones');
        const rawMobile = pick('moviles','mobile','mobilelogins','dispositivosmoviles','accesosmoviles');
        const rawDesktop = pick('escritorio','desktop','desktoplogins','dispositivosescritorio','accesosescritorio');
        const totalNumeric = fallbackParseNumericValue(rawTotal);
        const mobileNumeric = fallbackParseNumericValue(rawMobile);
        const desktopNumeric = fallbackParseNumericValue(rawDesktop);
        const horariosRaw = pick('horarios','horas','times','session_times','sesiones','schedule');
        let deviceSummary = fallbackFormatModule.formatLosgList(pick('dispositivos','devices','device_types','tipodispositivo','tiposdispositivo','origenes'));
        if(!deviceSummary){
          const pieces = [];
          if(Number.isFinite(mobileNumeric) && mobileNumeric > 0){
            pieces.push(`Móvil${mobileNumeric > 1 ? ` (${mobileNumeric})` : ''}`);
          }
          if(Number.isFinite(desktopNumeric) && desktopNumeric > 0){
            pieces.push(`Escritorio${desktopNumeric > 1 ? ` (${desktopNumeric})` : ''}`);
          }
          if(!pieces.length && Number.isFinite(totalNumeric) && totalNumeric > 0){
            pieces.push(totalNumeric === 1 ? 'Único acceso' : 'Múltiples dispositivos');
          }
          deviceSummary = pieces.join(' · ');
        }
        const normalized = {
          fecha: fallbackFormatModule.formatLosgDateTime(pick('fecha','date','dia','day')),
          usuario: fallbackFormatModule.formatLosgList(pick('usuario','user','nombre','name','displayname')),
          correo: fallbackFormatModule.formatLosgList(pick('correo','email','mail','correo_institucional')),
          rol: fallbackFormatModule.formatLosgList(pick('rol','role','perfil')),
          total_accesos: fallbackFormatModule.formatLosgNumber(rawTotal),
          primer_acceso: fallbackFormatModule.formatLosgDateTime(pick('primeracceso','firstlogin','primeravez','first_seen','inicio','primer_ingreso','primeraconexion')),
          ultimo_acceso: fallbackFormatModule.formatLosgDateTime(pick('ultimoacceso','lastlogin','ultimavez','last_seen','final','ultimo_ingreso','ultimaconexion')),
          accesos_moviles: fallbackFormatModule.formatLosgNumber(rawMobile),
          accesos_escritorio: fallbackFormatModule.formatLosgNumber(rawDesktop),
          dispositivos: deviceSummary,
          horarios: fallbackFormatModule.formatLosgList(horariosRaw),
          importaciones: fallbackFormatModule.formatLosgNumber(pick('importaciones','imports','import_count','accionesimportacion','importactivity')),
          exportaciones: fallbackFormatModule.formatLosgNumber(pick('exportaciones','exports','export_count','accionesexportacion','exportactivity')),
          cambios_masivos: fallbackFormatModule.formatLosgNumber(pick('cambiosmasivos','massupdates','bulkupdates','bulk','bulk_count','movimientosmasivos','actualizacionesmasivas')),
          diagnosticos: fallbackFormatModule.formatLosgNumber(pick('diagnosticos','diagnostics','diagnostics_count','ejecucionesdiagnostico','diagnosticosrealizados')),
          resultado_diagnostico: fallbackFormatModule.formatLosgList(pick('resultadodiagnostico','diagnostics_result','diagnosticosresultado','diagnosticos_resumen','diagnosticosdetalle','diagnosticresult')),
          permisos_asignados: fallbackFormatModule.formatLosgAssignments(pick('permisosasignados','permisos','permissions','permission_changes','permission_assignments')),
          planteles_asignados: fallbackFormatModule.formatLosgAssignments(pick('plantelasignado','planteles','campus','planteles_asignados','campus_assignments'))
        };
        const hasData = Object.values(normalized).some(value => fallbackCleanValue(value));
        return hasData ? normalized : null;
      }
    };
    return fallbackFormatModule;
  };
  const dataFormat = ensureFormatModule();
  const { cleanValue, parseNumericValue, formatLosgDateTime, formatLosgList, formatLosgAssignments, formatLosgNumber, normalizeLosgEntry } = dataFormat;

  function pickField(map, preferredKeys = [], fallbackPredicate){
    const visited = new Set();
    for(const key of preferredKeys){
      if(!key) continue;
      visited.add(key);
      const value = cleanValue(map[key]);
      if(value) return value;
    }
    if(typeof fallbackPredicate === 'function'){
      for(const key of Object.keys(map)){
        if(visited.has(key)) continue;
        const value = cleanValue(map[key]);
        if(!value) continue;
        if(!fallbackPredicate(key, value, map)) continue;
        return value;
      }
    }
    return '';
  }
  // —— Estado UI ——
  const createInitialState = () => ({
    query:"",
    sheet:"",
    asesor:[],
    campus:"",
    sort:{ key:null, dir:1 },
    page:0,
    pageSize:30,
    colFilters:Object.fromEntries(columns.map(k=>[k,''])),
    mobileColumns:{},
    columnLimits:{},
    columnLimitSignature:''
  });
  let state = createInitialState();
  const boardMobileQuery = window.matchMedia('(max-width: 700px)');
  const COLUMN_INITIAL_BATCH = 60;
  const COLUMN_BATCH_SIZE = 40;
  const ensureColumnLimitState = () => {
    if(!state.columnLimits || typeof state.columnLimits !== 'object'){
      state.columnLimits = {};
    }
    return state.columnLimits;
  };
  const getColumnLimit = (step, totalItems) => {
    const limits = ensureColumnLimitState();
    const total = Number.isFinite(totalItems) ? totalItems : 0;
    if(total <= 0){
      limits[step] = 0;
      return 0;
    }
    const current = limits[step];
    if(typeof current === 'number' && current > 0){
      return Math.min(total, current);
    }
    const initial = Math.min(total, COLUMN_INITIAL_BATCH);
    limits[step] = initial;
    return initial;
  };
  const increaseColumnLimit = (step, totalItems) => {
    const limits = ensureColumnLimitState();
    const total = Number.isFinite(totalItems) ? totalItems : 0;
    if(total <= 0){
      limits[step] = 0;
      return 0;
    }
    const current = typeof limits[step] === 'number' ? limits[step] : getColumnLimit(step, total);
    const next = Math.min(total, current + COLUMN_BATCH_SIZE);
    limits[step] = next;
    return next;
  };
  const pruneColumnLimits = rows => {
    const limits = ensureColumnLimitState();
    const counts = etapasUI.reduce((acc, step) => { acc[step] = 0; return acc; }, {});
    rows.forEach(row => {
      const label = etapaGroup(row.etapa);
      if(Object.prototype.hasOwnProperty.call(counts, label)){
        counts[label] += 1;
      }
    });
    Object.keys(limits).forEach(step => {
      if(!Object.prototype.hasOwnProperty.call(counts, step)){
        delete limits[step];
        return;
      }
      const total = counts[step];
      if(total <= 0){
        limits[step] = 0;
        return;
      }
      if(typeof limits[step] !== 'number' || limits[step] <= 0){
        limits[step] = Math.min(total, COLUMN_INITIAL_BATCH);
      }else if(limits[step] > total){
        limits[step] = total;
      }
    });
    etapasUI.forEach(step => {
      if(!Object.prototype.hasOwnProperty.call(counts, step)) return;
      if(!Object.prototype.hasOwnProperty.call(limits, step)){
        limits[step] = Math.min(counts[step], COLUMN_INITIAL_BATCH);
      }
    });
  };
  const getAsesorFilter = () => {
    const value = state.asesor;
    if(Array.isArray(value)){
      return value.filter(v => typeof v === 'string' && v.trim());
    }
    if(!value) return [];
    return [String(value).trim()].filter(Boolean);
  };
  const setAsesorFilter = values => {
    if(!values){
      state.asesor = [];
      return;
    }
    if(Array.isArray(values)){
      const seen = new Set();
      state.asesor = values
        .map(v => String(v || '').trim())
        .filter(v => {
          if(!v) return false;
          if(seen.has(v)) return false;
          seen.add(v);
          return true;
        });
      return;
    }
    const value = String(values || '').trim();
    state.asesor = value ? [value] : [];
  };

  function loadStoredAuthState(){
    try{
      const raw = localStorage.getItem(AUTH_STORAGE_KEY);
      if(!raw) return { token:'', user:null };
      const parsed = JSON.parse(raw);
      if(parsed && typeof parsed === 'object'){
        return { token: parsed.token || '', user: parsed.user || null };
      }
    }catch(err){
      console.warn('No se pudo leer el estado de autenticación.', err);
    }
    return { token:'', user:null };
  }

  function formatRoleLabel(role){
    const key = String(role || '').trim().toLowerCase();
    return ROLE_LABELS[key] || (key ? key.charAt(0).toUpperCase() + key.slice(1) : 'Sin rol');
  }

  function parseListInput(value){
    if(Array.isArray(value)){
      return value.map(v => String(v || '').trim()).filter(Boolean);
    }
    return String(value || '')
      .split(/[;,\n]/)
      .map(v => v.trim())
      .filter(Boolean);
  }

  function stringifyList(value){
    if(!value) return '';
    if(Array.isArray(value)){
      return value.map(v => String(v || '').trim()).filter(Boolean).join(', ');
    }
    return String(value || '').trim();
  }

  function normalizeScopeValues(values){
    if(!values) return [];
    const list = Array.isArray(values) ? values : parseListInput(values);
    const seen = new Set();
    const out = [];
    list.forEach(item => {
      const value = String(item || '').trim();
      if(!value || seen.has(value)) return;
      seen.add(value);
      out.push(value);
    });
    return out;
  }

  function normalizeScopeToken(value){
    return String(value || '')
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, ' ')
      .trim();
  }

  const GLOBAL_SCOPE_ALIAS_MAP = {
    planteles: new Set(['todos', 'todos los planteles', 'todos los campus', 'todos campus', 'acceso global', 'global', 'global planteles'].map(normalizeScopeToken)),
    bases: new Set(['todas', 'todas las bases', 'todas bases', 'acceso global', 'global', 'global bases'].map(normalizeScopeToken)),
    teamPlanteles: new Set(['todos', 'todos los planteles', 'todos los campus', 'todos campus', 'acceso global', 'global', 'global planteles'].map(normalizeScopeToken)),
    teamBases: new Set(['todas', 'todas las bases', 'todas bases', 'acceso global', 'global', 'global bases'].map(normalizeScopeToken))
  };

  function hasGlobalScopeSelection(field, values, config){
    if(!config || !config.globalValue) return false;
    const aliasSet = GLOBAL_SCOPE_ALIAS_MAP[field] || new Set();
    const normalizedGlobal = normalizeScopeToken(config.globalValue);
    const tokens = normalizeScopeValues(values).map(normalizeScopeToken).filter(Boolean);
    if(!tokens.length) return false;
    if(tokens.includes(normalizedGlobal)) return true;
    return tokens.some(token => aliasSet.has(token));
  }

  function normalizeScopeSelection(field, values, config){
    const list = normalizeScopeValues(values);
    if(!field || !config) return list;
    if(hasGlobalScopeSelection(field, list, config)){
      return [config.globalValue];
    }
    return list;
  }

  function resolveMultiSelectOptions(config){
    if(!config) return [];
    const rawOptions = Array.isArray(config.options) ? config.options : [];
    return rawOptions
      .map(option => {
        if(option && typeof option === 'object'){
          const value = String(option.value ?? '').trim();
          const label = option.label !== undefined ? String(option.label).trim() : value;
          if(!value) return null;
          return { value, label: label || value };
        }
        const value = String(option ?? '').trim();
        if(!value) return null;
        return { value, label: value };
      })
      .filter(Boolean);
  }

  function normalizeTeamId(value){
    return String(value || '')
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .replace(/[^a-zA-Z0-9_-]+/g, '-')
      .replace(/-+/g, '-')
      .replace(/^-+|-+$/g, '')
      .toUpperCase();
  }

  function updatePermissionMultiSelect(field, values){
    const control = permissionMultiSelects[field];
    if(!control) return;
    const { container, button, chips, hidden, menu, config } = control;
    const optionList = control.options && control.options.length ? control.options : resolveMultiSelectOptions(config);
    control.options = optionList;
    const labelMap = new Map();
    optionList.forEach(option => {
      labelMap.set(option.value, option.label || option.value);
    });
    if(config.globalValue){
      labelMap.set(config.globalValue, labelMap.get(config.globalValue) || config.globalValue);
    }
    const allowedSet = new Set(labelMap.keys());
    const normalizedInput = normalizeScopeSelection(field, values, config);
    const normalized = normalizedInput.filter(value => !allowedSet.size || allowedSet.has(value));
    const selectedSet = new Set();
    const finalValues = [];
    if(config.globalValue && normalized.includes(config.globalValue)){
      finalValues.push(config.globalValue);
      selectedSet.add(config.globalValue);
    }else{
      normalized.forEach(value => {
        if(selectedSet.has(value)) return;
        selectedSet.add(value);
        finalValues.push(value);
      });
    }
    if(menu){
      const checkboxSet = new Set(finalValues);
      menu.querySelectorAll('input[type="checkbox"]').forEach(input => {
        input.checked = checkboxSet.has(input.value);
      });
    }
    hidden.value = finalValues.join(', ');
    container.classList.toggle('has-selection', finalValues.length > 0);
    chips.innerHTML = '';
    if(finalValues.length){
      finalValues.forEach(value => {
        const chip = document.createElement('span');
        chip.className = 'multi-select__chip';
        chip.textContent = labelMap.get(value) || value;
        chips.appendChild(chip);
      });
    }else{
      const placeholder = document.createElement('span');
      placeholder.className = 'multi-select__placeholder';
      placeholder.textContent = config.placeholder;
      chips.appendChild(placeholder);
    }
    const buttonText = button.querySelector('.multi-select__button-text');
    if(buttonText){
      let labelText = '';
      if(!finalValues.length){
        labelText = config.placeholder;
      }else if(config.globalValue && finalValues.includes(config.globalValue)){
        labelText = 'Acceso global';
      }else if(finalValues.length === 1){
        labelText = labelMap.get(finalValues[0]) || finalValues[0];
      }else{
        const plural = config.summaryPlural || 'seleccionados';
        labelText = `${finalValues.length} ${plural}`;
      }
      buttonText.textContent = labelText;
    }
    control.selected = finalValues;
  }

  function setPermissionScopeSelection(field, values, options = {}){
    if(!permissionMultiSelectsInitialized){
      initPermissionScopeSelectors();
    }
    const control = permissionMultiSelects[field];
    const baseConfig = control && control.config ? control.config : PERMISSION_SCOPE_CONFIG[field];
    const normalized = normalizeScopeSelection(field, values, baseConfig);
    if(!control){
      if(baseConfig){
        const hidden = el(baseConfig.input);
        if(hidden){
          hidden.value = normalized.join(', ');
        }
      }
      if(!options.preserveDirty){
        markScopeDirty(field, Boolean(options.markDirty));
      }
      return;
    }
    const { menu } = control;
    const config = control.config || baseConfig || {};
    const optionsList = control.options && control.options.length ? control.options : resolveMultiSelectOptions(config);
    control.options = optionsList;
    if(menu){
      menu.querySelectorAll('input[type="checkbox"]').forEach(input => {
        input.checked = false;
      });
    }
    const labelMap = new Map();
    optionsList.forEach(option => {
      labelMap.set(option.value, option.label || option.value);
    });
    if(config.globalValue){
      labelMap.set(config.globalValue, labelMap.get(config.globalValue) || config.globalValue);
    }
    const allowedSet = new Set(labelMap.keys());
    const finalValues = [];
    normalized.forEach(value => {
      if(!allowedSet.size || allowedSet.has(value)){
        if(config.globalValue && value === config.globalValue){
          finalValues.length = 0;
          finalValues.push(config.globalValue);
        }else if(!finalValues.includes(value) && (!config.globalValue || !finalValues.includes(config.globalValue))){
          finalValues.push(value);
        }
      }
    });
    updatePermissionMultiSelect(field, finalValues);
    if(!options.preserveDirty){
      markScopeDirty(field, Boolean(options.markDirty));
    }
  }

  function togglePermissionMultiSelect(field){
    const control = permissionMultiSelects[field];
    if(!control) return;
    const isOpen = !control.container.classList.contains('is-open');
    Object.values(permissionMultiSelects).forEach(ctrl => {
      if(ctrl !== control) closePermissionMultiSelect(ctrl);
    });
    control.container.classList.toggle('is-open', isOpen);
    control.button.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
    if(isOpen){
      control.menu.focus({ preventScroll: true });
    }
  }

  function closePermissionMultiSelect(control){
    const target = typeof control === 'string' ? permissionMultiSelects[control] : control;
    if(!target) return;
    if(target.container.classList.contains('is-open')){
      target.container.classList.remove('is-open');
      target.button.setAttribute('aria-expanded', 'false');
    }
  }

  function setPermissionMultiSelectOptions(field, options){
    if(!permissionMultiSelectsInitialized){
      initPermissionScopeSelectors();
    }
    const control = permissionMultiSelects[field];
    if(!control) return;
    const config = control.config || {};
    config.options = Array.isArray(options) ? options.slice() : [];
    control.config = config;
    const resolvedOptions = resolveMultiSelectOptions(config);
    control.options = resolvedOptions;
    const menu = control.menu;
    if(menu){
      menu.innerHTML = '';
      resolvedOptions.forEach((option, index) => {
        const optionId = `${config.input.replace('#','') || field}-opt-${index}`;
        const optionLabel = document.createElement('label');
        optionLabel.className = 'multi-select__option';
        optionLabel.innerHTML = `
          <input type="checkbox" value="${escapeHtml(option.value)}" id="${escapeHtml(optionId)}">
          <span>${escapeHtml(option.label)}</span>
        `;
        menu.appendChild(optionLabel);
      });
    }
    updatePermissionMultiSelect(field, control.selected || []);
  }

  function markScopeDirty(field, dirty){
    permissionScopeDirty[field] = Boolean(dirty);
    const control = permissionMultiSelects[field];
    if(control && control.container){
      if(dirty){
        control.container.dataset.dirty = 'true';
      }else{
        delete control.container.dataset.dirty;
      }
    }
  }

  function isScopeDirty(field){
    return Boolean(permissionScopeDirty[field]);
  }

  function initPermissionScopeSelectors(){
    if(permissionMultiSelectsInitialized) return;
    permissionMultiSelectsInitialized = true;
    Object.entries(PERMISSION_SCOPE_CONFIG).forEach(([field, config]) => {
      const container = el(config.container);
      const hidden = el(config.input);
      if(!container || !hidden) return;
      const button = container.querySelector('.multi-select__button');
      const menu = container.querySelector('.multi-select__menu');
      const chips = container.querySelector('.multi-select__chips');
      if(!button || !menu || !chips) return;
      const resolvedOptions = resolveMultiSelectOptions(config);
      menu.innerHTML = '';
      resolvedOptions.forEach((option, index) => {
        const optionId = `${config.input.replace('#','') || field}-opt-${index}`;
        const optionLabel = document.createElement('label');
        optionLabel.className = 'multi-select__option';
        optionLabel.innerHTML = `
          <input type="checkbox" value="${escapeHtml(option.value)}" id="${escapeHtml(optionId)}">
          <span>${escapeHtml(option.label)}</span>
        `;
        menu.appendChild(optionLabel);
      });
      permissionMultiSelects[field] = { container, button, menu, chips, hidden, config, selected: [], options: resolvedOptions };
      markScopeDirty(field, Boolean(permissionScopeDirty[field]));
      button.addEventListener('click', () => togglePermissionMultiSelect(field));
      menu.addEventListener('change', event => {
        const target = event.target;
        if(!target || target.type !== 'checkbox') return;
        if(config.globalValue && target.value === config.globalValue && target.checked){
          menu.querySelectorAll('input[type="checkbox"]').forEach(input => {
            if(input !== target) input.checked = false;
          });
          updatePermissionMultiSelect(field, [config.globalValue]);
          return;
        }
        if(config.globalValue){
          const globalInput = menu.querySelector(`input[type="checkbox"][value="${config.globalValue}"]`);
          if(globalInput && globalInput.checked && target.checked){
            globalInput.checked = false;
          }
        }
        const selected = Array.from(menu.querySelectorAll('input[type="checkbox"]:checked')).map(input => input.value).filter(Boolean);
        updatePermissionMultiSelect(field, selected);
        markScopeDirty(field, true);
      });
    });
    document.addEventListener('click', event => {
      Object.values(permissionMultiSelects).forEach(control => {
        if(!control.container.contains(event.target)){
          closePermissionMultiSelect(control);
        }
      });
    });
    document.addEventListener('keydown', event => {
      if(event.key === 'Escape'){
        Object.values(permissionMultiSelects).forEach(closePermissionMultiSelect);
      }
    });
    Object.keys(permissionMultiSelects).forEach(field => updatePermissionMultiSelect(field, []));
  }

  function formatScopeSummary(values, config, field){
    const list = normalizeScopeSelection(field || '', values, config);
    if(!list.length) return '';
    if(config && config.globalValue && list.includes(config.globalValue)){
      return 'Acceso global';
    }
    if(list.length <= 2){
      return list.join(', ');
    }
    const label = config && (config.summaryPlural || config.summarySingular) ? (config.summaryPlural || config.summarySingular) : 'seleccionados';
    return `${list.length} ${label}`;
  }

  function renderPermissionReference(){
    const matrixContainer = el('#permissionMatrix');
    if(matrixContainer){
      matrixContainer.innerHTML = '';
      const title = document.createElement('h4');
      title.innerHTML = '<i class="bi bi-diagram-3"></i> Matriz de permisos';
      matrixContainer.appendChild(title);
      const subtitle = document.createElement('p');
      subtitle.textContent = 'Consulta el alcance de cada rol por tipo de acción.';
      matrixContainer.appendChild(subtitle);
      if(Array.isArray(PERMISSION_REFERENCE.roles) && PERMISSION_REFERENCE.roles.length){
        const table = document.createElement('table');
        table.className = 'permission-matrix';
        const thead = document.createElement('thead');
        thead.innerHTML = '<tr><th>Acción</th><th>Administrador</th><th>Coordinador</th><th>Asesor</th><th>Consulta</th></tr>';
        table.appendChild(thead);
        const tbody = document.createElement('tbody');
        PERMISSION_REFERENCE.roles.forEach(row => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${escapeHtml(row.action)}</td>
            <td>${escapeHtml(row.admin)}</td>
            <td>${escapeHtml(row.coordinador)}</td>
            <td>${escapeHtml(row.asesor)}</td>
            <td>${escapeHtml(row.viewer)}</td>
          `;
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        matrixContainer.appendChild(table);
      }
    }
    const rulesContainer = el('#permissionRules');
    if(rulesContainer){
      rulesContainer.innerHTML = '';
      const title = document.createElement('h4');
      title.innerHTML = '<i class="bi bi-shield-check"></i> Reglas operativas';
      rulesContainer.appendChild(title);
      if(Array.isArray(PERMISSION_REFERENCE.rules) && PERMISSION_REFERENCE.rules.length){
        const list = document.createElement('ul');
        list.className = 'permission-rules';
        PERMISSION_REFERENCE.rules.forEach(rule => {
          const item = document.createElement('li');
          item.textContent = rule;
          list.appendChild(item);
        });
        rulesContainer.appendChild(list);
      }
      const scopeNote = document.createElement('div');
      scopeNote.className = 'permission-scope-note';
      const basesTitle = document.createElement('strong');
      basesTitle.textContent = 'Bases disponibles';
      scopeNote.appendChild(basesTitle);
      const basesValues = document.createElement('div');
      basesValues.className = 'permission-scope-values';
      const baseValues = (PERMISSION_REFERENCE.bases && PERMISSION_REFERENCE.bases.values) || [];
      baseValues.forEach(value => {
        const pill = document.createElement('span');
        pill.className = 'multi-select__chip';
        pill.textContent = value;
        basesValues.appendChild(pill);
      });
      scopeNote.appendChild(basesValues);
      if(PERMISSION_REFERENCE.bases && PERMISSION_REFERENCE.bases.note){
        const basesNote = document.createElement('span');
        basesNote.textContent = PERMISSION_REFERENCE.bases.note;
        scopeNote.appendChild(basesNote);
      }
      const plantelesTitle = document.createElement('strong');
      plantelesTitle.textContent = 'Planteles disponibles';
      scopeNote.appendChild(plantelesTitle);
      const plantelesValues = document.createElement('div');
      plantelesValues.className = 'permission-scope-values';
      const plantelValues = (PERMISSION_REFERENCE.planteles && PERMISSION_REFERENCE.planteles.values) || [];
      plantelValues.forEach(value => {
        const pill = document.createElement('span');
        pill.className = 'multi-select__chip';
        pill.textContent = value;
        plantelesValues.appendChild(pill);
      });
      scopeNote.appendChild(plantelesValues);
      if(PERMISSION_REFERENCE.planteles && PERMISSION_REFERENCE.planteles.note){
        const plantelesNote = document.createElement('span');
        plantelesNote.textContent = PERMISSION_REFERENCE.planteles.note;
        scopeNote.appendChild(plantelesNote);
      }
      rulesContainer.appendChild(scopeNote);
    }
  }

  function updatePermissionRoleHint(role){
    const key = String(role || '').trim().toLowerCase();
    const hint = el('#permRoleHint');
    if(hint){
      hint.textContent = ROLE_SCOPE_HINTS[key] || 'Selecciona el alcance que tendrá esta cuenta.';
    }
    const suggestion = el('#permRoleSuggestion');
    const descriptionEl = el('#permRoleDescription');
    const chipsEl = el('#permRoleScopeChips');
    const applyBtn = el('#permApplyRolePreset');
    if(!suggestion || !descriptionEl || !chipsEl || !applyBtn){
      return;
    }
    const template = ROLE_TEMPLATES[key];
    if(template){
      suggestion.hidden = false;
      descriptionEl.textContent = template.description || (hint ? hint.textContent : '');
      chipsEl.innerHTML = '';
      const chips = [];
      chips.push(renderScopeChip(chipsEl, template.planteles, 'Planteles sugeridos', 'bi-diagram-3'));
      chips.push(renderScopeChip(chipsEl, template.bases, 'Bases sugeridas', 'bi-hdd-stack'));
      if(!chips.some(Boolean)){
        const placeholder = document.createElement('span');
        placeholder.className = 'scope-chip';
        placeholder.textContent = 'Define manualmente el alcance.';
        chipsEl.appendChild(placeholder);
      }
      applyBtn.disabled = false;
    }else{
      suggestion.hidden = true;
      chipsEl.innerHTML = '';
      applyBtn.disabled = true;
    }
  }

  function summarizeScopeValues(values){
    const list = Array.isArray(values) ? values.filter(Boolean) : [];
    if(!list.length) return '';
    if(list.length <= 3) return list.join(', ');
    return `${list.slice(0, 2).join(', ')} +${list.length - 2}`;
  }

  function renderScopeChip(container, values, label, icon){
    if(!container) return false;
    const list = Array.isArray(values) ? values.filter(Boolean) : [];
    if(!list.length) return false;
    const chip = document.createElement('span');
    chip.className = 'scope-chip';
    const summary = summarizeScopeValues(list);
    chip.innerHTML = `<i class="bi ${icon}"></i> ${label}: ${escapeHtml(summary)}`;
    chip.title = `${label}: ${list.join(', ')}`;
    container.appendChild(chip);
    return true;
  }

  function applyRoleScopeTemplate(role, options = {}){
    const key = String(role || '').trim().toLowerCase();
    const template = ROLE_TEMPLATES[key];
    if(!template) return false;
    const { force = false, silent = false } = options;
    const blockedFields = [];
    if(!force){
      if(isScopeDirty('planteles')) blockedFields.push('planteles');
      if(isScopeDirty('bases')) blockedFields.push('bases');
    }
    let applied = false;
    if(Array.isArray(template.planteles) && template.planteles.length && !blockedFields.includes('planteles')){
      setPermissionScopeSelection('planteles', template.planteles, { markDirty: false });
      applied = true;
    }
    if(Array.isArray(template.bases) && template.bases.length && !blockedFields.includes('bases')){
      setPermissionScopeSelection('bases', template.bases, { markDirty: false });
      applied = true;
    }
    if(!applied && blockedFields.length && !silent){
      const labels = blockedFields.map(field => field === 'planteles' ? 'planteles' : 'bases');
      const message = labels.length === 2
        ? 'Mantuvimos tus planteles y bases personalizados. Usa “Aplicar sugerencia” para reemplazarlos.'
        : `Mantuvimos tus ${labels[0]} personalizados. Usa “Aplicar sugerencia” para reemplazarlos.`;
      setPermissionStatus(message, 'info');
    }else if(!applied && !silent){
      setPermissionStatus('No hay sugerencias definidas para este rol todavía.', 'warning');
    }else if(applied && !silent){
      setPermissionStatus('Se aplicó la sugerencia de alcance del rol seleccionado.', 'success');
    }
    return applied;
  }

  function comparePermissionUsers(a, b){
    const activeDiff = Number((b && b.active) !== false) - Number((a && a.active) !== false);
    if(activeDiff) return activeDiff;
    const roleA = (a && a.role) ? String(a.role).trim().toLowerCase() : '';
    const roleB = (b && b.role) ? String(b.role).trim().toLowerCase() : '';
    const weightA = ROLE_ORDER.indexOf(roleA);
    const weightB = ROLE_ORDER.indexOf(roleB);
    const orderA = weightA === -1 ? ROLE_ORDER.length : weightA;
    const orderB = weightB === -1 ? ROLE_ORDER.length : weightB;
    if(orderA !== orderB) return orderA - orderB;
    const nameA = (a && (a.name || a.userId || '')).toString();
    const nameB = (b && (b.name || b.userId || '')).toString();
    const cmp = nameA.localeCompare(nameB, 'es', { sensitivity: 'base' });
    if(cmp) return cmp;
    const idA = (a && a.userId) || '';
    const idB = (b && b.userId) || '';
    return idA.localeCompare(idB, 'es', { sensitivity: 'base' });
  }

  function setPermissionStatus(message, tone = 'info'){
    const statusEl = el('#permStatus');
    if(!statusEl) return;
    const text = message ? String(message).trim() : '';
    statusEl.textContent = text;
    statusEl.dataset.tone = tone || 'info';
  }

  function renderPermissionList(){
    const listEl = el('#permList');
    if(!listEl) return;
    listEl.innerHTML = '';
    if(!permissionUsers.length){
      return;
    }
    const fragment = document.createDocumentFragment();
    const sorted = permissionUsers.slice().sort(comparePermissionUsers);
    sorted.forEach(user => {
      const item = document.createElement('button');
      item.type = 'button';
      item.className = 'perm-user';
      const userId = user && user.userId ? String(user.userId) : '';
      if(userId) item.dataset.userId = userId;
      item.setAttribute('role','option');
      const isSelected = userId && userId === selectedPermissionUserId;
      item.setAttribute('aria-selected', isSelected ? 'true' : 'false');
      if(isSelected) item.classList.add('active');
      if(user && user.active === false){
        item.classList.add('is-inactive');
      }
      const displayName = user && (user.name || user.userId || user.email) || 'Sin nombre';
      const email = user && user.email ? String(user.email) : '';
      const idText = user && user.userId ? String(user.userId) : '—';
      const roleLabel = formatRoleLabel(user && user.role);
      const statusText = user && user.active === false ? 'Inactivo' : 'Activo';
    const scopeParts = [];
    const plantelSummary = formatScopeSummary(user && user.planteles, PERMISSION_SCOPE_CONFIG.planteles, 'planteles');
    if(plantelSummary){
      scopeParts.push(plantelSummary);
    }
    const baseSummary = formatScopeSummary(user && user.bases, PERMISSION_SCOPE_CONFIG.bases, 'bases');
    if(baseSummary){
      scopeParts.push(baseSummary);
    }
    const scopeText = scopeParts.join(' · ');
      item.innerHTML = `
        <div class="perm-user__header">
          <span class="perm-user__name">${escapeHtml(displayName)}</span>
          <span class="perm-user__badge">${escapeHtml(roleLabel)}</span>
        </div>
        <div class="perm-user__meta">
          <span class="perm-user__id">${escapeHtml(idText)}</span>
          <span class="perm-user__status">${statusText}</span>
        </div>
        ${email ? `<div class="perm-user__meta">${escapeHtml(email)}</div>` : ''}
        ${scopeText ? `<div class="perm-user__meta">${escapeHtml(scopeText)}</div>` : ''}
      `;
      fragment.appendChild(item);
    });
    listEl.appendChild(fragment);
  }

  function startPermissionCreation(options = {}){
    const { focus = true, resetStatus = false, renderList = true } = options;
    selectedPermissionUserId = '';
    const title = el('#permFormTitle');
    if(title){
      title.textContent = 'Nuevo usuario';
    }
    const emailInput = el('#permEmail');
    if(emailInput){
      emailInput.value = '';
    }
    const idInput = el('#permUserId');
    if(idInput){
      idInput.value = '';
      idInput.removeAttribute('readonly');
    }
    const nameInput = el('#permName');
    if(nameInput){
      nameInput.value = '';
    }
    const roleSelect = el('#permRole');
    if(roleSelect){
      roleSelect.value = 'asesor';
    }
    const currentRole = roleSelect ? roleSelect.value : 'asesor';
    updatePermissionRoleHint(currentRole);
    setPermissionScopeSelection('planteles', []);
    setPermissionScopeSelection('bases', []);
    applyRoleScopeTemplate(currentRole, { force: true, silent: true });
    const passwordInput = el('#permPassword');
    if(passwordInput){
      passwordInput.value = '';
      passwordInput.required = true;
    }
    const passwordHint = el('#permPasswordHint');
    if(passwordHint){
      passwordHint.textContent = 'Se generará una contraseña temporal para compartir con la persona usuaria.';
    }
    const activeCheckbox = el('#permActive');
    if(activeCheckbox){
      activeCheckbox.checked = true;
    }
    const meta = el('#permMeta');
    if(meta){
      meta.textContent = '';
    }
    const deleteBtn = el('#permDeleteBtn');
    if(deleteBtn){
      deleteBtn.disabled = true;
      deleteBtn.title = 'Selecciona un usuario para desactivarlo.';
    }
    const form = el('#permForm');
    if(form){
      form.dataset.mode = 'create';
    }
    if(renderList){
      renderPermissionList();
    }
    if(resetStatus){
      setPermissionStatus('Completa los datos para crear un usuario.', 'info');
    }
    if(focus && emailInput){
      emailInput.focus();
    }
  }

  function populatePermissionForm(user, options = {}){
    if(!user) return;
    const { focus = true, renderList = true } = options;
    selectedPermissionUserId = user.userId || '';
    const form = el('#permForm');
    if(form){
      form.dataset.mode = 'edit';
    }
    const title = el('#permFormTitle');
    if(title){
      const label = user.name || user.userId || 'Usuario';
      title.textContent = `Editar ${label}`;
    }
    const emailInput = el('#permEmail');
    if(emailInput){
      emailInput.value = user.email || '';
    }
    const idInput = el('#permUserId');
    if(idInput){
      idInput.value = user.userId || '';
      idInput.setAttribute('readonly','readonly');
    }
    const nameInput = el('#permName');
    if(nameInput){
      nameInput.value = user.name || '';
    }
    const roleSelect = el('#permRole');
    if(roleSelect){
      roleSelect.value = user.role || 'asesor';
    }
    updatePermissionRoleHint(roleSelect ? roleSelect.value : user.role);
    setPermissionScopeSelection('planteles', user.planteles || [], { markDirty: true });
    setPermissionScopeSelection('bases', user.bases || [], { markDirty: true });
    const passwordInput = el('#permPassword');
    if(passwordInput){
      passwordInput.value = '';
      passwordInput.required = false;
    }
    const passwordHint = el('#permPasswordHint');
    if(passwordHint){
      passwordHint.textContent = 'Deja el campo vacío para conservar la contraseña actual.';
    }
    const activeCheckbox = el('#permActive');
    if(activeCheckbox){
      activeCheckbox.checked = user.active !== false;
    }
    const meta = el('#permMeta');
    if(meta){
      const metaParts = [];
      if(user.lastLogin) metaParts.push(`Último acceso: ${user.lastLogin}`);
      if(user.updatedAt) metaParts.push(`Actualizado: ${user.updatedAt}`);
      if(user.createdAt) metaParts.push(`Creado: ${user.createdAt}`);
      meta.textContent = metaParts.join(' · ');
    }
    const deleteBtn = el('#permDeleteBtn');
    if(deleteBtn){
      const sameUser = currentUser && currentUser.userId && user.userId && currentUser.userId === user.userId;
      deleteBtn.disabled = Boolean(sameUser);
      if(sameUser){
        deleteBtn.title = 'No puedes desactivar tu propia cuenta.';
      }else{
        deleteBtn.removeAttribute('title');
      }
    }
    if(renderList){
      renderPermissionList();
    }
    if(focus){
      const focusTarget = nameInput || emailInput;
      if(focusTarget){
        focusTarget.focus();
      }
    }
  }

  function selectPermissionUser(userId, options = {}){
    if(!userId){
      startPermissionCreation(options);
      return;
    }
    const user = permissionUsers.find(u => u.userId === userId);
    if(!user){
      startPermissionCreation(options);
      return;
    }
    populatePermissionForm(user, options);
    if(!options.silent){
      const label = user.name || user.userId;
      setPermissionStatus(`Editando permisos de ${label}.`, 'info');
    }
  }

  async function loadPermissionUsers(options = {}){
    if(getUserRole() !== 'admin') return;
    if(permissionsLoading) return;
    const { preserveSelection = true } = options;
    permissionsLoading = true;
    setPermissionStatus('Cargando usuarios…', 'info');
    try{
      const res = await apiFetch(`${API_URL}?action=listUsers`);
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      if(data && data.error){
        throw new Error(data.error);
      }
      const users = Array.isArray(data?.users) ? data.users.slice() : [];
      permissionUsers = users.sort(comparePermissionUsers);
      updateTeamMemberOptions();
      permissionsLoaded = true;
      const previousSelection = preserveSelection ? selectedPermissionUserId : '';
      if(permissionUsers.length){
        let targetUser = previousSelection ? permissionUsers.find(u => u.userId === previousSelection) : null;
        if(!targetUser){
          targetUser = permissionUsers[0];
        }
        populatePermissionForm(targetUser, { focus: false, renderList: false });
        renderPermissionList();
        const label = targetUser.name || targetUser.userId || 'usuario';
        setPermissionStatus(previousSelection ? `Se actualizaron los datos de ${label}.` : 'Usuarios cargados. Edita la ficha seleccionada o crea una nueva.', 'info');
      }else{
        startPermissionCreation({ focus: false, renderList: true });
        setPermissionStatus('No hay usuarios registrados. Crea el primero para comenzar.', 'info');
      }
    }catch(err){
      console.error('Error al cargar usuarios', err);
      setPermissionStatus(err && err.message ? err.message : 'No se pudieron cargar los usuarios.', 'error');
    }finally{
      permissionsLoading = false;
    }
  }

  async function ensurePermissionsLoaded(force = false){
    if(getUserRole() !== 'admin') return;
    if(permissionsLoading) return;
    if(permissionsLoaded && !force){
      if(!permissionUsers.length){
        startPermissionCreation({ focus: false, renderList: true });
      }
      return;
    }
    await loadPermissionUsers({ preserveSelection: true });
  }

  function collectPermissionFormData(){
    const emailInput = el('#permEmail');
    const idInput = el('#permUserId');
    const nameInput = el('#permName');
    const roleSelect = el('#permRole');
    const plantelesInput = el('#permPlanteles');
    const basesInput = el('#permBases');
    const passwordInput = el('#permPassword');
    const activeCheckbox = el('#permActive');
    return {
      email: emailInput ? String(emailInput.value || '').trim().toLowerCase() : '',
      userId: idInput ? String(idInput.value || '').trim() : '',
      name: nameInput ? String(nameInput.value || '').trim() : '',
      role: roleSelect ? String(roleSelect.value || '').trim().toLowerCase() : 'asesor',
      planteles: plantelesInput ? parseListInput(plantelesInput.value) : [],
      bases: basesInput ? parseListInput(basesInput.value) : [],
      password: passwordInput ? String(passwordInput.value || '').trim() : '',
      active: activeCheckbox ? Boolean(activeCheckbox.checked) : true
    };
  }

  async function handlePermissionSave(event){
    event.preventDefault();
    if(getUserRole() !== 'admin'){
      alert('No tienes permisos para administrar usuarios.');
      return;
    }
    const form = event.currentTarget;
    const mode = form && form.dataset.mode === 'edit' ? 'edit' : 'create';
    const data = collectPermissionFormData();
    if(!data.email){
      setPermissionStatus('El correo es obligatorio.', 'error');
      if(el('#permEmail')) el('#permEmail').focus();
      return;
    }
    if(!data.userId){
      setPermissionStatus('El ID de usuario es obligatorio.', 'error');
      if(el('#permUserId')) el('#permUserId').focus();
      return;
    }
    if(!data.name){
      setPermissionStatus('El nombre es obligatorio.', 'error');
      if(el('#permName')) el('#permName').focus();
      return;
    }
    if(mode === 'create' && !data.password){
      setPermissionStatus('Define una contraseña temporal para la nueva cuenta.', 'error');
      if(el('#permPassword')) el('#permPassword').focus();
      return;
    }
    const payload = {
      action: mode === 'create' ? 'createUser' : 'updateUser',
      email: data.email,
      name: data.name,
      role: data.role,
      planteles: data.planteles,
      bases: data.bases,
      active: data.active
    };
    if(mode === 'create'){
      payload.userId = data.userId;
      payload.password = data.password;
    }else{
      payload.userId = selectedPermissionUserId || data.userId;
      if(data.password){
        payload.password = data.password;
      }
    }
    setPermissionStatus(mode === 'create' ? 'Creando usuario…' : 'Actualizando usuario…', 'info');
    try{
      const res = await apiFetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: payload
      });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const response = await res.json();
      if(response && response.error){
        throw new Error(response.error);
      }
      const savedUser = response && response.user ? response.user : null;
      if(savedUser){
        const existingIndex = permissionUsers.findIndex(u => u.userId === savedUser.userId);
        if(existingIndex >= 0){
          permissionUsers[existingIndex] = savedUser;
        }else{
          permissionUsers.push(savedUser);
        }
        permissionUsers.sort(comparePermissionUsers);
        updateTeamMemberOptions();
        populatePermissionForm(savedUser, { focus: false, renderList: false });
        renderPermissionList();
        setPermissionStatus(mode === 'create' ? 'Usuario creado correctamente.' : 'Permisos actualizados.', 'success');
      }else{
        setPermissionStatus('La respuesta no contiene información del usuario.', 'warning');
      }
    }catch(err){
      console.error('Error al guardar usuario', err);
      setPermissionStatus(err && err.message ? err.message : 'No se pudo guardar el usuario.', 'error');
    }finally{
      const passwordInput = el('#permPassword');
      if(passwordInput){
        passwordInput.value = '';
      }
    }
  }

  async function handlePermissionDelete(){
    if(getUserRole() !== 'admin'){
      alert('No tienes permisos para administrar usuarios.');
      return;
    }
    if(!selectedPermissionUserId){
      return;
    }
    const user = permissionUsers.find(u => u.userId === selectedPermissionUserId);
    if(!user){
      setPermissionStatus('Selecciona un usuario válido para desactivar.', 'error');
      return;
    }
    if(currentUser && currentUser.userId && user.userId === currentUser.userId){
      setPermissionStatus('No puedes desactivar tu propia cuenta.', 'error');
      return;
    }
    const confirmMessage = `¿Desactivar el acceso de ${user.name || user.userId}?`;
    if(!confirm(confirmMessage)) return;
    setPermissionStatus('Desactivando usuario…', 'info');
    try{
      const res = await apiFetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: { action: 'deleteUser', userId: user.userId }
      });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const response = await res.json();
      if(response && response.error){
        throw new Error(response.error);
      }
      const updated = response && response.user ? response.user : null;
      if(updated){
        const idx = permissionUsers.findIndex(u => u.userId === updated.userId);
        if(idx >= 0){
          permissionUsers[idx] = updated;
        }
        permissionUsers.sort(comparePermissionUsers);
        updateTeamMemberOptions();
        populatePermissionForm(updated, { focus: false, renderList: false });
        renderPermissionList();
        setPermissionStatus('El usuario fue desactivado. Puedes reactivarlo cambiando su estado.', 'warning');
      }else{
        setPermissionStatus('No se recibió la confirmación de desactivación.', 'warning');
      }
    }catch(err){
      console.error('Error al desactivar usuario', err);
      setPermissionStatus(err && err.message ? err.message : 'No se pudo desactivar el usuario.', 'error');
    }
  }

  function compareTeams(a, b){
    const activeDiff = Number((b && b.active) !== false) - Number((a && a.active) !== false);
    if(activeDiff) return activeDiff;
    const nameA = (a && (a.name || a.teamId || '')) || '';
    const nameB = (b && (b.name || b.teamId || '')) || '';
    const cmp = nameA.localeCompare(nameB, 'es', { sensitivity: 'base' });
    if(cmp) return cmp;
    const idA = (a && a.teamId) || '';
    const idB = (b && b.teamId) || '';
    return idA.localeCompare(idB, 'es', { sensitivity: 'base' });
  }

  function setTeamStatus(message, tone = 'info'){
    const statusEl = el('#teamStatus');
    if(!statusEl) return;
    const text = message ? String(message).trim() : '';
    statusEl.textContent = text;
    statusEl.dataset.tone = tone || 'info';
  }

  function renderTeamList(){
    const listEl = el('#teamList');
    if(!listEl) return;
    listEl.innerHTML = '';
    if(!teams.length) return;
    const fragment = document.createDocumentFragment();
    const sorted = teams.slice().sort(compareTeams);
    sorted.forEach(team => {
      const item = document.createElement('button');
      item.type = 'button';
      item.className = 'team-item';
      const teamId = team && team.teamId ? String(team.teamId) : '';
      if(teamId) item.dataset.teamId = teamId;
      item.setAttribute('role', 'option');
      const isSelected = teamId && teamId === selectedTeamId;
      item.setAttribute('aria-selected', isSelected ? 'true' : 'false');
      if(isSelected) item.classList.add('active');
      if(team && team.active === false){
        item.classList.add('is-inactive');
      }
      const displayName = team && (team.name || team.teamId) || 'Sin nombre';
      const idText = teamId || '—';
      const memberCount = Array.isArray(team?.members) ? team.members.length : 0;
      const memberLabel = memberCount ? `${memberCount} integrante${memberCount === 1 ? '' : 's'}` : 'Sin integrantes';
      const scopeParts = [];
      const plantelSummary = formatScopeSummary(team?.planteles, PERMISSION_SCOPE_CONFIG.teamPlanteles, 'teamPlanteles');
      if(plantelSummary) scopeParts.push(plantelSummary);
      const baseSummary = formatScopeSummary(team?.bases, PERMISSION_SCOPE_CONFIG.teamBases, 'teamBases');
      if(baseSummary) scopeParts.push(baseSummary);
      const statusLabel = team && team.active === false ? 'Inactivo' : 'Activo';
      item.innerHTML = `
        <div class="team-item__header">
          <span class="team-item__name">${escapeHtml(displayName)}</span>
          <span class="team-item__badge">${escapeHtml(statusLabel)}</span>
        </div>
        <div class="team-item__meta">
          <span class="team-item__id">${escapeHtml(idText)}</span>
          <span class="team-item__status">${escapeHtml(memberLabel)}</span>
        </div>
        ${scopeParts.length ? `<div class="team-item__meta">${escapeHtml(scopeParts.join(' · '))}</div>` : ''}
        ${team && team.description ? `<div class="team-item__description">${escapeHtml(team.description)}</div>` : ''}
      `;
      fragment.appendChild(item);
    });
    listEl.appendChild(fragment);
  }

  function renderTeamTemplateToolbar(){
    const toolbar = el('#teamTemplateToolbar');
    if(!toolbar) return;
    toolbar.innerHTML = '';
    const canUseTemplates = canPerform('manageTeams');
    const templates = Array.isArray(TEAM_TEMPLATES) ? TEAM_TEMPLATES.filter(Boolean) : [];
    if(!canUseTemplates || !templates.length){
      toolbar.hidden = true;
      toolbar.setAttribute('hidden', 'hidden');
      return;
    }
    toolbar.hidden = false;
    toolbar.removeAttribute('hidden');
    templates.forEach(template => {
      if(!template || !template.name) return;
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'scope-template-btn';
      btn.dataset.templateId = template.id || '';
      const title = document.createElement('strong');
      title.textContent = template.name;
      btn.appendChild(title);
      if(template.description){
        const desc = document.createElement('span');
        desc.textContent = template.description;
        btn.appendChild(desc);
      }
      const scopeSummary = document.createElement('span');
      const plantelSummary = summarizeScopeValues(template.planteles || []);
      const baseSummary = summarizeScopeValues(template.bases || []);
      scopeSummary.textContent = `Planteles: ${plantelSummary || '—'} · Bases: ${baseSummary || '—'}`;
      btn.appendChild(scopeSummary);
      btn.addEventListener('click', () => applyTeamTemplate(template));
      toolbar.appendChild(btn);
    });
  }

  function applyTeamTemplate(template, options = {}){
    if(!template) return false;
    const form = el('#teamForm');
    const isEdit = form && form.dataset.mode === 'edit';
    if(isEdit && !options.force){
      const confirmed = confirm('Aplicar la plantilla reemplazará la configuración actual del equipo. ¿Deseas continuar?');
      if(!confirmed) return false;
    }
    const idInput = el('#teamId');
    if(idInput && !idInput.value && template.id){
      idInput.value = template.id;
    }
    const nameInput = el('#teamName');
    if(nameInput && template.name && (!nameInput.value || options.overwrite !== false)){
      nameInput.value = template.name;
    }
    const descriptionInput = el('#teamDescription');
    if(descriptionInput && template.description && (!descriptionInput.value || options.overwrite !== false)){
      descriptionInput.value = template.description;
    }
    setPermissionScopeSelection('teamPlanteles', template.planteles || [], { markDirty: false });
    setPermissionScopeSelection('teamBases', template.bases || [], { markDirty: false });
    const members = Array.isArray(template.members) ? template.members.filter(Boolean) : [];
    const memberOptions = new Set((permissionMultiSelects.teamMembers?.options || []).map(option => option.value));
    const availableMembers = members.filter(memberId => memberOptions.has(memberId));
    const missingMembers = members.filter(memberId => !memberOptions.has(memberId));
    setPermissionScopeSelection('teamMembers', availableMembers, { markDirty: false });
    if(!options.silent){
      let message = `Se aplicó la plantilla “${template.name}”.`;
      if(missingMembers.length){
        message += ` Integrantes no disponibles: ${missingMembers.join(', ')}.`;
      }
      setTeamStatus(message, 'info');
    }
    return true;
  }

  function cloneSelectedTeam(){
    if(!selectedTeamId){
      setTeamStatus('Selecciona un equipo para clonar su configuración.', 'warning');
      return;
    }
    const team = teams.find(t => t.teamId === selectedTeamId);
    if(!team){
      setTeamStatus('No se encontró el equipo seleccionado para clonar.', 'error');
      return;
    }
    startTeamCreation({ focus: false, renderList: true });
    const idInput = el('#teamId');
    if(idInput){
      idInput.value = '';
      idInput.focus();
    }
    const nameInput = el('#teamName');
    if(nameInput){
      const sourceName = team.name || team.teamId || 'Equipo';
      nameInput.value = `${sourceName} (copia)`;
    }
    const descriptionInput = el('#teamDescription');
    if(descriptionInput){
      descriptionInput.value = team.description || '';
    }
    setPermissionScopeSelection('teamPlanteles', team.planteles || [], { markDirty: false });
    setPermissionScopeSelection('teamBases', team.bases || [], { markDirty: false });
    setPermissionScopeSelection('teamMembers', team.members || [], { markDirty: false });
    setTeamStatus(`Se clonó la configuración de ${team.name || team.teamId}. Define un nuevo ID para guardarla.`, 'info');
  }

  function startTeamCreation(options = {}){
    const { focus = true, resetStatus = false, renderList = true } = options;
    selectedTeamId = '';
    const form = el('#teamForm');
    if(form){
      form.dataset.mode = 'create';
    }
    const title = el('#teamFormTitle');
    if(title){
      title.textContent = 'Nuevo equipo';
    }
    const idInput = el('#teamId');
    if(idInput){
      idInput.value = '';
      idInput.removeAttribute('readonly');
    }
    const nameInput = el('#teamName');
    if(nameInput) nameInput.value = '';
    const descriptionInput = el('#teamDescription');
    if(descriptionInput) descriptionInput.value = '';
    setPermissionScopeSelection('teamPlanteles', []);
    setPermissionScopeSelection('teamBases', []);
    setPermissionScopeSelection('teamMembers', []);
    const activeCheckbox = el('#teamActive');
    if(activeCheckbox) activeCheckbox.checked = true;
    const meta = el('#teamMeta');
    if(meta) meta.textContent = '';
    const deleteBtn = el('#teamDeleteBtn');
    if(deleteBtn){
      deleteBtn.disabled = true;
      deleteBtn.title = 'Selecciona un equipo para desactivarlo.';
    }
    if(renderList){
      renderTeamList();
    }
    if(resetStatus){
      setTeamStatus('Completa los datos para crear un equipo.', 'info');
    }
    if(focus && idInput){
      idInput.focus();
    }
  }

  function populateTeamForm(team, options = {}){
    if(!team) return;
    const { focus = true, renderList = true } = options;
    selectedTeamId = team.teamId || '';
    const form = el('#teamForm');
    if(form){
      form.dataset.mode = 'edit';
    }
    const title = el('#teamFormTitle');
    if(title){
      const label = team.name || team.teamId || 'Equipo';
      title.textContent = `Editar ${label}`;
    }
    const idInput = el('#teamId');
    if(idInput){
      idInput.value = team.teamId || '';
      idInput.setAttribute('readonly', 'readonly');
    }
    const nameInput = el('#teamName');
    if(nameInput) nameInput.value = team.name || '';
    const descriptionInput = el('#teamDescription');
    if(descriptionInput) descriptionInput.value = team.description || '';
    setPermissionScopeSelection('teamPlanteles', team.planteles || []);
    setPermissionScopeSelection('teamBases', team.bases || []);
    setPermissionScopeSelection('teamMembers', team.members || []);
    const activeCheckbox = el('#teamActive');
    if(activeCheckbox) activeCheckbox.checked = team.active !== false;
    const meta = el('#teamMeta');
    if(meta){
      const metaParts = [];
      if(team.updatedAt) metaParts.push(`Actualizado: ${team.updatedAt}`);
      if(team.createdAt) metaParts.push(`Creado: ${team.createdAt}`);
      meta.textContent = metaParts.join(' · ');
    }
    const deleteBtn = el('#teamDeleteBtn');
    if(deleteBtn){
      deleteBtn.disabled = false;
      deleteBtn.removeAttribute('title');
    }
    if(renderList){
      renderTeamList();
    }
    if(focus){
      const focusTarget = nameInput || idInput;
      if(focusTarget) focusTarget.focus();
    }
  }

  function selectTeam(teamId, options = {}){
    if(!teamId){
      startTeamCreation(options);
      return;
    }
    const team = teams.find(t => t.teamId === teamId);
    if(!team){
      startTeamCreation(options);
      return;
    }
    populateTeamForm(team, options);
    if(!options.silent){
      const label = team.name || team.teamId;
      setTeamStatus(`Editando propiedades de ${label}.`, 'info');
    }
  }

  function collectTeamFormData(){
    const idInput = el('#teamId');
    const nameInput = el('#teamName');
    const descriptionInput = el('#teamDescription');
    const plantelesInput = el('#teamPlanteles');
    const basesInput = el('#teamBases');
    const membersInput = el('#teamMembers');
    const activeCheckbox = el('#teamActive');
    const teamId = idInput ? normalizeTeamId(idInput.value) : '';
    if(idInput) idInput.value = teamId;
    return {
      teamId,
      name: nameInput ? String(nameInput.value || '').trim() : '',
      description: descriptionInput ? String(descriptionInput.value || '').trim() : '',
      planteles: plantelesInput ? parseListInput(plantelesInput.value) : [],
      bases: basesInput ? parseListInput(basesInput.value) : [],
      members: membersInput ? parseListInput(membersInput.value) : [],
      active: activeCheckbox ? Boolean(activeCheckbox.checked) : true
    };
  }

  async function loadTeams(options = {}){
    if(getUserRole() !== 'admin') return;
    if(teamsLoading) return;
    const { preserveSelection = true } = options;
    teamsLoading = true;
    setTeamStatus('Cargando equipos…', 'info');
    try{
      const res = await apiFetch(`${API_URL}?action=listTeams`);
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      if(data && data.error){
        throw new Error(data.error);
      }
      const list = Array.isArray(data?.teams) ? data.teams.slice() : [];
      teams = list.sort(compareTeams);
      teamsLoaded = true;
      const previousSelection = preserveSelection ? selectedTeamId : '';
      if(teams.length){
        let targetTeam = previousSelection ? teams.find(t => t.teamId === previousSelection) : null;
        if(!targetTeam){
          targetTeam = teams[0];
        }
        populateTeamForm(targetTeam, { focus: false, renderList: false });
        renderTeamList();
        const label = targetTeam.name || targetTeam.teamId || 'equipo';
        setTeamStatus(previousSelection ? `Se actualizaron los datos de ${label}.` : 'Equipos cargados. Edita el equipo seleccionado o crea uno nuevo.', 'info');
      }else{
        startTeamCreation({ focus: false, renderList: true });
        setTeamStatus('No hay equipos registrados. Crea el primero para comenzar.', 'info');
      }
    }catch(err){
      console.error('Error al cargar equipos', err);
      setTeamStatus(err && err.message ? err.message : 'No se pudieron cargar los equipos.', 'error');
    }finally{
      teamsLoading = false;
    }
  }

  async function ensureTeamsLoaded(force = false){
    if(getUserRole() !== 'admin') return;
    if(teamsLoading) return;
    if(teamsLoaded && !force){
      if(!teams.length){
        startTeamCreation({ focus: false, renderList: true });
      }
      return;
    }
    await loadTeams({ preserveSelection: true });
  }

  async function handleTeamSave(event){
    event.preventDefault();
    if(getUserRole() !== 'admin'){
      alert('No tienes permisos para administrar equipos.');
      return;
    }
    const form = event.currentTarget;
    const mode = form && form.dataset.mode === 'edit' ? 'edit' : 'create';
    const data = collectTeamFormData();
    if(!data.teamId){
      setTeamStatus('El ID del equipo es obligatorio.', 'error');
      if(el('#teamId')) el('#teamId').focus();
      return;
    }
    if(!data.name){
      setTeamStatus('El nombre del equipo es obligatorio.', 'error');
      if(el('#teamName')) el('#teamName').focus();
      return;
    }
    if(form && mode === 'create'){
      const idInput = el('#teamId');
      if(idInput) idInput.value = data.teamId;
    }
    const payload = {
      action: mode === 'create' ? 'createTeam' : 'updateTeam',
      teamId: mode === 'create' ? data.teamId : (selectedTeamId || data.teamId),
      name: data.name,
      description: data.description,
      planteles: data.planteles,
      bases: data.bases,
      members: data.members,
      active: data.active
    };
    setTeamStatus(mode === 'create' ? 'Creando equipo…' : 'Actualizando equipo…', 'info');
    try{
      const res = await apiFetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: payload
      });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const response = await res.json();
      if(response && response.error){
        throw new Error(response.error);
      }
      const savedTeam = response && response.team ? response.team : null;
      if(savedTeam){
        const existingIndex = teams.findIndex(t => t.teamId === savedTeam.teamId);
        if(existingIndex >= 0){
          teams[existingIndex] = savedTeam;
        }else{
          teams.push(savedTeam);
        }
        teams.sort(compareTeams);
        populateTeamForm(savedTeam, { focus: false, renderList: false });
        renderTeamList();
        setTeamStatus(mode === 'create' ? 'Equipo creado correctamente.' : 'Equipo actualizado.', 'success');
      }else{
        setTeamStatus('La respuesta no contiene información del equipo.', 'warning');
      }
    }catch(err){
      console.error('Error al guardar equipo', err);
      setTeamStatus(err && err.message ? err.message : 'No se pudo guardar el equipo.', 'error');
    }
  }

  async function handleTeamDelete(){
    if(getUserRole() !== 'admin'){
      alert('No tienes permisos para administrar equipos.');
      return;
    }
    if(!selectedTeamId){
      return;
    }
    const team = teams.find(t => t.teamId === selectedTeamId);
    if(!team){
      setTeamStatus('Selecciona un equipo válido para desactivarlo.', 'error');
      return;
    }
    const confirmMessage = `¿Desactivar el equipo ${team.name || team.teamId}?`;
    if(!confirm(confirmMessage)) return;
    setTeamStatus('Desactivando equipo…', 'info');
    try{
      const res = await apiFetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: { action: 'deleteTeam', teamId: team.teamId }
      });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const response = await res.json();
      if(response && response.error){
        throw new Error(response.error);
      }
      const updated = response && response.team ? response.team : null;
      if(updated){
        const idx = teams.findIndex(t => t.teamId === updated.teamId);
        if(idx >= 0){
          teams[idx] = updated;
        }
        teams.sort(compareTeams);
        populateTeamForm(updated, { focus: false, renderList: false });
        renderTeamList();
        setTeamStatus('El equipo fue desactivado. Puedes reactivarlo desde el formulario.', 'warning');
      }else{
        setTeamStatus('No se recibió la confirmación de desactivación.', 'warning');
      }
    }catch(err){
      console.error('Error al desactivar equipo', err);
      setTeamStatus(err && err.message ? err.message : 'No se pudo desactivar el equipo.', 'error');
    }
  }

  function updateTeamMemberOptions(){
    const options = permissionUsers
      .filter(user => user && user.userId)
      .map(user => {
        const primary = user.name || user.userId || user.email || 'Sin nombre';
        const details = [];
        if(user.userId && primary !== user.userId){
          details.push(user.userId);
        }
        if(user.role){
          details.push(formatRoleLabel(user.role));
        }
        if(user.active === false){
          details.push('Inactivo');
        }
        const label = details.length ? `${primary} · ${details.join(' · ')}` : primary;
        return { value: user.userId, label };
      });
    setPermissionMultiSelectOptions('teamMembers', options);
  }

  function saveAuthState(state){
    try{
      localStorage.setItem(AUTH_STORAGE_KEY, JSON.stringify(state || {}));
    }catch(err){
      console.warn('No se pudo guardar el estado de autenticación.', err);
    }
  }

  function clearAuthState(){
    try{
      localStorage.removeItem(AUTH_STORAGE_KEY);
    }catch(err){
      console.warn('No se pudo limpiar el estado de autenticación.', err);
    }
  }

  function setAuthState(token, user, persist = true){
    authToken = token || '';
    currentUser = user || null;
    if(persist){
      saveAuthState({ token: authToken, user: currentUser });
    }
    updateUserBadge();
  }

  function getUserRole(){
    if(currentUser && currentUser.role){
      return String(currentUser.role).trim().toLowerCase();
    }
    return '';
  }

  function canAccessView(view){
    if(!view) return true;
    const role = getUserRole();
    if(role === 'admin') return true;
    if(!role) return false;
    const allowed = VIEW_PERMISSIONS[view];
    if(!allowed || !allowed.length) return true;
    return allowed.includes(role) || allowed.includes('*') || VIEW_PERMISSIONS[view].includes('admin');
  }

  function canPerform(action){
    if(!action) return true;
    const role = getUserRole();
    if(role === 'admin') return true;
    if(!role) return false;
    const allowed = ACTION_PERMISSIONS[action];
    if(!allowed || !allowed.length) return true;
    return allowed.includes(role) || allowed.includes('*');
  }

  function getAllowedPlanteles(){
    const empty = [];
    empty.hasGlobalAccess = false;
    empty.isGlobal = false;
    empty.globalTokens = [];
    if(!currentUser || !Array.isArray(currentUser.planteles)) return empty;

    const plantelConfig = PERMISSION_SCOPE_CONFIG?.planteles || {};
    const globalValue = plantelConfig.globalValue ? normalizeScopeToken(plantelConfig.globalValue) : '';
    const aliasSet = GLOBAL_SCOPE_ALIAS_MAP?.planteles || new Set();
    const seenTokens = new Set();
    const normalizedValues = new Set();
    const list = [];
    const globalTokens = [];

    currentUser.planteles.forEach(value => {
      const rawValue = String(value || '').trim();
      if(!rawValue) return;
      const token = normalizeScopeToken(rawValue);
      if(token && (aliasSet.has(token) || (globalValue && token === globalValue))){
        globalTokens.push(rawValue);
        return;
      }
      if(!token || normalizedValues.has(token)) return;
      normalizedValues.add(token);
      if(seenTokens.has(rawValue)) return;
      seenTokens.add(rawValue);
      list.push(rawValue);
    });

    list.hasGlobalAccess = globalTokens.length > 0;
    list.isGlobal = list.hasGlobalAccess;
    list.globalTokens = globalTokens;
    return list;
  }

  function normalizePlantelKey(value){
    return String(value || '')
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .toLowerCase()
      .trim();
  }

  function resetAppData(){
    leads = [];
    sheets = [];
    lastDiagnostics = null;
    globalLeadIndex = null;
    diagInProgress = false;
    permissionUsers = [];
    permissionsLoaded = false;
    permissionsLoading = false;
    selectedPermissionUserId = '';
    currentSolutionPlan = null;
    solvingInProgress = false;
    lastSolverAutoRunId = null;
    currentDiagnosticsRunId = 0;
    clearSolverLog();
    updateProblemSolverPanel();
  }

  function setLoginError(message){
    const errorEl = document.getElementById('loginError');
    if(!errorEl) return;
    const text = message ? String(message).trim() : '';
    if(text){
      errorEl.textContent = text;
      errorEl.classList.remove('hidden');
    }else{
      errorEl.textContent = '';
      errorEl.classList.add('hidden');
    }
  }

  function setLoginBusy(busy){
    const btn = document.getElementById('loginSubmit');
    if(!btn) return;
    const original = btn.dataset.originalLabel || btn.textContent || 'Ingresar';
    if(!btn.dataset.originalLabel){
      btn.dataset.originalLabel = original;
    }
    btn.disabled = Boolean(busy);
    btn.textContent = busy ? 'Ingresando…' : btn.dataset.originalLabel;
  }

  function resolveErrorMessage(err, fallback){
    const fallbackMessage = fallback ? String(fallback).trim() : 'Ocurrió un error.';
    if(!err){
      return fallbackMessage;
    }
    const rawMessage = typeof err === 'string' ? err : err.message;
    const message = rawMessage ? String(rawMessage).trim() : '';
    if(!message){
      return fallbackMessage;
    }
    const normalized = message.toLowerCase();
    const networkPatterns = [
      'failed to fetch',
      'load failed',
      'network error',
      'networkerror when attempting to fetch resource',
      'the network connection was lost',
      'network request failed',
      'net::err_failed',
      'net::err_internet_disconnected',
      'offline'
    ];
    if(networkPatterns.some(pattern => normalized.includes(pattern))){
      return 'No se pudo conectar con el servicio. Verifica tu conexión e inténtalo nuevamente.';
    }
    return message;
  }

  function attachForgotPasswordHandler(){
    const trigger = document.getElementById('forgotPasswordBtn');
    if(trigger && !trigger.dataset.bound){
      trigger.addEventListener('click', event => {
        event.preventDefault();
        showResetView();
      });
      trigger.dataset.bound = 'true';
    }
  }

  function renderDefaultLoginHint(target){
    if(!target) return;
    target.innerHTML = '¿Es tu primer ingreso o olvidaste tu contraseña? <button type="button" class="link-button" id="forgotPasswordBtn">Solicita una contraseña temporal</button>.';
    attachForgotPasswordHandler();
  }

  function updateLoginHint(message){
    const hint = document.getElementById('loginHint');
    if(!hint) return;
    const text = message ? String(message).trim() : DEFAULT_LOGIN_HINT;
    if(text === DEFAULT_LOGIN_HINT){
      renderDefaultLoginHint(hint);
    }else{
      hint.textContent = text;
    }
  }

  function updateResetHint(message){
    const hint = document.getElementById('resetHint');
    if(!hint) return;
    hint.textContent = message ? String(message) : DEFAULT_RESET_HINT;
  }

  function setResetStatus(message, variant){
    const status = document.getElementById('resetMessage');
    if(!status) return;
    status.classList.remove('login-error','login-success','login-info');
    const text = message ? String(message).trim() : '';
    if(text){
      const tone = variant || 'info';
      const className = tone === 'error' ? 'login-error' : tone === 'success' ? 'login-success' : 'login-info';
      status.textContent = text;
      status.classList.add('login-message', className);
      status.classList.remove('hidden');
      status.setAttribute('role', tone === 'error' ? 'alert' : 'status');
      status.setAttribute('aria-live', tone === 'error' ? 'assertive' : 'polite');
    }else{
      status.textContent = '';
      status.classList.add('hidden');
      status.removeAttribute('role');
      status.setAttribute('aria-live', 'polite');
    }
  }

  function setResetBusy(busy){
    const btn = document.getElementById('resetSubmit');
    if(btn){
      const original = btn.dataset.originalLabel || btn.textContent || 'Generar contraseña';
      if(!btn.dataset.originalLabel){
        btn.dataset.originalLabel = original;
      }
      btn.disabled = Boolean(busy);
      btn.textContent = busy ? 'Generando…' : btn.dataset.originalLabel;
    }
    const cancelBtn = document.getElementById('resetCancel');
    if(cancelBtn){
      cancelBtn.disabled = Boolean(busy);
    }
  }

  function showSignInView(options = {}){
    const { preserveError = false } = options;
    const signIn = document.getElementById('loginSignIn');
    const reset = document.getElementById('loginReset');
    if(signIn){
      signIn.classList.remove('hidden');
      signIn.setAttribute('aria-hidden','false');
    }
    if(reset){
      reset.classList.add('hidden');
      reset.setAttribute('aria-hidden','true');
    }
    const resetEmailEl = document.getElementById('resetEmail');
    const typedResetEmail = resetEmailEl ? resetEmailEl.value : '';
    setResetStatus('');
    updateResetHint(DEFAULT_RESET_HINT);
    const resetForm = document.getElementById('resetForm');
    if(resetForm) resetForm.reset();
    if(resetEmailEl && !pendingResetCredentials){
      lastLoginEmail = typedResetEmail || lastLoginEmail;
    }
    const loginForm = document.getElementById('loginForm');
    if(loginForm) loginForm.reset();
    if(!preserveError){
      setLoginError('');
    }
    const loginEmailInput = document.getElementById('loginEmail');
    const loginPasswordInput = document.getElementById('loginPassword');
    if(loginEmailInput && !pendingResetCredentials){
      loginEmailInput.value = lastLoginEmail;
    }
    if(pendingResetCredentials){
      if(loginEmailInput) loginEmailInput.value = pendingResetCredentials.email || '';
      if(loginPasswordInput) loginPasswordInput.value = pendingResetCredentials.password || '';
      updateLoginHint(pendingResetCredentials.message || DEFAULT_LOGIN_HINT);
      const focusTarget = loginPasswordInput || loginEmailInput;
      if(focusTarget){
        focusTarget.focus();
      }
      pendingResetCredentials = null;
      return;
    }
    updateLoginHint(DEFAULT_LOGIN_HINT);
    if(loginEmailInput){
      loginEmailInput.focus();
    }
  }

  function showResetView(){
    const signIn = document.getElementById('loginSignIn');
    const reset = document.getElementById('loginReset');
    if(signIn){
      signIn.classList.add('hidden');
      signIn.setAttribute('aria-hidden','true');
    }
    if(reset){
      reset.classList.remove('hidden');
      reset.setAttribute('aria-hidden','false');
    }
    setLoginError('');
    setResetBusy(false);
    updateResetHint(DEFAULT_RESET_HINT);
    setResetStatus('');
    const loginEmailInput = document.getElementById('loginEmail');
    if(loginEmailInput){
      lastLoginEmail = loginEmailInput.value || lastLoginEmail;
    }
    const resetForm = document.getElementById('resetForm');
    if(resetForm) resetForm.reset();
    const resetEmailInput = document.getElementById('resetEmail');
    if(resetEmailInput){
      resetEmailInput.value = lastLoginEmail;
      setTimeout(() => resetEmailInput.focus(), 50);
    }
  }

  function showLoginScreen(message){
    const screen = document.getElementById('loginScreen');
    if(screen){
      screen.classList.remove('hidden');
      screen.setAttribute('aria-hidden','false');
    }
    const appShell = document.getElementById('app');
    if(appShell){
      appShell.classList.add('hidden');
    }
    pendingResetCredentials = null;
    lastLoginEmail = '';
    showSignInView({ preserveError: true });
    updateLoginHint(DEFAULT_LOGIN_HINT);
    updateResetHint(DEFAULT_RESET_HINT);
    setResetStatus('');
    setLoginError(message || '');
  }

  function hideLoginScreen(){
    const screen = document.getElementById('loginScreen');
    if(screen){
      screen.classList.add('hidden');
      screen.setAttribute('aria-hidden','true');
    }
    setLoginError('');
    setResetStatus('');
    updateLoginHint(DEFAULT_LOGIN_HINT);
    updateResetHint(DEFAULT_RESET_HINT);
  }

  function showAppShell(){
    const appShell = document.getElementById('app');
    if(appShell){
      appShell.classList.remove('hidden');
    }
    hideLoginScreen();
  }

  const brandImg = document.getElementById('sidebarBrandImg');
  const brandNameEl = document.getElementById('sidebarBrandName');
  const brandContainer = document.querySelector('.brand');

  function getFaviconSource(){
    if(!brandImg) return './icon-unidep180.png';
    return brandImg.dataset.faviconSrc || brandImg.getAttribute('data-favicon-src') || './icon-unidep180.png';
  }

  function applyBrandLogoState(){
    if(!brandImg) return;
    const appEl = document.getElementById('app');
    const isCollapsed = Boolean(appEl && appEl.classList.contains('collapsed'));
    const faviconSrc = getFaviconSource();
    const fallbackSrc = brandImg.dataset.fallbackSrc || brandImg.getAttribute('data-fallback-src') || faviconSrc;
    const avatarSrc = brandImg.dataset.avatarSrc || '';
    let nextSrc = fallbackSrc || faviconSrc;
    let useAvatar = false;
    if(isCollapsed){
      nextSrc = faviconSrc;
    }else if(avatarSrc){
      nextSrc = avatarSrc;
      useAvatar = true;
    }
    if(!nextSrc){
      nextSrc = faviconSrc;
    }
    brandImg.src = nextSrc;
    const logoAlt = brandImg.dataset.logoAlt || brandImg.getAttribute('data-logo-alt') || '';
    if(useAvatar){
      const avatarAlt = brandImg.dataset.avatarAlt || '';
      brandImg.alt = avatarAlt || logoAlt || '';
    }else{
      brandImg.alt = logoAlt || '';
    }
    brandImg.classList.toggle('brand-logo--avatar', useAvatar);
  }

  function updateCollapsedBrandInteractivity(){
    if(!brandContainer) return;
    const appEl = document.getElementById('app');
    const shouldBeInteractive = Boolean(appEl && appEl.classList.contains('collapsed') && window.innerWidth > 900);
    brandContainer.classList.toggle('brand--interactive', shouldBeInteractive);
    if(shouldBeInteractive){
      brandContainer.setAttribute('role','button');
      brandContainer.setAttribute('tabindex','0');
      const expandLabel = brandContainer.dataset.expandLabel || 'Expandir menú';
      brandContainer.setAttribute('aria-label', expandLabel);
    }else{
      brandContainer.removeAttribute('role');
      brandContainer.removeAttribute('tabindex');
      brandContainer.removeAttribute('aria-label');
    }
  }

  function expandDesktopSidebar(){
    const appEl = document.getElementById('app');
    if(!appEl || window.innerWidth <= 900 || !appEl.classList.contains('collapsed')) return false;
    appEl.classList.remove('collapsed');
    const toggleBtn = document.getElementById('menuToggle');
    if(toggleBtn){
      toggleBtn.setAttribute('aria-expanded','true');
      toggleBtn.classList.remove('is-collapsed');
    }
    const sidebarEl = document.getElementById('sidebar');
    if(sidebarEl){
      sidebarEl.setAttribute('aria-hidden','false');
    }
    applyBrandLogoState();
    updateCollapsedBrandInteractivity();
    return true;
  }

  if(brandContainer){
    brandContainer.addEventListener('click', () => {
      if(window.innerWidth <= 900) return;
      expandDesktopSidebar();
    });
    brandContainer.addEventListener('keydown', event => {
      if(event.key !== 'Enter' && event.key !== ' ') return;
      if(window.innerWidth <= 900) return;
      event.preventDefault();
      expandDesktopSidebar();
    });
    updateCollapsedBrandInteractivity();
  }

  function updateUserBadge(){
    const badge = document.getElementById('userBadge');
    const toggle = document.getElementById('menuToggle');
    const avatarImg = document.getElementById('sidebarAvatarImg');
    const avatarUrl = userProfile && userProfile.avatar ? String(userProfile.avatar).trim() : '';
    const fallbackLogo = brandImg ? (brandImg.dataset.fallbackSrc || brandImg.getAttribute('data-fallback-src') || './assets/relead-logo.svg') : './assets/relead-logo.svg';
    const currentName = currentUser && currentUser.name ? String(currentUser.name).trim() : '';
    const profileName = userProfile && userProfile.name ? String(userProfile.name).trim() : '';
    const userId = currentUser && currentUser.userId ? String(currentUser.userId).trim() : '';
    const role = currentUser && currentUser.role ? String(currentUser.role).trim().toLowerCase() : '';
    const roleLabel = ROLE_LABELS[role] || role;
    const displayName = currentName || profileName || userId || 'Usuario';

    const faviconSrc = getFaviconSource();
    const avatarDisplayUrl = avatarUrl || faviconSrc || '';

    if(toggle){
      toggle.classList.toggle('has-avatar', Boolean(avatarDisplayUrl));
    }
    if(avatarImg){
      if(avatarDisplayUrl){
        avatarImg.src = avatarDisplayUrl;
        if(avatarUrl){
          const avatarAltText = displayName && displayName !== 'Usuario'
            ? `Foto de perfil de ${displayName}`
            : 'Foto de perfil del usuario';
          avatarImg.alt = avatarAltText;
        }else{
          const defaultLogoAlt = brandImg && (brandImg.dataset.logoAlt || brandImg.getAttribute('data-logo-alt'));
          avatarImg.alt = defaultLogoAlt || 'Icono de la aplicación';
        }
      }else{
        avatarImg.removeAttribute('src');
        avatarImg.alt = '';
      }
    }

    if(brandNameEl){
      brandNameEl.textContent = displayName;
    }
    if(brandImg){
      const fallbackSrc = fallbackLogo || faviconSrc;
      brandImg.dataset.faviconSrc = faviconSrc;
      brandImg.dataset.fallbackSrc = fallbackSrc;
      if(avatarUrl){
        brandImg.dataset.avatarSrc = avatarUrl;
        const avatarAltText = displayName && displayName !== 'Usuario'
          ? `Avatar de ${displayName}`
          : 'Avatar del usuario';
        brandImg.dataset.avatarAlt = avatarAltText;
      }else{
        brandImg.dataset.avatarSrc = '';
        delete brandImg.dataset.avatarAlt;
      }
      if(!brandImg.dataset.logoAlt){
        const defaultLogoAlt = brandImg.getAttribute('data-logo-alt') || 'ReLead EDU';
        brandImg.dataset.logoAlt = defaultLogoAlt;
      }
      applyBrandLogoState();
      updateCollapsedBrandInteractivity();
    }

    if(!badge) return;
    const badgeParts = [userId, roleLabel].filter(Boolean);
    const badgeText = badgeParts.join(' - ');
    if(badgeText){
      badge.textContent = badgeText;
      badge.classList.remove('hidden');
      const titleParts = [];
      if(displayName && displayName !== badgeText){
        titleParts.push(displayName);
      }
      if(!titleParts.length && badgeText){
        titleParts.push(badgeText);
      }
      if(titleParts.length){
        badge.title = titleParts.join(' · ');
      }else{
        badge.removeAttribute('title');
      }
    }else{
      badge.textContent = '';
      badge.classList.add('hidden');
      badge.removeAttribute('title');
    }

    if(typeof applyNavigationPermissions === 'function'){
      applyNavigationPermissions();
    }
  }

  function hydrateProfileFromUser(){
    if(!currentUser) return;
    const updates = {};
    if(currentUser.userId && userProfile.userId !== currentUser.userId){
      updates.userId = currentUser.userId;
    }
    if(currentUser.name && userProfile.name !== currentUser.name){
      updates.name = currentUser.name;
    }
    if(currentUser.email && userProfile.email !== currentUser.email){
      updates.email = currentUser.email;
    }
    if(currentUser.role && userProfile.role !== currentUser.role){
      updates.role = currentUser.role;
    }
    if(!userProfile.campus || (currentUser.planteles && currentUser.planteles.length && !currentUser.planteles.includes(userProfile.campus))){
      const planteles = getAllowedPlanteles();
      if(planteles.length){
        updates.campus = planteles[0];
      }
    }
    const sourceTimestamp = Number(currentUser.directoryUpdatedAt || currentUser.sourceUpdatedAt || currentUser.updatedAt || 0);
    if(sourceTimestamp && (!userProfile.sourceUpdatedAt || userProfile.sourceUpdatedAt !== sourceTimestamp)){
      updates.sourceUpdatedAt = sourceTimestamp;
    }
    if(currentUser.sourceLabel || currentUser.directorySource){
      const label = currentUser.sourceLabel || currentUser.directorySource;
      if(label && label !== userProfile.sourceLabel){
        updates.sourceLabel = label;
      }
    }
    if(Number.isFinite(currentUser.profileSyncedAt) && currentUser.profileSyncedAt > 0){
      updates.syncedAt = Number(currentUser.profileSyncedAt);
    }
    if(Object.keys(updates).length){
      updateProfileData(updates);
    }else if(settingsReady){
      syncProfileUI();
    }
  }

  function getNavigationLinks(){
    return Array.from(document.querySelectorAll('.nav-link[data-nav]'));
  }

  function syncNavigationState(activeView){
    const links = getNavigationLinks();
    links.forEach(link => {
      const view = link.dataset.nav;
      const isActive = view === activeView;
      link.classList.toggle('active', isActive);
      if(link.tagName === 'A'){
        if(isActive){
          link.setAttribute('aria-current','page');
        }else{
          link.removeAttribute('aria-current');
        }
      }
      if(link.getAttribute('role') === 'tab'){
        link.setAttribute('aria-selected', isActive ? 'true' : 'false');
        link.setAttribute('tabindex', isActive ? '0' : '-1');
      }
    });
  }

  function applyNavigationPermissions(){
    const links = getNavigationLinks();
    let fallbackLink = null;
    links.forEach(link => {
      const view = link.dataset.nav;
      const allowed = canAccessView(view);
      link.classList.toggle('hidden', !allowed);
      if(link.tagName === 'BUTTON' || link.getAttribute('role') === 'tab'){
        link.disabled = !allowed;
      }
      const section = view ? document.getElementById(`view-${view}`) : null;
      if(section && !allowed){
        section.classList.add('hidden');
        section.classList.remove('is-visible','is-exiting');
      }
      if(allowed && !fallbackLink){
        fallbackLink = link;
      }
    });
    const activeLink = links.find(link => link.classList.contains('active') && !link.classList.contains('hidden'));
    const targetLink = activeLink && canAccessView(activeLink.dataset.nav) ? activeLink : fallbackLink;
    if(targetLink){
      activateView(targetLink.dataset.nav, targetLink);
    }
  }

  function activateView(view, sourceLink){
    if(!view || !canAccessView(view)) return;
    const section = document.getElementById(`view-${view}`);
    if(!section) return;
    const sections = els('.view-section');
    const reduceMotion = document.documentElement.getAttribute('data-motion') === 'reduced'
      || (typeof window !== 'undefined' && window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches);
    if(reduceMotion){
      sections.forEach(sec => {
        const isTarget = sec === section;
        sec.classList.toggle('hidden', !isTarget);
        if(isTarget){
          sec.classList.add('is-visible');
          sec.classList.remove('is-exiting');
        }else{
          sec.classList.remove('is-visible', 'is-exiting');
        }
      });
    }else{
      sections.forEach(sec => {
        const isTarget = sec === section;
        if(isTarget){
          sec.classList.remove('hidden', 'is-exiting');
          sec.classList.remove('is-visible');
          void sec.offsetWidth;
          sec.classList.add('is-visible');
        }else if(!sec.classList.contains('hidden')){
          sec.classList.add('is-exiting');
          sec.classList.remove('is-visible');
          const onEnd = event => {
            if(event.target !== sec) return;
            sec.removeEventListener('transitionend', onEnd);
            sec.classList.add('hidden');
            sec.classList.remove('is-exiting');
          };
          sec.addEventListener('transitionend', onEnd);
          setTimeout(() => {
            if(sec.classList.contains('is-exiting')){
              sec.removeEventListener('transitionend', onEnd);
              sec.classList.add('hidden');
              sec.classList.remove('is-exiting');
            }
          }, 380);
        }else{
          sec.classList.remove('is-visible', 'is-exiting');
        }
      });
    }
    syncNavigationState(view);
    updateMobileTopbar(section, sourceLink);
    handleViewShown(view);
  }

  function handleViewShown(view){
    if(view === 'permisos'){
      ensurePermissionsLoaded();
      ensureTeamsLoaded();
    }
  }

  const pendingRequests = new Map();
  const networkErrorLog = [];
  const MAX_NETWORK_ERRORS = 50;
  const createAbortError = message => {
    try{
      return new DOMException(message, 'AbortError');
    }catch(_err){
      const error = new Error(message);
      error.name = 'AbortError';
      return error;
    }
  };
  function logNetworkError(error, context = {}){
    const entry = {
      time: new Date().toISOString(),
      message: error && error.message ? error.message : String(error),
      context
    };
    networkErrorLog.push(entry);
    if(networkErrorLog.length > MAX_NETWORK_ERRORS){
      networkErrorLog.shift();
    }
    console.error('API request failed', entry);
  }
  function applyActionPermissions(){
    const setDisabled = (selector, allowed, message) => {
      const element = document.querySelector(selector);
      if(!element) return;
      element.disabled = !allowed;
      if(!allowed && message){
        element.title = message;
      }else if(element.title){
        element.removeAttribute('title');
      }
    };
    const importAllowed = canPerform('importData');
    ['#btnVerify','#btnExecute','#btnActivosVerify','#btnActivosExecute','#btnBulkVerify','#btnBulkExecute'].forEach(sel => setDisabled(sel, importAllowed, 'No tienes permisos para importar datos.'));
    const exportAllowed = canPerform('exportData');
    ['#btnExportData','#btnExportReport','#btnExportResolution'].forEach(sel => setDisabled(sel, exportAllowed, 'No tienes permisos para exportar información.'));
    setDisabled('#diagBtn', canPerform('runDiagnostics'), 'No tienes permisos para ejecutar el diagnóstico.');
    const manageTeamsAllowed = canPerform('manageTeams');
    ['#teamSaveBtn','#teamDeleteBtn','#teamNewBtn','#teamReloadBtn','#teamCloneBtn'].forEach(sel => setDisabled(sel, manageTeamsAllowed, 'No tienes permisos para administrar equipos.'));
    renderTeamTemplateToolbar();
    renderPreferencePresets();
  }

  async function apiFetch(url, options = {}){
    const opts = { ...options };
    const dedupeKey = opts.dedupeKey;
    const externalSignal = opts.signal;
    const requestLabel = opts.label || '';
    const customTimeout = Number.isFinite(opts.timeout) ? opts.timeout : REQUEST_TIMEOUT_MS;
    delete opts.dedupeKey;
    delete opts.signal;
    delete opts.label;
    delete opts.timeout;
    const controller = new AbortController();
    let timeoutId = null;
    if(externalSignal){
      if(externalSignal.aborted){
        controller.abort(externalSignal.reason);
      }else{
        externalSignal.addEventListener('abort', () => controller.abort(externalSignal.reason), { once: true });
      }
    }
    if(dedupeKey){
      const previous = pendingRequests.get(dedupeKey);
      if(previous){
        previous.abort(createAbortError('Request superseded'));
      }
      pendingRequests.set(dedupeKey, controller);
    }
    if(customTimeout && customTimeout > 0){
      timeoutId = setTimeout(() => {
        if(!controller.signal.aborted){
          controller.abort(createAbortError('Tiempo de espera agotado'));
        }
      }, customTimeout);
    }
    const method = String(opts.method || 'GET').toUpperCase();
    let finalUrl = url;
    const headers = new Headers(opts.headers || {});
    if(headers.has('Authorization')){
      headers.delete('Authorization');
    }
    const contentType = headers.get('Content-Type');
    if(contentType && contentType.toLowerCase().includes('application/json')){
      headers.delete('Content-Type');
    }
    let body = opts.body;
    const requestAuthToken = authToken || '';
    const hasAuth = Boolean(requestAuthToken);
    const isBodyInit = value => {
      if(value === null || value === undefined) return false;
      if(typeof value === 'string') return true;
      if(value instanceof FormData) return true;
      if(value instanceof URLSearchParams) return true;
      if(value instanceof Blob) return true;
      if(value instanceof ArrayBuffer) return true;
      if(ArrayBuffer.isView(value)) return true;
      return false;
    };
    const appendTokenToQuery = () => {
      if(!hasAuth) return;
      if(/(?:^|[?&])token=/.test(finalUrl)) return;
      finalUrl += (finalUrl.includes('?') ? '&' : '?') + `token=${encodeURIComponent(requestAuthToken)}`;
    };
    if(method === 'GET' || method === 'HEAD'){
      appendTokenToQuery();
      body = undefined;
    }else{
      if(body instanceof FormData){
        if(hasAuth && !body.has('token')){
          body.set('token', requestAuthToken);
        }
      }else if(body instanceof URLSearchParams){
        if(hasAuth && !body.has('token')){
          body.set('token', requestAuthToken);
        }
      }else if(typeof body === 'string' && body.trim()){
        if(hasAuth){
          try{
            const parsed = JSON.parse(body);
            if(!parsed.token){
              parsed.token = requestAuthToken;
            }
            body = JSON.stringify(parsed);
          }catch(_err){
            const joiner = body.includes('=') && !body.trim().endsWith('&') ? '&' : '';
            body = `${body}${joiner}token=${encodeURIComponent(requestAuthToken)}`;
          }
        }
      }else if(body && typeof body === 'object' && !isBodyInit(body)){
        const payload = Array.isArray(body) ? body.slice() : { ...body };
        if(hasAuth && !payload.token){
          payload.token = requestAuthToken;
        }
        body = JSON.stringify(payload);
      }else if(hasAuth && !body){
        body = JSON.stringify({ token: requestAuthToken });
      }
    }
    const requestInit = { ...opts, method };
    if(method === 'GET' || method === 'HEAD'){
      delete requestInit.body;
    }else if(body !== undefined){
      requestInit.body = body;
    }else{
      delete requestInit.body;
    }
    if(headers.size){
      requestInit.headers = headers;
    }else{
      delete requestInit.headers;
    }
    requestInit.signal = controller.signal;
    let response;
    try{
      response = await fetch(finalUrl, requestInit);
    }catch(err){
      if(!(err && err.name === 'AbortError')){
        logNetworkError(err, { url: finalUrl, method, dedupeKey, label: requestLabel });
      }
      throw err;
    }finally{
      if(timeoutId) clearTimeout(timeoutId);
      if(dedupeKey){
        const pending = pendingRequests.get(dedupeKey);
        if(pending === controller){
          pendingRequests.delete(dedupeKey);
        }
      }
    }
    if(response.status === 401){
      let message = 'Tu sesión expiró. Inicia sesión nuevamente.';
      try{
        const clone = response.clone();
        const data = await clone.json();
        if(data && data.error){
          message = data.error;
        }
      }catch(_err){}
      if(requestAuthToken && authToken === requestAuthToken){
        handleUnauthorized(message);
      }
      const error = new Error(message);
      error.code = 'UNAUTHORIZED';
      throw error;
    }
    return response;
  }
  async function onAuthenticated(token, user, options = {}){
    const persist = options.persist !== false;
    setAuthState(token, user, persist);
    resetAppData();
    state = createInitialState();
    hydrateProfileFromUser();
    showAppShell();
    applyNavigationPermissions();
    applyActionPermissions();
    await initializeApp();
  }

  async function restoreSession(){
    const stored = loadStoredAuthState();
    if(stored.token){
      authToken = stored.token;
      currentUser = stored.user || null;
      updateUserBadge();
      try{
        const res = await apiFetch(`${API_URL}?action=me`);
        if(!res.ok){
          throw new Error(`HTTP ${res.status}`);
        }
        const data = await res.json();
        if(data && data.user){
          await onAuthenticated(stored.token, data.user, { persist: true });
          return;
        }
        throw new Error('Respuesta inválida del servicio de autenticación.');
      }catch(err){
        if(err && err.code === 'UNAUTHORIZED'){
          return;
        }
        console.warn('No se pudo restaurar la sesión', err);
        handleUnauthorized('No se pudo restaurar tu sesión. Inicia nuevamente.');
        return;
      }
    }
    showLoginScreen('');
  }

  function handleUnauthorized(message){
    clearAuthState();
    authToken = '';
    currentUser = null;
    updateUserBadge();
    resetAppData();
    state = createInitialState();
    showLoginScreen(message || 'Tu sesión expiró. Inicia sesión nuevamente.');
  }

  async function performLogout(){
    const logoutBtn = document.getElementById('logoutBtn');
    if(logoutBtn && logoutBtn.disabled) return;
    if(logoutBtn){
      setNavLinkBusy(logoutBtn, true);
    }
    try{
      await withGlobalLoading('Cerrando sesión…', async()=>{
        if(!authToken) return;
        try{
          const separator = API_URL.includes('?') ? '&' : '?';
          const tokenPart = authToken ? `&token=${encodeURIComponent(authToken)}` : '';
          await fetch(`${API_URL}${separator}action=logout${tokenPart}`, { method:'POST' });
        }catch(err){
          console.warn('No se pudo notificar el cierre de sesión.', err);
        }
      });
    }finally{
      if(logoutBtn){
        setNavLinkBusy(logoutBtn, false);
      }
      clearAuthState();
      authToken = '';
      currentUser = null;
      updateUserBadge();
      resetAppData();
      state = createInitialState();
      showLoginScreen('Sesión cerrada.');
    }
  }

  function syncSheetSelectorsUI(){
    const selects = [document.getElementById('sheetSelect'), document.getElementById('importBaseSelect')];
    selects.forEach(select => {
      if(!select) return;
      const previous = select.value;
      select.innerHTML = sheets
        .map(s => {
          const label = sheetDisplayName(s) || s;
          return `<option value="${s}">${label}</option>`;
        })
        .join('');
      if(state.sheet && sheets.includes(state.sheet)){
        select.value = state.sheet;
      }else if(sheets.length){
        select.value = sheets[0] || '';
      }else{
        select.value = '';
      }
      if(!select.value && previous && sheets.includes(previous)){
        select.value = previous;
      }
    });
  }

  async function loadSheets(){
    if(!authToken) return;
    try{
      const res = await apiFetch(`${API_URL}?action=listSheets`, { dedupeKey: 'listSheets' });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      if(data && data.error){
        throw new Error(data.error);
      }
      const rawSheets = Array.isArray(data?.sheets) ? data.sheets : [];
      const parsedSheets = rawSheets
        .map(sheet => {
          if(typeof sheet === 'string') return sheet;
          if(sheet && typeof sheet.name === 'string') return sheet.name;
          if(sheet && typeof sheet.displayName === 'string') return sheet.displayName;
          if(sheet && typeof sheet.title === 'string') return sheet.title;
          if(sheet && sheet.properties && typeof sheet.properties.title === 'string'){
            return sheet.properties.title;
          }
          return '';
        })
        .map(name => (typeof name === 'string' ? name.trim() : ''))
        .filter(Boolean);
      sheets = parsedSheets.filter(isLeadSheetName);
      if(state.sheet && !sheets.includes(state.sheet)){
        state.sheet = sheets[0] || '';
      }
      if(!state.sheet){
        state.sheet = sheets[0] || '';
      }
    }catch(err){
      if(err && err.code === 'UNAUTHORIZED') return;
      console.error('Error al cargar hojas', err);
      sheets = [];
      state.sheet = '';
    }
  }

  function normalizeLeadRecord(raw, sheetName){
    const map = {};
    Object.keys(raw).forEach(k=>{
      const norm = k.normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,'').toLowerCase();
      map[norm] = raw[k];
    });
    const etapaVal = etapaLabel(map.etapa || '');
    const estadoVal = map.estado || '';
    const comentarioVal = map.comentario || '';
    const resolVal = map.resolucion || '';
    const crmVal = map.crm || '';
    const telefonoVal = pickField(
      map,
      ['telefononormalizado','telefono','telefonos','telefonocelular','telefonofijo','telefono1','telefono2','celular','movil','whatsapp','tel'],
      (key, value) => {
        const k = key.toLowerCase();
        const digits = value.replace(/\D/g,'');
        if(digits.length < 7) return false;
        if(k.startsWith('tel')) return true;
        if(k.includes('telefon')) return true;
        if(k.includes('tlf')) return true;
        if(k.includes('celular')) return true;
        if(k.includes('movil')) return true;
        if(k.includes('mobile')) return true;
        if(k.includes('whats')) return true;
        if(k.includes('phone')) return true;
        if(k.includes('cel') && k.includes('contact')) return true;
        if(k.includes('contact') && (k.includes('tel') || k.includes('phone'))) return true;
        return false;
      }
    );
    const telefonoNormalizado = map.telefononormalizado || '';
    const callUrl = map.telefonoaircall || '';
    const whatsappUrl = map.telefonowhatsapp || '';
    const emailUrl = map.correogmail || '';
    const campusVal = pickField(
      map,
      ['campus','plantel','sede'],
      key => key.includes('plantel') || key.includes('campus') || key.includes('sede')
    );
    return {
      id: map.id || '',
      nombre: map.nombre || '',
      matricula: map.matricula || '',
      correo: map.correo || '',
      telefono: telefonoVal,
      telefonoNormalizado: telefonoNormalizado || telefonoVal,
      callUrl,
      whatsappUrl,
      emailUrl,
      campus: campusVal,
      modalidad: map.modalidad || '',
      programa: map.programa || '',
      etapa: etapaVal,
      estado: estadoVal,
      asesor: map.asesor || (sheetDisplayName(sheetName) === 'Carga de Datos' ? 'Sistema' : ''),
      comentario: comentarioVal,
      asignacion: map.asignacion || '',
      toque1: map.toque1 || '',
      toque2: map.toque2 || '',
      toque3: map.toque3 || '',
      toque4: map.toque4 || '',
      resolucion: resolVal,
      crm: crmVal,
      metadatos: map.metadatos || '',
      base: sheetName,
      _originalEtapa: etapaVal,
      _originalEstado: estadoVal,
      _originalComentario: String(comentarioVal || '').trim()
    };
  }

  async function loadLeads(){
    if(!authToken){
      leads = [];
      return;
    }
    if(!state.sheet){
      leads = [];
      return;
    }
    try{
      const res = await apiFetch(`${API_URL}?action=getLeads&sheet=${encodeURIComponent(state.sheet)}`, { dedupeKey: `getLeads:${state.sheet}` });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      if(Array.isArray(data)){
        let mapped = data.map(raw => normalizeLeadRecord(raw, state.sheet));
        const planteles = getAllowedPlanteles();
        if(!planteles.hasGlobalAccess && planteles.length){
          const allowedSet = new Set(planteles.map(normalizePlantelKey));
          mapped = mapped.filter(item => {
            const campus = item.campus || '';
            if(!campus) return true;
            return allowedSet.has(normalizePlantelKey(campus));
          });
        }
        leads = mapped;
        state.columnLimits = {};
        state.columnLimitSignature = '';
      }else if(data && data.error){
        throw new Error(data.error);
      }else{
        leads = [];
      }
    }catch(err){
      if(err && err.code === 'UNAUTHORIZED') return;
      console.error('Error al cargar leads', err);
      leads = [];
    }
  }

  function invalidateGlobalLeadIndex(){
    globalLeadIndex = null;
  }

  function addIndexEntry(store, key, lead){
    if(!key) return;
    if(!store.has(key)) store.set(key, []);
    store.get(key).push(lead);
  }

  function addLeadToGlobalIndex(index, lead){
    const idKey = normalizeIdentifierKey(lead.id);
    if(idKey) addIndexEntry(index.byId, idKey, lead);
    const matKey = normalizeIdentifierKey(lead.matricula);
    if(matKey) addIndexEntry(index.byMatricula, matKey, lead);
    const phoneKey = normalizePhoneKey(lead.telefonoNormalizado || lead.telefono);
    if(phoneKey) addIndexEntry(index.byPhone, phoneKey, lead);
  }

  async function ensureGlobalLeadIndex(){
    if(globalLeadIndex) return globalLeadIndex;
    if(!authToken){
      globalLeadIndex = { byId:new Map(), byMatricula:new Map(), byPhone:new Map() };
      return globalLeadIndex;
    }
    if(!sheets.length){
      await loadSheets();
    }
    const index = { byId:new Map(), byMatricula:new Map(), byPhone:new Map() };
    const planteles = getAllowedPlanteles();
    const plantelSet = (!planteles.hasGlobalAccess && planteles.length)
      ? new Set(planteles.map(normalizePlantelKey))
      : null;
    for(const sheetName of sheets){
      if(!sheetName) continue;
      try{
        const res = await apiFetch(`${API_URL}?action=getLeads&sheet=${encodeURIComponent(sheetName)}`);
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        if(Array.isArray(data)){
          data
            .map(raw => normalizeLeadRecord(raw, sheetName))
            .filter(lead => {
              if(!plantelSet) return true;
              const campus = lead.campus || '';
              if(!campus) return true;
              return plantelSet.has(normalizePlantelKey(campus));
            })
            .forEach(lead => addLeadToGlobalIndex(index, lead));
        }
      }catch(err){
        if(err && err.code === 'UNAUTHORIZED'){
          globalLeadIndex = index;
          return index;
        }
        console.error('Error al cargar base para Activos', sheetName, err);
      }
    }
    globalLeadIndex = index;
    return index;
  }

  function populateAsesores(){
    const sel = el('#asesorSelect');
    if(!sel) return;
    const role = getUserRole();
    const asesores = [...new Set(
      leads
        .map(l => String(l.asesor || '').trim())
        .filter(a => a && !a.toLowerCase().includes('sistema'))
    )].sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
    let options = asesores.slice();
    const selected = getAsesorFilter();
    if(role === 'asesor'){
      const name = currentUser && currentUser.name ? String(currentUser.name).trim() : '';
      const normalizedName = normalizeAsesorName(name);
      if(normalizedName){
        const matches = asesores.filter(item => normalizeAsesorName(item) === normalizedName);
        options = matches.length ? matches : (name ? [name] : []);
      }else{
        options = [];
      }
      const enforced = options.length ? options[0] : '';
      setAsesorFilter(enforced ? [enforced] : []);
    }else if(selected.length){
      const map = new Map(options.map(item => [normalizeAsesorName(item), item]));
      const sanitized = selected
        .map(value => {
          const normalized = normalizeAsesorName(value);
          return normalized && map.has(normalized) ? map.get(normalized) : '';
        })
        .filter(Boolean);
      if(sanitized.length !== selected.length || sanitized.some((val, idx) => val !== selected[idx])){
        setAsesorFilter(sanitized);
      }
    }
    const multi = role === 'coordinador';
    sel.multiple = multi;
    sel.classList.toggle('is-multiple', multi);
    sel.size = multi ? Math.min(Math.max(options.length + 1, 4), 8) : 1;
    sel.innerHTML = '';
    const includeAllOption = multi || role !== 'asesor';
    if(includeAllOption){
      const allOption = document.createElement('option');
      allOption.value = '';
      allOption.textContent = multi ? 'Todos los asesores' : 'Todos';
      sel.appendChild(allOption);
    }
    const selectedSet = new Set(getAsesorFilter().map(normalizeAsesorName).filter(Boolean));
    options.forEach(optionValue => {
      const option = document.createElement('option');
      option.value = optionValue;
      option.textContent = optionValue;
      if(selectedSet.has(normalizeAsesorName(optionValue))){
        option.selected = true;
      }
      sel.appendChild(option);
    });
    if(multi){
      if(!selectedSet.size && sel.options.length){
        sel.options[0].selected = true;
      }
    }else if(role !== 'asesor'){
      const current = getAsesorFilter();
      sel.value = current.length ? current[0] : '';
    }else{
      const enforced = getAsesorFilter();
      sel.value = enforced.length ? enforced[0] : '';
    }
    if(role === 'asesor'){
      sel.disabled = true;
      sel.title = 'Solo puedes visualizar tu propio usuario.';
    }else{
      sel.disabled = false;
      sel.removeAttribute('title');
    }
  }

  function populateCampuses(){
    const sel = el('#campusSelect');
    if(!sel) return;
    const campuses = [...new Set(
      leads
        .map(l => l.campus)
        .filter(c => c)
    )].sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
    sel.innerHTML = '<option value="">Todos</option>' +
      campuses.map(c=>`<option value="${c}">${c}</option>`).join('');
    if(state.campus && !campuses.includes(state.campus)){
      state.campus = '';
    }
    sel.value = state.campus;
  }

  const el = sel => document.querySelector(sel);
  const els = sel => Array.from(document.querySelectorAll(sel));
  function readStorageJSON(key){
    try{
      const raw = localStorage.getItem(key);
      if(!raw) return null;
      return JSON.parse(raw);
    }catch(err){
      console.warn('No se pudo leer', key, err);
      return null;
    }
  }
  function writeStorageJSON(key, value){
    try{
      localStorage.setItem(key, JSON.stringify(value));
    }catch(err){
      console.warn('No se pudo guardar', key, err);
    }
  }
  function removeStorageKey(key){
    try{
      localStorage.removeItem(key);
    }catch(err){
      console.warn('No se pudo eliminar', key, err);
    }
  }
  function clearLegacyThemeKey(){
    try{
      localStorage.removeItem('pulseTheme');
    }catch(err){
      /* noop */
    }
  }
  function loadStoredProfile(){
    const stored = readStorageJSON(STORAGE_KEYS.profile);
    if(stored && typeof stored === 'object'){
      return { ...DEFAULT_PROFILE, ...stored };
    }
    return { ...DEFAULT_PROFILE };
  }
  function loadStoredPreferences(){
    const stored = readStorageJSON(STORAGE_KEYS.preferences);
    let prefs = { ...DEFAULT_PREFERENCES, ...(stored && typeof stored === 'object' ? stored : {}) };
    if((!stored || typeof stored.reducedMotion === 'undefined') && typeof window !== 'undefined' && window.matchMedia){
      const motionQuery = window.matchMedia('(prefers-reduced-motion: reduce)');
      if(motionQuery.matches){
        prefs.reducedMotion = true;
      }
    }
    try{
      const legacyTheme = localStorage.getItem('pulseTheme');
      if(legacyTheme && !prefs.theme){
        prefs.theme = legacyTheme;
      }
    }catch(err){
      /* ignore legacy read */
    }
    return prefs;
  }
  function loadStoredPasswordRequest(){
    const stored = readStorageJSON(STORAGE_KEYS.password);
    if(stored && typeof stored === 'object'){
      const normalized = { ...DEFAULT_PASSWORD_REQUEST };
      if(typeof stored.status === 'string') normalized.status = stored.status;
      if(typeof stored.requestedAt === 'number') normalized.requestedAt = stored.requestedAt;
      if(typeof stored.requestedBy === 'string') normalized.requestedBy = stored.requestedBy;
      if(typeof stored.approvedAt === 'number') normalized.approvedAt = stored.approvedAt;
      if(typeof stored.approvedBy === 'string') normalized.approvedBy = stored.approvedBy;
      if(typeof stored.completedAt === 'number') normalized.completedAt = stored.completedAt;
      if(typeof stored.completedBy === 'string') normalized.completedBy = stored.completedBy;
      if(!normalized.requestedAt && typeof stored.timestamp === 'number'){
        normalized.requestedAt = stored.timestamp;
      }
      if(!normalized.status){
        if(normalized.completedAt) normalized.status = 'completed';
        else if(normalized.approvedAt) normalized.status = 'approved';
        else if(normalized.requestedAt) normalized.status = 'requested';
      }
      return normalized;
    }
    if(typeof stored === 'number' && stored > 0){
      return { ...DEFAULT_PASSWORD_REQUEST, status: 'requested', requestedAt: stored };
    }
    return { ...DEFAULT_PASSWORD_REQUEST };
  }
  function handleSystemThemeChange(event){
    if((userPreferences.theme || 'system') === 'system'){
      document.documentElement.setAttribute('data-theme', event.matches ? 'dark' : 'light');
    }
  }
  function resolveTheme(themePref){
    const pref = themePref || 'system';
    return pref === 'system' ? (systemThemeQuery.matches ? 'dark' : 'light') : pref;
  }
  function applyPreferences(){
    applyTheme();
    applyLanguage();
    applyDensity();
    applyEcoMode();
    applyMotionPreference();
    applyFontScale();
    applyAccentPreference();
    applyBoardLayoutPreference();
    applyContrastPreference();
    applyLeadIdPreference();
  }
  function applyTheme(){
    const pref = userPreferences.theme || 'system';
    const resolved = resolveTheme(pref);
    document.documentElement.setAttribute('data-theme', resolved);
    document.documentElement.setAttribute('data-theme-pref', pref);
  }
  function applyLanguage(){
    const lang = userPreferences.language || 'es';
    document.documentElement.setAttribute('lang', lang);
  }
  function applyDensity(){
    const density = userPreferences.density || 'comfortable';
    document.documentElement.setAttribute('data-density', density);
  }
  function applyEcoMode(){
    document.documentElement.setAttribute('data-eco', userPreferences.eco ? 'true' : 'false');
  }
  function applyMotionPreference(){
    document.documentElement.setAttribute('data-motion', userPreferences.reducedMotion ? 'reduced' : 'full');
  }
  function applyFontScale(){
    document.documentElement.setAttribute('data-font-scale', userPreferences.largeText ? 'large' : 'normal');
  }
  function applyAccentPreference(){
    const palette = ACCENT_PALETTES[userPreferences.accent] || ACCENT_PALETTES.blue;
    document.documentElement.style.setProperty('--color-primary', palette.primary);
    document.documentElement.style.setProperty('--color-secondary', palette.secondary);
    document.documentElement.style.setProperty('--accent', palette.primary);
    document.documentElement.style.setProperty('--accent-2', palette.secondary);
    document.documentElement.style.setProperty('--panel-base-rgb', palette.panel);
  }
  function applyBoardLayoutPreference(){
    const layout = userPreferences.boardDensity || 'standard';
    document.documentElement.setAttribute('data-board-density', layout);
  }
  function applyContrastPreference(){
    document.documentElement.setAttribute('data-contrast', userPreferences.highContrast ? 'high' : 'normal');
  }
  function applyLeadIdPreference(){
    document.documentElement.setAttribute('data-show-lead-id', userPreferences.showLeadId ? 'true' : 'false');
  }
  function renderPreferencePresets(){
    const container = el('#prefPresetRecommendations');
    const list = el('#prefPresetList');
    if(!container || !list) return;
    const presets = Array.isArray(INSTITUTIONAL_PRESETS) ? INSTITUTIONAL_PRESETS.filter(Boolean) : [];
    if(getUserRole() !== 'admin' || !presets.length){
      container.hidden = true;
      list.innerHTML = '';
      return;
    }
    list.innerHTML = '';
    presets.forEach(preset => {
      const card = document.createElement('div');
      card.className = 'pref-preset-card';
      const title = document.createElement('strong');
      title.textContent = preset.name || 'Preset';
      card.appendChild(title);
      if(preset.description){
        const desc = document.createElement('p');
        desc.textContent = preset.description;
        card.appendChild(desc);
      }
      const button = document.createElement('button');
      button.type = 'button';
      button.className = 'btn micro';
      if(userPreferences.appliedPreset === preset.id){
        button.innerHTML = '<i class="bi bi-check-circle"></i> Aplicado';
        button.disabled = true;
      }else{
        button.innerHTML = '<i class="bi bi-lightning-charge"></i> Aplicar';
        button.addEventListener('click', () => applyInstitutionalPreset(preset));
      }
      card.appendChild(button);
      list.appendChild(card);
    });
    container.hidden = false;
    container.removeAttribute('hidden');
  }
  function applyInstitutionalPreset(preset){
    if(!preset || !preset.values) return;
    const updates = { ...preset.values, appliedPreset: preset.id || '' };
    updatePreferences(updates);
    showSettingsMessage(`Se aplicó el preset ${preset.name || 'institucional'}.`, 'success');
  }
  function updatePreferences(partial){
    userPreferences = { ...userPreferences, ...partial };
    writeStorageJSON(STORAGE_KEYS.preferences, userPreferences);
    clearLegacyThemeKey();
    applyPreferences();
    if(settingsReady){
      syncPreferencesForm();
      renderPreferencePresets();
    }
    if(typeof refresh === 'function'){
      try{
        refresh();
      }catch(err){
        console.warn('No se pudo actualizar la vista tras modificar preferencias.', err);
      }
    }
  }
  function resetPreferences(){
    userPreferences = { ...DEFAULT_PREFERENCES };
    removeStorageKey(STORAGE_KEYS.preferences);
    clearLegacyThemeKey();
    applyPreferences();
    if(settingsReady){
      syncPreferencesForm();
    }
    if(typeof refresh === 'function'){
      try{
        refresh();
      }catch(err){
        console.warn('No se pudo actualizar la vista tras restablecer preferencias.', err);
      }
    }
  }
  function updateProfileData(partial){
    userProfile = { ...userProfile, ...partial };
    writeStorageJSON(STORAGE_KEYS.profile, userProfile);
    if(settingsReady){
      syncProfileUI();
    }
    updateUserBadge();
  }
  function resetProfileData(){
    userProfile = { ...DEFAULT_PROFILE };
    removeStorageKey(STORAGE_KEYS.profile);
    if(settingsReady){
      syncProfileUI();
    }
    updateUserBadge();
  }
  function computeInitials(){
    const name = (userProfile.name || '').trim();
    if(name){
      const parts = name.split(/\s+/).filter(Boolean).slice(0, 2);
      if(parts.length){
        return parts.map(p => p.charAt(0).toUpperCase()).join('');
      }
    }
    const id = (userProfile.userId || '').trim();
    if(id){
      return id.slice(0, 2).toUpperCase();
    }
    return 'U';
  }
  function syncProfileUI(){
    const idInput = el('#profileId');
    if(idInput) idInput.value = userProfile.userId || '';
    const nameInput = el('#profileName');
    if(nameInput) nameInput.value = userProfile.name || '';
    const emailInput = el('#profileEmail');
    if(emailInput) emailInput.value = userProfile.email || '';
    const roleInput = el('#profileRole');
    if(roleInput) roleInput.value = userProfile.role || '';
    const campusInput = el('#profileCampus');
    if(campusInput) campusInput.value = userProfile.campus || '';
    const avatarFrame = el('#profileAvatarFrame');
    const avatarImg = el('#profileAvatarImg');
    const avatarInitials = el('#profileAvatarInitials');
    if(avatarFrame && avatarImg && avatarInitials){
      if(userProfile.avatar){
        avatarFrame.classList.add('has-image');
        avatarImg.src = userProfile.avatar;
        avatarInitials.textContent = '';
      }else{
        avatarFrame.classList.remove('has-image');
        avatarImg.removeAttribute('src');
        avatarInitials.textContent = computeInitials();
      }
    }
    const summaryId = el('#profileSummaryId');
    if(summaryId) summaryId.textContent = userProfile.userId || 'Sin definir';
    const summaryName = el('#profileSummaryName');
    if(summaryName) summaryName.textContent = userProfile.name || 'Sin definir';
    const summaryEmail = el('#profileSummaryEmail');
    if(summaryEmail) summaryEmail.textContent = userProfile.email || 'Sin definir';
    const summaryRole = el('#profileSummaryRole');
    if(summaryRole) summaryRole.textContent = userProfile.role || 'Sin definir';
    const summaryCampus = el('#profileSummaryCampus');
    if(summaryCampus) summaryCampus.textContent = userProfile.campus || 'Sin definir';
    updateProfileSyncAlert();
  }

  function updateProfileSyncAlert(){
    const alert = el('#profileSyncAlert');
    if(!alert) return;
    if(getUserRole() !== 'admin'){
      alert.hidden = true;
      return;
    }
    const sourceLabel = userProfile.sourceLabel || 'Directorio maestro';
    const syncedAt = Number(userProfile.syncedAt) || 0;
    const sourceAt = Number(userProfile.sourceUpdatedAt) || 0;
    alert.innerHTML = '';
    let state = '';
    const title = document.createElement('strong');
    const description = document.createElement('span');
    if(!sourceAt && !syncedAt){
      state = 'unknown';
      title.textContent = 'Sin referencia de sincronización';
      description.textContent = `Vincula este perfil con ${sourceLabel} para garantizar datos vigentes.`;
    }else if(sourceAt && (!syncedAt || sourceAt > syncedAt)){
      state = 'stale';
      title.textContent = 'Datos desactualizados';
      description.textContent = `Última actualización en ${sourceLabel}: ${formatDateTime(sourceAt)}.`;
    }else{
      title.textContent = 'Información sincronizada';
      description.textContent = `Última verificación local: ${formatDateTime(syncedAt)}.`;
    }
    alert.appendChild(title);
    alert.appendChild(description);
    if(state === 'stale'){
      const hint = document.createElement('span');
      hint.textContent = 'Sincroniza la ficha y alinea los datos críticos con la fuente maestra.';
      alert.appendChild(hint);
    }else if(state === 'unknown'){
      const hint = document.createElement('span');
      hint.textContent = 'Registra una sincronización cuando valides la información desde la fuente maestra.';
      alert.appendChild(hint);
    }
    const button = document.createElement('button');
    button.type = 'button';
    button.className = 'btn micro';
    if(state === ''){
      button.innerHTML = '<i class="bi bi-clock-history"></i> Registrar nueva sincronización';
    }else{
      button.innerHTML = '<i class="bi bi-arrow-repeat"></i> Sincronizar ahora';
    }
    button.addEventListener('click', handleProfileSyncNow);
    alert.appendChild(button);
    if(state){
      alert.dataset.state = state;
    }else{
      delete alert.dataset.state;
    }
    alert.hidden = false;
  }

  function handleProfileSyncNow(){
    const now = Date.now();
    const updates = { syncedAt: now };
    if(!userProfile.sourceUpdatedAt){
      updates.sourceUpdatedAt = now;
    }
    updateProfileData(updates);
    showSettingsMessage('Se marcó la información del perfil como sincronizada.', 'success');
  }

  function syncPreferencesForm(){
    const themePref = userPreferences.theme || 'system';
    els('input[name="pref-theme"]').forEach(radio => {
      radio.checked = radio.value === themePref;
    });
    const languageSel = el('#prefLanguage');
    if(languageSel) languageSel.value = userPreferences.language || 'es';
    const densitySel = el('#prefDensity');
    if(densitySel) densitySel.value = userPreferences.density || 'comfortable';
    const boardDensitySel = el('#prefBoardDensity');
    if(boardDensitySel) boardDensitySel.value = userPreferences.boardDensity || 'standard';
    const accentSel = el('#prefAccent');
    if(accentSel) accentSel.value = userPreferences.accent || 'blue';
    const ecoToggle = el('#prefEco');
    if(ecoToggle) ecoToggle.checked = Boolean(userPreferences.eco);
    const motionToggle = el('#prefMotion');
    if(motionToggle) motionToggle.checked = Boolean(userPreferences.reducedMotion);
    const largeTextToggle = el('#prefLargeText');
    if(largeTextToggle) largeTextToggle.checked = Boolean(userPreferences.largeText);
    const highContrastToggle = el('#prefHighContrast');
    if(highContrastToggle) highContrastToggle.checked = Boolean(userPreferences.highContrast);
    const showLeadIdToggle = el('#prefShowLeadId');
    if(showLeadIdToggle) showLeadIdToggle.checked = Boolean(userPreferences.showLeadId);
  }
  function formatDateTime(timestamp){
    if(!timestamp) return 'nunca';
    try{
      return new Date(timestamp).toLocaleString(userPreferences.language || 'es', { dateStyle: 'medium', timeStyle: 'short' });
    }catch(err){
      return new Date(timestamp).toLocaleString();
    }
  }
  function updatePasswordInfo(){
    const state = passwordRequestState || { ...DEFAULT_PASSWORD_REQUEST };
    let message = 'Sin solicitudes registradas.';
    let tone = 'info';
    if(state.status === 'requested' && state.requestedAt){
      const parts = [`Pendiente de aprobación desde ${formatDateTime(state.requestedAt)}`];
      if(state.requestedBy) parts.push(`Responsable: ${state.requestedBy}`);
      message = parts.join(' · ');
      tone = 'warning';
    }else if(state.status === 'approved' && state.approvedAt){
      const parts = [`Aprobada el ${formatDateTime(state.approvedAt)}`];
      if(state.approvedBy) parts.push(`Responsable: ${state.approvedBy}`);
      message = parts.join(' · ');
      tone = 'info';
    }else if(state.status === 'completed' && state.completedAt){
      const parts = [`Completada el ${formatDateTime(state.completedAt)}`];
      if(state.completedBy) parts.push(`Responsable: ${state.completedBy}`);
      message = parts.join(' · ');
      tone = 'success';
    }
    setPasswordStatus(message, tone);
    renderPasswordTimeline(state);
    updatePasswordActionVisibility(state);
  }
  function clearPasswordForm(){
    const current = el('#passwordCurrent');
    const next = el('#passwordNew');
    const confirm = el('#passwordConfirm');
    if(current) current.value = '';
    if(next) next.value = '';
    if(confirm) confirm.value = '';
  }
  function setPasswordStatus(message, tone = 'info'){
    const statusWrap = el('#passwordStatusCard');
    const statusText = el('#passwordRequestStatus');
    if(statusText){
      statusText.textContent = message;
    }
    if(statusWrap){
      if(tone){
        statusWrap.dataset.tone = tone;
      }else{
        statusWrap.removeAttribute('data-tone');
      }
    }
  }
  function renderPasswordTimeline(state){
    const timeline = el('#passwordRequestTimeline');
    if(!timeline) return;
    timeline.innerHTML = '';
    const currentState = state || { ...DEFAULT_PASSWORD_REQUEST };
    if(!currentState.requestedAt && !currentState.approvedAt && !currentState.completedAt){
      const empty = document.createElement('span');
      empty.className = 'security-timeline__meta';
      empty.textContent = 'Registra una solicitud para iniciar el flujo de aprobación.';
      timeline.appendChild(empty);
      return;
    }
    const steps = [
      { key: 'requestedAt', label: 'Solicitud registrada', timestamp: currentState.requestedAt, by: currentState.requestedBy },
      { key: 'approvedAt', label: 'Aprobación', timestamp: currentState.approvedAt, by: currentState.approvedBy },
      { key: 'completedAt', label: 'Entrega confirmada', timestamp: currentState.completedAt, by: currentState.completedBy }
    ];
    steps.forEach((step, index) => {
      const item = document.createElement('div');
      item.className = 'security-timeline__item';
      let stateTag = 'future';
      if(step.timestamp){
        stateTag = 'done';
      }else if(index === 0){
        stateTag = 'active';
      }else if(index === 1 && currentState.requestedAt){
        stateTag = 'active';
      }else if(index === 2 && currentState.approvedAt){
        stateTag = 'active';
      }
      item.dataset.state = stateTag;
      const badge = document.createElement('span');
      badge.className = 'security-timeline__badge';
      item.appendChild(badge);
      const content = document.createElement('div');
      content.className = 'security-timeline__content';
      const label = document.createElement('span');
      label.className = 'security-timeline__label';
      label.textContent = step.label;
      content.appendChild(label);
      const meta = document.createElement('span');
      meta.className = 'security-timeline__meta';
      if(step.timestamp){
        const metaParts = [formatDateTime(step.timestamp)];
        if(step.by) metaParts.push(`Responsable: ${step.by}`);
        meta.textContent = metaParts.join(' · ');
      }else if(stateTag === 'active'){
        meta.textContent = 'Pendiente de registrar.';
      }else{
        meta.textContent = 'En espera del paso previo.';
      }
      content.appendChild(meta);
      item.appendChild(content);
      timeline.appendChild(item);
    });
  }

  function updatePasswordActionVisibility(state){
    const approveBtn = el('#passwordApproveBtn');
    const completeBtn = el('#passwordCompleteBtn');
    const actions = el('#passwordStatusActions');
    const canApprove = Boolean(state?.requestedAt) && !state?.approvedAt;
    const canComplete = Boolean(state?.approvedAt) && !state?.completedAt;
    if(approveBtn) approveBtn.hidden = !canApprove;
    if(completeBtn) completeBtn.hidden = !canComplete;
    if(actions){
      actions.hidden = !canApprove && !canComplete;
    }
  }

  function persistPasswordRequestState(){
    writeStorageJSON(STORAGE_KEYS.password, passwordRequestState);
  }

  function getCurrentOperatorLabel(){
    if(currentUser){
      if(currentUser.name) return currentUser.name;
      if(currentUser.userId) return currentUser.userId;
      if(currentUser.email) return currentUser.email;
    }
    if(userProfile){
      if(userProfile.name) return userProfile.name;
      if(userProfile.userId) return userProfile.userId;
      if(userProfile.email) return userProfile.email;
    }
    return 'Administrador';
  }
  function showSettingsMessage(message, type = 'info'){
    const status = el('#settingsStatus');
    if(!status) return;
    status.textContent = message;
    if(type && type !== 'info'){
      status.dataset.state = type;
    }else{
      delete status.dataset.state;
    }
    status.classList.add('visible');
    status.classList.remove('fade');
    if(settingsStatusTimer){
      clearTimeout(settingsStatusTimer);
    }
    settingsStatusTimer = setTimeout(()=>{
      status.classList.add('fade');
    }, 4500);
  }
  function handleAvatarUpload(file){
    if(!file) return;
    if(file.size > 1572864){
      showSettingsMessage('La imagen supera 1.5 MB, elige una versión más ligera.', 'error');
      return;
    }
    const reader = new FileReader();
    reader.onload = event => {
      updateProfileData({ avatar: event.target?.result || '' });
      showSettingsMessage('Foto de perfil actualizada.', 'success');
    };
    reader.onerror = () => {
      showSettingsMessage('No se pudo leer la imagen seleccionada.', 'error');
    };
    reader.readAsDataURL(file);
  }
  function initSettings(){
    if(settingsReady){
      syncProfileUI();
      syncPreferencesForm();
      renderPreferencePresets();
      updatePasswordInfo();
      return;
    }
    settingsReady = true;
    syncProfileUI();
    syncPreferencesForm();
    renderPreferencePresets();
    updatePasswordInfo();
    const profileForm = el('#profileForm');
    if(profileForm){
      profileForm.addEventListener('submit', e => {
        e.preventDefault();
        updateProfileData({
          userId: (el('#profileId')?.value || '').trim(),
          name: (el('#profileName')?.value || '').trim(),
          email: (el('#profileEmail')?.value || '').trim(),
          role: (el('#profileRole')?.value || '').trim(),
          campus: (el('#profileCampus')?.value || '').trim()
        });
        showSettingsMessage('Perfil actualizado correctamente.', 'success');
      });
    }
    const profileReset = el('#profileReset');
    if(profileReset){
      profileReset.addEventListener('click', () => {
        resetProfileData();
        showSettingsMessage('Se restableció la información del perfil.', 'warning');
      });
    }
    const avatarInput = el('#profileAvatarInput');
    const avatarUpload = el('#profileAvatarUpload');
    if(avatarUpload && avatarInput){
      avatarUpload.addEventListener('click', () => avatarInput.click());
    }
    if(avatarInput){
      avatarInput.addEventListener('change', () => {
        const file = avatarInput.files && avatarInput.files[0];
        handleAvatarUpload(file || null);
        avatarInput.value = '';
      });
    }
    const avatarRemove = el('#profileAvatarRemove');
    if(avatarRemove){
      avatarRemove.addEventListener('click', () => {
        if(userProfile.avatar){
          updateProfileData({ avatar: '' });
          showSettingsMessage('Se eliminó la foto de perfil.', 'success');
        }else{
          showSettingsMessage('No hay una foto guardada.', 'warning');
        }
      });
    }
    els('input[name="pref-theme"]').forEach(radio => {
      radio.addEventListener('change', () => {
        if(radio.checked){
          updatePreferences({ theme: radio.value });
        }
      });
    });
    const languageSel = el('#prefLanguage');
    if(languageSel){
      languageSel.addEventListener('change', () => updatePreferences({ language: languageSel.value }));
    }
    const densitySel = el('#prefDensity');
    if(densitySel){
      densitySel.addEventListener('change', () => updatePreferences({ density: densitySel.value }));
    }
    const boardLayoutSel = el('#prefBoardDensity');
    if(boardLayoutSel){
      boardLayoutSel.addEventListener('change', () => updatePreferences({ boardDensity: boardLayoutSel.value }));
    }
    const accentSel = el('#prefAccent');
    if(accentSel){
      accentSel.addEventListener('change', () => updatePreferences({ accent: accentSel.value }));
    }
    const ecoToggle = el('#prefEco');
    if(ecoToggle){
      ecoToggle.addEventListener('change', () => updatePreferences({ eco: ecoToggle.checked }));
    }
    const motionToggle = el('#prefMotion');
    if(motionToggle){
      motionToggle.addEventListener('change', () => updatePreferences({ reducedMotion: motionToggle.checked }));
    }
    const largeTextToggle = el('#prefLargeText');
    if(largeTextToggle){
      largeTextToggle.addEventListener('change', () => updatePreferences({ largeText: largeTextToggle.checked }));
    }
    const highContrastToggle = el('#prefHighContrast');
    if(highContrastToggle){
      highContrastToggle.addEventListener('change', () => updatePreferences({ highContrast: highContrastToggle.checked }));
    }
    const showLeadIdToggle = el('#prefShowLeadId');
    if(showLeadIdToggle){
      showLeadIdToggle.addEventListener('change', () => updatePreferences({ showLeadId: showLeadIdToggle.checked }));
    }
    const prefReset = el('#prefReset');
    if(prefReset){
      prefReset.addEventListener('click', () => {
        resetPreferences();
        showSettingsMessage('Restauraste las preferencias originales.', 'success');
      });
    }
    const passwordForm = el('#passwordForm');
    if(passwordForm){
      passwordForm.addEventListener('submit', e => {
        e.preventDefault();
        const current = (el('#passwordCurrent')?.value || '').trim();
        const next = (el('#passwordNew')?.value || '').trim();
        const confirm = (el('#passwordConfirm')?.value || '').trim();
        if(!current || !next || !confirm){
          setPasswordStatus('Completa todos los campos para registrar la solicitud.', 'warning');
          showSettingsMessage('Completa todos los campos de seguridad.', 'warning');
          return;
        }
        if(next.length < 8){
          setPasswordStatus('La nueva contraseña debe tener al menos 8 caracteres.', 'error');
          showSettingsMessage('La nueva contraseña debe tener al menos 8 caracteres.', 'error');
          return;
        }
        if(next !== confirm){
          setPasswordStatus('La confirmación no coincide con la nueva contraseña.', 'error');
          showSettingsMessage('La confirmación no coincide con la nueva contraseña.', 'error');
          return;
        }
        if(current === next){
          setPasswordStatus('La nueva contraseña debe ser distinta a la actual.', 'warning');
          showSettingsMessage('La nueva contraseña debe ser distinta a la actual.', 'warning');
          return;
        }
        const requestedAt = Date.now();
        passwordRequestState = {
          ...DEFAULT_PASSWORD_REQUEST,
          status: 'requested',
          requestedAt,
          requestedBy: getCurrentOperatorLabel()
        };
        persistPasswordRequestState();
        clearPasswordForm();
        updatePasswordInfo();
        showSettingsMessage('Se registró tu solicitud de cambio de contraseña.', 'success');
      });
    }
    const passwordClear = el('#passwordClear');
    if(passwordClear){
      passwordClear.addEventListener('click', () => {
        clearPasswordForm();
        showSettingsMessage('Se limpiaron los campos de seguridad.', 'info');
      });
    }
    const passwordApproveBtn = el('#passwordApproveBtn');
    if(passwordApproveBtn){
      passwordApproveBtn.addEventListener('click', () => {
        if(!passwordRequestState?.requestedAt){
          setPasswordStatus('Registra una solicitud antes de aprobarla.', 'warning');
          showSettingsMessage('Registra una solicitud antes de aprobarla.', 'warning');
          return;
        }
        if(passwordRequestState.approvedAt){
          setPasswordStatus('La solicitud ya fue aprobada.', 'info');
          return;
        }
        passwordRequestState = {
          ...passwordRequestState,
          status: 'approved',
          approvedAt: Date.now(),
          approvedBy: getCurrentOperatorLabel()
        };
        persistPasswordRequestState();
        updatePasswordInfo();
        showSettingsMessage('Se registró la aprobación de la solicitud.', 'success');
      });
    }
    const passwordCompleteBtn = el('#passwordCompleteBtn');
    if(passwordCompleteBtn){
      passwordCompleteBtn.addEventListener('click', () => {
        if(!passwordRequestState?.requestedAt){
          setPasswordStatus('Registra una solicitud antes de confirmarla.', 'warning');
          showSettingsMessage('Registra una solicitud antes de confirmarla.', 'warning');
          return;
        }
        if(!passwordRequestState.approvedAt){
          setPasswordStatus('Aprueba la solicitud antes de confirmar la entrega.', 'warning');
          showSettingsMessage('Aprueba la solicitud antes de confirmar la entrega.', 'warning');
          return;
        }
        if(passwordRequestState.completedAt){
          setPasswordStatus('La entrega ya fue confirmada.', 'info');
          return;
        }
        passwordRequestState = {
          ...passwordRequestState,
          status: 'completed',
          completedAt: Date.now(),
          completedBy: getCurrentOperatorLabel()
        };
        persistPasswordRequestState();
        updatePasswordInfo();
        showSettingsMessage('Se confirmó la entrega de credenciales.', 'success');
      });
    }
    const status = el('#settingsStatus');
    if(status && !status.textContent.trim()){
      status.textContent = 'Tus ajustes se guardan en este dispositivo.';
    }
  }
  let panelHideTimer = null;
  function showPanelOverlay(){
    const overlay = el('#panelOverlay');
    if(!overlay) return;
    const panel = overlay.querySelector('.panel');
    if(panelHideTimer){
      clearTimeout(panelHideTimer);
      panelHideTimer = null;
    }
    overlay.classList.add('open');
    overlay.setAttribute('aria-hidden','false');
    if(panel){
      panel.classList.remove('show');
      void panel.offsetWidth;
      panel.classList.add('show');
      panel.focus({ preventScroll: true });
    }
  }
  function hidePanelOverlay(){
    const overlay = el('#panelOverlay');
    if(!overlay || !overlay.classList.contains('open')) return;
    const panel = overlay.querySelector('.panel');
    overlay.setAttribute('aria-hidden','true');
    if(panel){
      panel.classList.remove('show');
    }
    if(panelHideTimer){
      clearTimeout(panelHideTimer);
      panelHideTimer = null;
    }
    panelHideTimer = setTimeout(()=>{
      overlay.classList.remove('open');
      panelHideTimer = null;
    }, 200);
  }
  const etapaLabel = value => {
    const s = String(value || '').toLowerCase();
    if(s === 'no contactado') return 'No Contactado';
    if(s === 'contactado') return 'Contactado';
    if(s === 'inscrito') return 'Inscrito';
    if(s === 'descartado') return 'Descartado';
    if(s === 'nuevo') return 'Nuevo';
    return value || '';
  };
  const fillEtapaSelect = select => {
    if(!select) return;
    select.innerHTML = etapasUI.map(e=>`<option value="${e}">${e}</option>`).join('');
  };
  const fillEstadoOptions = (etapa, select) => {
    const sel = select || el('#selEstado');
    if(!sel) return;
    const options = estadosByEtapa[etapa] || [];
    sel.innerHTML = options.length ? options.map(s=>`<option value="${s}">${s}</option>`).join('') : '<option value="">—</option>';
  };

  // —— Agrupación de etapas para vista ——
  const etapaGroup = e => {
    const s = String(e || '').toLowerCase();
    if(s === 'descartado') return 'Descartado';
    if(s === 'inscrito') return 'Inscrito';
    if(s === 'contactado') return 'Contactado';
    if(s === 'no contactado') return 'No Contactado';
    return 'Nuevo';
  };

  const etapaSlug = e => {
    if(!e) return '';
    const label = etapaGroup(e);
    return label ? label.toLowerCase().replace(/\s+/g,'-') : '';
  };

  const etapaBackend = e => e === 'No Contactado' ? 'No contactado' : e;

  // —— Render KPIs ——
  function renderKPIs(rows){
    const box = el('#kpiContainer');
    if(!box) return;
    box.innerHTML = '';
    if(!rows || !rows.length){
      const empty = document.createElement('p');
      empty.className = 'kpi-empty';
      const hasLeads = Array.isArray(leads) && leads.length > 0;
      empty.innerHTML = hasLeads
        ? 'No hay leads que cumplan los filtros seleccionados.'
        : 'Selecciona una base desde el filtro <strong>Base</strong> en la vista Leads para cargar los indicadores.';
      box.appendChild(empty);
      return;
    }
    const role = getUserRole();
    const allowed = KPI_ROLE_GROUPS[role] || KPI_ROLE_GROUPS.viewer || Object.keys(KPI_GROUPS);
    if(!allowed.length){
      const empty = document.createElement('p');
      empty.className = 'kpi-empty';
      empty.textContent = 'Tu rol no tiene indicadores asignados por el momento.';
      box.appendChild(empty);
      return;
    }
    const ctx = buildKpiContext(rows);
    allowed.forEach(groupKey => {
      const group = KPI_GROUPS[groupKey];
      if(!group) return;
      const section = document.createElement('section');
      section.className = 'kpi-group';
      section.dataset.group = groupKey;
      const header = document.createElement('header');
      const title = document.createElement('h4');
      title.textContent = group.label;
      header.appendChild(title);
      if(group.description){
        const desc = document.createElement('p');
        desc.textContent = group.description;
        header.appendChild(desc);
      }
      section.appendChild(header);
      const grid = document.createElement('div');
      grid.className = 'kpi-grid';
      group.metrics.forEach(metric => {
        const metricEl = document.createElement('article');
        metricEl.className = 'kpi-metric';
        metricEl.dataset.metric = metric.key;
        const nameEl = document.createElement('span');
        nameEl.className = 'metric-name';
        nameEl.textContent = metric.label;
        metricEl.appendChild(nameEl);
        const result = resolveKpiMetric(metric, ctx);
        const valueEl = document.createElement('span');
        valueEl.className = 'metric-value';
        const valueText = result.value === undefined || result.value === null || result.value === '' ? '—' : String(result.value);
        valueEl.textContent = valueText;
        metricEl.appendChild(valueEl);
        if(result.extra){
          const extraEl = document.createElement('span');
          extraEl.className = 'metric-extra';
          extraEl.textContent = result.extra;
          metricEl.appendChild(extraEl);
        }
        if(Array.isArray(result.list) && result.list.length){
          const listEl = document.createElement('ul');
          result.list.forEach(item => {
            const li = document.createElement('li');
            li.textContent = item;
            listEl.appendChild(li);
          });
          metricEl.appendChild(listEl);
        }
        if(metric.description){
          const descEl = document.createElement('p');
          descEl.className = 'metric-desc';
          descEl.textContent = metric.description;
          metricEl.appendChild(descEl);
        }
        if(result.note){
          const noteEl = document.createElement('p');
          noteEl.className = 'metric-note';
          noteEl.textContent = result.note;
          metricEl.appendChild(noteEl);
        }
        grid.appendChild(metricEl);
      });
      section.appendChild(grid);
      box.appendChild(section);
    });
  }

  function buildKpiContext(rows){
    const stageCounts = { Nuevo: 0, Contactado: 0, 'No Contactado': 0, Inscrito: 0, Descartado: 0 };
    let reimpactados = 0;
    let responded = 0;
    let inscritos = 0;
    let descartados = 0;
    let interesados = 0;
    const asesorMap = {};
    rows.forEach(row => {
      const stage = etapaGroup(row.etapa);
      stageCounts[stage] = (stageCounts[stage] || 0) + 1;
      if(stage !== 'Nuevo') reimpactados++;
      if(stage === 'Contactado' || stage === 'Inscrito') responded++;
      if(stage === 'Inscrito') inscritos++;
      if(stage === 'Descartado') descartados++;
      const estado = String(row.estado || '').trim().toLowerCase();
      const isInterested = estado.includes('interes') || estado.includes('labor de venta') || KPI_INTEREST_STATES.has(estado);
      if(isInterested) interesados++;
      const asesorKey = normalizeAsesorName(row.asesor);
      if(asesorKey){
        if(!asesorMap[asesorKey]){
          const displayName = displayAsesorName(row.asesor);
          asesorMap[asesorKey] = { name: displayName, total: 0, reimpactados: 0, responded: 0, interesados: 0, inscritos: 0 };
        }
        const stats = asesorMap[asesorKey];
        stats.total++;
        if(stage !== 'Nuevo') stats.reimpactados++;
        if(stage === 'Contactado' || stage === 'Inscrito') stats.responded++;
        if(stage === 'Inscrito') stats.inscritos++;
        if(isInterested) stats.interesados++;
      }
    });
    const total = rows.length;
    const basePendiente = stageCounts['Nuevo'] || Math.max(0, total - reimpactados);
    const reactivados = interesados + inscritos;
    const asesorList = Object.values(asesorMap);
    return {
      total,
      stageCounts,
      reimpactados,
      responded,
      interesados,
      inscritos,
      descartados,
      basePendiente,
      reactivados,
      asesorList
    };
  }

  function resolveKpiMetric(metric, ctx){
    if(!metric || typeof metric.compute !== 'function'){
      return { value: '—' };
    }
    try{
      const raw = metric.compute(ctx);
      if(raw === null || raw === undefined){
        return { value: '—' };
      }
      if(typeof raw === 'string'){
        return { value: raw };
      }
      if(typeof raw === 'number'){
        return { value: formatKpiNumber(raw) };
      }
      if(typeof raw === 'object'){
        const valueProvided = raw.value !== undefined && raw.value !== null && raw.value !== '';
        const extraProvided = raw.extra !== undefined && raw.extra !== null && raw.extra !== '';
        const noteProvided = raw.note !== undefined && raw.note !== null && raw.note !== '';
        const result = {
          value: valueProvided ? raw.value : '—'
        };
        if(typeof result.value === 'number'){
          result.value = formatKpiNumber(result.value);
        }
        if(extraProvided){
          const extraValue = typeof raw.extra === 'number' ? formatKpiNumber(raw.extra) : raw.extra;
          result.extra = String(extraValue);
        }
        if(Array.isArray(raw.list) && raw.list.length){
          result.list = raw.list.map(item => String(item));
        }
        if(noteProvided){
          result.note = String(raw.note);
        }
        return result;
      }
    }catch(err){
      console.warn('Error al calcular KPI', metric.key, err);
      return { value: '—', note: 'No se pudo calcular este KPI.' };
    }
    return { value: '—' };
  }

  function formatKpiNumber(value){
    if(typeof value !== 'number' || !isFinite(value)) return '—';
    return KPI_NUMBER_FORMAT.format(Math.round(value));
  }

  function formatKpiPercent(value){
    if(typeof value !== 'number' || !isFinite(value)) return '—';
    return KPI_PERCENT_FORMAT.format(value);
  }

  function safeDivide(num, denom){
    if(typeof num !== 'number' || typeof denom !== 'number') return null;
    if(!isFinite(num) || !isFinite(denom) || denom === 0) return null;
    return num / denom;
  }

  function normalizeAsesorName(name){
    const value = String(name || '').trim();
    if(!value) return '';
    const lower = value.toLowerCase();
    if(lower.includes('sistema') || lower === 'sin asignar' || lower === 'sinasesor') return '';
    const normalized = value
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .toLowerCase()
      .replace(/[^a-z0-9\s]/g, ' ')
      .replace(/\s+/g, ' ')
      .trim();
    return normalized;
  }

  function displayAsesorName(value){
    const raw = String(value || '').trim();
    if(!raw) return 'Sin asignar';
    const lower = raw.toLowerCase();
    if(lower.includes('sistema') || lower === 'sin asignar' || lower === 'sinasesor'){
      return 'Sin asignar';
    }
    return raw;
  }

  function formatContactTimestamp(date = new Date()){
    const target = date instanceof Date ? date : new Date(date);
    if(CONTACT_TIMESTAMP_FORMAT){
      try{
        return CONTACT_TIMESTAMP_FORMAT.format(target);
      }catch(err){
        /* fallback */
      }
    }
    return target.toLocaleString('es-MX');
  }

  function computeLeadPriorityScore(row){
    if(!row) return 0;
    let score = 0;
    const stage = etapaGroup(row.etapa);
    if(stage === 'Nuevo') score += 3;
    else if(stage === 'No Contactado') score += 2;
    else if(stage === 'Contactado') score += 1;
    const estadoNorm = String(row.estado || '').trim().toLowerCase();
    if(KPI_INTEREST_STATES.has(estadoNorm)) score += 4;
    if(row.campus) score += 0.5;
    if(row.modalidad) score += 0.5;
    return score;
  }

  function resolveLeadPriorityLevel(score){
    if(score >= LEAD_PRIORITY_THRESHOLDS.high) return 'alta';
    if(score >= LEAD_PRIORITY_THRESHOLDS.medium) return 'media';
    if(score > 0) return 'baja';
    return '';
  }

  function formatLeadPriorityLabel(level){
    if(level === 'alta') return 'Alta prioridad';
    if(level === 'media') return 'Seguimiento';
    if(level === 'baja') return 'Primer contacto';
    return '';
  }

  function buildContactScripts(lead){
    const firstName = String(lead?.nombre || '').trim().split(/\s+/)[0] || '';
    const asesorName = currentUser && currentUser.name ? String(currentUser.name).trim() : 'tu asesor de UNIDEP';
    const campusText = lead?.campus ? ` de UNIDEP ${lead.campus}` : ' de UNIDEP';
    const programaText = lead?.programa ? ` ${lead.programa}` : ' tu interés';
    const modalidadText = lead?.modalidad ? ` (${lead.modalidad})` : '';
    const saludo = firstName ? `Hola ${firstName},` : 'Hola,';
    const greeting = firstName ? `Hola ${firstName}!` : 'Hola!';
    const callScript = `${saludo} te habla ${asesorName}${campusText}. Me gustaría acompañarte${programaText}${modalidadText} y revisar contigo los siguientes pasos. ¿Tienes unos minutos hoy para que lo revisemos?`;
    const whatsappScript = `${greeting} Soy ${asesorName}${campusText}. Te escribo${programaText}${modalidadText} para ayudarte con los siguientes pasos. ¿Agendamos una llamada breve hoy para revisar becas y asegurar tu lugar?`;
    const subject = `Asunto: Seguimiento UNIDEP ${lead?.programa || 'tu inscripción'}`;
    const emailGreeting = firstName ? `Hola ${firstName},` : 'Hola,';
    const emailBody = `${subject}\n\n${emailGreeting}\n\nSoy ${asesorName}${campusText}. Gracias por tu interés${programaText}${modalidadText}. Te comparto los pasos para asegurar tu inscripción y las becas disponibles. ¿Qué día te gustaría que confirmemos juntos tu registro?\n\nQuedo al pendiente,\n${asesorName}\nUNIDEP`;
    return { call: callScript, whatsapp: whatsappScript, email: emailBody };
  }

  function createContactNote(type, lead){
    const timestamp = formatContactTimestamp();
    const channel = CONTACT_CHANNEL_LABELS[type] || 'Contacto';
    const programa = lead?.programa ? ` ${lead.programa}` : '';
    const modalidad = lead?.modalidad ? ` (${lead.modalidad})` : '';
    const campus = lead?.campus ? ` - ${lead.campus}` : '';
    if(type === 'call'){
      return `${timestamp} · ${channel}: llamada de seguimiento${programa}${modalidad}${campus}.`;
    }
    if(type === 'whatsapp'){
      return `${timestamp} · ${channel}: mensaje inicial enviado, pendiente de respuesta.`;
    }
    if(type === 'email'){
      return `${timestamp} · ${channel}: correo con información y próximos pasos enviado.`;
    }
    return `${timestamp} · ${channel}: contacto registrado.`;
  }

  async function copyToClipboard(text){
    if(!text) return false;
    try{
      if(typeof navigator !== 'undefined' && navigator.clipboard && navigator.clipboard.writeText){
        await navigator.clipboard.writeText(text);
        return true;
      }
    }catch(err){
      /* fallback below */
    }
    const textarea = document.createElement('textarea');
    textarea.value = text;
    textarea.setAttribute('readonly','');
    textarea.style.position = 'absolute';
    textarea.style.left = '-9999px';
    document.body.appendChild(textarea);
    textarea.select();
    let success = false;
    try{
      success = document.execCommand('copy');
    }catch(err){
      success = false;
    }
    document.body.removeChild(textarea);
    return success;
  }

  function aggregateDailyShortcuts(rows, type){
    if(!Array.isArray(rows) || !rows.length) return [];
    const map = new Map();
    if(type === 'campus'){
      rows.forEach(row => {
        const campus = String(row.campus || '').trim();
        if(!campus) return;
        const score = computeLeadPriorityScore(row);
        if(score <= 0) return;
        const entry = map.get(campus) || { key: campus, label: campus, value: campus, count: 0, score: 0 };
        entry.count += 1;
        entry.score += score;
        map.set(campus, entry);
      });
    }else if(type === 'asesor'){
      rows.forEach(row => {
        const raw = String(row.asesor || '').trim();
        const normalized = normalizeAsesorName(raw);
        if(!normalized) return;
        const score = computeLeadPriorityScore(row);
        if(score <= 0) return;
        const label = displayAsesorName(raw);
        const entry = map.get(normalized) || { key: normalized, label, value: raw, count: 0, score: 0 };
        entry.count += 1;
        entry.score += score;
        if(!entry.value && raw) entry.value = raw;
        if(!entry.label && label) entry.label = label;
        map.set(normalized, entry);
      });
    }
    return Array.from(map.values())
      .sort((a,b) => {
        if(b.score !== a.score) return b.score - a.score;
        if(b.count !== a.count) return b.count - a.count;
        return (a.label || '').localeCompare(b.label || '', 'es', { sensitivity: 'base' });
      })
      .slice(0, DAILY_SHORTCUT_LIMIT);
  }

  function renderShortcutButton(type, entry){
    const classes = ['daily-shortcuts__btn'];
    let isActive = false;
    if(type === 'campus'){
      isActive = Boolean(state.campus) && state.campus === entry.value;
    }else if(type === 'asesor'){
      const selected = getAsesorFilter();
      isActive = selected.length === 1 && normalizeAsesorName(selected[0]) === entry.key;
    }
    if(isActive) classes.push('is-active');
    const countLabel = `${entry.count} ${entry.count === 1 ? 'lead' : 'leads'}`;
    const title = `Prioridad combinada: ${Math.round(entry.score || 0)} pts`;
    return `<button type="button" class="${classes.join(' ')}" data-type="${type}" data-value="${escapeHtml(entry.value || '')}" aria-pressed="${isActive ? 'true' : 'false'}" title="${escapeHtml(title)}"><span>${escapeHtml(entry.label || '')}</span><span>${escapeHtml(countLabel)}</span></button>`;
  }

  function renderDailyShortcuts(rows){
    const container = el('#dailyShortcuts');
    if(!container) return;
    const list = Array.isArray(rows) ? rows : [];
    const viable = list.filter(row => computeLeadPriorityScore(row) > 0);
    const campusEntries = aggregateDailyShortcuts(viable, 'campus');
    const asesorEntries = aggregateDailyShortcuts(viable, 'asesor');
    const parts = ['<div class="daily-shortcuts__header">Listas diarias sugeridas</div>'];
    if(campusEntries.length){
      parts.push(`<div class="daily-shortcuts__group" data-group="campus"><span class="daily-shortcuts__label">Por campus</span>${campusEntries.map(entry => renderShortcutButton('campus', entry)).join('')}</div>`);
    }
    if(asesorEntries.length){
      parts.push(`<div class="daily-shortcuts__group" data-group="asesor"><span class="daily-shortcuts__label">Por asesor</span>${asesorEntries.map(entry => renderShortcutButton('asesor', entry)).join('')}</div>`);
    }
    if(!campusEntries.length && !asesorEntries.length){
      parts.push('<div class="daily-shortcuts__empty">Sin recomendaciones con los filtros actuales.</div>');
    }
    container.innerHTML = parts.join('');
  }

  // —— Filtro base ——
  function applyFilters(){
    const q = state.query.toLowerCase();
    const qDigits = q.replace(/\D/g,'');
    const colFilters = state.colFilters;
    const selectedAsesores = getAsesorFilter();
    const selectedAsesorSet = new Set(selectedAsesores.map(normalizeAsesorName).filter(Boolean));
    const rows = leads.filter(r => {
      const text = columns.map(k=>r[k]||'').join(' ').toLowerCase();
      const phoneForSearch = r.telefonoNormalizado || r.telefono || '';
      const tDigits = String(phoneForSearch).replace(/\D/g,'');
      const passesQ = !q || text.includes(q) || (qDigits && tDigits.includes(qDigits));
      const passCols = columns.every(k => {
        const val = colFilters[k];
        return !val || String(r[k]||'').toLowerCase().includes(val);
      });
      const passAsesor = !selectedAsesorSet.size || selectedAsesorSet.has(normalizeAsesorName(r.asesor));
      const passCampus = !state.campus || r.campus===state.campus;
      return passesQ && passCols && passAsesor && passCampus;
    });
    renderKPIs(rows);
    return rows;
  }

  function renderPagination(total){
    const container = el('#paginator');
    if(!container) return;
    const pageSize = Number.isFinite(state.pageSize) && state.pageSize > 0 ? state.pageSize : 0;
    if(!pageSize){
      container.innerHTML = '';
      container.classList.add('is-hidden');
      if(state.page !== 0){
        state.page = 0;
      }
      return;
    }
    container.classList.remove('is-hidden');
    const pages = Math.max(1, Math.ceil(total / pageSize));
    if(state.page >= pages) state.page = pages - 1;
    const current = state.page;
    container.innerHTML = '';
    const prev = document.createElement('button');
    prev.textContent = 'Página anterior';
    prev.disabled = current === 0;
    prev.addEventListener('click', ()=>{ if(state.page>0){ state.page--; refresh(); } });
    container.appendChild(prev);
    const start = Math.max(0, current - 1);
    const end = Math.min(pages, start + 5);
    for(let i=start;i<end;i++){
      const b=document.createElement('button');
      b.textContent=String(i+1);
      if(i===current) b.classList.add('active');
      b.addEventListener('click',()=>{ state.page=i; refresh(); });
      container.appendChild(b);
    }
    if(end < pages){
      const ell=document.createElement('span');
      ell.textContent='…';
      container.appendChild(ell);
    }
    const next = document.createElement('button');
    next.textContent = 'Página siguiente';
    next.disabled = current >= pages-1;
    next.addEventListener('click', ()=>{ if(state.page<pages-1){ state.page++; refresh(); } });
    container.appendChild(next);
  }

  // —— Render Kanban ——
  function renderKanban(rows, totals){
    const container = el('#viewKanban');
    container.innerHTML = '';
    const isMobileBoard = boardMobileQuery.matches;
    if(!state.mobileColumns) state.mobileColumns = {};

    etapasUI.forEach(step => {
      const col = document.createElement('div');
      col.className = 'column';
      col.dataset.step = step;
      const items = rows.filter(r=>etapaGroup(r.etapa)===step);
      const totalCount = totals && typeof totals[step] === 'number' ? totals[step] : items.length;
      col.innerHTML = `
        <header>
          <div class=\"row gap8 stage-title\"><strong>${step}</strong><span class=\"count\" title=\"Total de leads en ${step}\">${totalCount}</span></div>
          <button type=\"button\" class=\"column-toggle\" aria-expanded=\"true\" aria-label=\"Contraer etapa ${step}\">
            <i class=\"bi bi-chevron-down column-toggle-icon\" aria-hidden=\"true\"></i>
          </button>
        </header>
        <div class=\"list\" aria-label=\"Leads en etapa ${step}\"></div>
      `;
      const list = col.querySelector('.list');
      const header = col.querySelector('header');
      const toggleBtn = col.querySelector('.column-toggle');
      let loadMoreBtn = null;
      if(list){
        const limit = getColumnLimit(step, items.length);
        const visibleItems = limit >= items.length ? items : items.slice(0, limit);
        visibleItems.forEach(r => list.appendChild(cardLead(r)));
        if(items.length > limit){
          const remaining = items.length - limit;
          const batch = Math.min(COLUMN_BATCH_SIZE, remaining);
          loadMoreBtn = document.createElement('button');
          loadMoreBtn.type = 'button';
          loadMoreBtn.className = 'column-load-more';
          loadMoreBtn.textContent = `Mostrar ${batch} más`;
          loadMoreBtn.setAttribute('aria-label', `Mostrar ${batch} leads adicionales en ${step}`);
          loadMoreBtn.addEventListener('click', () => {
            increaseColumnLimit(step, items.length);
            renderKanban(rows, totals);
          });
          col.appendChild(loadMoreBtn);
        }
      }

      const applyExpansion = expanded => {
        const isExpanded = !isMobileBoard || Boolean(expanded);
        col.classList.toggle('mobile-collapsible', isMobileBoard);
        col.classList.toggle('expanded', isMobileBoard && isExpanded);
        col.classList.toggle('collapsed', isMobileBoard && !isExpanded);
        if(toggleBtn){
          toggleBtn.setAttribute('aria-expanded', isExpanded ? 'true' : 'false');
          toggleBtn.setAttribute('aria-label', `${isExpanded ? 'Contraer' : 'Expandir'} etapa ${step}`);
          toggleBtn.setAttribute('aria-hidden', isMobileBoard ? 'false' : 'true');
          toggleBtn.tabIndex = isMobileBoard ? 0 : -1;
        }
        if(list){
          list.setAttribute('aria-hidden', isMobileBoard && !isExpanded ? 'true' : 'false');
        }
        if(loadMoreBtn){
          loadMoreBtn.hidden = isMobileBoard && !isExpanded;
        }
        if(header && !isMobileBoard){
          header.removeAttribute('role');
          header.removeAttribute('tabindex');
        }
      };

      if(isMobileBoard){
        const expanded = Boolean(state.mobileColumns[step]);
        applyExpansion(expanded);
        const toggle = () => {
          const next = !col.classList.contains('expanded');
          if(next){
            state.mobileColumns[step] = true;
          }else{
            delete state.mobileColumns[step];
          }
          applyExpansion(next);
        };
        if(toggleBtn){
          toggleBtn.addEventListener('click', e=>{ e.stopPropagation(); toggle(); });
        }
        if(header){
          header.setAttribute('role','button');
          header.tabIndex = 0;
          header.addEventListener('click', e=>{
            if(e.target.closest('.column-toggle')) return;
            toggle();
          });
          header.addEventListener('keypress', e=>{
            if(e.key === 'Enter' || e.key === ' '){
              e.preventDefault();
              toggle();
            }
          });
        }
      }else{
        applyExpansion(true);
      }

      container.appendChild(col);
    });
  }

  function cardLead(r){
    const d = document.createElement('article');
    d.className = 'card-lead';
    d.tabIndex = 0;
    d.setAttribute('role','button');
    d.dataset.id = r.id;
    d.dataset.step = etapaGroup(r.etapa);
    const priorityScore = computeLeadPriorityScore(r);
    const priorityLevel = resolveLeadPriorityLevel(priorityScore);
    if(priorityLevel){
      d.dataset.priority = priorityLevel;
    }else{
      delete d.dataset.priority;
    }
    const priorityLabel = formatLeadPriorityLabel(priorityLevel);
    const priorityPill = priorityLabel ? `<span class="pill priority-pill priority-${priorityLevel}">${priorityLabel}</span>` : '';
    const campusLabel = [r.campus, r.modalidad].filter(Boolean).join(' · ');
    const campusTag = campusLabel ? `<span class="tag">${escapeHtml(campusLabel)}</span>` : '';
    const idPill = userPreferences.showLeadId && r.id ? `<span class="pill id-pill">ID ${escapeHtml(String(r.id))}</span>` : '';
    const phoneValue = fmtPhone(r.telefono || r.telefonoNormalizado);
    const phonePill = phoneValue ? `<span class="pill">${escapeHtml(phoneValue)}</span>` : '';
    const mailPill = r.correo ? `<span class="pill">${escapeHtml(r.correo)}</span>` : '';
    const programLine = r.programa ? `<div class="muted">${escapeHtml(r.programa)}</div>` : '';
    const estadoLine = `<div class="muted">${escapeHtml(r.estado || '—')} · ${escapeHtml(displayAsesorName(r.asesor))}</div>`;
    d.innerHTML = `
      <div class="row between align-start">
        <strong>${escapeHtml(r.nombre || 'Sin nombre')}</strong>
        <div class="row gap6 align-center">
          ${priorityPill}
          ${campusTag}
        </div>
      </div>
      ${programLine}
      ${estadoLine}
      <div class="row gap8" style="margin-top:8px">
        ${idPill}
        ${phonePill}
        ${mailPill}
      </div>
      ${detailsFooter}
    `;
    d.addEventListener('click', ()=>openDetails(r));
    d.addEventListener('keypress',e=>{ if(e.key==="Enter") openDetails(r) });
    return d;
  }

  // —— Render Tabla ——
  function renderTabla(rows){
    const tbody = el('#tbody');

    tbody.innerHTML = '';
    rows.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.id}</td>
        <td>${r.nombre}</td>
        <td>${r.matricula}</td>
        <td>${r.correo}</td>
        <td>${fmtPhone(r.telefono || r.telefonoNormalizado)}</td>
        <td>${r.campus}</td>
        <td>${r.modalidad}</td>
        <td>${r.programa}</td>
        <td><span class="tag ${r.etapa==='Inscrito'?'ok':''} ${r.etapa==='Descartado'?'bad':''}">${r.etapa}</span></td>
        <td>${r.estado}</td>
        <td>${displayAsesorName(r.asesor)}</td>
        <td>${r.comentario}</td>
        <td>${r.asignacion}</td>
      `;
      tr.addEventListener('click', ()=>openDetails(r));
      tbody.appendChild(tr);
    });
  }

  // —— Detalle ——
  function openDetails(r){
    el('#d-nombre').textContent = r.nombre || '—';
    const basePhone = r.telefono || r.telefonoNormalizado || '';
    const showField = (val,labelId,valueId,fmt)=>{
      const has = Boolean(val);
      const labelEl = el('#'+labelId);
      const valueEl = el('#'+valueId);
      if(labelEl){
        labelEl.classList.toggle('hidden', !has);
      }
      if(valueEl){
        valueEl.classList.toggle('hidden', !has);
        if(has) valueEl.textContent = fmt ? fmt(val) : val;
      }
    };
    showField(r.matricula,'lab-matricula','d-matricula');
    showField(basePhone,'lab-tel','d-tel',fmtPhone);
    showField(r.correo,'lab-mail','d-mail');
    showField(r.campus,'lab-campus','d-campus');
    showField(r.modalidad,'lab-modalidad','d-modalidad');
    showField(r.programa,'lab-programa','d-programa');
    showField(displayAsesorName(r.asesor),'lab-asesor','d-asesor');

    const stageEl = el('#d-etapa');
    const panelEl = el('#panelOverlay .panel');

    const updateDetailState = () => {
      const etapaTexto = r.etapa || '—';
      if(stageEl){
        stageEl.textContent = etapaTexto;
        stageEl.classList.toggle('is-empty', !r.etapa);
      }
      showField(r.estado,'lab-estado','d-estado');
      const drawerEtapa = document.getElementById('drawerEtapaVal');
      if(drawerEtapa){
        drawerEtapa.textContent = r.etapa || '—';
      }
      const drawerEstado = document.getElementById('drawerEstadoVal');
      if(drawerEstado){
        drawerEstado.textContent = r.estado || '—';
      }
      if(panelEl){
        const slug = etapaSlug(r.etapa);
        if(slug){
          panelEl.setAttribute('data-etapa', slug);
        }else{
          panelEl.removeAttribute('data-etapa');
        }
      }
    };
    updateDetailState();

    if(!window.matchMedia('(max-width: 1200px)').matches){
      showPanelOverlay();
    }else{
      hidePanelOverlay();
    }

    const formSets = [];
    const canEditLead = canPerform('updateLead');
    const COMMENT_REQUIRED_TITLE = 'Agrega una nota de seguimiento';
    const COMMENT_REQUIRED_BODY = 'Describe brevemente la conversación y la próxima acción antes de guardar los cambios.';

    const clearFormMessage = controls => {
      if(!controls || !controls.feedbackEl) return;
      controls.feedbackEl.classList.add('hidden');
      controls.feedbackEl.removeAttribute('data-tone');
      if(controls.feedbackTitleEl) controls.feedbackTitleEl.textContent = '';
      if(controls.feedbackMessageEl) controls.feedbackMessageEl.textContent = '';
    };

    const showFormMessage = (controls, tone, title, message) => {
      if(!controls || !controls.feedbackEl) return;
      if(tone){
        controls.feedbackEl.setAttribute('data-tone', tone);
      }else{
        controls.feedbackEl.removeAttribute('data-tone');
      }
      controls.feedbackEl.classList.remove('hidden');
      if(controls.feedbackTitleEl) controls.feedbackTitleEl.textContent = title || '';
      if(controls.feedbackMessageEl) controls.feedbackMessageEl.textContent = message || '';
    };

    const clearAllMessages = () => { formSets.forEach(clearFormMessage); };
    const broadcastMessage = (tone, title, message) => { formSets.forEach(set => showFormMessage(set, tone, title, message)); };

    const applyFormState = controls => {
      if(!controls) return;
      if(controls.etapaSelect){
        controls.etapaSelect.value = r.etapa || '';
      }
      if(controls.estadoSelect){
        fillEstadoOptions(r.etapa, controls.estadoSelect);
        const hasOption = Array.from(controls.estadoSelect.options || []).some(opt => opt.value === r.estado);
        controls.estadoSelect.value = hasOption ? r.estado : (controls.estadoSelect.options[0]?.value || '');
        if(!hasOption){
          r.estado = controls.estadoSelect.value || r.estado;
          updateDetailState();
        }
      }
      if(controls.comentarioInput){
        controls.comentarioInput.value = r.comentario || '';
      }
    };

    const refreshForms = () => {
      formSets.forEach(applyFormState);
      syncSaveAvailability();
    };

    let isSaving = false;
    const handleUpdate = async button => {
      if(isSaving) return;
      if(!canPerform('updateLead')){
        alert('No tienes permisos para actualizar leads.');
        return;
      }
      clearAllMessages();
      const etapaChanged = r.etapa !== r._originalEtapa;
      const estadoChanged = r.estado !== r._originalEstado;
      const comentarioActual = (r.comentario || '').trim();
      const comentarioChanged = comentarioActual !== (r._originalComentario || '').trim();
      if(!etapaChanged && !estadoChanged && !comentarioChanged){
        alert('No hay cambios para guardar');
        return;
      }
      const commentText = (r.comentario || '').trim();
      if(!commentText){
        broadcastScriptStatus('Agrega una nota en el comentario antes de guardar.');
        const commentControl = formSets.find(set => set.comentarioInput)?.comentarioInput;
        if(commentControl){
          commentControl.focus();
        }
        alert('Agrega un comentario antes de guardar.');
        return;
      }
      const registrarToque = etapaChanged || estadoChanged;
      if(registrarToque && !comentarioActual){
        broadcastMessage('error', COMMENT_REQUIRED_TITLE, COMMENT_REQUIRED_BODY);
        const currentSet = formSets.find(set => set.updateBtn === button);
        if(currentSet?.comentarioInput){
          currentSet.comentarioInput.focus();
        }
        return;
      }
      const params = new URLSearchParams({
        action: 'updateLead',
        id: r.id,
        sheet: state.sheet,
        etapa: etapaBackend(r.etapa),
        estado: r.estado,
        comentario: comentarioActual,
        registrarToque: registrarToque ? 'true' : 'false'
      });
      if(registrarToque){
        params.set('fecha', new Date().toISOString());
      }
      const buttons = formSets.map(set => set.updateBtn).filter(Boolean);
      try{
        isSaving = true;
        buttons.forEach(btn => { btn.disabled = true; });
        const res = await apiFetch(`${API_URL}?${params.toString()}`);
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        if(data?.error) throw new Error(data.error);
        const updated = data?.lead || {};
        if(updated.etapa !== undefined) r.etapa = etapaLabel(updated.etapa);
        if(updated.estado !== undefined) r.estado = updated.estado;
        if(updated.comentario !== undefined) r.comentario = updated.comentario;
        if(updated.asignacion !== undefined) r.asignacion = updated.asignacion;
        if(updated.resolucion !== undefined) r.resolucion = updated.resolucion;
        if(Array.isArray(updated.toques)){
          ['toque1','toque2','toque3','toque4'].forEach((k,idx) => {
            if(updated.toques[idx] !== undefined) r[k] = updated.toques[idx];
          });
        }
        r._originalEtapa = r.etapa;
        r._originalEstado = r.estado;
        r._originalComentario = (r.comentario || '').trim();
        updateDetailState();
        refreshForms();
        alert('Actualizado');
        refresh();
      }catch(err){
        console.error('Error al actualizar', err);
        const message = resolveErrorMessage(err, 'No se pudo actualizar el lead.');
        broadcastMessage('error', 'No se pudo actualizar el lead', message);
      }finally{
        buttons.forEach(btn => { btn.disabled = false; });
        isSaving = false;
      }
    };

    const attachListeners = controls => {
      if(!controls) return;
      if(controls.comentarioInput){
        controls.comentarioInput.oninput = () => {
          r.comentario = controls.comentarioInput.value;
          clearAllMessages();
          formSets.forEach(set=>{
            if(set !== controls && set.comentarioInput){
              set.comentarioInput.value = r.comentario || '';
            }
          });
        };
      }
      if(controls.etapaSelect){
        controls.etapaSelect.onchange = () => {
          r.etapa = controls.etapaSelect.value;
          const nextEstado = (estadosByEtapa[r.etapa] || [''])[0] || '';
          r.estado = nextEstado;
          clearAllMessages();
          updateDetailState();
          formSets.forEach(set => {
            if(set.etapaSelect){
              set.etapaSelect.value = r.etapa;
            }
            if(set.estadoSelect){
              fillEstadoOptions(r.etapa, set.estadoSelect);
              const hasOpt = Array.from(set.estadoSelect.options || []).some(opt => opt.value === r.estado);
              set.estadoSelect.value = hasOpt ? r.estado : (set.estadoSelect.options[0]?.value || '');
              if(!hasOpt){
                r.estado = set.estadoSelect.value || '';
                updateDetailState();
              }
            }
          });
          refresh();
        };
      }
      if(controls.estadoSelect){
        controls.estadoSelect.onchange = () => {
          r.estado = controls.estadoSelect.value;
          clearAllMessages();
          updateDetailState();
          formSets.forEach(set => {
            if(set !== controls && set.estadoSelect){
              const hasOpt = Array.from(set.estadoSelect.options || []).some(opt => opt.value === r.estado);
              if(hasOpt){
                set.estadoSelect.value = r.estado;
              }
            }
          });
          refresh();
        };
      }
      if(controls.updateBtn){
        controls.updateBtn.onclick = () => handleUpdate(controls.updateBtn);
      }
    };

    const registerForm = controls => {
      if(!controls) return;
      const hasControl = Boolean(controls.etapaSelect || controls.estadoSelect || controls.comentarioInput || controls.updateBtn);
      if(!hasControl) return;
      if(controls.etapaSelect){
        fillEtapaSelect(controls.etapaSelect);
      }
      formSets.push(controls);
      applyFormState(controls);
      clearFormMessage(controls);
      if(!canEditLead){
        if(controls.etapaSelect) controls.etapaSelect.disabled = true;
        if(controls.estadoSelect) controls.estadoSelect.disabled = true;
        if(controls.comentarioInput){
          controls.comentarioInput.disabled = true;
        }
        if(controls.updateBtn){
          controls.updateBtn.disabled = true;
          controls.updateBtn.title = 'No tienes permisos para actualizar leads.';
        }
        return;
      }
      attachListeners(controls);
      syncSaveAvailability();
    };

    const applyContactScripts = () => {
      const scripts = buildContactScripts(r);
      broadcastScriptStatus('');
      ['contactScripts','drawerContactScripts'].forEach(id => {
        const container = document.getElementById(id);
        if(!container) return;
        CONTACT_SCRIPT_TYPES.forEach(type => {
          const textEl = container.querySelector(`[data-script-text="${type}"]`);
          if(textEl){
            textEl.value = scripts[type] || 'No hay guion disponible para este lead.';
          }
          const actionBtn = container.querySelector(`[data-script-apply="${type}"]`);
          if(actionBtn){
            actionBtn.disabled = !scripts[type];
            actionBtn.onclick = async event => {
              event.preventDefault();
              if(!scripts[type]) return;
              const copied = await copyToClipboard(scripts[type]);
              registerContactNote(type);
              broadcastScriptStatus(copied ? `${CONTACT_CHANNEL_LABELS[type]} copiado. Completa la nota y guarda el lead.` : `${CONTACT_CHANNEL_LABELS[type]} registrado. Copia el guion manualmente si lo necesitas.`);
            };
          }
        });
      });
    };

    registerForm({
      etapaSelect: el('#selEtapa'),
      estadoSelect: el('#selEstado'),
      comentarioInput: el('#txtComentario'),
      updateBtn: el('#updateBtn'),
      feedbackEl: el('#panelFeedback'),
      feedbackTitleEl: el('#panelFeedbackTitle'),
      feedbackMessageEl: el('#panelFeedbackMessage')
    });

    const phone = parsePhone(basePhone);
    const phoneDigits = phone.intl || phone.digits;
    const waDigits = phone.wa || phoneDigits;
    const phoneDisplay = fmtPhone(basePhone);
    const callHref = r.callUrl || (phoneDigits && phoneDigits.length >= 10 ? `https://dashboard.aircall.io/call/${phoneDigits}` : '');
    const waHref = r.whatsappUrl || (waDigits && waDigits.length >= 10 ? `https://wa.me/${waDigits}` : '');
    const mailHref = r.emailUrl || (r.correo ? `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(r.correo)}&su=Seguimiento%20UNIDEP&body=Hola%20${encodeURIComponent(r.nombre)}%2C%20` : '');
    const hasPhoneValue = Boolean(phoneDisplay);
    const hasCallLink = Boolean(callHref);
    const hasWaLink = Boolean(waHref);
    const hasMailLink = Boolean(mailHref);
    const actCall = el('#act-call');
    const actWa = el('#act-wa');
    const actMail = el('#act-mail');
    if(actCall){
      actCall.classList.toggle('hidden', !hasCallLink);
      if(hasCallLink){
        actCall.href = callHref;
        actCall.onclick = () => { maybeRegisterContactNote('call'); };
      }else{
        actCall.onclick = null;
      }
    }
    if(actWa){
      actWa.classList.toggle('hidden', !hasWaLink);
      if(hasWaLink){
        actWa.href = waHref;
        actWa.onclick = () => { maybeRegisterContactNote('whatsapp'); };
      }else{
        actWa.onclick = null;
      }
    }
    if(actMail){
      actMail.classList.toggle('hidden', !hasMailLink);
      if(hasMailLink){
        actMail.href = mailHref;
        actMail.onclick = () => { maybeRegisterContactNote('email'); };
      }else{
        actMail.onclick = null;
      }
    }

    if (window.matchMedia('(max-width: 1200px)').matches){
      const drawer = el('#drawer');
      drawer.classList.add('open');
      drawer.ariaHidden = 'false';
      const summaryParts = [r.campus, r.modalidad, r.programa].filter(Boolean);
      const summaryHtml = summaryParts.length ? `<div class="drawer-summary">${summaryParts.join(' · ')}</div>` : '';
      const infoRows = [
        r.matricula ? `<div class="muted">Matrícula</div><div>${r.matricula}</div>` : '',
        hasPhoneValue ? `<div class="muted">Teléfono</div><div>${phoneDisplay}</div>` : '',
        r.correo ? `<div class="muted">Correo</div><div>${r.correo}</div>` : '',
        r.campus ? `<div class="muted">Plantel</div><div>${r.campus}</div>` : '',
        r.modalidad ? `<div class="muted">Modalidad</div><div>${r.modalidad}</div>` : '',
        r.programa ? `<div class="muted">Programa</div><div>${r.programa}</div>` : ''
      ].filter(Boolean).join('');
      el('#drawerContent').innerHTML = `
        <h3>${r.nombre}</h3>
        ${summaryHtml}
        <div class="kv" style="margin:10px 0">
          ${infoRows}
          <div class="muted">Etapa</div><div id="drawerEtapaVal">${r.etapa || '—'}</div>
          <div class="muted">Estado</div><div id="drawerEstadoVal">${r.estado || '—'}</div>
        </div>
        <section class="drawer-quick" aria-label="Actualiza y contacta">
          <p class="drawer-quick__hint">Actualiza etapa y estado antes de abrir un nuevo contacto.</p>
          <div class="drawer-quick__shortcuts" role="group" aria-label="Accesos rápidos de contacto">
            ${hasCallLink?`<a class="btn" target="_blank" rel="noopener" href="${callHref}"><i class='bi bi-telephone'></i> Llamar</a>`:''}
            ${hasWaLink?`<a class="btn" target="_blank" rel="noopener" href="${waHref}"><i class='bi bi-whatsapp'></i> WhatsApp</a>`:''}
            ${hasMailLink?`<a class="btn" target="_blank" rel="noopener" href="${mailHref}"><i class='bi bi-envelope'></i> Email</a>`:''}
          </div>
          <label class="drawer-quick__field">Etapa
            <select id="drawerEtapa" class="w100"></select>
          </label>
          <label class="drawer-quick__field">Estado
            <select id="drawerEstado" class="w100"></select>
          </label>
          <label class="drawer-quick__field">Comentario
            <textarea id="drawerComentario" class="w100" rows="3"></textarea>
          </label>
          <div class="drawer-quick__feedback hidden" id="drawerFeedback" role="alert" aria-live="assertive">
            <strong id="drawerFeedbackTitle"></strong>
            <p id="drawerFeedbackMessage"></p>
          </div>
          <div class="drawer-quick__actions">
            <button class="btn primary" type="button" id="drawerUpdateBtn">Guardar actualización</button>
          </div>
          <p class="contact-scripts__status hidden" id="drawerContactScriptStatus" role="status" aria-live="polite"></p>
        </div>
        <div class="actions" style="margin-top:12px">
          <button class="btn primary" type="button" id="drawerUpdateBtn">Guardar</button>
        </div>`;
      registerForm({
        etapaSelect: el('#drawerEtapa'),
        estadoSelect: el('#drawerEstado'),
        comentarioInput: el('#drawerComentario'),
        updateBtn: el('#drawerUpdateBtn'),
        feedbackEl: el('#drawerFeedback'),
        feedbackTitleEl: el('#drawerFeedbackTitle'),
        feedbackMessageEl: el('#drawerFeedbackMessage')
      });
      const drawerCall = document.getElementById('drawerActCall');
      if(drawerCall){
        drawerCall.onclick = () => { maybeRegisterContactNote('call'); };
      }
      const drawerWa = document.getElementById('drawerActWa');
      if(drawerWa){
        drawerWa.onclick = () => { maybeRegisterContactNote('whatsapp'); };
      }
      const drawerMail = document.getElementById('drawerActMail');
      if(drawerMail){
        drawerMail.onclick = () => { maybeRegisterContactNote('email'); };
      }
    }
    applyContactScripts();
    syncSaveAvailability();
  }


  // —— Util ——
  const parsePhone = raw => {
    const normalized = cleanValue(raw);
    if(!normalized) return { raw: '', digits: '', local: '', intl: '', wa: '' };
    const digitsOriginal = normalized.replace(/\D/g,'');
    if(!digitsOriginal) return { raw: normalized, digits: '', local: '', intl: '', wa: '' };
    let digits = digitsOriginal;
    if(digits.startsWith('0052')){
      digits = digits.slice(4);
    }
    if(digits.startsWith('521')){
      digits = digits.slice(3);
    }else if(digits.startsWith('52')){
      digits = digits.slice(2);
    }
    if(digits.length > 10 && (digits.startsWith('044') || digits.startsWith('045'))){
      digits = digits.slice(3);
    }
    if(digits.length > 10 && digits.startsWith('01')){
      digits = digits.slice(2);
    }
    if(digits.length === 11 && digits.startsWith('1')){
      digits = digits.slice(1);
    }
    if(digits.startsWith('0') && digits.length > 10){
      digits = digits.replace(/^0+/, '');
    }
    let local = digits;
    if(local.length > 10){
      local = local.slice(0, 10);
    }
    if(local.length < 7){
      return { raw: normalized, digits: '', local: '', intl: '', wa: '' };
    }
    const intl = local.length === 10 ? `52${local}` : digitsOriginal;
    const wa = local.length === 10 ? `521${local}` : digitsOriginal;
    return { raw: normalized, digits: digitsOriginal, local, intl, wa };
  };

  const fmtPhone = p => {
    const phone = parsePhone(p);
    const local = phone.local;
    if(local){
      if(local.length === 10){
        return `${local.slice(0,3)} ${local.slice(3,6)} ${local.slice(6)}`;
      }
      return local;
    }
    return phone.raw || '';
  };

  function isLeadSheetName(name){
    if(typeof name !== 'string') return false;
    const trimmed = name.trim();
    if(!trimmed) return false;
    const normalized = trimmed
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .toLowerCase();
    if(normalized === 'catalogo') return false;
    return true;
  }

  function sheetDisplayName(name){
    if(typeof name !== 'string') return '';
    return name.replace(/^\s*\*+\s*/, '').trim();
  }

  function colorForTone(tone){
    return TONE_COLORS[tone] || TONE_COLORS.info;
  }

  function clearSolverLog(){
    const logEl = el('#solverLog');
    if(logEl){
      logEl.innerHTML = '';
    }
  }

  function appendSolverLog(message, tone = 'info'){
    const logEl = el('#solverLog');
    if(!logEl) return null;
    const li = document.createElement('li');
    li.textContent = message;
    const color = colorForTone(tone);
    if(color){
      li.style.color = color;
    }
    logEl.appendChild(li);
    const panel = logEl.parentElement;
    if(panel){
      panel.scrollTop = panel.scrollHeight;
    }
    return li;
  }

  function buildSolutionPlan(diagnostics){
    if(!diagnostics) return null;
    const plan = {
      summary: 'Diagnóstico sin incidencias pendientes.',
      severity: 'ok',
      issues: [],
      autoActions: [],
      steps: [],
      diagnosticRunId: currentDiagnosticsRunId
    };
    const pushIssue = (text, tone = 'info') => {
      if(!text) return;
      plan.issues.push({ text, tone });
      if(tone === 'bad'){
        plan.severity = 'bad';
      }else if(tone === 'warn' && plan.severity !== 'bad'){
        plan.severity = 'warn';
      }else if(plan.severity === 'ok' && tone === 'info'){
        plan.severity = 'info';
      }
    };
    const addStep = (text, tone = 'info') => {
      if(!text) return;
      plan.steps.push({ text, tone });
    };
    const sheetRepairMap = new Map();
    const ensureRepairEntry = sheet => {
      if(!sheet || !sheet.name) return null;
      const key = sheet.name;
      if(!sheetRepairMap.has(key)){
        sheetRepairMap.set(key, {
          sheet,
          missingColumns: new Set(),
          hasInvalidRows: false,
          ensureContactColumns: false
        });
      }
      return sheetRepairMap.get(key);
    };
    if(!navigator.onLine){
      pushIssue('El dispositivo está sin conexión a internet.', 'bad');
      plan.autoActions.push({
        id: 'wait-for-online',
        label: 'Esperar reconexión de red',
        auto: true,
        handler: async log => {
          if(navigator.onLine){
            log('La conexión local ya está disponible.', 'ok');
            return;
          }
          log('Esperando a que el dispositivo recupere la conexión…', 'warn');
          await new Promise((resolve, reject) => {
            let settled = false;
            const cleanup = () => {
              window.removeEventListener('online', handleOnline);
              clearTimeout(timer);
            };
            const handleOnline = () => {
              if(settled) return;
              settled = true;
              cleanup();
              resolve();
            };
            const timer = setTimeout(() => {
              if(settled) return;
              settled = true;
              cleanup();
              reject(new Error('La conexión no se restableció en 30 segundos.'));
            }, 30000);
            window.addEventListener('online', handleOnline);
          });
          log('Conexión local restablecida.', 'ok');
        }
      });
      addStep('Verifica tu conexión Wi-Fi o cable de red si la reconexión tarda más de 30 segundos.', 'info');
    }

    const connectionCheck = diagnostics.checks?.connection;
    if((connectionCheck && !connectionCheck.ok) || diagnostics.connection === false || diagnostics.connectionFailed){
      const msg = connectionCheck?.message ? `Conexión con Google Sheets: ${connectionCheck.message}` : 'La conexión con Google Sheets falló durante el diagnóstico.';
      pushIssue(msg, 'bad');
      plan.autoActions.push({
        id: 'verify-connection',
        label: 'Verificar conexión con Google Sheets',
        auto: true,
        handler: async log => {          const maxAttempts = 3;
          for(let attempt = 1; attempt <= maxAttempts; attempt++){
            if(!navigator.onLine){
              log('Sin conexión local. Esperando reconexión antes de verificar el servicio…', 'warn');
              await new Promise((resolve, reject) => {
                let settled = false;
                const cleanup = () => {
                  window.removeEventListener('online', handleOnline);
                  clearTimeout(timer);
                };
                const handleOnline = () => {
                  if(settled) return;
                  settled = true;
                  cleanup();
                  resolve();
                };
                const timer = setTimeout(() => {
                  if(settled) return;
                  settled = true;
                  cleanup();
                  reject(new Error('No se recuperó la conexión local en el tiempo esperado.'));
                }, 15000);
                window.addEventListener('online', handleOnline);
              }).catch(err => {
                throw err instanceof Error ? err : new Error(String(err));
              });
            }
            log(`Validando conectividad con Google Sheets (intento ${attempt}/${maxAttempts})…`, 'info');
            let response;
            try{
              response = await apiFetch(`${API_URL}?action=listSheets`);
            }catch(err){
              if(attempt === maxAttempts){
                const error = err instanceof Error ? err : new Error(String(err));
                throw error;
              }
              log('El intento falló por un error de red. Reintentando…', 'warn');
              await new Promise(resolve => setTimeout(resolve, attempt * 2000));
              continue;
            }
            if(!response.ok){
              const body = await response.text().catch(() => '');
              const label = body ? `${response.status} ${body}` : `HTTP ${response.status}`;
              if(attempt === maxAttempts){
                throw new Error(label);
              }
              log(`Respuesta inesperada (${label}). Reintentando…`, 'warn');
              await new Promise(resolve => setTimeout(resolve, attempt * 2000));
              continue;
            }
            await response.json().catch(() => null);
            log('Conexión con Google Sheets establecida correctamente.', 'ok');
            return;
          }
        }
      });
      addStep('Confirma que el Apps Script siga desplegado y que el libro de Google Sheets esté accesible y sin restricciones.', 'info');
    }

    const readCheck = diagnostics.checks?.read;
    if(readCheck && !readCheck.ok){
      pushIssue('La prueba de lectura falló en Google Sheets.', 'bad');
      addStep(readCheck.message || 'Verifica que el libro no esté protegido y que el usuario tenga permiso de lectura.', 'bad');
    }
    const writeCheck = diagnostics.checks?.write;
    if(writeCheck && !writeCheck.ok){
      pushIssue('La prueba de escritura falló en Google Sheets.', 'bad');
      addStep(writeCheck.message || 'Confirma permisos de edición y que la hoja no esté protegida.', 'bad');
    }

    if(diagnostics.failed){
      const errorMessage = (Array.isArray(diagnostics.errors) && diagnostics.errors[0]) || diagnostics.errorMessage || 'El diagnóstico no se completó.';
      pushIssue(errorMessage, 'bad');
      addStep('Repite el diagnóstico después de resolver el problema indicado.', 'info');
    }

    if(Array.isArray(diagnostics.errors) && diagnostics.errors.length){
      diagnostics.errors.forEach(err => {
        pushIssue(err, 'bad');
        addStep(`Corrige: ${err}`, 'bad');
      });
    }

    if(Array.isArray(diagnostics.warnings) && diagnostics.warnings.length){
      pushIssue('Se detectaron alertas durante el diagnóstico.', 'warn');
      diagnostics.warnings.forEach(warn => {
        addStep(`Atiende la alerta: ${warn}`, 'warn');
      });
    }

    const sheetsWithDuplicates = (diagnostics.sheets || [])
      .filter(sheet => (sheet?.duplicateIdTotal || 0) > 0 || (sheet?.duplicatePhoneTotal || 0) > 0);
    if(sheetsWithDuplicates.length){
      const sheetLabels = sheetsWithDuplicates.map(sheet => sheetDisplayName(sheet.name) || sheet.name);
      pushIssue(`Duplicados detectados en ${sheetLabels.join(', ')}.`, 'warn');
      if(canPerform('manageDuplicates')){
        plan.autoActions.push({
          id: 'resolve-duplicates',
          label: `Limpiar duplicados (${sheetsWithDuplicates.length})`,
          auto: true,
          handler: async log => {
            for(const sheet of sheetsWithDuplicates){
              const displayName = sheetDisplayName(sheet.name) || sheet.name;
              log(`Eliminando duplicados en "${displayName}"…`, 'warn');
              const message = await performDuplicateCleanup(sheet.name);
              log(`${displayName}: ${message}`, 'ok');
            }
          }
        });
      }else{
        addStep('Solicita a una persona administradora que ejecute la limpieza de duplicados desde Sistema > Duplicados.', 'warn');
      }
      addStep('Revisa en Google Sheets que los registros depurados sigan con datos completos.', 'info');
    }
    const canRepairSheets = canPerform('repairSheetStructure');
    const sheetsWithMissingColumns = (diagnostics.sheets || [])
      .filter(sheet => Array.isArray(sheet?.missingColumns) && sheet.missingColumns.length);
    sheetsWithMissingColumns.forEach(sheet => {
      const columnsList = sheet.missingColumns.join(', ');
      const displayName = sheetDisplayName(sheet.name) || sheet.name;
      pushIssue(`Faltan columnas obligatorias en ${displayName}: ${columnsList}.`, 'bad');
      const entry = ensureRepairEntry(sheet);
      if(entry){
        sheet.missingColumns.forEach(col => entry.missingColumns.add(col));
        entry.ensureContactColumns = true;
      }
      if(canRepairSheets){
        addStep(`El solucionador agregará automáticamente las columnas faltantes en ${displayName}.`, 'info');
      }else{
        addStep(`Agrega las columnas ${columnsList} en la hoja ${displayName} respetando el encabezado exacto.`, 'bad');
      }
    });

    const sheetsWithUnknownColumns = (diagnostics.sheets || [])
      .filter(sheet => Array.isArray(sheet?.unknownColumns) && sheet.unknownColumns.length);
    sheetsWithUnknownColumns.forEach(sheet => {
      const displayName = sheetDisplayName(sheet.name) || sheet.name;
      const unknownList = sheet.unknownColumns.map(col => col.column ? `${col.name} (${col.column})` : col.name).join(', ');
      pushIssue(`Encabezados no reconocidos en ${displayName}: ${unknownList}.`, 'warn');
      addStep(`Revisa y corrige los encabezados no reconocidos en ${displayName} para evitar datos fuera de catálogo.`, 'warn');
    });

    const sheetsWithInvalidRows = (diagnostics.sheets || [])
      .filter(sheet => (sheet?.invalidCount || 0) > 0);
    sheetsWithInvalidRows.forEach(sheet => {
      const displayName = sheetDisplayName(sheet.name) || sheet.name;
      pushIssue(`Datos inválidos en ${displayName}: ${sheet.invalidCount} filas requieren corrección.`, 'warn');
      const entry = ensureRepairEntry(sheet);
      if(entry){
        entry.hasInvalidRows = true;
        entry.ensureContactColumns = true;
      }
      if(canRepairSheets){
        addStep(`El solucionador corregirá automáticamente las filas inválidas detectadas en ${displayName}.`, 'info');
      }else{
        addStep(`Corrige las filas con datos inválidos en ${displayName} siguiendo las indicaciones del diagnóstico.`, 'warn');
      }
    });

    if(canRepairSheets){
      sheetRepairMap.forEach(entry => {
        if(!entry) return;
        const missingColumns = Array.from(entry.missingColumns);
        const shouldRepair = missingColumns.length > 0 || entry.hasInvalidRows;
        if(!shouldRepair) return;
        const sheetName = entry.sheet.name;
        const displayName = sheetDisplayName(sheetName) || sheetName;
        plan.autoActions.push({
          id: `repair-${sheetName}`,
          label: `Reparar estructura en ${displayName}`,
          auto: true,
          handler: async log => {
            log(`Reparando "${displayName}"…`, 'warn');
            const payload = {
              action: 'repairSheetStructure',
              sheet: sheetName,
              ensureColumns: missingColumns,
              ensureContactColumns: Boolean(entry.ensureContactColumns),
              fixInvalidRows: entry.hasInvalidRows,
              rebuildContactLinks: entry.hasInvalidRows || Boolean(entry.ensureContactColumns)
            };
            const response = await apiFetch(API_URL, {
              method: 'POST',
              body: JSON.stringify(payload)
            });
            if(!response.ok){
              const body = await response.text().catch(() => '');
              throw new Error(body ? `${response.status} ${body}` : `HTTP ${response.status}`);
            }
            const data = await response.json().catch(() => null);
            if(!data || data.ok === false){
              throw new Error(data?.error || 'No se pudo reparar la hoja.');
            }
            const actions = Array.isArray(data.actions) ? data.actions : [];
            if(actions.length){
              actions.forEach(action => log(action, 'info'));
            }else{
              log('Reparación completada sin cambios adicionales.', 'ok');
            }
          }
        });
      });
    }

    if(diagnostics.system && diagnostics.system.status && diagnostics.system.status !== 'Operativo'){
      pushIssue(`Estado del sistema: ${diagnostics.system.status}.`, diagnostics.system.status === 'Con incidencias' ? 'warn' : 'info');
    }

    if(diagnostics.login && !diagnostics.login.ok){
      const loginMsg = diagnostics.login.message || 'El inicio de sesión está desactivado temporalmente.';
      pushIssue(`Inicio de sesión: ${loginMsg}`, diagnostics.login.enabled === false ? 'warn' : 'info');
      addStep('Revisa la configuración de autenticación y restablece tokens o contraseñas si es necesario.', 'warn');
    }

    if(plan.issues.length){
      const priorityIssue = plan.issues.find(issue => issue.tone === 'bad')
        || plan.issues.find(issue => issue.tone === 'warn')
        || plan.issues[0];
      if(priorityIssue){
        plan.summary = priorityIssue.text;
        plan.severity = priorityIssue.tone;
      }
    }else{
      plan.summary = 'Diagnóstico sin incidencias pendientes. No se requieren acciones adicionales.';
      plan.severity = 'ok';
    }

    return plan;
  }

  function updateProblemSolverPanel(){
    const statusEl = el('#solverStatus');
    const autoBtn = el('#solverAutoBtn');
    const stepsBtn = el('#solverStepsBtn');
    if(!statusEl || !autoBtn || !stepsBtn) return;
    if(diagInProgress){
      currentSolutionPlan = null;
      statusEl.textContent = 'Ejecutando diagnóstico…';
      statusEl.style.color = colorForTone('info');
      autoBtn.disabled = true;
      stepsBtn.disabled = true;
      return;
    }
    if(solvingInProgress){
      autoBtn.disabled = true;
      stepsBtn.disabled = true;
    }
    if(!lastDiagnostics){
      currentSolutionPlan = null;
      statusEl.textContent = 'Ejecuta el diagnóstico para generar recomendaciones.';
      statusEl.style.color = colorForTone('info');
      autoBtn.disabled = true;
      stepsBtn.disabled = true;
      return;
    }
    currentSolutionPlan = buildSolutionPlan(lastDiagnostics);
    if(!currentSolutionPlan){
      statusEl.textContent = 'No se pudo construir el plan de solución.';
      statusEl.style.color = colorForTone('bad');
      autoBtn.disabled = true;
      stepsBtn.disabled = true;
      return;
    }
    const color = colorForTone(currentSolutionPlan.severity || 'info');
    statusEl.textContent = currentSolutionPlan.summary;
    statusEl.style.color = color;
    autoBtn.disabled = solvingInProgress || !(currentSolutionPlan.autoActions || []).length;
    stepsBtn.disabled = solvingInProgress || !(currentSolutionPlan.steps || []).length;
  }

  async function executeProblemSolver(options = {}){
    if(solvingInProgress) return;
    if(diagInProgress){
      appendSolverLog('Espera a que termine el diagnóstico antes de ejecutar el solucionador.', 'warn');
      return;
    }
    const plan = currentSolutionPlan;
    if(!plan){
      appendSolverLog('No hay un plan de solución disponible. Ejecuta el diagnóstico primero.', 'info');
      return;
    }
    const autoOnly = Boolean(options.autoOnly);
    const actions = (plan.autoActions || []).filter(action => !autoOnly || action.auto !== false);
    if(!actions.length){
      appendSolverLog('No hay acciones automáticas disponibles. Consulta los pasos sugeridos.', 'info');
      return;
    }
    solvingInProgress = true;
    const autoButton = el('#solverAutoBtn');
    if(autoButton && !autoButton.dataset.originalLabel){
      autoButton.dataset.originalLabel = autoButton.textContent;
    }
    if(autoButton){
      autoButton.disabled = true;
      autoButton.textContent = 'Resolviendo…';
    }
    const stepsButton = el('#solverStepsBtn');
    if(stepsButton){
      stepsButton.disabled = true;
    }
    clearSolverLog();
    appendSolverLog('Iniciando plan de solución…', 'info');
    try{
      for(const action of actions){
        appendSolverLog(action.label || 'Ejecutando acción…', 'warn');
        await action.handler((message, tone = 'info') => appendSolverLog(message, tone));
      }
      appendSolverLog('Plan de solución completado. Validando con un nuevo diagnóstico…', 'ok');
      await runDiagnostics();
    }catch(err){
      const message = err instanceof Error ? err.message : String(err);
      appendSolverLog(`Error al ejecutar el plan: ${message}`, 'bad');
    }finally{
      solvingInProgress = false;
      if(autoButton){
        autoButton.textContent = autoButton.dataset.originalLabel || 'Solución automática';
      }
      if(stepsButton){
        stepsButton.disabled = false;
      }
      updateProblemSolverPanel();
    }
  }

  function displaySolutionSteps(){
    const plan = currentSolutionPlan;
    if(!plan){
      appendSolverLog('No hay pasos disponibles. Ejecuta el diagnóstico.', 'info');
      return;
    }
    clearSolverLog();
    appendSolverLog(plan.summary, plan.severity || 'info');
    if(Array.isArray(plan.issues) && plan.issues.length){
      appendSolverLog('Incidencias detectadas:', 'warn');
      plan.issues.forEach(issue => appendSolverLog(`• ${issue.text}`, issue.tone || 'info'));
    }
    if(Array.isArray(plan.steps) && plan.steps.length){
      appendSolverLog('Pasos sugeridos:', 'info');
      plan.steps.forEach(step => appendSolverLog(`• ${step.text}`, step.tone || 'info'));
    }else{
      appendSolverLog('No hay pasos manuales pendientes.', 'ok');
    }
  }

  function triggerAutoSolverIfNeeded(){
    const plan = currentSolutionPlan;
    if(solvingInProgress || !plan) return;
    const hasAuto = (plan.autoActions || []).some(action => action.auto !== false);
    if(!hasAuto) return;
    const runId = plan.diagnosticRunId;
    if(!runId) return;
    if(lastSolverAutoRunId === runId) return;
    lastSolverAutoRunId = runId;
    executeProblemSolver({ autoOnly: true });
  }

  function updateDuplicatesPanel(){
    const statusEl = el('#dupStatus');
    const listEl = el('#dupList');
    if(!statusEl || !listEl) return;
    listEl.innerHTML = '';
    if(diagInProgress){
      statusEl.textContent = 'Diagnóstico en ejecución…';
      listEl.classList.add('hidden');
      return;
    }
    if(!lastDiagnostics){
      statusEl.textContent = 'Ejecuta el diagnóstico para habilitar esta sección.';
      listEl.classList.add('hidden');
      return;
    }
    if(lastDiagnostics.failed){
      statusEl.textContent = 'El diagnóstico no se completó. Ejecuta nuevamente para evaluar duplicados.';
      listEl.classList.add('hidden');
      return;
    }
    const sheetsWithDuplicates = (lastDiagnostics.sheets || [])
      .filter(sheet => (sheet?.duplicateIdTotal || 0) > 0 || (sheet?.duplicatePhoneTotal || 0) > 0);
    if(!sheetsWithDuplicates.length){
      statusEl.textContent = 'Sin duplicados detectados en las bases analizadas.';
      listEl.classList.add('hidden');
      return;
    }
    statusEl.textContent = 'Duplicados detectados. Revisa cada base y limpia los registros repetidos directamente en Google Sheets.';
    listEl.classList.remove('hidden');
    sheetsWithDuplicates.forEach(sheet => {
      const card = document.createElement('article');
      card.className = 'dup-card';
      const header = document.createElement('header');
      const title = document.createElement('h3');
      title.textContent = sheetDisplayName(sheet.name) || sheet.name;
      header.appendChild(title);
      const counts = document.createElement('div');
      counts.className = 'dup-counts';
      if(sheet.duplicateIdTotal){
        const span = document.createElement('span');
        span.textContent = `IDs: ${sheet.duplicateIdTotal}`;
        counts.appendChild(span);
      }
      if(sheet.duplicatePhoneTotal){
        const span = document.createElement('span');
        span.textContent = `Teléfonos: ${sheet.duplicatePhoneTotal}`;
        counts.appendChild(span);
      }
      header.appendChild(counts);
      card.appendChild(header);

      const sample = document.createElement('div');
      sample.className = 'dup-sample';
      let hasSample = false;
      if(Array.isArray(sheet.duplicateIds) && sheet.duplicateIds.length){
        const block = document.createElement('div');
        const label = document.createElement('strong');
        label.textContent = 'IDs duplicados';
        block.appendChild(label);
        const ul = document.createElement('ul');
        sheet.duplicateIds.slice(0,3).forEach(item => {
          const li = document.createElement('li');
          li.textContent = `${item.value} → filas ${item.rows.join(', ')}`;
          ul.appendChild(li);
        });
        block.appendChild(ul);
        sample.appendChild(block);
        hasSample = true;
      }
      if(Array.isArray(sheet.duplicatePhones) && sheet.duplicatePhones.length){
        const block = document.createElement('div');
        const label = document.createElement('strong');
        label.textContent = 'Teléfonos duplicados';
        block.appendChild(label);
        const ul = document.createElement('ul');
        sheet.duplicatePhones.slice(0,3).forEach(item => {
          const phoneLabel = Array.isArray(item.samples) && item.samples.length
            ? item.samples.join(' / ')
            : item.value;
          const li = document.createElement('li');
          li.textContent = `${phoneLabel} → filas ${item.rows.join(', ')}`;
          ul.appendChild(li);
        });
        block.appendChild(ul);
        sample.appendChild(block);
        hasSample = true;
      }
      if(hasSample){
        card.appendChild(sample);
      }

      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'btn primary';
      btn.textContent = 'Limpiar';
      btn.disabled = diagInProgress;
      btn.addEventListener('click', ()=> handleDuplicateCleanup(sheet.name, btn));
      card.appendChild(btn);

      listEl.appendChild(card);
    });
  }

  async function performDuplicateCleanup(sheetName){
    if(!sheetName) throw new Error('Hoja no especificada');
    const res = await apiFetch(`${API_URL}?action=resolveDuplicates&sheet=${encodeURIComponent(sheetName)}`);
    if(!res.ok){
      throw new Error(`HTTP ${res.status}`);
    }
    const data = await res.json().catch(() => ({}));
    if(data && data.error){
      throw new Error(data.error);
    }
    if(data?.ok === false){
      throw new Error(data.error || 'No se pudo completar la limpieza');
    }
    return data?.message || 'Proceso completado.';
  }

  async function handleDuplicateCleanup(sheetName, button){
    if(!sheetName) return;
    if(!canPerform('manageDuplicates')){
      alert('No tienes permisos para eliminar duplicados.');
      return;
    }
    if(diagInProgress){
      alert('Espera a que termine el diagnóstico en curso.');
      return;
    }
    const displayName = sheetDisplayName(sheetName) || sheetName;
    const proceed = confirm(`Se eliminarán los registros duplicados detectados en "${displayName}" directamente en Google Sheets. ¿Deseas continuar?`);
    if(!proceed) return;
    let cleanupOk = false;
    const originalLabel = button ? button.textContent : '';
    if(button){
      button.disabled = true;
      button.textContent = 'Limpiando…';
    }
    try{
      const message = await performDuplicateCleanup(sheetName);
      cleanupOk = true;
      alert(message);
    }catch(err){
      console.error('Error al eliminar duplicados', err);
      alert('Error al eliminar duplicados: ' + err.message);
    }finally{
    if(button){
      button.disabled = false;
      button.textContent = originalLabel || 'Limpiar';
    }
    }
    if(cleanupOk){
      await runDiagnostics();
    }
  }

  // —— Eventos ——
  function bind(){
    if(hasBound) return;
    hasBound = true;
    // Buscar (Ctrl+/)
    const q = el('#q');
    q.addEventListener('input', ()=>{ state.query = q.value.trim(); state.page=0; refresh(); });
    el('#searchBtn').addEventListener('click', ()=>{ state.query = q.value.trim(); state.page=0; refresh(); });
    window.addEventListener('keydown', e=>{ if((e.ctrlKey||e.metaKey) && e.key === '/'){ e.preventDefault(); q.focus(); } })

    const appShell = el('#app');
    const menuTriggers = els('.menu-trigger');
    const sidebarOverlay = el('#sidebarOverlay');
    const sidebarNav = el('#sidebar');
    const sidebarCloseBtn = el('#sidebarClose');
    const setSidebarOpen = open => {
      if(appShell){
        appShell.classList.toggle('show-sidebar', Boolean(open));
      }
      if(sidebarOverlay){
        sidebarOverlay.setAttribute('aria-hidden', open ? 'false' : 'true');
      }
      menuTriggers.forEach(btn => btn.setAttribute('aria-expanded', open ? 'true' : 'false'));
      if(sidebarNav){
        const hideSidebar = window.innerWidth <= 900 && !open;
        sidebarNav.setAttribute('aria-hidden', hideSidebar ? 'true' : 'false');
      }
      document.body.classList.toggle('sidebar-open', Boolean(open));
    };
    const toggleSidebar = () => setSidebarOpen(!(appShell && appShell.classList.contains('show-sidebar')));
    const closeSidebar = () => {
      if(window.innerWidth <= 900){
        setSidebarOpen(false);
      }else if(appShell){
        if(!appShell.classList.contains('collapsed')){
          appShell.classList.add('collapsed');
        }
        const toggleBtn = el('#menuToggle');
        if(toggleBtn){
          toggleBtn.setAttribute('aria-expanded','false');
          toggleBtn.classList.add('is-collapsed');
        }
        applyBrandLogoState();
        updateCollapsedBrandInteractivity();
      }
    };
    const preferencesShortcut = el('#preferencesShortcut');
    if(preferencesShortcut){
      preferencesShortcut.addEventListener('click', event => {
        event.preventDefault();
        const targetLink = document.querySelector('.nav-link[data-nav="configuracion"]');
        if(targetLink){
          activateView('configuracion', targetLink);
          setSidebarOpen(false);
          const focusTarget = el('#prefBoardDensity') || el('#prefDensity');
          if(focusTarget && typeof focusTarget.focus === 'function'){
            focusTarget.focus();
            if(typeof focusTarget.scrollIntoView === 'function'){
              focusTarget.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
          }
        }
      });
    }
    menuTriggers.forEach(btn => {
      btn.addEventListener('click', toggleSidebar);
      btn.setAttribute('aria-expanded','false');
    });
    if(sidebarOverlay){
      sidebarOverlay.addEventListener('click', ()=>setSidebarOpen(false));
    }
    if(sidebarCloseBtn){
      sidebarCloseBtn.addEventListener('click', event => {
        event.preventDefault();
        closeSidebar();
      });
    }
    if(sidebarNav){
      const hideSidebar = window.innerWidth <= 900;
      sidebarNav.setAttribute('aria-hidden', hideSidebar ? 'true' : 'false');
    }
    const navLinks = getNavigationLinks();
    const handleNavClick = event => {
      event.preventDefault();
      const link = event.currentTarget;
      if(!link || link.classList.contains('hidden') || link.disabled) return;
      const target = link.dataset.nav;
      if(!target) return;
      activateView(target, link);
      setSidebarOpen(false);
    };
    const handleTabKeydown = event => {
      const key = event.key;
      if(key !== 'ArrowRight' && key !== 'ArrowLeft' && key !== 'Home' && key !== 'End') return;
      const tabs = getNavigationLinks().filter(link => link.getAttribute('role') === 'tab' && !link.classList.contains('hidden') && !link.disabled);
      const current = event.currentTarget;
      const index = tabs.indexOf(current);
      if(index < 0 || !tabs.length) return;
      event.preventDefault();
      let nextIndex = index;
      if(key === 'ArrowRight'){
        nextIndex = (index + 1) % tabs.length;
      }else if(key === 'ArrowLeft'){
        nextIndex = (index - 1 + tabs.length) % tabs.length;
      }else if(key === 'Home'){
        nextIndex = 0;
      }else if(key === 'End'){
        nextIndex = tabs.length - 1;
      }
      const nextTab = tabs[nextIndex];
      if(nextTab){
        nextTab.focus();
        nextTab.click();
      }
    };
    navLinks.forEach(link => {
      link.addEventListener('click', handleNavClick);
      if(link.getAttribute('role') === 'tab'){
        link.addEventListener('keydown', handleTabKeydown);
      }
    });
    const logoutBtn = el('#logoutBtn');
    if(logoutBtn){
      logoutBtn.addEventListener('click', event => {
        event.preventDefault();
        if(logoutBtn.disabled) return;
        performLogout();
      });
    }
    const initialNav = navLinks.find(link => link.classList.contains('active') && !link.classList.contains('hidden')) || navLinks.find(link => !link.classList.contains('hidden'));
    if(initialNav){
      activateView(initialNav.dataset.nav, initialNav);
    }
    initPermissionScopeSelectors();
    renderPermissionReference();
    renderTeamTemplateToolbar();
    const permRoleSelect = el('#permRole');
    if(permRoleSelect){
      permRoleSelect.addEventListener('change', () => {
        const value = permRoleSelect.value;
        updatePermissionRoleHint(value);
        applyRoleScopeTemplate(value, { silent: true });
      });
      updatePermissionRoleHint(permRoleSelect.value);
    }
    const permApplyRolePreset = el('#permApplyRolePreset');
    if(permApplyRolePreset){
      permApplyRolePreset.addEventListener('click', () => {
        const roleSelect = el('#permRole');
        const role = roleSelect ? roleSelect.value : 'asesor';
        const applied = applyRoleScopeTemplate(role, { force: true, silent: false });
        if(applied){
          updatePermissionRoleHint(role);
        }
      });
    }
    const permList = el('#permList');
    if(permList){
      permList.addEventListener('click', event => {
        const target = event.target.closest('.perm-user');
        if(!target || target.classList.contains('active')) return;
        const userId = target.dataset.userId;
        if(userId){
          selectPermissionUser(userId);
        }
      });
    }
    const permForm = el('#permForm');
    if(permForm){
      permForm.addEventListener('submit', handlePermissionSave);
      if(getUserRole() === 'admin'){
        startPermissionCreation({ focus: false, renderList: false });
      }
    }
    const permNewBtn = el('#permNewBtn');
    if(permNewBtn){
      permNewBtn.addEventListener('click', ()=> startPermissionCreation({ resetStatus: true }));
    }
    const permReloadBtn = el('#permReloadBtn');
    if(permReloadBtn){
      permReloadBtn.addEventListener('click', ()=> ensurePermissionsLoaded(true));
    }
    const permResetBtn = el('#permResetBtn');
    if(permResetBtn){
      permResetBtn.addEventListener('click', ()=>{
        if(selectedPermissionUserId){
          const user = permissionUsers.find(u => u.userId === selectedPermissionUserId);
          if(user){
            populatePermissionForm(user, { focus: false });
            setPermissionStatus(`Se restauraron los datos guardados de ${user.name || user.userId}.`, 'info');
          }else{
            startPermissionCreation({ resetStatus: true });
          }
        }else{
          startPermissionCreation({ resetStatus: true });
        }
      });
    }
    const solverAutoBtn = el('#solverAutoBtn');
    if(solverAutoBtn){
      solverAutoBtn.addEventListener('click', () => executeProblemSolver());
    }
    const solverStepsBtn = el('#solverStepsBtn');
    if(solverStepsBtn){
      solverStepsBtn.addEventListener('click', () => displaySolutionSteps());
    }
    const permDeleteBtn = el('#permDeleteBtn');
    if(permDeleteBtn){
      permDeleteBtn.addEventListener('click', handlePermissionDelete);
    }
    const teamList = el('#teamList');
    if(teamList){
      teamList.addEventListener('click', event => {
        const target = event.target.closest('.team-item');
        if(!target || target.classList.contains('active')) return;
        const teamId = target.dataset.teamId;
        if(teamId){
          selectTeam(teamId);
        }
      });
    }
    const teamForm = el('#teamForm');
    if(teamForm){
      teamForm.addEventListener('submit', handleTeamSave);
      if(getUserRole() === 'admin'){
        startTeamCreation({ focus: false, renderList: false });
      }
    }
    const teamNewBtn = el('#teamNewBtn');
    if(teamNewBtn){
      teamNewBtn.addEventListener('click', ()=> startTeamCreation({ resetStatus: true }));
    }
    const teamReloadBtn = el('#teamReloadBtn');
    if(teamReloadBtn){
      teamReloadBtn.addEventListener('click', ()=> ensureTeamsLoaded(true));
    }
    const teamResetBtn = el('#teamResetBtn');
    if(teamResetBtn){
      teamResetBtn.addEventListener('click', ()=>{
        if(selectedTeamId){
          const team = teams.find(t => t.teamId === selectedTeamId);
          if(team){
            populateTeamForm(team, { focus: false });
            setTeamStatus(`Se restauraron los datos guardados de ${team.name || team.teamId}.`, 'info');
          }else{
            startTeamCreation({ resetStatus: true });
          }
        }else{
          startTeamCreation({ resetStatus: true });
        }
      });
    }
    const teamCloneBtn = el('#teamCloneBtn');
    if(teamCloneBtn){
      teamCloneBtn.addEventListener('click', cloneSelectedTeam);
    }
    const teamDeleteBtn = el('#teamDeleteBtn');
    if(teamDeleteBtn){
      teamDeleteBtn.addEventListener('click', handleTeamDelete);
    }
    const mobileNavQuery = window.matchMedia('(max-width: 900px)');
    const handleNavBreakpoint = e => { if(!e.matches){ setSidebarOpen(false); } };
    if(typeof mobileNavQuery.addEventListener === 'function'){
      mobileNavQuery.addEventListener('change', handleNavBreakpoint);
    }else if(typeof mobileNavQuery.addListener === 'function'){
      mobileNavQuery.addListener(handleNavBreakpoint);
    }

    const handleBoardBreakpoint = e => {
      if(!e.matches){
        state.mobileColumns = {};
      }
      refresh();
    };
    if(typeof boardMobileQuery.addEventListener === 'function'){
      boardMobileQuery.addEventListener('change', handleBoardBreakpoint);
    }else if(typeof boardMobileQuery.addListener === 'function'){
      boardMobileQuery.addListener(handleBoardBreakpoint);
    }

    // Selección de hoja
    const sheetSel = el('#sheetSelect');
    const importSheetSel = el('#importBaseSelect');

    const ensureSheetSelection = () => {
      if(!sheets.includes(state.sheet)){
        state.sheet = sheets[0] || '';
      }
    };

    const handleSheetChange = async event => {
      const select = event?.currentTarget;
      if(!select) return;
      const selected = select.value;
      if(!selected || !sheets.includes(selected)){
        syncSheetSelectorsUI();
        return;
      }
      if(selected === state.sheet){
        syncSheetSelectorsUI();
        return;
      }
      state.sheet = selected;
      setAsesorFilter([]);
      state.campus = '';
      state.mobileColumns = {};
      await withGlobalLoading('Cargando base seleccionada…', () => loadLeads());
      populateAsesores();
      populateCampuses();
      populateExportFilters();
      state.page = 0;
      refresh();
      syncSheetSelectorsUI();
    };

    ensureSheetSelection();
    syncSheetSelectorsUI();

    if(sheetSel){
      sheetSel.addEventListener('change', handleSheetChange);
    }
    if(importSheetSel){
      importSheetSel.addEventListener('change', handleSheetChange);
    }

    // Selección de asesor
    const asesorSel = el('#asesorSelect');
    populateAsesores();
    if(asesorSel){
      asesorSel.addEventListener('change', ()=>{
        if(asesorSel.multiple){
          const selectedOptions = Array.from(asesorSel.selectedOptions || []);
          const hasAll = selectedOptions.some(opt => !opt.value);
          if(hasAll){
            Array.from(asesorSel.options).forEach(opt => {
              opt.selected = opt.value === '';
            });
            setAsesorFilter([]);
          }else{
            const values = selectedOptions.map(opt => opt.value).filter(Boolean);
            setAsesorFilter(values);
            if(!values.length && asesorSel.options.length){
              asesorSel.options[0].selected = true;
            }
          }
        }else{
          setAsesorFilter(asesorSel.value);
        }
        state.page=0;
        refresh();
      });
    }

    // Selección de plantel
    const campusSel = el('#campusSelect');
    populateCampuses();
    if(campusSel){
      campusSel.addEventListener('change', ()=>{ state.campus = campusSel.value; state.page=0; refresh(); });
    }

    const dailyShortcuts = el('#dailyShortcuts');
    if(dailyShortcuts){
      dailyShortcuts.addEventListener('click', event => {
        const button = event.target.closest('button[data-type]');
        if(!button) return;
        const type = button.dataset.type;
        const value = button.dataset.value || '';
        state.query = '';
        const qInput = el('#q');
        if(qInput) qInput.value = '';
        if(type === 'campus'){
          state.campus = state.campus === value ? '' : value;
          populateCampuses();
        }else if(type === 'asesor'){
          const normalizedValue = normalizeAsesorName(value);
          const selected = getAsesorFilter();
          const isActive = selected.length === 1 && normalizeAsesorName(selected[0]) === normalizedValue;
          if(isActive){
            setAsesorFilter([]);
          }else{
            setAsesorFilter(value ? [value] : []);
          }
          populateAsesores();
        }
        state.page = 0;
        refresh();
      });
    }

    // Filtros por columna
    els('input[data-col]').forEach(inp=>{
      inp.addEventListener('input', ()=>{
        state.colFilters[inp.dataset.col] = inp.value.trim().toLowerCase();
        state.page=0;
        refresh();
      });
    });

    // Configuración y preferencias
    initSettings();

    // Panel emergente
    const panelClose = el('#panelClose');
    if(panelClose){
      panelClose.addEventListener('click', hidePanelOverlay);
    }
    const panelOverlay = el('#panelOverlay');
    if(panelOverlay){
      panelOverlay.addEventListener('click', e=>{
        if(e.target === panelOverlay){
          hidePanelOverlay();
        }
      });
    }
    const overlayBreakpoint = window.matchMedia('(max-width: 1200px)');
    const handleOverlayBreakpoint = e => { if(e.matches){ hidePanelOverlay(); } };
    if(typeof overlayBreakpoint.addEventListener === 'function'){
      overlayBreakpoint.addEventListener('change', handleOverlayBreakpoint);
    }else if(typeof overlayBreakpoint.addListener === 'function'){
      overlayBreakpoint.addListener(handleOverlayBreakpoint);
    }
    document.addEventListener('keydown', e=>{
      if(e.key === 'Escape'){
        hidePanelOverlay();
        const drawer = el('#drawer');
        if(drawer && drawer.classList.contains('open')){
          drawer.classList.remove('open');
          drawer.ariaHidden = 'true';
        }
        setSidebarOpen(false);
      }
    });

    // Tamaño de página
    const sizeSel = el('#pageSize');
    if(sizeSel) sizeSel.addEventListener('change', ()=>{
      const value = Number(sizeSel.value);
      state.pageSize = Number.isFinite(value) && value > 0 ? value : 0;
      state.page = 0;
      state.columnLimits = {};
      refresh();
    });

    // Drawer
    el('#closeDrawer').addEventListener('click', ()=>{ el('#drawer').classList.remove('open'); el('#drawer').ariaHidden='true'; });
    el('#drawer').addEventListener('click', (e)=>{ if(e.target.id==='drawer') { el('#drawer').classList.remove('open'); el('#drawer').ariaHidden='true'; } });
  }

  function refresh(){
    const rows = applyFilters();
    renderDailyShortcuts(rows);
    const {key, dir} = state.sort;
    if(key){ rows.sort((a,b)=> (a[key]||'').localeCompare(b[key]||'') * dir ); }
    const totals = etapasUI.reduce((acc, step)=>{ acc[step] = 0; return acc; }, {});
    rows.forEach(row => {
      const label = etapaGroup(row.etapa);
      if(typeof totals[label] === 'number') totals[label]++;
    });
    const columnSignature = JSON.stringify({
      query: state.query,
      asesor: getAsesorFilter(),
      campus: state.campus,
      sort: state.sort,
      filters: Object.entries(state.colFilters || {}).sort(([a],[b]) => a.localeCompare(b)),
      sheet: state.sheet,
      pageSize: state.pageSize
    });
    if(columnSignature !== state.columnLimitSignature){
      state.columnLimitSignature = columnSignature;
      state.columnLimits = {};
    }
    renderPagination(rows.length);
    const hasPagination = Number.isFinite(state.pageSize) && state.pageSize > 0;
    const start = hasPagination ? state.page * state.pageSize : 0;
    const end = hasPagination ? start + state.pageSize : rows.length;
    const pageRows = rows.slice(start, end);
    pruneColumnLimits(pageRows);
    renderKanban(pageRows, totals);
  }

  async function initializeApp(){
    try{
      await withGlobalLoading('Sincronizando bases…', () => loadSheets());
      if(!state.sheet || !sheets.includes(state.sheet)){
        state.sheet = sheets[0] || '';
      }
      syncSheetSelectorsUI();
      if(state.sheet){
        await withGlobalLoading('Cargando leads…', () => loadLeads());
      }else{
        leads = [];
      }
    }catch(err){
      if(!(err && err.code === 'UNAUTHORIZED')){
        console.error('Error durante la inicialización', err);
      }
    }finally{
      bind();
      populateAsesores();
      populateCampuses();
      populateExportFilters();
      applyActionPermissions();
      refresh();
      if(getUserRole() === 'admin'){
        await ensurePermissionsLoaded();
      }
    }
  }

  function updateMobileTopbar(targetSection, sourceLink){
    const mobileTopbar = el('#mobileTopbar');
    if(!mobileTopbar) return;
    const labelEl = el('#mobileViewLabel');
    const explicitLabel = targetSection ? (targetSection.getAttribute('data-mobile-title') || '').trim() : '';
    const labelSource = sourceLink && (sourceLink.querySelector('span') || sourceLink);
    const fallbackLabel = labelSource ? (labelSource.textContent || '').trim() : '';
    const labelText = explicitLabel || fallbackLabel || 'Vista actual';
    if(labelEl){
      labelEl.textContent = `Vista: ${labelText}`;
    }
    const hideAttr = targetSection ? targetSection.getAttribute('data-hide-mobile-topbar') : null;
    const shouldHide = typeof hideAttr === 'string' && hideAttr !== '' && hideAttr !== 'false';
    mobileTopbar.classList.toggle('hidden', Boolean(shouldHide));
    mobileTopbar.setAttribute('aria-hidden', shouldHide ? 'true' : 'false');
  }

  const menuToggle = el('#menuToggle');
  if(menuToggle){
    const appEl = el('#app');
    const sidebarEl = el('#sidebar');
    const isMobileViewport = () => window.innerWidth <= 900;
    const ensureDesktopSidebarAria = () => {
      if(sidebarEl && !isMobileViewport()){
        sidebarEl.setAttribute('aria-hidden','false');
      }
    };
    const syncToggleState = () => {
      if(!appEl) return;
      const isCollapsed = appEl.classList.contains('collapsed');
      menuToggle.setAttribute('aria-expanded', String(!isCollapsed));

      menuToggle.classList.toggle('is-collapsed', isCollapsed);
    };
    const toggleMenu = () => {
      if(!appEl) return;
      appEl.classList.toggle('collapsed');
      syncToggleState();
      ensureDesktopSidebarAria();
      applyBrandLogoState();
      updateCollapsedBrandInteractivity();
    };
    menuToggle.addEventListener('click', toggleMenu);
    window.addEventListener('resize', () => {
      ensureDesktopSidebarAria();

      syncToggleState();
      applyBrandLogoState();
      updateCollapsedBrandInteractivity();
    });
    ensureDesktopSidebarAria();
    syncToggleState();
    applyBrandLogoState();
    updateCollapsedBrandInteractivity();
  }

  updateDuplicatesPanel();
  updateProblemSolverPanel();


  // Diagnóstico
  async function runDiagnostics(){
    if(diagInProgress) return;
    if(!canPerform('runDiagnostics')){
      alert('No tienes permisos para ejecutar el diagnóstico.');
      return;
    }
    const log = el('#diagLog');
    if(!log) return;
    const diagButton = el('#diagBtn');
    const setLoading = (loading) => {
      if(!diagButton) return;
      if(loading){
        diagButton.disabled = true;
        if(!diagButton.dataset.originalLabel){
          diagButton.dataset.originalLabel = diagButton.textContent;
        }
        diagButton.textContent = 'Analizando...';
      }else{
        diagButton.disabled = false;
        if(diagButton.dataset.originalLabel){
          diagButton.textContent = diagButton.dataset.originalLabel;
        }
      }
    };
    const addLine = (text, tone='info') => {
      const li = document.createElement('li');
      li.textContent = text;
      const color = colorForTone(tone);
      if(color) li.style.color = color;
      log.appendChild(li);
      const panel = log.parentElement;
      if(panel) panel.scrollTop = panel.scrollHeight;
      return li;
    };
    const addSublist = (parent, items) => {
      if(!parent || !items || !items.length) return;
      const ul = document.createElement('ul');
      ul.classList.add('diag-sublist');
      items.forEach(item => {
        const li = document.createElement('li');
        const data = typeof item === 'string' ? { text: item, tone: 'info' } : item;
        li.textContent = data.text || '';
        const tone = data.tone || 'info';
        const color = colorForTone(tone);
        if(color) li.style.color = color;
        ul.appendChild(li);
      });
      parent.appendChild(ul);
    };

    currentDiagnosticsRunId = Date.now();
    diagInProgress = true;
    lastDiagnostics = null;
    updateDuplicatesPanel();
    updateProblemSolverPanel();
    setLoading(true);
    log.innerHTML = '';
    clearSolverLog();
    try{
      addLine(navigator.onLine ? 'Conexión local: en línea' : 'Conexión local: sin conexión', navigator.onLine ? 'ok' : 'bad');
      if(!sheets.length){
        await loadSheets();
      }
      const sheetName = state.sheet && sheets.includes(state.sheet)
        ? state.sheet
        : (sheets[0] || '');
      if(!sheetName){
        addLine('No hay hojas disponibles para ejecutar el diagnóstico.', 'bad');
        lastDiagnostics = { failed: true, errors: ['No hay hojas disponibles para ejecutar el diagnóstico.'], reason: 'noSheets' };
        return;
      }

      let response;
      try{
        response = await apiFetch(`${API_URL}?action=diagnostics&sheet=${encodeURIComponent(sheetName)}`);
      }catch(err){
        if(err && err.code === 'UNAUTHORIZED') return;
        addLine(`Error al contactar el servicio: ${err.message}`, 'bad');
        lastDiagnostics = {
          failed: true,
          errors: [`Error al contactar el servicio: ${err.message}`],
          connectionFailed: true,
          errorMessage: err.message,
          checks: { connection: { ok: false, message: err.message } }
        };
        return;
      }
      const httpLabel = `Respuesta HTTP: ${response.status}${response.statusText ? ' '+response.statusText : ''}`.trim();
      addLine(httpLabel, response.ok ? 'ok' : 'bad');
      if(!response.ok){
        const body = await response.text().catch(()=> '');
        if(body) addLine(body, 'bad');
        lastDiagnostics = {
          failed: true,
          errors: body ? [body] : [`HTTP ${response.status}`],
          httpStatus: response.status
        };
        return;
      }

      let data;
      try{
        data = await response.json();
      }catch(err){
        addLine('No se pudo interpretar la respuesta del diagnóstico.', 'bad');
        lastDiagnostics = { failed: true, errors: ['No se pudo interpretar la respuesta del diagnóstico.'] };
        return;
      }

      if(data.timestamp){
        const ts = new Date(data.timestamp);
        if(!isNaN(ts.getTime())){
          addLine(`Ejecutado: ${ts.toLocaleString()}`, 'info');
        }
      }

      const sheetLabel = data.sheet || sheetName;
      const connectionCheck = data.checks?.connection;
      if(connectionCheck){
        const connLine = addLine(`Google Sheets (${sheetLabel}): ${connectionCheck.ok ? 'OK' : 'Fallo'}`, connectionCheck.ok ? 'ok' : 'bad');
        if(connectionCheck.message){
          addSublist(connLine, [{ text: connectionCheck.message, tone: connectionCheck.ok ? 'info' : 'warn' }]);
        }
      }else{
        addLine(`Google Sheets (${sheetLabel}): ${data.connection ? 'OK' : 'Fallo'}`, data.connection ? 'ok' : 'bad');
      }

      const readCheck = data.checks?.read;
      if(readCheck){
        const readLine = addLine(`Prueba de lectura: ${readCheck.ok ? 'OK' : 'Fallo'}`, readCheck.ok ? 'ok' : 'bad');
        if(readCheck.message){
          addSublist(readLine, [{ text: readCheck.message, tone: readCheck.ok ? 'info' : 'bad' }]);
        }
      }
      const writeCheck = data.checks?.write;
      if(writeCheck){
        const writeLine = addLine(`Prueba de escritura: ${writeCheck.ok ? 'OK' : 'Fallo'}`, writeCheck.ok ? 'ok' : 'bad');
        if(writeCheck.message){
          addSublist(writeLine, [{ text: writeCheck.message, tone: writeCheck.ok ? 'info' : 'bad' }]);
        }
      }

      if(data.system){
        const sysStatus = data.system.status || 'Sin definir';
        const sysTone = sysStatus === 'Operativo' ? 'ok' : (sysStatus === 'Con incidencias' ? 'warn' : 'info');
        const sysLine = addLine(`Estado del sistema: ${sysStatus}`, sysTone);
        const sysDetails = [];
        if(data.system.timezone) sysDetails.push({ text: `Zona horaria: ${data.system.timezone}`, tone: 'info' });
        if(typeof data.summary?.sheetsWithErrors === 'number'){
          sysDetails.push({ text: `Hojas con incidencias: ${data.summary.sheetsWithErrors}`, tone: data.summary.sheetsWithErrors ? 'warn' : 'info' });
        }
        if(typeof data.summary?.invalidRows === 'number'){
          sysDetails.push({ text: `Filas con datos inválidos: ${data.summary.invalidRows}`, tone: data.summary.invalidRows ? 'warn' : 'info' });
        }
        addSublist(sysLine, sysDetails);
      }

      if(data.login){
        const loginTone = data.login.ok ? 'ok' : (data.login.enabled ? 'warn' : 'info');
        const loginMsg = data.login.message || (data.login.ok ? 'Activo' : 'Desactivado');
        addLine(`Inicio de sesión: ${loginMsg}`, loginTone);
      }

      if(Array.isArray(data.errors) && data.errors.length){
        const errLi = addLine(`Errores (${data.errors.length})`, 'bad');
        addSublist(errLi, data.errors.map(msg => ({ text: msg, tone: 'bad' })));
      }
      if(Array.isArray(data.warnings) && data.warnings.length){
        const warnLi = addLine(`Alertas (${data.warnings.length})`, 'warn');
        addSublist(warnLi, data.warnings.map(msg => ({ text: msg, tone: 'warn' })));
      }

      if(Array.isArray(data.sheets) && data.sheets.length){
        data.sheets.forEach(sheet => {
          const tone = !sheet.ok ? 'bad' : (sheet.hasWarnings ? 'warn' : 'ok');
          const sheetLine = addLine(`Hoja "${sheet.name}": ${sheet.ok ? 'sin errores críticos' : 'requiere revisión'}`, tone);
          const details = [];
          if(sheet.name === sheetLabel) details.push({ text: 'Hoja utilizada actualmente por la aplicación.', tone: 'info' });
          if(Array.isArray(sheet.missingColumns) && sheet.missingColumns.length){
            details.push({ text: `Columnas faltantes: ${sheet.missingColumns.join(', ')}`, tone: 'bad' });
          }
          if(Array.isArray(sheet.unknownColumns) && sheet.unknownColumns.length){
            const unknownList = sheet.unknownColumns.map(c => c.column ? `${c.name} (${c.column})` : c.name).join(', ');
            details.push({ text: `Encabezados no reconocidos: ${unknownList}`, tone: 'warn' });
          }
          if(sheet.duplicateIdTotal){
            details.push({ text: `IDs duplicados: ${sheet.duplicateIdTotal}`, tone: 'warn' });
            sheet.duplicateIds.slice(0,5).forEach(item => {
              details.push({ text: `· ${item.value} en filas ${item.rows.join(', ')}`, tone: 'warn' });
            });
            if(sheet.duplicateIdTotal > sheet.duplicateIds.length){
              details.push({ text: '· ... se omitieron más coincidencias de ID.', tone: 'info' });
            }
          }
          if(sheet.duplicatePhoneTotal){
            details.push({ text: `Teléfonos duplicados: ${sheet.duplicatePhoneTotal}`, tone: 'warn' });
            sheet.duplicatePhones.slice(0,5).forEach(item => {
              const label = item.samples && item.samples.length ? item.samples.join(' / ') : item.value;
              details.push({ text: `· ${label} en filas ${item.rows.join(', ')}`, tone: 'warn' });
            });
            if(sheet.duplicatePhoneTotal > sheet.duplicatePhones.length){
              details.push({ text: '· ... se omitieron más coincidencias de teléfono.', tone: 'info' });
            }
          }
          if(sheet.invalidCount){
            details.push({ text: `Filas con datos inválidos: ${sheet.invalidCount}`, tone: 'bad' });
            (sheet.invalidRows || []).slice(0,5).forEach(row => {
              details.push({ text: `· Fila ${row.row}: ${row.issues.join('; ')}`, tone: 'bad' });
            });
            if(sheet.truncatedInvalid){
              details.push({ text: '· ... se omitieron filas adicionales con incidencias.', tone: 'info' });
            }
          }
          if(!details.length){
            details.push({ text: 'Sin observaciones.', tone: 'info' });
          }
          addSublist(sheetLine, details);
        });
      }

      if(data.aggregate){
        const ids = Array.isArray(data.aggregate.duplicateIds) ? data.aggregate.duplicateIds : [];
        const phones = Array.isArray(data.aggregate.duplicatePhones) ? data.aggregate.duplicatePhones : [];
        const idsLine = addLine(`Duplicados globales de ID: ${ids.length}`, ids.length ? 'warn' : 'ok');
        if(ids.length){
          const items = ids.slice(0,5).map(entry => ({
            text: `${entry.value} (${entry.count}) → ${entry.occurrences.map(o => `${o.sheet} (fila ${o.row})`).join(', ')}`,
            tone: 'warn'
          }));
          if(ids.length > 5 || ids.some(entry => entry.truncated)){
            items.push({ text: '... se omitieron coincidencias adicionales.', tone: 'info' });
          }
          addSublist(idsLine, items);
        }
        const phonesLine = addLine(`Duplicados globales de teléfono: ${phones.length}`, phones.length ? 'warn' : 'ok');
        if(phones.length){
          const items = phones.slice(0,5).map(entry => ({
            text: `${entry.value} (${entry.count}) → ${entry.occurrences.map(o => `${o.sheet} (fila ${o.row})`).join(', ')}`,
            tone: 'warn'
          }));
          if(phones.length > 5 || phones.some(entry => entry.truncated)){
            items.push({ text: '... se omitieron coincidencias adicionales.', tone: 'info' });
          }
          addSublist(phonesLine, items);
        }
      }
      lastDiagnostics = data;
      updateDuplicatesPanel();
      updateProblemSolverPanel();
      triggerAutoSolverIfNeeded();
      return data;
    }catch(err){
      addLine('Error inesperado durante el diagnóstico: '+err.message, 'bad');
      lastDiagnostics = { failed: true, errors: [`Error inesperado durante el diagnóstico: ${err.message}`], errorMessage: err.message };
    }finally{
      setLoading(false);
      diagInProgress = false;
      updateDuplicatesPanel();
      updateProblemSolverPanel();
      triggerAutoSolverIfNeeded();
    }
  }
  const diagBtn = el('#diagBtn');
  if(diagBtn) diagBtn.addEventListener('click', runDiagnostics);

  
  // Importar
  const FIELD_LABELS = {
    id: 'ID',
    nombre: 'Nombre',
    matricula: 'Matrícula',
    telefono: 'Teléfono',
    correo: 'Correo',
    campus: 'Campus',
    modalidad: 'Modalidad',
    programa: 'Programa',
    etapa: 'Etapa',
    estado: 'Estado',
    asesor: 'Asesor',
    comentario: 'Comentario',
    asignacion: 'Asignación',
    metadatos: 'Metadatos',
    telefonoNormalizado: 'Teléfono normalizado',
    telefonoAircall: 'Teléfono Aircall',
    telefonoWhatsapp: 'Teléfono WhatsApp',
    resolucion: 'Resolución',
    crm: 'CRM',
    toque1: 'Toque 1',
    toque2: 'Toque 2',
    toque3: 'Toque 3',
    toque4: 'Toque 4',
    motivo: 'Motivo',
    base: 'Base',
    asesorActual: 'Asesor actual',
    asesorNuevo: 'Asesor nuevo'
  };
  const IMPORT_OUTPUT_FIELDS = ['id','nombre','matricula','telefono','correo','campus','modalidad','programa','etapa','estado','asesor','comentario','asignacion'];
  const IMPORT_PAYLOAD_FIELDS = [...IMPORT_OUTPUT_FIELDS, 'metadatos'];
  const BULK_OUTPUT_FIELDS = ['id','matricula','etapa','estado','comentario','asesor'];
  const ACTIVOS_UPDATE_FIELDS = ['nombre','matricula','telefono','correo','campus','modalidad','programa'];
  const headerAliasMap = new Map();
  const etapaAliasMap = new Map();
  const estadoAliasMap = new Map();
  const FIELD_FORMATTERS = {
    telefono: value => fmtPhone(value),
    telefonoNormalizado: value => fmtPhone(value)
  };

  function normalizeAliasKey(value){
    return String(value || '')
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g,'')
      .toLowerCase()
      .replace(/[^a-z0-9]+/g,'');
  }
  function normalizeTextValue(value){
    return String(value || '')
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g,'')
      .toLowerCase()
      .replace(/\s+/g,' ')
      .trim();
  }
  function registerHeaderAlias(key, aliases){
    const list = Array.isArray(aliases) ? aliases : [aliases];
    [key, ...list].forEach(name => {
      const norm = normalizeAliasKey(name);
      if(norm && !headerAliasMap.has(norm)) headerAliasMap.set(norm, key);
    });
  }
  function registerEtapaAlias(value, aliases){
    const list = Array.isArray(aliases) ? aliases : [aliases];
    [value, ...list].forEach(name => {
      const norm = normalizeTextValue(name);
      if(norm && !etapaAliasMap.has(norm)) etapaAliasMap.set(norm, value);
    });
  }
  function registerEstadoAlias(etapa, value, aliases){
    const list = Array.isArray(aliases) ? aliases : [aliases];
    [value, ...list].forEach(name => {
      const norm = normalizeTextValue(name);
      if(norm && !estadoAliasMap.has(norm)) estadoAliasMap.set(norm, { etapa, value });
    });
  }

  registerHeaderAlias('id',['leadid','idcrm','idlead','folio','identificador']);
  registerHeaderAlias('nombre',['name','alumno','prospecto','contacto','fullname']);
  registerHeaderAlias('matricula',['matricula','matrícula','expediente','nexpediente','noexpediente','exped']);
  registerHeaderAlias('telefono',['telefono','teléfono','telefonos','telefono1','telefono 1','telefono2','telefono 2','celular','cel','movil','whatsapp','tel','phone','numero']);
  registerHeaderAlias('correo',['correo','correo electronico','correo electrónico','email','mail','emailaddress']);
  registerHeaderAlias('campus',['campus','plantel','sede','campus interes','campusinteres']);
  registerHeaderAlias('modalidad',['modalidad','modalidad academica','modalidadacademica','modalidad interes','modalidadinteres','modalidad educativa']);
  registerHeaderAlias('programa',['programa','carrera','programa interes','programa de interes','licenciatura','posgrado','curso']);
  registerHeaderAlias('etapa',['etapa','status','estatus','fase','fase actual','faseactual','stage','pipeline']);
  registerHeaderAlias('estado',['estado','subestado','subestatus','resultado','estado actual','estadoactual']);
  registerHeaderAlias('asesor',['asesor','agente','ejecutivo','owner','responsable','asesor asignado']);
  registerHeaderAlias('comentario',['comentario','nota','notas','observaciones','comentarios','comentario asesor']);
  registerHeaderAlias('asignacion',['asignacion','fecha asignacion','fechaasignacion','fecha de asignacion','fecha asignación','asignado','fecha contacto','fecha seguimiento']);
  registerHeaderAlias('telefonoNormalizado',['telefono normalizado','telefononormalizado','telefono estandarizado','telefonolimpio']);
  registerHeaderAlias('telefonoAircall',['telefono aircall','link aircall','aircall']);
  registerHeaderAlias('telefonoWhatsapp',['telefono whatsapp','whatsapplink','link whatsapp','url whatsapp']);
  registerHeaderAlias('resolucion',['resolucion','resolución','resolution']);
  registerHeaderAlias('toque1',['toque1','toque 1','primer toque']);
  registerHeaderAlias('toque2',['toque2','toque 2','segundo toque']);
  registerHeaderAlias('toque3',['toque3','toque 3','tercer toque']);
  registerHeaderAlias('toque4',['toque4','toque 4','cuarto toque']);
  registerHeaderAlias('metadatos',['metadatos','metadato','metadata','datos extra','informacion extra','info extra']);

  const HEADER_TOKEN_HINTS = [
    { field: 'telefonoWhatsapp', tokens: ['whatsapp'], score: 96 },
    { field: 'telefonoAircall', tokens: ['aircall'], score: 92 },
    { field: 'telefonoNormalizado', tokens: ['normalizad'], score: 90 },
    { field: 'telefono', tokens: ['tel*','cel*','movil','mobile','telefono'], score: 84 },
    { field: 'correo', tokens: ['correo','email','mail'], score: 82 },
    { field: 'matricula', tokens: ['matric*','control'], score: 78 },
    { field: 'id', tokens: ['id','folio'], score: 74 },
    { field: 'nombre', tokens: ['nombre','alumno','prospecto'], score: 72 },
    { field: 'programa', tokens: ['programa','carrera','licenciatura','posgrado','curso'], score: 68 },
    { field: 'campus', tokens: ['campus','plantel','sede'], score: 66 },
    { field: 'modalidad', tokens: ['modalidad','modal','turno'], score: 64 },
    { field: 'etapa', tokens: ['etapa','fase','status','pipeline'], score: 70 },
    { field: 'estado', tokens: ['estado','subestado','resultado'], score: 70 },
    { field: 'asesor', tokens: ['asesor','agente','ejecutivo','owner','responsable'], score: 66 },
    { field: 'comentario', tokens: ['coment*','nota','observa*'], score: 64 },
    { field: 'asignacion', tokens: ['asign*','seguimiento'], score: 62 }
  ];

  const KNOWN_ESTADOS = (() => {
    const set = new Set();
    Object.values(estadosByEtapa || {}).forEach(list => {
      if(!Array.isArray(list)) return;
      list.forEach(item => {
        const normalized = normalizeTextValue(item);
        if(normalized) set.add(normalized);
      });
    });
    return set;
  })();

  const HEADER_SOURCE_PRIORITY = { alias: 3, header: 2, data: 1 };

  function extractHeaderTokens(header){
    return String(header || '')
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g,'')
      .toLowerCase()
      .split(/[^a-z0-9]+/)
      .filter(Boolean);
  }

  function tokenMatchesPattern(token, pattern){
    if(!token || !pattern) return false;
    const normalizedToken = token.toLowerCase();
    const normalizedPattern = pattern.toLowerCase();
    if(normalizedPattern.endsWith('*')){
      const base = normalizedPattern.slice(0, -1);
      return base ? normalizedToken.startsWith(base) : false;
    }
    return normalizedToken === normalizedPattern;
  }

  function matchesTokenHint(tokens, patterns){
    if(!tokens.length || !patterns.length) return false;
    return patterns.some(pattern => tokens.some(token => tokenMatchesPattern(token, pattern)));
  }

  function collectColumnSamples(header, rows, limit = 50){
    const values = [];
    if(!Array.isArray(rows) || !rows.length) return values;
    for(let i = 0; i < rows.length && values.length < limit; i++){
      const row = rows[i];
      if(!row || typeof row !== 'object') continue;
      const value = cleanValue(row[header]);
      if(!value) continue;
      values.push(value);
    }
    return values;
  }

  function computeRatio(values, predicate){
    if(!values.length) return 0;
    let matches = 0;
    values.forEach(value => {
      if(predicate(value)) matches += 1;
    });
    return matches / values.length;
  }

  function isLikelyEmail(value){
    const str = cleanValue(value).toLowerCase();
    if(!str) return false;
    if(str.includes(' ')) return false;
    const parts = str.split('@');
    if(parts.length !== 2) return false;
    if(parts[0].length < 2) return false;
    if(!parts[1] || parts[1].indexOf('.') === -1) return false;
    const domainParts = parts[1].split('.');
    if(domainParts.some(part => !part)) return false;
    return domainParts[domainParts.length - 1].length >= 2;
  }

  function isLikelyPhoneValue(value){
    const phone = parsePhone(value);
    return Boolean(phone && phone.local && phone.local.length >= 7);
  }

  function isLikelyName(value){
    const str = cleanValue(value);
    if(!str) return false;
    if(/[0-9@]/.test(str)) return false;
    const words = str.split(/\s+/).filter(Boolean);
    if(words.length < 2) return false;
    const validWords = words.filter(word => /^[a-záéíóúñü'´-]+$/i.test(word));
    return validWords.length / words.length >= 0.6;
  }

  function isLikelyMatricula(value){
    const str = cleanValue(value);
    if(!str) return false;
    if(isLikelyEmail(str) || isLikelyPhoneValue(str)) return false;
    const normalized = str.replace(/[^a-z0-9]/gi,'');
    if(!normalized) return false;
    if(normalized.length < 4 || normalized.length > 16) return false;
    if(/^[a-z]+$/i.test(normalized)) return false;
    return /\d/.test(normalized);
  }

  function isLikelyDate(value){
    const str = cleanValue(value);
    if(!str) return false;
    if(/\d{4}-\d{2}-\d{2}/.test(str)) return true;
    if(/\d{2}[\/.-]\d{2}[\/.-]\d{2,4}/.test(str)) return true;
    const parsed = Date.parse(str);
    if(Number.isNaN(parsed)) return false;
    const year = new Date(parsed).getFullYear();
    return year >= 1990 && year <= 2100;
  }

  function isKnownEstado(value){
    const normalized = normalizeTextValue(value);
    if(!normalized) return false;
    if(estadoAliasMap.has(normalized)) return true;
    return KNOWN_ESTADOS.has(normalized);
  }

  function evaluateHeaderCandidate(header, rows, index){
    const headerText = cleanValue(header);
    if(!headerText){
      return { header: headerText, index, key: null, score: 0, source: '' };
    }
    const headerNorm = normalizeAliasKey(headerText);
    const tokens = extractHeaderTokens(headerText);
    const samples = collectColumnSamples(headerText, rows, 60);
    const candidateMap = new Map();
    const addCandidate = (field, score, source) => {
      if(!field || !FIELD_LABELS[field]) return;
      const existing = candidateMap.get(field);
      const entry = { field, score, source };
      if(!existing){
        candidateMap.set(field, entry);
        return;
      }
      if(score > existing.score){
        candidateMap.set(field, entry);
        return;
      }
      if(score === existing.score && HEADER_SOURCE_PRIORITY[source] > HEADER_SOURCE_PRIORITY[existing.source]){
        candidateMap.set(field, entry);
      }
    };

    const aliasKey = resolveHeaderKey(headerText);
    if(aliasKey){
      addCandidate(aliasKey, 100, 'alias');
    }

    if(tokens.length){
      HEADER_TOKEN_HINTS.forEach(hint => {
        if(matchesTokenHint(tokens, hint.tokens)){
          if(hint.field === 'asignacion'){
            const dateRatio = computeRatio(samples, isLikelyDate);
            if(dateRatio >= 0.2) addCandidate(hint.field, hint.score, 'header');
          }else{
            addCandidate(hint.field, hint.score, 'header');
          }
        }
      });
    }

    if(headerNorm){
      headerAliasMap.forEach((field, aliasNorm) => {
        if(!aliasNorm || aliasNorm === headerNorm) return;
        if(aliasNorm.length < 4) return;
        if(headerNorm.includes(aliasNorm)){
          addCandidate(field, Math.min(88, 40 + aliasNorm.length), 'header');
        }
      });
      Object.entries(FIELD_LABELS).forEach(([field, label]) => {
        const labelNorm = normalizeAliasKey(label);
        if(!labelNorm || labelNorm === headerNorm) return;
        if(headerNorm.includes(labelNorm)){
          addCandidate(field, 72, 'header');
        }
      });
    }

    if(samples.length){
      const emailRatio = computeRatio(samples, isLikelyEmail);
      if(emailRatio >= 0.6){
        addCandidate('correo', 92, 'data');
      }else if(emailRatio >= 0.35){
        addCandidate('correo', 78, 'data');
      }else if(emailRatio >= 0.2){
        addCandidate('correo', 65, 'data');
      }

      const phoneRatio = computeRatio(samples, isLikelyPhoneValue);
      if(phoneRatio >= 0.6){
        addCandidate('telefono', 88, 'data');
      }else if(phoneRatio >= 0.35){
        addCandidate('telefono', 74, 'data');
      }else if(phoneRatio >= 0.2){
        addCandidate('telefono', 60, 'data');
      }

      const nameRatio = computeRatio(samples, isLikelyName);
      if(nameRatio >= 0.7){
        addCandidate('nombre', 74, 'data');
      }else if(nameRatio >= 0.5){
        addCandidate('nombre', 66, 'data');
      }

      const matriculaRatio = computeRatio(samples, isLikelyMatricula);
      if(matriculaRatio >= 0.6){
        addCandidate('matricula', 70, 'data');
      }else if(matriculaRatio >= 0.45){
        addCandidate('matricula', 62, 'data');
      }

      const etapaRatio = computeRatio(samples, value => Boolean(normalizeEtapaValue(value)));
      if(etapaRatio >= 0.5){
        addCandidate('etapa', 78, 'data');
      }else if(etapaRatio >= 0.3){
        addCandidate('etapa', 68, 'data');
      }

      const estadoRatio = computeRatio(samples, isKnownEstado);
      if(estadoRatio >= 0.5){
        addCandidate('estado', 78, 'data');
      }else if(estadoRatio >= 0.3){
        addCandidate('estado', 68, 'data');
      }

      const dateRatio = computeRatio(samples, isLikelyDate);
      if(dateRatio >= 0.6){
        addCandidate('asignacion', 72, 'data');
      }else if(dateRatio >= 0.4){
        addCandidate('asignacion', 64, 'data');
      }
    }

    let best = null;
    candidateMap.forEach(candidate => {
      if(!best){
        best = candidate;
        return;
      }
      if(candidate.score > best.score){
        best = candidate;
        return;
      }
      if(candidate.score === best.score && HEADER_SOURCE_PRIORITY[candidate.source] > HEADER_SOURCE_PRIORITY[best.source]){
        best = candidate;
      }
    });

    if(!best){
      return { header: headerText, index, key: null, score: 0, source: '' };
    }
    return { header: headerText, index, key: best.field, score: best.score, source: best.source };
  }

  function buildHeaderMapping(headers, rows){
    if(!Array.isArray(headers) || !headers.length){
      return new Map();
    }
    const candidates = headers.map((header, index) => evaluateHeaderCandidate(header, rows, index));
    const assignments = new Map();
    const mapping = new Map();
    candidates.forEach(candidate => {
      if(!candidate || !candidate.key) return;
      const existing = assignments.get(candidate.key);
      if(!existing){
        assignments.set(candidate.key, candidate);
        return;
      }
      if(candidate.score > existing.score){
        assignments.set(candidate.key, candidate);
        return;
      }
      if(candidate.score === existing.score){
        const priorityDiff = HEADER_SOURCE_PRIORITY[candidate.source] - HEADER_SOURCE_PRIORITY[existing.source];
        if(priorityDiff > 0 || (priorityDiff === 0 && candidate.index < existing.index)){
          assignments.set(candidate.key, candidate);
        }
      }
    });
    const normalizedMapping = new Map();
    assignments.forEach(candidate => {
      mapping.set(candidate.header, candidate.key);
      const normalized = normalizeAliasKey(candidate.header);
      if(normalized) normalizedMapping.set(normalized, candidate.key);
    });
    mapping._normalized = normalizedMapping;
    return mapping;
  }

  registerEtapaAlias('Nuevo',['nuevo','prospecto nuevo']);
  registerEtapaAlias('Contactado',['contactado','en seguimiento','seguimiento','labor de venta','laborventa']);
  registerEtapaAlias('No Contactado',['no contactado','nocontactado','no-contactado','sin contacto','sinrespuesta','no se localizo']);
  registerEtapaAlias('Inscrito',['inscrito','matriculado']);
  registerEtapaAlias('Descartado',['descartado','descartada','no interesado','no interesada','sin interes','spam','rechazado']);

  Object.entries(estadosByEtapa).forEach(([etapa, estados]) => {
    estados.forEach(estado => registerEstadoAlias(etapa, estado));
  });
  registerEstadoAlias('Nuevo','Sin contactar',['nuevo']);
  registerEstadoAlias('No Contactado','No contesta',['sin respuesta','no responde','buzon de voz','buzón de voz','cuelga','no contesta whatsapp']);
  registerEstadoAlias('No Contactado','Mensaje no respondido',['mensaje sin responder','mensaje no contestado']);
  registerEstadoAlias('No Contactado','Pendiente de reintento',['volver a marcar','reintentar','limite intentos contacto','limite de intentos de contacto']);
  registerEstadoAlias('Contactado','Seguimiento activo',['seguimiento']);
  registerEstadoAlias('Contactado','En labor de venta',['labor de venta']);
  registerEstadoAlias('Descartado','Sin interés',['no interesado','no interesada','no desea informacion','no desea información','inscrito en otra escuela']);
  registerEstadoAlias('Descartado','Datos incorrectos',['datos falsos','telefono incorrecto','correo incorrecto']);
  registerEstadoAlias('Descartado','Duplicado',['duplicado','duplicada']);
  registerEstadoAlias('Descartado','SPAM',['spam']);
  registerEstadoAlias('Inscrito','Inscrito confirmado',['inscrito']);

  function resolveHeaderKey(header){
    const norm = normalizeAliasKey(header);
    return norm ? (headerAliasMap.get(norm) || null) : null;
  }
  function mapRowToCanonical(row, headerMapping){
    const out = {};
    const extras = [];
    Object.keys(row || {}).forEach(key => {
      const value = cleanValue(row[key]);
      if(value === '') return;
      let canonical = null;
      if(headerMapping){
        canonical = headerMapping.get(key) || null;
        if(!canonical && headerMapping._normalized){
          const normalizedKey = normalizeAliasKey(key);
          if(normalizedKey) canonical = headerMapping._normalized.get(normalizedKey) || null;
        }
      }
      if(!canonical){
        canonical = resolveHeaderKey(key);
      }
      if(canonical){
        if(out[canonical] === undefined){
          out[canonical] = value;
          return;
        }
        extras.push({ header: key, value });
        return;
      }
      extras.push({ header: key, value });
    });
    if(extras.length){
      out._extras = extras.map(item => ({
        header: String(item.header ?? '').trim(),
        value: cleanValue(item.value)
      }));
    }
    return out;
  }
  function hasFieldData(row, fields){
    return fields.some(field => cleanValue(row[field] || '') !== '');
  }
  function escapeHtml(value){
    return String(value ?? '')
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  }
  async function parseTabularFile(file){
    if(!file) return {headers:[], rows:[]};
    if(typeof XLSX !== 'undefined'){
      try{
        const buffer = await file.arrayBuffer();
        const workbook = XLSX.read(buffer, {type:'array'});
        const sheetName = workbook.SheetNames[0];
        if(sheetName){
          const sheet = workbook.Sheets[sheetName];
          const matrix = XLSX.utils.sheet_to_json(sheet, {header:1, defval:'', blankrows:false});
          if(matrix.length){
            const headers = (matrix[0] || []).map(cleanValue);
            const rows = matrix.slice(1).map(values => {
              const obj = {};
              headers.forEach((header, idx) => {
                const key = header || `col${idx}`;
                obj[key] = cleanValue(values[idx] ?? '');
              });
              return obj;
            }).filter(obj => Object.values(obj).some(val => cleanValue(val)));
            return {headers, rows};
          }
        }
      }catch(err){
        console.warn('No se pudo leer con XLSX', err);
      }
    }
    const text = await file.text();
    return parseCsvText(text);
  }
  function parseCsvText(text){
    if(!text) return {headers:[], rows:[]};
    const normalized = text.replace(/^﻿/, '');
    const firstLine = normalized.split(/\r?\n/)[0] || '';
    const commaCount = (firstLine.match(/,/g) || []).length;
    const semicolonCount = (firstLine.match(/;/g) || []).length;
    const delimiter = semicolonCount > commaCount ? ';' : ',';
    const rows = [];
    let field = '';
    let row = [];
    let inQuotes = false;
    for(let i=0;i<normalized.length;i++){
      const char = normalized[i];
      if(inQuotes){
        if(char === '"'){
          if(normalized[i+1] === '"'){
            field += '"';
            i++;
          }else{
            inQuotes = false;
          }
        }else{
          field += char;
        }
      }else{
        if(char === '"'){
          inQuotes = true;
        }else if(char === delimiter){
          row.push(field);
          field = '';
        }else if(char === '\r'){
          row.push(field);
          rows.push(row);
          row = [];
          field = '';
          if(normalized[i+1] === '\n') i++;
        }else if(char === '\n'){
          row.push(field);
          rows.push(row);
          row = [];
          field = '';
        }else{
          field += char;
        }
      }
    }
    if(field.length || row.length){
      row.push(field);
      rows.push(row);
    }
    while(rows.length && rows[rows.length-1].every(val => cleanValue(val) === '')){
      rows.pop();
    }
    if(!rows.length) return {headers:[], rows:[]};
    const headers = (rows.shift() || []).map(cleanValue);
    const mappedRows = rows.map(values => {
      const obj = {};
      headers.forEach((header, idx) => {
        const key = header || `col${idx}`;
        obj[key] = cleanValue(values[idx] ?? '');
      });
      return obj;
    }).filter(obj => Object.values(obj).some(val => cleanValue(val)));
    return {headers, rows: mappedRows};
  }
  function normalizeEtapaValue(value){
    const norm = normalizeTextValue(value);
    if(!norm) return '';
    if(etapaAliasMap.has(norm)) return etapaAliasMap.get(norm);
    if(norm.includes('no contact')) return 'No Contactado';
    if(norm.includes('contact') && !norm.includes('no')) return 'Contactado';
    if(norm.includes('inscrit')) return 'Inscrito';
    if(norm.includes('descart')) return 'Descartado';
    if(norm.includes('nuevo')) return 'Nuevo';
    return '';
  }
  function inferEtapaFromEstado(value){
    const entry = estadoAliasMap.get(normalizeTextValue(value));
    return entry ? entry.etapa : '';
  }
  function normalizeEstadoValue(value, etapa){
    const entry = estadoAliasMap.get(normalizeTextValue(value));
    if(entry){
      if(!etapa || entry.etapa === etapa) return entry.value;
      return entry.value;
    }
    return cleanValue(value);
  }
  function harmonizeEtapaEstado(etapaRaw, estadoRaw){
    let etapa = normalizeEtapaValue(etapaRaw);
    let estado = normalizeEstadoValue(estadoRaw, etapa);
    const inferred = inferEtapaFromEstado(estado);
    if(inferred) etapa = inferred;
    etapa = etapa ? etapaLabel(etapa) : '';
    if(etapa){
      const validStates = estadosByEtapa[etapa] || [];
      if(estado){
        const normalized = normalizeEstadoValue(estado, etapa);
        estado = validStates.length && validStates.indexOf(normalized) === -1 ? '' : normalized;
      }else if(validStates.length === 1){
        estado = validStates[0];
      }
    }
    return { etapa, estado };
  }
  function normalizeIdentifierKey(value){
    const str = cleanValue(value).toLowerCase().replace(/\s+/g,'');
    return str || '';
  }
  function normalizeEmailKey(value){
    const str = cleanValue(value).toLowerCase();
    return str || '';
  }
  function normalizePhoneKey(value){
    const phone = parsePhone(value);
    return phone.local || phone.digits || '';
  }
  function formatMetadataLabel(key){
    if(!key) return '';
    if(FIELD_LABELS[key]) return FIELD_LABELS[key];
    return String(key || '')
      .replace(/([a-z])([A-Z])/g, '$1 $2')
      .replace(/[_-]+/g, ' ')
      .replace(/\s+/g, ' ')
      .trim()
      .replace(/\b\w/g, ch => ch.toUpperCase());
  }
  function normalizeImportRow(raw, headerMapping){
    const mapped = mapRowToCanonical(raw, headerMapping);
    const extras = Array.isArray(mapped._extras) ? mapped._extras : [];
    if('_extras' in mapped) delete mapped._extras;
    const stageState = harmonizeEtapaEstado(mapped.etapa, mapped.estado);
    const telefonoBase = mapped.telefono || mapped.telefonoNormalizado || '';
    const row = {
      id: mapped.id || '',
      nombre: mapped.nombre || '',
      matricula: mapped.matricula || '',
      telefono: mapped.telefono || '',
      correo: mapped.correo || '',
      campus: mapped.campus || '',
      modalidad: mapped.modalidad || '',
      programa: mapped.programa || '',
      etapa: stageState.etapa,
      estado: stageState.estado,
      asesor: mapped.asesor || '',
      comentario: mapped.comentario || '',
      asignacion: mapped.asignacion || ''
    };
    if(!row.telefono && telefonoBase){
      row.telefono = telefonoBase;
    }
    row._phoneKey = normalizePhoneKey(telefonoBase || row.telefono);
    row._emailKey = normalizeEmailKey(row.correo);
    row._idKey = normalizeIdentifierKey(row.id);
    row._matriculaKey = normalizeIdentifierKey(row.matricula);
    const metadataEntries = [];
    let unnamedExtraCount = 0;
    const pushMetadata = (header, value) => {
      const sanitizedValue = cleanValue(value);
      if(!sanitizedValue) return;
      let label = cleanValue(header);
      if(!label){
        unnamedExtraCount += 1;
        label = `Columna extra ${unnamedExtraCount}`;
      }
      metadataEntries.push({ header: label, value: sanitizedValue });
    };
    extras.forEach(item => pushMetadata(item.header, item.value));
    const metadataFieldExclusions = new Set([...IMPORT_OUTPUT_FIELDS, 'telefonoNormalizado','telefonoAircall','telefonoWhatsapp','metadatos']);
    Object.keys(mapped).forEach(key => {
      if(!key || metadataFieldExclusions.has(key)) return;
      const value = cleanValue(mapped[key]);
      if(!value) return;
      pushMetadata(formatMetadataLabel(key), value);
    });
    let metadataValue = cleanValue(mapped.metadatos || '');
    const metadataString = metadataEntries
      .map(entry => `${entry.header}: ${entry.value}`)
      .join(' | ');
    if(metadataString){
      metadataValue = metadataValue
        ? `${metadataValue} | ${metadataString}`
        : metadataString;
    }
    row.metadatos = metadataValue;
    if(metadataEntries.length){
      row._metadataEntries = metadataEntries;
    }
    if(!hasFieldData(row, IMPORT_OUTPUT_FIELDS)) return null;
    return row;
  }
  function normalizeBulkRow(raw, headerMapping){
    const mapped = mapRowToCanonical(raw, headerMapping);
    const stageState = harmonizeEtapaEstado(mapped.etapa, mapped.estado);
    const row = {
      id: mapped.id || '',
      matricula: mapped.matricula || '',
      etapa: stageState.etapa,
      estado: stageState.estado,
      comentario: mapped.comentario || '',
      asesor: mapped.asesor || ''
    };
    row._idKey = normalizeIdentifierKey(row.id);
    row._matriculaKey = normalizeIdentifierKey(row.matricula);
    if(!hasFieldData(row, BULK_OUTPUT_FIELDS)) return null;
    return row;
  }
  function createLeadKeyStores(){
    const stores = { phone:new Set(), email:new Set(), id:new Set(), matricula:new Set() };
    leads.forEach(lead => {
      const phone = normalizePhoneKey(lead.telefonoNormalizado || lead.telefono);
      if(phone) stores.phone.add(phone);
      const email = normalizeEmailKey(lead.correo);
      if(email) stores.email.add(email);
      const idKey = normalizeIdentifierKey(lead.id);
      if(idKey) stores.id.add(idKey);
      const matKey = normalizeIdentifierKey(lead.matricula);
      if(matKey) stores.matricula.add(matKey);
    });
    return stores;
  }
  function splitImportRows(rows){
    const valid = [];
    const duplicates = [];
    const stores = createLeadKeyStores();
    const seen = { phone:new Set(), email:new Set(), id:new Set(), matricula:new Set() };
    rows.forEach(row => {
      const reasons = [];
      if(row._phoneKey){
        if(stores.phone.has(row._phoneKey)) reasons.push('Teléfono ya existe en la base');
        if(seen.phone.has(row._phoneKey)) reasons.push('Teléfono duplicado en el archivo');
      }
      if(row._emailKey){
        if(stores.email.has(row._emailKey)) reasons.push('Correo ya existe en la base');
        if(seen.email.has(row._emailKey)) reasons.push('Correo duplicado en el archivo');
      }
      if(row._idKey){
        if(stores.id.has(row._idKey)) reasons.push('ID ya existe en la base');
        if(seen.id.has(row._idKey)) reasons.push('ID duplicado en el archivo');
      }
      if(row._matriculaKey){
        if(stores.matricula.has(row._matriculaKey)) reasons.push('Matrícula ya existe en la base');
        if(seen.matricula.has(row._matriculaKey)) reasons.push('Matrícula duplicada en el archivo');
      }
      if(reasons.length){
        duplicates.push({ data: row, reason: [...new Set(reasons)].join(' · ') });
      }else{
        if(row._phoneKey) seen.phone.add(row._phoneKey);
        if(row._emailKey) seen.email.add(row._emailKey);
        if(row._idKey) seen.id.add(row._idKey);
        if(row._matriculaKey) seen.matricula.add(row._matriculaKey);
        valid.push(row);
      }
    });
    return { valid, duplicates };
  }
  function buildLeadLookups(){
    const byId = new Map();
    const byMatricula = new Map();
    leads.forEach(lead => {
      const idKey = normalizeIdentifierKey(lead.id);
      if(idKey && !byId.has(idKey)) byId.set(idKey, lead);
      const matKey = normalizeIdentifierKey(lead.matricula);
      if(matKey && !byMatricula.has(matKey)) byMatricula.set(matKey, lead);
    });
    return { byId, byMatricula };
  }
  function splitBulkRows(rows){
    const lookups = buildLeadLookups();
    const seen = { id:new Set(), matricula:new Set() };
    const valid = [];
    const issues = [];
    rows.forEach(row => {
      const reasons = [];
      const idKey = row._idKey;
      const matKey = row._matriculaKey;
      if(!idKey && !matKey) reasons.push('ID o Matrícula requerido');
      if(idKey && seen.id.has(idKey)) reasons.push('ID duplicado en el archivo');
      if(matKey && seen.matricula.has(matKey)) reasons.push('Matrícula duplicada en el archivo');
      let exists = false;
      if(idKey && lookups.byId.has(idKey)) exists = true;
      if(!exists && matKey && lookups.byMatricula.has(matKey)) exists = true;
      if((idKey || matKey) && !exists) reasons.push('Registro no encontrado en la base');
      if(!row.etapa) reasons.push('Etapa requerida');
      if(!row.estado) reasons.push('Estado requerido');
      if(row.etapa && row.estado){
        const validStates = estadosByEtapa[row.etapa] || [];
        if(validStates.length && validStates.indexOf(row.estado) === -1){
          reasons.push(`Estado no válido para etapa ${row.etapa}`);
        }
      }
      if(reasons.length){
        issues.push({ data: row, reason: [...new Set(reasons)].join(' · ') });
      }else{
        if(idKey) seen.id.add(idKey);
        if(matKey) seen.matricula.add(matKey);
        valid.push(row);
      }
    });
    return { valid, issues };
  }
  function projectImportRow(row){
    const out = {};
    IMPORT_PAYLOAD_FIELDS.forEach(field => { out[field] = cleanValue(row[field] || ''); });
    return out;
  }
  function projectBulkRow(row){
    const out = {};
    BULK_OUTPUT_FIELDS.forEach(field => { out[field] = cleanValue(row[field] || ''); });
    return out;
  }
  function clearContainer(target){
    const node = typeof target === 'string' ? el(target) : target;
    if(!node) return;
    node.innerHTML = '';
    node.classList.add('hidden');
  }
  function renderTable(target, rows, options = {}){
    const element = typeof target === 'string' ? el(target) : target;
    if(!element) return;
    if(!rows || !rows.length){
      clearContainer(element);
      return;
    }
    const limit = options.limit || 15;
    const fields = (options.fields && options.fields.length)
      ? options.fields
      : Object.keys(rows[0]).filter(key => !key.startsWith('_'));
    const headerHtml = fields.map(field => `<th>${FIELD_LABELS[field] || field}</th>`).join('');
    const bodyHtml = rows.slice(0, limit).map(row => {
      const cells = fields.map(field => {
        const formatter = FIELD_FORMATTERS[field];
        const value = formatter ? formatter(row[field]) : row[field];
        return `<td>${escapeHtml(value ?? '')}</td>`;
      }).join('');
      return `<tr>${cells}</tr>`;
    }).join('');
    const summaryText = options.summary
      ? options.summary
      : `Mostrando ${Math.min(limit, rows.length)} de ${rows.length} registros`;
    const extra = rows.length > limit && !options.summary
      ? `<div class="muted" style="margin-top:6px">Se muestran ${limit} de ${rows.length} registros.</div>`
      : '';
    element.innerHTML = `
      <div class="preview-summary">${escapeHtml(summaryText)}</div>
      <div class="table-wrap"><table><thead><tr>${headerHtml}</tr></thead><tbody>${bodyHtml}</tbody></table></div>
      ${extra}
    `;
    element.classList.remove('hidden');
  }
  function setButtonBusy(button, busy, label){
    if(!button) return;
    if(busy){
      if(!button.dataset.originalLabel){
        button.dataset.originalLabel = button.textContent;
      }
      button.disabled = true;
      if(label) button.textContent = label;
    }else{
      button.disabled = false;
      if(button.dataset.originalLabel){
        button.textContent = button.dataset.originalLabel;
        delete button.dataset.originalLabel;
      }
    }
  }

  function setNavLinkBusy(button, busy){
    if(!button) return;
    const isBusy = Boolean(busy);
    button.classList.toggle('is-busy', isBusy);
    if('disabled' in button){
      button.disabled = isBusy;
    }
    button.setAttribute('aria-busy', isBusy ? 'true' : 'false');
    let spinner = button.querySelector('.nav-link__spinner');
    if(isBusy){
      if(!spinner){
        spinner = document.createElement('span');
        spinner.className = 'nav-link__spinner';
        spinner.setAttribute('aria-hidden','true');
        button.appendChild(spinner);
      }
    }else if(spinner){
      spinner.remove();
    }
  }

  let globalLoadingDepth = 0;
  function toggleGlobalLoading(active, message){
    const overlay = document.getElementById('globalLoading');
    if(!overlay) return;
    const messageEl = document.getElementById('globalLoadingMessage');
    const text = message ? cleanValue(message) : '';
    if(messageEl){
      if(text){
        messageEl.textContent = text;
      }else if(!overlay.classList.contains('active') && !cleanValue(messageEl.textContent)){
        messageEl.textContent = 'Procesando…';
      }
    }
    if(active){
      globalLoadingDepth++;
      overlay.classList.remove('hidden');
      overlay.setAttribute('aria-hidden','false');
      overlay.setAttribute('aria-busy','true');
      requestAnimationFrame(()=> overlay.classList.add('active'));
    }else{
      if(globalLoadingDepth === 0) return;
      globalLoadingDepth = Math.max(0, globalLoadingDepth - 1);
      if(globalLoadingDepth === 0){
        overlay.classList.remove('active');
        overlay.setAttribute('aria-busy','false');
        overlay.setAttribute('aria-hidden','true');
        setTimeout(()=>{
          if(globalLoadingDepth === 0){
            overlay.classList.add('hidden');
          }
        }, 220);
      }
    }
  }

  async function withGlobalLoading(message, task){
    if(typeof task !== 'function') return;
    toggleGlobalLoading(true, message);
    try{
      return await task();
    }finally{
      toggleGlobalLoading(false);
    }
  }

  function buildBulkTemplateWorkbook(){
    if(typeof XLSX === 'undefined'){
      throw new Error('La librería XLSX no está disponible');
    }
    const headers = ['ID','Matrícula','Etapa','Estado','Motivo','Asesor'];
    const maxRows = 2000;
    const worksheet = XLSX.utils.aoa_to_sheet([headers]);
    worksheet['!ref'] = XLSX.utils.encode_range({
      s:{ c:0, r:0 },
      e:{ c: headers.length - 1, r: maxRows }
    });
    worksheet['!cols'] = [
      { wch: 18 },
      { wch: 18 },
      { wch: 18 },
      { wch: 26 },
      { wch: 34 },
      { wch: 22 }
    ];

    const stateOptions = [];
    Object.values(estadosByEtapa).forEach(list => {
      (list || []).forEach(option => {
        if(option && stateOptions.indexOf(option) === -1){
          stateOptions.push(option);
        }
      });
    });
    if(!stateOptions.length) stateOptions.push('');

    const listRows = [['Etapas','Estados']];
    const rowCount = Math.max(etapasUI.length, stateOptions.length) || 1;
    for(let i = 0; i < rowCount; i++){
      listRows.push([
        etapasUI[i] || '',
        stateOptions[i] || ''
      ]);
    }
    const listSheet = XLSX.utils.aoa_to_sheet(listRows);
    listSheet['!ref'] = XLSX.utils.encode_range({
      s:{ c:0, r:0 },
      e:{ c:1, r: rowCount }
    });
    listSheet['!state'] = 'hidden';
    listSheet['!cols'] = [
      { wch: 18 },
      { wch: 32 }
    ];

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, worksheet, 'Cambios masivos');
    XLSX.utils.book_append_sheet(wb, listSheet, 'Listas');

    const stageRange = `'Listas'!$A$2:$A$${etapasUI.length + 1}`;
    const stateRange = `'Listas'!$B$2:$B$${stateOptions.length + 1}`;
    worksheet['!dataValidation'] = [
      {
        type: 'list',
        allowBlank: 1,
        sqref: `C2:C${maxRows + 1}`,
        formulas: [stageRange]
      },
      {
        type: 'list',
        allowBlank: 1,
        sqref: `D2:D${maxRows + 1}`,
        formulas: [stateRange]
      }
    ];

    return wb;
  }

  function downloadBulkTemplate(){
    const wb = buildBulkTemplateWorkbook();
    const buffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'plantilla_cambios_masivos.xlsx';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  }

  let importData = [];
  const importFile = el('#importFile');
  const importPreview = el('#importPreview');
  const dupWrap = el('#dupWrap');
  const execBtn = el('#btnExecute');
  if(importFile) importFile.addEventListener('change', ()=>{
    importData = [];
    clearContainer(importPreview);
    clearContainer(dupWrap);
    if(execBtn) execBtn.disabled = true;
  });
  const verifyBtn = el('#btnVerify');
  if(verifyBtn) verifyBtn.addEventListener('click', async()=>{
    if(!canPerform('importData')){
      alert('No tienes permisos para importar datos.');
      return;
    }
    const file = importFile?.files?.[0];
    if(!file){ alert('Selecciona un archivo'); return; }
    setButtonBusy(verifyBtn, true, 'Verificando...');
    try{
      const parsed = await parseTabularFile(file);
      if(!parsed.rows.length){
        alert('El archivo no contiene datos.');
        importData = [];
        clearContainer(importPreview);
        clearContainer(dupWrap);
        if(execBtn) execBtn.disabled = true;
        return;
      }
      const headerMapping = buildHeaderMapping(parsed.headers, parsed.rows);
      const normalized = parsed.rows
        .map(row => normalizeImportRow(row, headerMapping))
        .filter(Boolean);
      if(!normalized.length){
        alert('No se encontraron columnas compatibles con la base.');
        importData = [];
        clearContainer(importPreview);
        clearContainer(dupWrap);
        if(execBtn) execBtn.disabled = true;
        return;
      }
      const { valid, duplicates } = splitImportRows(normalized);
      const validRows = valid.map(projectImportRow);
      const duplicateRows = duplicates.map(item => {
        const projected = projectImportRow(item.data);
        projected.motivo = item.reason;
        return projected;
      });
      importData = validRows;
      if(validRows.length){
        renderTable(importPreview, validRows, {
          fields: ['nombre','matricula','telefono','programa','etapa','estado'],
          summary: `Registros listos: ${validRows.length}${duplicateRows.length ? ` · Descartados: ${duplicateRows.length}` : ''}`
        });
        if(execBtn) execBtn.disabled = false;
      }else{
        clearContainer(importPreview);
        if(execBtn) execBtn.disabled = true;
      }
      if(duplicateRows.length){
        renderTable(dupWrap, duplicateRows, {
          fields: ['nombre','matricula','telefono','motivo'],
          limit: 10,
          summary: `Registros descartados: ${duplicateRows.length}`
        });
      }else{
        clearContainer(dupWrap);
      }
      if(!validRows.length){
        alert('No se encontraron registros nuevos después de eliminar duplicados.');
      }
    }catch(err){
      console.error('Error al verificar importación', err);
      alert('No se pudo procesar el archivo. Revisa que tenga formato CSV o XLSX.');
      importData = [];
      clearContainer(importPreview);
      clearContainer(dupWrap);
      if(execBtn) execBtn.disabled = true;
    }finally{
      setButtonBusy(verifyBtn, false);
    }
  });

  let activosData = [];
  let activosDiff = [];
  const activosFile = el('#activosFile');
  const activosPreview = el('#activosPreview');
  const activosDiffWrap = el('#activosDiff');
  const activosVerifyBtn = el('#btnActivosVerify');
  const activosExecuteBtn = el('#btnActivosExecute');

  if(activosFile) activosFile.addEventListener('change', ()=>{
    activosData = [];
    activosDiff = [];
    clearContainer(activosPreview);
    clearContainer(activosDiffWrap);
    if(activosExecuteBtn) activosExecuteBtn.disabled = true;
  });

  function dedupeLeadList(list){
    const set = new Set();
    const out = [];
    (list || []).forEach(lead => {
      if(!lead || set.has(lead)) return;
      set.add(lead);
      out.push(lead);
    });
    return out;
  }

  function matchActivosRow(row, index){
    const attempts = [
      { key: row._idKey, map: index.byId },
      { key: row._matriculaKey, map: index.byMatricula },
      { key: row._phoneKey, map: index.byPhone }
    ];
    for(const attempt of attempts){
      if(!attempt.key) continue;
      const list = attempt.map?.get(attempt.key) || [];
      if(!list.length) continue;
      const unique = dedupeLeadList(list);
      if(unique.length === 1){
        return { status:'ok', lead: unique[0] };
      }
      return { status:'conflict', reason:'Coincidencias múltiples en la base' };
    }
    return { status:'none', reason:'No se encontró en la base' };
  }

  function buildActivosUpdates(row){
    const updates = {};
    ACTIVOS_UPDATE_FIELDS.forEach(field => {
      const value = cleanValue(row[field] || '');
      if(value) updates[field] = value;
    });
    return updates;
  }

  function renderActivosPreview(matches, differences){
    if(matches.length){
      const rows = matches.map(item => {
        const updates = item.updates;
        const lead = item.lead;
        return {
          nombre: updates.nombre || lead.nombre,
          matricula: updates.matricula || lead.matricula,
          telefono: updates.telefono || lead.telefono,
          programa: updates.programa || lead.programa,
          modalidad: updates.modalidad || lead.modalidad,
          base: sheetDisplayName(item.sheet) || item.sheet,
          asesorActual: lead.asesor || '',
          asesorNuevo: 'Sistema'
        };
      });
      renderTable(activosPreview, rows, {
        fields: ['nombre','matricula','telefono','programa','modalidad','base','asesorActual','asesorNuevo'],
        summary: `Similitudes: ${matches.length}${differences.length ? ` · Diferencias: ${differences.length}` : ''}`
      });
    }else{
      clearContainer(activosPreview);
    }
    if(differences.length){
      const rows = differences.map(item => ({
        nombre: item.row?.nombre || '',
        matricula: item.row?.matricula || '',
        telefono: item.row?.telefono || '',
        motivo: item.reason
      }));
      renderTable(activosDiffWrap, rows, {
        fields: ['nombre','matricula','telefono','motivo'],
        limit: 10,
        summary: `Diferencias: ${differences.length}`
      });
    }else{
      clearContainer(activosDiffWrap);
    }
  }

  if(activosVerifyBtn) activosVerifyBtn.addEventListener('click', async()=>{
    if(!canPerform('importData')){
      alert('No tienes permisos para analizar activos.');
      return;
    }
    const file = activosFile?.files?.[0];
    if(!file){ alert('Selecciona un archivo'); return; }
    setButtonBusy(activosVerifyBtn, true, 'Analizando...');
    try{
      const parsed = await parseTabularFile(file);
      if(!parsed.rows.length){
        alert('El archivo no contiene datos.');
        activosData = [];
        activosDiff = [];
        clearContainer(activosPreview);
        clearContainer(activosDiffWrap);
        if(activosExecuteBtn) activosExecuteBtn.disabled = true;
        return;
      }
      const headerMapping = buildHeaderMapping(parsed.headers, parsed.rows);
      const normalized = parsed.rows
        .map(row => normalizeImportRow(row, headerMapping))
        .filter(Boolean);
      if(!normalized.length){
        alert('No se encontraron columnas compatibles para comparar activos.');
        activosData = [];
        activosDiff = [];
        clearContainer(activosPreview);
        clearContainer(activosDiffWrap);
        if(activosExecuteBtn) activosExecuteBtn.disabled = true;
        return;
      }
      const index = await ensureGlobalLeadIndex();
      const matches = [];
      const differences = [];
      const seen = { id:new Set(), matricula:new Set(), phone:new Set() };
      normalized.forEach(row => {
        const reasons = [];
        if(row._idKey){
          if(seen.id.has(row._idKey)) reasons.push('ID duplicado en el archivo');
          else seen.id.add(row._idKey);
        }
        if(row._matriculaKey){
          if(seen.matricula.has(row._matriculaKey)) reasons.push('Matrícula duplicada en el archivo');
          else seen.matricula.add(row._matriculaKey);
        }
        if(row._phoneKey){
          if(seen.phone.has(row._phoneKey)) reasons.push('Teléfono duplicado en el archivo');
          else seen.phone.add(row._phoneKey);
        }
        if(!row._idKey && !row._matriculaKey && !row._phoneKey){
          reasons.push('Sin identificadores (ID, Matrícula o Teléfono)');
        }
        if(reasons.length){
          differences.push({ row, reason: [...new Set(reasons)].join(' · ') });
          return;
        }
        const match = matchActivosRow(row, index);
        if(match.status === 'ok'){
          const updates = buildActivosUpdates(row);
          matches.push({
            row,
            lead: match.lead,
            sheet: match.lead.base,
            updates,
            phoneKey: row._phoneKey || '',
            matriculaKey: row._matriculaKey || '',
            idKey: row._idKey || ''
          });
        }else{
          differences.push({ row, reason: match.reason });
        }
      });
      activosData = matches;
      activosDiff = differences;
      renderActivosPreview(matches, differences);
      if(activosExecuteBtn) activosExecuteBtn.disabled = !matches.length;
      if(!matches.length){
        alert('No se encontraron coincidencias en la base.');
      }
    }catch(err){
      console.error('Error al analizar activos', err);
      alert('No se pudo procesar el archivo de activos.');
      activosData = [];
      activosDiff = [];
      clearContainer(activosPreview);
      clearContainer(activosDiffWrap);
      if(activosExecuteBtn) activosExecuteBtn.disabled = true;
    }finally{
      setButtonBusy(activosVerifyBtn, false);
    }
  });

  function buildActivosPayloadEntry(entry){
    const updates = {};
    ACTIVOS_UPDATE_FIELDS.forEach(field => {
      const value = entry.updates[field];
      if(value) updates[field] = value;
    });
    return {
      sheet: entry.sheet,
      id: entry.lead.id || '',
      idKey: entry.idKey || normalizeIdentifierKey(entry.lead.id),
      matriculaKey: entry.matriculaKey || normalizeIdentifierKey(entry.lead.matricula),
      phoneKey: entry.phoneKey || normalizePhoneKey(entry.lead.telefonoNormalizado || entry.lead.telefono),
      updates
    };
  }

  if(activosExecuteBtn) activosExecuteBtn.addEventListener('click', async()=>{
    if(!canPerform('syncActivos')){
      alert('No tienes permisos para actualizar activos.');
      return;
    }
    if(!activosData.length){ alert('No hay coincidencias verificadas.'); return; }
    setButtonBusy(activosExecuteBtn, true, 'Actualizando...');
    try{
      const payload = {
        action: 'syncActivos',
        rows: activosData.map(buildActivosPayloadEntry)
      };
      const response = await apiFetch(API_URL, {
        method: 'POST',
        body: payload
      });
      const rawBody = await response.text().catch(()=> '');
      if(!response.ok){
        let message = rawBody || `HTTP ${response.status}`;
        try{
          const parsed = rawBody ? JSON.parse(rawBody) : null;
          if(parsed && parsed.error){
            message = parsed.error;
          }
        }catch(_ignore){}
        throw new Error(message);
      }
      let successMessage = 'Actualización completada.';
      if(rawBody){
        try{
          const parsed = JSON.parse(rawBody);
          if(parsed && parsed.ok){
            const parts = [`Registros actualizados: ${parsed.updated || 0}`];
            if(parsed.unmatched && parsed.unmatched.length){
              parts.push(`No encontrados: ${parsed.unmatched.length}`);
            }
            successMessage = parts.join(' · ');
          }else if(parsed && parsed.error){
            throw new Error(parsed.error);
          }
        }catch(errJson){
          console.warn('Respuesta inesperada al actualizar activos', errJson);
        }
      }
      alert(successMessage);
      activosData = [];
      activosDiff = [];
      clearContainer(activosPreview);
      clearContainer(activosDiffWrap);
      if(activosExecuteBtn) activosExecuteBtn.disabled = true;
      invalidateGlobalLeadIndex();
      await withGlobalLoading('Actualizando leads…', () => loadLeads());
      populateAsesores();
      populateCampuses();
      populateExportFilters();
      refresh();
    }catch(err){
      console.error('Error al actualizar activos', err);
      alert(`Error al actualizar activos: ${err.message || err}`);
    }finally{
      setButtonBusy(activosExecuteBtn, false);
    }
  });

  let bulkData = [];
  const bulkFile = el('#bulkFile');
  const bulkPreview = el('#bulkPreview');
  const bulkIssuesWrap = el('#bulkDupWrap');
  const bulkExecBtn = el('#btnBulkExecute');
  if(bulkFile) bulkFile.addEventListener('change', ()=>{
    bulkData = [];
    clearContainer(bulkPreview);
    clearContainer(bulkIssuesWrap);
    if(bulkExecBtn) bulkExecBtn.disabled = true;
  });
  const bulkVerifyBtn = el('#btnBulkVerify');
  if(bulkVerifyBtn) bulkVerifyBtn.addEventListener('click', async()=>{
    if(!canPerform('importData')){
      alert('No tienes permisos para validar cambios masivos.');
      return;
    }
    const file = bulkFile?.files?.[0];
    if(!file){ alert('Selecciona un archivo'); return; }
    setButtonBusy(bulkVerifyBtn, true, 'Verificando...');
    try{
      const parsed = await parseTabularFile(file);
      if(!parsed.rows.length){
        alert('El archivo no contiene datos.');
        bulkData = [];
        clearContainer(bulkPreview);
        clearContainer(bulkIssuesWrap);
        if(bulkExecBtn) bulkExecBtn.disabled = true;
        return;
      }
      const headerMapping = buildHeaderMapping(parsed.headers, parsed.rows);
      const normalized = parsed.rows
        .map(row => normalizeBulkRow(row, headerMapping))
        .filter(Boolean);
      if(!normalized.length){
        alert('No se encontraron columnas válidas para cambios masivos.');
        bulkData = [];
        clearContainer(bulkPreview);
        clearContainer(bulkIssuesWrap);
        if(bulkExecBtn) bulkExecBtn.disabled = true;
        return;
      }
      const { valid, issues } = splitBulkRows(normalized);
      const validRows = valid.map(projectBulkRow);
      const issueRows = issues.map(item => {
        const projected = projectBulkRow(item.data);
        projected.motivo = item.reason;
        return projected;
      });
      bulkData = validRows;
      if(validRows.length){
        renderTable(bulkPreview, validRows, {
          fields: ['id','matricula','etapa','estado','comentario'],
          summary: `Registros listos: ${validRows.length}${issueRows.length ? ` · Con incidencias: ${issueRows.length}` : ''}`
        });
        if(bulkExecBtn) bulkExecBtn.disabled = false;
      }else{
        clearContainer(bulkPreview);
        if(bulkExecBtn) bulkExecBtn.disabled = true;
      }
      if(issueRows.length){
        renderTable(bulkIssuesWrap, issueRows, {
          fields: ['id','matricula','etapa','estado','motivo'],
          limit: 10,
          summary: `Registros con incidencias: ${issueRows.length}`
        });
      }else{
        clearContainer(bulkIssuesWrap);
      }
      if(!validRows.length){
        alert('No se encontró ningún registro válido para actualizar.');
      }
    }catch(err){
      console.error('Error al verificar cambios masivos', err);
      alert('No se pudo procesar el archivo de cambios masivos.');
      bulkData = [];
      clearContainer(bulkPreview);
      clearContainer(bulkIssuesWrap);
      if(bulkExecBtn) bulkExecBtn.disabled = true;
    }finally{
      setButtonBusy(bulkVerifyBtn, false);
    }
  });

  const bulkTemplateBtn = el('#btnBulkTemplate');
  if(bulkTemplateBtn) bulkTemplateBtn.addEventListener('click', ()=>{
    try{
      downloadBulkTemplate();
    }catch(err){
      console.error('Error al generar plantilla', err);
      alert('No se pudo generar la plantilla. Vuelve a intentarlo.');
    }
  });

  if(execBtn) execBtn.addEventListener('click', async()=>{
    if(!canPerform('importData')){ alert('No tienes permisos para importar datos.'); return; }
    if(!importData.length){ alert('No hay datos verificados'); return; }
    if(!state.sheet){ alert('Selecciona una base antes de importar.'); return; }
    setButtonBusy(execBtn, true, 'Enviando...');
    try{
      const payload = { action:'importLeads', sheet: state.sheet, rows: importData };
      const response = await apiFetch(API_URL, {
        method: 'POST',
        body: payload
      });
      const rawBody = await response.text().catch(()=> '');
      if(!response.ok){
        let message = rawBody || `HTTP ${response.status}`;
        try{
          const parsed = rawBody ? JSON.parse(rawBody) : null;
          if(parsed && parsed.error){
            message = parsed.error;
          }
        }catch(_ignore){}
        throw new Error(message);
      }
      let successMessage = 'Importación completada';
      if(rawBody){
        try{
          const parsed = JSON.parse(rawBody);
          if(parsed && parsed.message){
            successMessage = parsed.message;
          }
        }catch(_ignore){}
      }
      alert(successMessage);
      importData = [];
      clearContainer(importPreview);
      clearContainer(dupWrap);
      execBtn.disabled = true;
      invalidateGlobalLeadIndex();
      await withGlobalLoading('Actualizando leads…', () => loadLeads());
      populateAsesores();
      populateCampuses();
      populateExportFilters();
      refresh();
    }catch(err){
      console.error('Error al importar',err);
      alert(`Error al importar: ${err.message || err}`);
    }finally{
      setButtonBusy(execBtn, false);
    }
  });

  if(bulkExecBtn) bulkExecBtn.addEventListener('click', ()=>{
    if(!canPerform('importData')){
      alert('No tienes permisos para ejecutar cambios masivos.');
      return;
    }
    if(!bulkData.length){ alert('No hay cambios verificados'); return; }
    alert(`${bulkData.length} registros verificados. Envía los datos al backend desde aquí cuando esté disponible.`);
  });
  // Exportar
  function populateExportFilters(){
    const dataBase = el('#expDataBase');
    const dataAsesor = el('#expDataAsesor');
    const dataEtapa = el('#expDataEtapa');
    const dataEstado = el('#expDataEstado');
    const reportBase = el('#expReportBase');
    const reportAsesor = el('#expReportAsesor');
    const resolBase = el('#expResolBase');
    const resolAsesor = el('#expResolAsesor');
    if(!dataBase && !reportBase && !resolBase && !dataAsesor && !reportAsesor && !resolAsesor && !dataEtapa && !dataEstado) return;

    const populateSelect = (select, placeholder, values, labelFn) => {
      if(!select) return;
      const previous = select.value;
      select.innerHTML = '';
      if(typeof placeholder === 'string'){
        const option = document.createElement('option');
        option.value = '';
        option.textContent = placeholder;
        select.appendChild(option);
      }
      values.forEach(value => {
        const option = document.createElement('option');
        option.value = value;
        option.textContent = typeof labelFn === 'function' ? labelFn(value) : value;
        select.appendChild(option);
      });
      if(previous){
        select.value = previous;
        if(select.value !== previous) select.value = '';
      }else{
        select.value = '';
      }
    };

    const bases = [...new Set(leads.map(r => r.base).filter(Boolean))]
      .sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
    const baseLabel = base => sheetDisplayName(base) || base;
    populateSelect(dataBase, 'Bases', bases, baseLabel);
    populateSelect(reportBase, 'Base', bases, baseLabel);
    populateSelect(resolBase, 'Base', bases, baseLabel);

    const asesores = [...new Set(
      leads
        .map(r => r.asesor)
        .filter(a => a && !a.toLowerCase().includes('sistema'))
    )].sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
    populateSelect(dataAsesor, 'Todos los asesores', asesores);
    populateSelect(reportAsesor, 'Todos los asesores', asesores);
    populateSelect(resolAsesor, 'Todos los asesores', asesores);

    const etapas = [...new Set(leads.map(r => r.etapa).filter(Boolean))]
      .sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
    populateSelect(dataEtapa, 'Etapa', etapas);

    const estadoSet = new Set(
      leads
        .map(r => r.estado)
        .filter(Boolean)
    );
    if(!estadoSet.size){
      Object.values(estadosByEtapa).forEach(list => {
        list.forEach(item => estadoSet.add(item));
      });
    }
    const estadosOrdenados = Array.from(estadoSet)
      .sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' }));
    populateSelect(dataEstado, 'Todos los estados', estadosOrdenados);

    const selTipo = el('#expReportTipo');
    if(selTipo) selTipo.value = '';
    const selCRM = el('#expResolCRM');
    if(selCRM) selCRM.value = '';
  }

  function exportData(rows,name){
    const headers=['Matricula','Nombre','Telefono','Correo','ID','Etapa'];
    const csv=[headers.join(',')].concat(rows.map(r=>[r.matricula||'',r.nombre,r.telefono,r.correo,r.id,r.etapa].join(','))).join('\n');
    const blob=new Blob([csv],{type:'text/csv'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=name; a.click(); URL.revokeObjectURL(url);
  }
  const formatCsvField = value => {
    const text = cleanValue(value);
    if(!text) return '';
    return /[",\n]/.test(text) ? `"${text.replace(/"/g,'""')}"` : text;
  };
  function downloadCsvFromRows(rows, columns, filename){
    if(!Array.isArray(rows) || !rows.length) return;
    const cols = Array.isArray(columns) && columns.length
      ? columns
      : Object.keys(rows[0] || {}).map(key => ({ key, label: key }));
    const header = cols.map(col => formatCsvField(col.label)).join(',');
    const lines = rows.map(row => cols.map(col => formatCsvField(row?.[col.key])).join(','));
    const csv = [header].concat(lines).join('\n');
    const blob = new Blob([csv],{type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename || 'reporte.csv';
    a.click();
    URL.revokeObjectURL(url);
  }
  async function exportReport(params){
    const qs = new URLSearchParams({
      action:'report',
      asesor:params.asesor||'',
      base:params.base||'',
      etapa:params.etapa||'',
      estado:params.estado||'',
      fi:params.fi||'',
      ff:params.ff||'',
      type:params.tipo||''
    });
    try{
      const res = await apiFetch(`${API_URL}?${qs.toString()}`);
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      if(data && data.error){
        throw new Error(data.error);
      }
      if((params.tipo || '').toLowerCase() === 'losg'){
        const source = Array.isArray(data?.logs)
          ? data.logs
          : Array.isArray(data?.data?.logs)
            ? data.data.logs
            : Array.isArray(data?.data)
              ? data.data
              : Array.isArray(data?.records)
                ? data.records
                : Array.isArray(data?.rows)
                  ? data.rows
                  : (data?.data && typeof data.data === 'object')
                    ? Object.values(data.data)
                    : [];
        const normalizedLogs = source.map(normalizeLosgEntry).filter(Boolean);
        if(!normalizedLogs.length){
          alert('No se encontraron registros de actividad para el periodo seleccionado.');
          return;
        }
        const columns = [
          { key:'fecha', label:'Fecha' },
          { key:'usuario', label:'Usuario' },
          { key:'correo', label:'Correo' },
          { key:'rol', label:'Rol' },
          { key:'total_accesos', label:'Accesos totales' },
          { key:'primer_acceso', label:'Primer acceso' },
          { key:'ultimo_acceso', label:'Último acceso' },
          { key:'accesos_moviles', label:'Accesos móviles' },
          { key:'accesos_escritorio', label:'Accesos escritorio' },
          { key:'dispositivos', label:'Dispositivos' },
          { key:'horarios', label:'Horarios de conexión' },
          { key:'importaciones', label:'Importaciones' },
          { key:'exportaciones', label:'Exportaciones' },
          { key:'cambios_masivos', label:'Cambios masivos' },
          { key:'diagnosticos', label:'Diagnósticos ejecutados' },
          { key:'resultado_diagnostico', label:'Resultado diagnóstico' },
          { key:'permisos_asignados', label:'Permisos asignados' },
          { key:'planteles_asignados', label:'Planteles asignados' }
        ];
        downloadCsvFromRows(normalizedLogs, columns, 'reporte_losg.csv');
        return;
      }
      const rows = Object.entries(data.data||{}).map(([k,v])=>({item:k,cantidad:v}));
      const headers=['Item','Cantidad'];
      const csv=[headers.join(',')].concat(rows.map(r=>[r.item,r.cantidad].join(','))).join('\n');
      const blob=new Blob([csv],{type:'text/csv'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=`reporte_${params.tipo||'general'}.csv`; a.click(); URL.revokeObjectURL(url);
    }catch(err){
      alert('Error al generar reporte');
    }
  }
  function exportResolutions(rows,name){
    const headers=['ID','Nombre','Asesor','Base','CRM','Resolución','Etapa','Estado','Asignación'];
    const csv=[headers.join(',')].concat(rows.map(r=>[
      r.id||'',
      r.nombre||'',
      r.asesor||'',
      (sheetDisplayName(r.base)||r.base||''),
      r.crm||'',
      r.resolucion||'',
      r.etapa||'',
      r.estado||'',
      r.asignacion||''
    ].join(','))).join('\n');
    const blob=new Blob([csv],{type:'text/csv'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=name; a.click(); URL.revokeObjectURL(url);
  }
  const getValue = selector => {
    const control = el(selector);
    return control ? control.value : '';
  };
  const normalizeCRMValue = value => {
    const text = cleanValue(value);
    if(text && typeof text.normalize === 'function'){
      return text.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
    }
    return text.toLowerCase();
  };
  function handleDataExport(){
    if(!canPerform('exportData')){ alert('No tienes permisos para exportar información.'); return; }
    const params = {
      asesor: getValue('#expDataAsesor'),
      base: getValue('#expDataBase'),
      etapa: getValue('#expDataEtapa'),
      estado: getValue('#expDataEstado'),
      fi: getValue('#expDataStart'),
      ff: getValue('#expDataEnd')
    };
    let rows = leads.slice();
    if(params.asesor) rows = rows.filter(r => r.asesor === params.asesor);
    if(params.base) rows = rows.filter(r => r.base === params.base);
    if(params.etapa) rows = rows.filter(r => r.etapa === params.etapa || r.estado === params.etapa);
    if(params.estado) rows = rows.filter(r => r.estado === params.estado);
    if(params.fi) rows = rows.filter(r => r.asignacion >= params.fi);
    if(params.ff) rows = rows.filter(r => r.asignacion <= params.ff);
    rows = rows.slice(0,150);
    exportData(rows,'datos.csv');
  }
  async function handleReportExport(){
    if(!canPerform('exportData')){ alert('No tienes permisos para exportar información.'); return; }
    const params = {
      asesor: getValue('#expReportAsesor'),
      base: getValue('#expReportBase'),
      etapa: '',
      estado: '',
      fi: getValue('#expReportStart'),
      ff: getValue('#expReportEnd'),
      tipo: getValue('#expReportTipo')
    };
    if(!params.tipo){
      alert('Selecciona un tipo de reporte');
      return;
    }
    const reportBtn = el('#btnExportReport');
    setButtonBusy(reportBtn, true, 'Generando...');
    try{
      await withGlobalLoading('Generando reporte…', () => exportReport(params));
    }finally{
      setButtonBusy(reportBtn, false);
    }
  }
  function handleResolutionExport(){
    if(!canPerform('exportData')){ alert('No tienes permisos para exportar información.'); return; }
    const params = {
      crm: getValue('#expResolCRM'),
      asesor: getValue('#expResolAsesor'),
      base: getValue('#expResolBase'),
      fi: getValue('#expResolStart'),
      ff: getValue('#expResolEnd')
    };
    let rows = leads.slice();
    if(params.crm){
      const targetCRM = normalizeCRMValue(params.crm);
      rows = rows.filter(r => normalizeCRMValue(r.crm) === targetCRM);
    }
    if(params.asesor) rows = rows.filter(r => r.asesor === params.asesor);
    if(params.base) rows = rows.filter(r => r.base === params.base);
    if(params.fi) rows = rows.filter(r => r.asignacion >= params.fi);
    if(params.ff) rows = rows.filter(r => r.asignacion <= params.ff);
    rows = rows.slice(0,150);
    exportResolutions(rows,'resoluciones.csv');
  }
  const expDataBtn=el('#btnExportData');
  const expReportBtn=el('#btnExportReport');
  const expResolutionBtn=el('#btnExportResolution');
  if(expDataBtn) expDataBtn.addEventListener('click', handleDataExport);
  if(expReportBtn) expReportBtn.addEventListener('click', handleReportExport);
  if(expResolutionBtn) expResolutionBtn.addEventListener('click', handleResolutionExport);

  // —— Nota de conexión ——
  // Los datos se cargan desde Google Sheets mediante la URL de Apps Script definida en API_URL.

  attachForgotPasswordHandler();

  const resetCancelBtn = document.getElementById('resetCancel');
  if(resetCancelBtn){
    resetCancelBtn.addEventListener('click', () => {
      const resetEmailInput = document.getElementById('resetEmail');
      if(resetEmailInput){
        lastLoginEmail = resetEmailInput.value || lastLoginEmail;
      }
      showSignInView();
    });
  }

  const resetForm = document.getElementById('resetForm');
  if(resetForm){
    resetForm.addEventListener('submit', async event => {
      event.preventDefault();
      const emailInput = document.getElementById('resetEmail');
      const userIdInput = document.getElementById('resetUserId');
      const email = (emailInput?.value || '').trim().toLowerCase();
      const userId = (userIdInput?.value || '').trim();
      if(!email || !userId){
        setResetStatus('Ingresa correo e ID de usuario.', 'error');
        return;
      }
      setResetBusy(true);
      setResetStatus('');
      try{
        const response = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify({ action: 'requestPasswordReset', email, userId })
        });
        let data = null;
        try{
          data = await response.json();
        }catch(_err){
          data = null;
        }
        if(!response.ok || !data || data.error){
          const message = data && data.error ? data.error : `Error al generar la contraseña (${response.status})`;
          throw new Error(message);
        }
        const tempPassword = data.tempPassword || '';
        const baseMessage = data.message || 'Contraseña temporal generada.';
        const message = tempPassword ? `${baseMessage} Contraseña temporal: ${tempPassword}` : baseMessage;
        setResetStatus(message, 'success');
        updateResetHint('Copia la contraseña temporal y da clic en "Volver a iniciar sesión" para utilizarla.');
        lastLoginEmail = email;
        pendingResetCredentials = {
          email,
          password: tempPassword,
          message: 'Contraseña temporal generada. Ingresa y cámbiala desde Configuración.'
        };
      }catch(err){
        setResetStatus(resolveErrorMessage(err, 'No se pudo generar la contraseña temporal.'), 'error');
      }finally{
        setResetBusy(false);
      }
    });
  }

  const loginForm = document.getElementById('loginForm');
  if(loginForm){
    loginForm.addEventListener('submit', async event => {
      event.preventDefault();
      const emailInput = document.getElementById('loginEmail');
      const passwordInput = document.getElementById('loginPassword');
      const email = (emailInput?.value || '').trim().toLowerCase();
      const password = (passwordInput?.value || '').trim();
      if(!email || !password){
        setLoginError('Ingresa correo y contraseña.');
        return;
      }
      setLoginBusy(true);
      setLoginError('');
      try{
        const response = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify({ action: 'login', email, password })
        });
        let data = null;
        try{
          data = await response.json();
        }catch(_err){
          data = null;
        }
        if(!response.ok || !data || data.error){
          const message = data && data.error ? data.error : `Error de inicio de sesión (${response.status})`;
          throw new Error(message);
        }
        await onAuthenticated(data.token, data.user, { persist: true });
        loginForm.reset();
      }catch(err){
        setLoginError(resolveErrorMessage(err, 'No se pudo iniciar sesión.'));
      }finally{
        setLoginBusy(false);
      }
    });
  }

  restoreSession();
  </script>
</body>
</html>
